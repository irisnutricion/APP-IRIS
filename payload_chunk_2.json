[{"path":"inspect_angel.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\n\r\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\nconst envConfig = fs.readFileSync(envPath, 'utf8');\r\nconst env = {};\r\nenvConfig.split('\\n').forEach(line => {\r\n    const [key, value] = line.split('=');\r\n    if (key && value) env[key.trim()] = value.trim();\r\n});\r\n\r\nconst supabaseUrl = env.VITE_SUPABASE_URL;\r\nconst supabaseKey = env.VITE_SUPABASE_KEY;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nconst ANGEL_ID = \"ecdaeee4-4f23-479a-a9af-59346c40966e\";\r\n\r\nasync function inspect() {\r\n    console.log('Fetching details for Angel...');\r\n\r\n    const { data: history } = await supabase\r\n        .from('subscription_history')\r\n        .select('*')\r\n        .eq('patient_id', ANGEL_ID)\r\n        .order('start_date', { ascending: false });\r\n\r\n    const { data: extensions } = await supabase\r\n        .from('subscription_extensions')\r\n        .select('*')\r\n        .eq('patient_id', ANGEL_ID)\r\n        .order('created_at', { ascending: false });\r\n\r\n    const result = {\r\n        history,\r\n        extensions\r\n    };\r\n\r\n    fs.writeFileSync('angel_details.json', JSON.stringify(result, null, 2));\r\n    console.log('Details written to angel_details.json');\r\n}\r\n\r\ninspect();\r\n"},{"path":"list_patients_data.sql","content":"-- List all patients to see who has a category assigned\r\nSELECT id, first_name, last_name, payment_category_id \r\nFROM patients \r\nORDER BY created_at DESC;\r\n"},{"path":"migration.sql","content":"-- Add subscription_type_id to link rates to specific durations\r\nALTER TABLE payment_rates \r\nADD COLUMN IF NOT EXISTS subscription_type_id UUID REFERENCES subscription_types(id) ON DELETE SET NULL;\r\n\r\n-- Add is_active to allow archiving old rates\r\nALTER TABLE payment_rates \r\nADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true;\r\n\r\n-- Update existing rates to be active by default if null\r\nUPDATE payment_rates SET is_active = true WHERE is_active IS NULL;\r\n"},{"path":"migration_add_notes.sql","content":"\r\nDO $$ \r\nBEGIN \r\n    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'patients' AND column_name = 'notes') THEN \r\n        ALTER TABLE patients ADD COLUMN notes TEXT; \r\n    END IF; \r\nEND $$;\r\n"},{"path":"migration_patients_category.sql","content":"-- Add payment_category_id to patients to store their Center/Channel\r\nALTER TABLE patients \r\nADD COLUMN IF NOT EXISTS payment_category_id UUID REFERENCES payment_categories(id) ON DELETE SET NULL;\r\n\r\n-- Insert default Centers if they don't exist\r\nINSERT INTO payment_categories (label, color, is_active)\r\nSELECT 'Online', 'bg-blue-100 text-blue-700 border-blue-200', true\r\nWHERE NOT EXISTS (SELECT 1 FROM payment_categories WHERE label = 'Online');\r\n\r\nINSERT INTO payment_categories (label, color, is_active)\r\nSELECT 'Maroon Think', 'bg-red-100 text-red-700 border-red-200', true\r\nWHERE NOT EXISTS (SELECT 1 FROM payment_categories WHERE label = 'Maroon Think');\r\n\r\nINSERT INTO payment_categories (label, color, is_active)\r\nSELECT 'Hawk Training Center', 'bg-slate-100 text-slate-700 border-slate-200', true\r\nWHERE NOT EXISTS (SELECT 1 FROM payment_categories WHERE label = 'Hawk Training Center');\r\n"},{"path":"migration_patients_category_v2.sql","content":"-- Add payment_category_id to patients to store their Center/Channel\r\n-- Using TEXT because payment_categories.id is TEXT, not UUID\r\nALTER TABLE patients \r\nADD COLUMN IF NOT EXISTS payment_category_id TEXT REFERENCES payment_categories(id) ON DELETE SET NULL;\r\n\r\n-- Insert default Centers if they don't exist\r\n-- We create a temporary function to handle conditional inserts more cleanly or just use standard INSERT WHERE NOT EXISTS\r\nINSERT INTO payment_categories (label, color, is_active)\r\nSELECT 'Online', 'bg-blue-100 text-blue-700 border-blue-200', true\r\nWHERE NOT EXISTS (SELECT 1 FROM payment_categories WHERE label = 'Online');\r\n\r\nINSERT INTO payment_categories (label, color, is_active)\r\nSELECT 'Maroon Think', 'bg-red-100 text-red-700 border-red-200', true\r\nWHERE NOT EXISTS (SELECT 1 FROM payment_categories WHERE label = 'Maroon Think');\r\n\r\nINSERT INTO payment_categories (label, color, is_active)\r\nSELECT 'Hawk Training Center', 'bg-slate-100 text-slate-700 border-slate-200', true\r\nWHERE NOT EXISTS (SELECT 1 FROM payment_categories WHERE label = 'Hawk Training Center');\r\n"},{"path":"migration_patients_category_v3.sql","content":"-- Add payment_category_id to patients to store their Center/Channel if not exists\r\nALTER TABLE patients \r\nADD COLUMN IF NOT EXISTS payment_category_id TEXT REFERENCES payment_categories(id) ON DELETE SET NULL;\r\n\r\n-- Insert default Centers with Explicit IDs (using UUID as text)\r\n-- Fixes \"null value in column id\" error\r\nINSERT INTO payment_categories (id, label, color, is_active)\r\nSELECT gen_random_uuid()::text, 'Online', 'bg-blue-100 text-blue-700 border-blue-200', true\r\nWHERE NOT EXISTS (SELECT 1 FROM payment_categories WHERE label = 'Online');\r\n\r\nINSERT INTO payment_categories (id, label, color, is_active)\r\nSELECT gen_random_uuid()::text, 'Maroon Think', 'bg-red-100 text-red-700 border-red-200', true\r\nWHERE NOT EXISTS (SELECT 1 FROM payment_categories WHERE label = 'Maroon Think');\r\n\r\nINSERT INTO payment_categories (id, label, color, is_active)\r\nSELECT gen_random_uuid()::text, 'Hawk Training Center', 'bg-slate-100 text-slate-700 border-slate-200', true\r\nWHERE NOT EXISTS (SELECT 1 FROM payment_categories WHERE label = 'Hawk Training Center');\r\n\r\n-- Refresh cache\r\nNOTIFY pgrst, 'reload config';\r\n"},{"path":"migration_payments.sql","content":"-- Add payment_rate_id to link payments to specific rates (new system)\r\nALTER TABLE payments \r\nADD COLUMN IF NOT EXISTS payment_rate_id UUID REFERENCES payment_rates(id) ON DELETE SET NULL;\r\n"},{"path":"migration_subscription_pauses.sql","content":"-- Create subscription_pauses table\r\nCREATE TABLE IF NOT EXISTS public.subscription_pauses (\r\n    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\r\n    patient_id UUID NOT NULL REFERENCES public.patients(id) ON DELETE CASCADE,\r\n    start_date DATE NOT NULL,\r\n    end_date DATE, -- NULL means currently paused\r\n    notes TEXT,\r\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL\r\n);\r\n\r\n-- Enable RLS\r\nALTER TABLE public.subscription_pauses ENABLE ROW LEVEL SECURITY;\r\n\r\n-- Create policies (assuming public access for now as per other tables in this project context, or authenticated)\r\n-- Checking other tables policy is good practice, but for now we follow the pattern of loose permissions or anon access if that's what's valid, \r\n-- but ideally we should be secure. Given the context (local dev, Supabase), let's create a policy that allows all for anon/service_role if that's the established pattern, \r\n-- OR just basic authenticated. \r\n-- Looking at previous files, I don't see explicit policy creation, so I'll create a basic one to avoid access errors.\r\n\r\nCREATE POLICY \"Enable read access for all users\" ON public.subscription_pauses FOR SELECT USING (true);\r\nCREATE POLICY \"Enable insert access for all users\" ON public.subscription_pauses FOR INSERT WITH CHECK (true);\r\nCREATE POLICY \"Enable update access for all users\" ON public.subscription_pauses FOR UPDATE USING (true);\r\nCREATE POLICY \"Enable delete access for all users\" ON public.subscription_pauses FOR DELETE USING (true);\r\n\r\n-- Refresh schema cache\r\nNOTIFY pgrst, 'reload config';\r\n"},{"path":"package.json","content":"{\n  \"name\": \"nutri-crm\",\n  \"private\": true,\n  \"version\": \"0.0.0\",\n  \"type\": \"module\",\n  \"scripts\": {\n    \"dev\": \"vite\",\n    \"build\": \"vite build\",\n    \"lint\": \"eslint .\",\n    \"preview\": \"vite preview\"\n  },\n  \"dependencies\": {\n    \"@supabase/supabase-js\": \"^2.94.0\",\n    \"chart.js\": \"^4.5.1\",\n    \"clsx\": \"^2.1.1\",\n    \"date-fns\": \"^4.1.0\",\n    \"html2canvas\": \"^1.4.1\",\n    \"jspdf\": \"^2.5.2\",\n    \"jspdf-autotable\": \"^3.8.4\",\n    \"lucide-react\": \"^0.563.0\",\n    \"react\": \"^19.2.0\",\n    \"react-chartjs-2\": \"^5.3.1\",\n    \"react-dom\": \"^19.2.0\",\n    \"react-router-dom\": \"^7.13.0\",\n    \"tailwind-merge\": \"^3.4.0\"\n  },\n  \"devDependencies\": {\n    \"@eslint/js\": \"^9.39.1\",\n    \"@types/react\": \"^19.2.5\",\n    \"@types/react-dom\": \"^19.2.3\",\n    \"@vitejs/plugin-react\": \"^5.1.1\",\n    \"autoprefixer\": \"^10.4.24\",\n    \"dotenv\": \"^17.2.4\",\n    \"eslint\": \"^9.39.1\",\n    \"eslint-plugin-react-hooks\": \"^7.0.1\",\n    \"eslint-plugin-react-refresh\": \"^0.4.24\",\n    \"globals\": \"^16.5.0\",\n    \"postcss\": \"^8.5.6\",\n    \"tailwindcss\": \"^3.4.17\",\n    \"vite\": \"^7.2.4\"\n  }\n}\n"},{"path":"postcss.config.cjs","content":"module.exports = {\r\n    plugins: {\r\n        tailwindcss: {},\r\n        autoprefixer: {},\r\n    },\r\n}\r\n"},{"path":"README.md","content":"# React + Vite\n\nThis template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.\n\nCurrently, two official plugins are available:\n\n- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh\n- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh\n\n## React Compiler\n\nThe React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).\n\n## Expanding the ESLint configuration\n\nIf you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.\n"},{"path":"refresh_schema.sql","content":"-- 1. Force Supabase/PostgREST to refresh its schema cache\r\nNOTIFY pgrst, 'reload config';\r\n\r\n-- 2. Check if the column actually exists\r\nSELECT column_name \r\nFROM information_schema.columns \r\nWHERE table_name = 'payments' \r\nAND column_name = 'payment_rate_id';\r\n"},{"path":"repair_angel_history.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\nimport { addDays, parseISO, format, addMonths } from 'date-fns';\r\n\r\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\nconst envConfig = fs.readFileSync(envPath, 'utf8');\r\nconst env = {};\r\nenvConfig.split('\\n').forEach(line => {\r\n    const [key, value] = line.split('=');\r\n    if (key && value) env[key.trim()] = value.trim();\r\n});\r\n\r\nconst supabaseUrl = env.VITE_SUPABASE_URL;\r\nconst supabaseKey = env.VITE_SUPABASE_KEY;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nconst ANGEL_ID = \"ecdaeee4-4f23-479a-a9af-59346c40966e\";\r\n\r\nasync function repairAngel() {\r\n    console.log('Fetching Angel subscriptions...');\r\n\r\n    const { data: subs, error } = await supabase\r\n        .from('patient_subscriptions')\r\n        .select('*')\r\n        .eq('patient_id', ANGEL_ID)\r\n        .order('start_date', { ascending: false });\r\n\r\n    if (error) {\r\n        console.error('Error:', error);\r\n        return;\r\n    }\r\n\r\n    // Assume the first one is the active one (Dec 14 - Jan 28)\r\n    const activeSub = subs[0];\r\n    console.log(`Active sub: ${activeSub.start_date} -> ${activeSub.end_date} (Status: ${activeSub.status})`);\r\n\r\n    // The rest are past subscriptions. Fix them.\r\n    const pastSubs = subs.slice(1);\r\n\r\n    for (const sub of pastSubs) {\r\n        const startDate = parseISO(sub.start_date);\r\n        // Calculate expected end date (1 month duration)\r\n        // Using addMonths to be cleaner, or just fix to the start of the next one?\r\n        // In the list, the \"previous\" one in iteration is actually the \"next\" one in time (since sorted desc).\r\n        // But here we are iterating descending.\r\n        // So 'sub' is OLDER than 'activeSub'.\r\n\r\n        // Let's just set it to start_date + 30 days for simplicity, or 1 month.\r\n        const expectedEnd = addMonths(startDate, 1);\r\n        const expectedEndStr = format(expectedEnd, 'yyyy-MM-dd');\r\n\r\n        if (sub.end_date !== expectedEndStr) {\r\n            console.log(`Fixing sub ${sub.id} (${sub.start_date}): ${sub.end_date} -> ${expectedEndStr}`);\r\n\r\n            const { error: updateError } = await supabase\r\n                .from('patient_subscriptions')\r\n                .update({\r\n                    end_date: expectedEndStr,\r\n                    status: 'expired' // Ensure it's expired\r\n                })\r\n                .eq('id', sub.id);\r\n\r\n            if (updateError) console.error('Update error:', updateError);\r\n        }\r\n    }\r\n    console.log('Repair complete.');\r\n}\r\n\r\nrepairAngel();\r\n"},{"path":"tailwind.config.js","content":"/** @type {import('tailwindcss').Config} */\r\nexport default {\r\n    darkMode: 'class',\r\n    content: [\r\n        \"./index.html\",\r\n        \"./src/**/*.{js,ts,jsx,tsx}\",\r\n    ],\r\n    theme: {\r\n        extend: {\r\n            fontFamily: {\r\n                sans: ['Inter', 'system-ui', 'sans-serif'],\r\n                display: ['Plus Jakarta Sans', 'system-ui', 'sans-serif'],\r\n            },\r\n            colors: {\r\n                // Mapping the Green Brand Colors to 'primary'\r\n                primary: {\r\n                    50: '#f4fcf8',\r\n                    100: '#e3f6ed',\r\n                    200: '#c6ebd9',\r\n                    300: '#9adbbd',\r\n                    400: '#66c29b',\r\n                    500: '#3ea07a',\r\n                    600: '#2b8462',\r\n                    700: '#28483a', // Brand Base\r\n                    800: '#225142',\r\n                    900: '#1e4338',\r\n                    950: '#0f2720',\r\n                },\r\n                secondary: {\r\n                    DEFAULT: '#d09a84', // Keeping the secondary earth tone\r\n                    50: '#fbf6f4',\r\n                    100: '#f5ebe7',\r\n                    200: '#ebd6cd',\r\n                    300: '#dfc0b3',\r\n                    400: '#d09a84',\r\n                    500: '#bf7d64',\r\n                    600: '#a6624a',\r\n                    700: '#8a4f3b',\r\n                    800: '#734335',\r\n                    900: '#603a30',\r\n                }\r\n            }\r\n        },\r\n    },\r\n    plugins: [],\r\n}\r\n"},{"path":"test_connection.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\n\r\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\nconst envConfig = fs.readFileSync(envPath, 'utf8');\r\nconst env = {};\r\nenvConfig.split('\\n').forEach(line => {\r\n    const [key, value] = line.split('=');\r\n    if (key && value) env[key.trim()] = value.trim();\r\n});\r\n\r\nconst supabaseUrl = env.VITE_SUPABASE_URL;\r\nconst supabaseKey = env.VITE_SUPABASE_KEY;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function test() {\r\n    console.log('Testing connection...');\r\n    const { count, error } = await supabase\r\n        .from('patients')\r\n        .select('*', { count: 'exact', head: true });\r\n\r\n    if (error) {\r\n        console.error('Error:', error.message);\r\n    } else {\r\n        console.log('Total patients:', count);\r\n    }\r\n\r\n    const { data, error: dataError } = await supabase\r\n        .from('patients')\r\n        .select('id, first_name, last_name, subscription_end');\r\n\r\n    if (dataError) {\r\n        console.error('Search Error:', dataError.message);\r\n    } else {\r\n        fs.writeFileSync('patients_dump.json', JSON.stringify(data, null, 2));\r\n        console.log('Data written to patients_dump.json');\r\n    }\r\n}\r\n\r\ntest();\r\n"},{"path":"test_db_update.sql","content":"-- 1. Pick a patient (any one)\r\nDO $$\r\nDECLARE\r\n    v_patient_id uuid;\r\nBEGIN\r\n    SELECT id INTO v_patient_id FROM patients LIMIT 1;\r\n    \r\n    RAISE NOTICE 'Testing update on patient %', v_patient_id;\r\n\r\n    -- 2. Try to update\r\n    UPDATE patients \r\n    SET payment_category_id = 'online' \r\n    WHERE id = v_patient_id;\r\n\r\n    -- 3. Verify\r\n    IF EXISTS (SELECT 1 FROM patients WHERE id = v_patient_id AND payment_category_id = 'online') THEN\r\n        RAISE NOTICE 'SUCCESS: Update worked via SQL.';\r\n    ELSE\r\n        RAISE NOTICE 'FAILURE: Update did NOT work via SQL.';\r\n    END IF;\r\nEND $$;\r\n"},{"path":"update_payment_function_v2.sql","content":"-- Función Actualizada: Registrar pagos incluso si no existe el paciente\r\nCREATE OR REPLACE FUNCTION register_payment_by_email(\r\n    p_email TEXT,\r\n    p_amount NUMERIC,\r\n    p_date DATE,\r\n    p_concept TEXT DEFAULT 'Mensualidad Stripe'\r\n)\r\nRETURNS JSON\r\nLANGUAGE plpgsql\r\nSECURITY DEFINER\r\nAS $$\r\nDECLARE\r\n    v_patient_id UUID;\r\n    v_patient_name TEXT;\r\n    v_payment_id UUID;\r\n    v_message TEXT;\r\nBEGIN\r\n    -- 1. Buscar Paciente\r\n    SELECT id, first_name || ' ' || last_name\r\n    INTO v_patient_id, v_patient_name\r\n    FROM patients\r\n    WHERE email ILIKE p_email\r\n    LIMIT 1;\r\n\r\n    -- 2. Definir estado\r\n    IF v_patient_id IS NULL THEN\r\n        v_message := 'Pago registrado sin asignar (email no encontrado: ' || p_email || ')';\r\n        v_patient_name := 'Cliente Desconocido';\r\n    ELSE\r\n        v_message := 'Pago registrado correctamente';\r\n    END IF;\r\n\r\n    -- 3. Insertar Pago (patient_id será NULL si no se encontró)\r\n    INSERT INTO payments (\r\n        patient_id, date, amount, payment_method, concept, status, created_at\r\n    ) VALUES (\r\n        v_patient_id, p_date, p_amount, 'Stripe', p_concept, 'pagado', NOW()\r\n    ) RETURNING id INTO v_payment_id;\r\n\r\n    -- 4. Devolver Éxito (siempre true, para que n8n no falle)\r\n    RETURN json_build_object(\r\n        'success', true,\r\n        'patient_found', (v_patient_id IS NOT NULL),\r\n        'patient_name', v_patient_name,\r\n        'payment_id', v_payment_id,\r\n        'message', v_message\r\n    );\r\nEXCEPTION WHEN OTHERS THEN\r\n    RETURN json_build_object(\r\n        'success', false,\r\n        'message', SQLERRM\r\n    );\r\nEND;\r\n$$;\r\n"},{"path":"vite.config.js","content":"import { defineConfig } from 'vite'\nimport react from '@vitejs/plugin-react'\n\n// https://vite.dev/config/\nexport default defineConfig({\n  plugins: [react()],\n})\n"},{"path":"public/vite.svg","content":"<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--logos\" width=\"31.88\" height=\"32\" preserveAspectRatio=\"xMidYMid meet\" viewBox=\"0 0 256 257\"><defs><linearGradient id=\"IconifyId1813088fe1fbc01fb466\" x1=\"-.828%\" x2=\"57.636%\" y1=\"7.652%\" y2=\"78.411%\"><stop offset=\"0%\" stop-color=\"#41D1FF\"></stop><stop offset=\"100%\" stop-color=\"#BD34FE\"></stop></linearGradient><linearGradient id=\"IconifyId1813088fe1fbc01fb467\" x1=\"43.376%\" x2=\"50.316%\" y1=\"2.242%\" y2=\"89.03%\"><stop offset=\"0%\" stop-color=\"#FFEA83\"></stop><stop offset=\"8.333%\" stop-color=\"#FFDD35\"></stop><stop offset=\"100%\" stop-color=\"#FFA800\"></stop></linearGradient></defs><path fill=\"url(#IconifyId1813088fe1fbc01fb466)\" d=\"M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z\"></path><path fill=\"url(#IconifyId1813088fe1fbc01fb467)\" d=\"M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z\"></path></svg>"},{"path":"src/App.jsx","content":"import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';\nimport { DataProvider } from './context/DataContext';\nimport Layout from './components/Layout';\nimport Dashboard from './components/Dashboard';\nimport PatientList from './components/Patients/PatientList';\nimport PatientForm from './components/Patients/PatientForm';\nimport PatientDetail from './components/Patients/PatientDetail';\nimport Renewals from './components/Renewals/Renewals';\n\nimport Settings from './components/Settings/Settings';\nimport Statistics from './components/Settings/Statistics';\nimport TrackingCalendar from './components/Tracking/TrackingCalendar';\nimport Tasks from './components/Tasks/Tasks';\nimport Payments from './components/Payments/Payments';\nimport Team from './components/Team/Team';\n\nfunction App() {\n  return (\n    <DataProvider>\n      <Router>\n        <Routes>\n          <Route path=\"/\" element={<Layout />}>\n            <Route index element={<Dashboard />} />\n            <Route path=\"patients\" element={<PatientList />} />\n            <Route path=\"patients/new\" element={<PatientForm />} />\n            <Route path=\"patients/:id\" element={<PatientDetail />} />\n            <Route path=\"patients/:id/edit\" element={<PatientForm />} />\n            <Route path=\"tracking\" element={<TrackingCalendar />} />\n            <Route path=\"tasks\" element={<Tasks />} />\n            <Route path=\"renewals\" element={<Renewals />} />\n            <Route path=\"payments\" element={<Payments />} />\n            <Route path=\"team\" element={<Team />} />\n\n            <Route path=\"statistics\" element={<Statistics />} />\n            <Route path=\"settings\" element={<Settings />} />\n            <Route path=\"*\" element={<Navigate to=\"/\" replace />} />\n          </Route>\n        </Routes>\n      </Router>\n    </DataProvider>\n  );\n}\n\nexport default App;\n"},{"path":"src/index.css","content":"@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap');\n\n@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n@layer base {\n  body {\n    @apply bg-slate-50 text-slate-900 transition-colors duration-300 font-sans antialiased;\n  }\n\n  h1,\n  h2,\n  h3,\n  h4,\n  h5,\n  h6 {\n    @apply font-display tracking-tight text-slate-900;\n  }\n}\n\n/* Custom scrollbar for tables from Aldase */\n@layer utilities {\n  .scrollbar-thin::-webkit-scrollbar {\n    width: 6px;\n    height: 6px;\n  }\n\n  .scrollbar-thin::-webkit-scrollbar-track {\n    background: transparent;\n  }\n\n  .scrollbar-thin::-webkit-scrollbar-thumb {\n    background-color: #cbd5e1;\n    border-radius: 20px;\n  }\n}\n\n/* \n   LEGACY MAPPING \n   Mapping old CSS classes to Tailwind Utility Components \n   so we don't have to rewrite every single page file immediately.\n*/\n@layer components {\n\n  /* Layout Helpers */\n  .dashboard-container {\n    @apply max-w-7xl mx-auto;\n  }\n\n  .dashboard-header {\n    @apply flex justify-between items-center mb-8;\n  }\n\n  .page-title {\n    @apply text-3xl font-bold text-slate-900 mb-1 dark:text-slate-100;\n  }\n\n  .page-subtitle {\n    @apply text-slate-500 text-sm dark:text-slate-400;\n  }\n\n  /* Cards */\n  .card {\n    @apply bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-6 dark:bg-slate-800 dark:border-slate-700;\n  }\n\n  .card-header {\n    @apply flex justify-between items-center mb-6;\n  }\n\n  /* Buttons */\n  .btn {\n    @apply inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed;\n  }\n\n  .btn-primary {\n    @apply bg-primary-700 hover:bg-primary-800 text-white shadow-md shadow-primary-900/10 focus:ring-primary-600;\n  }\n\n  .btn-outline {\n    @apply border border-slate-200 bg-transparent hover:bg-slate-50 text-slate-700 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800;\n  }\n\n  .btn-ghost {\n    @apply bg-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-slate-200 dark:hover:bg-slate-800;\n  }\n\n  .btn-sm {\n    @apply px-3 py-1.5 text-sm;\n  }\n\n  /* Forms */\n  .form-input,\n  .form-select,\n  .form-textarea {\n    @apply w-full px-4 py-2 rounded-lg border border-slate-300 bg-white text-slate-900 caret-slate-900 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all duration-200 text-sm dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100 dark:caret-slate-100;\n  }\n\n  .form-group {\n    @apply mb-4;\n  }\n\n  .form-label {\n    @apply block text-sm font-medium text-slate-700 mb-1.5;\n  }\n\n  /* Badges */\n  .badge {\n    @apply px-2.5 py-0.5 rounded-full text-xs font-bold whitespace-nowrap;\n  }\n\n  .badge-active {\n    @apply bg-green-100 text-green-800;\n  }\n\n  .badge-expired {\n    @apply bg-red-100 text-red-800;\n  }\n\n  .badge-warning {\n    @apply bg-amber-100 text-amber-800;\n  }\n\n  .badge-success {\n    @apply bg-green-100 text-green-800;\n  }\n\n  /* Tables */\n  .data-table {\n    @apply w-full border-collapse text-left text-sm;\n  }\n\n  .data-table th {\n    @apply font-semibold text-slate-500 border-b border-slate-200 pb-3 px-4 uppercase text-xs tracking-wider dark:text-slate-400 dark:border-slate-700;\n  }\n\n  .data-table td {\n    @apply py-3 px-4 border-b border-slate-100 text-slate-700 dark:border-slate-800 dark:text-slate-300;\n  }\n\n  .data-table tr:hover td {\n    @apply bg-primary-50 cursor-default dark:bg-slate-800/50;\n  }\n\n  .profile-initials {\n    @apply flex items-center justify-center rounded-full bg-primary-700 text-white font-bold text-xs;\n  }\n}"},{"path":"src/main.jsx","content":"import { StrictMode } from 'react'\nimport { createRoot } from 'react-dom/client'\nimport './index.css'\nimport App from './App.jsx'\nimport { ThemeProvider } from './context/ThemeContext.jsx'\n\ncreateRoot(document.getElementById('root')).render(\n  <StrictMode>\n    <ThemeProvider defaultTheme=\"light\" storageKey=\"nutri-crm-theme\">\n      <App />\n    </ThemeProvider>\n  </StrictMode>,\n)\n"},{"path":"src/supabaseClient.js","content":"import { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\r\nconst supabaseKey = import.meta.env.VITE_SUPABASE_KEY;\r\n\r\nexport const supabase = createClient(supabaseUrl, supabaseKey);\r\n"},{"path":"src/assets/react.svg","content":"<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--logos\" width=\"35.93\" height=\"32\" preserveAspectRatio=\"xMidYMid meet\" viewBox=\"0 0 256 228\"><path fill=\"#00D8FF\" d=\"M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z\"></path></svg>"},{"path":"src/components/Dashboard.jsx","content":"import { useMemo } from 'react';\r\nimport { useData } from '../context/DataContext';\r\nimport { Users, Clock, AlertTriangle, Plus, ChevronDown, MoreVertical, Search, Filter, TrendingUp, TrendingDown, CheckSquare, Square } from 'lucide-react';\r\nimport { Link, useNavigate } from 'react-router-dom';\r\nimport { addDays, isBefore, parseISO, isSameDay, format } from 'date-fns';\r\n\r\nconst MetricItem = ({ title, value, change, isPositive }) => (\r\n    <div className=\"flex flex-col p-4 bg-slate-50 rounded-lg border border-slate-100 dark:bg-slate-800 dark:border-slate-700\">\r\n        <span className=\"text-sm text-slate-500 font-medium mb-1 dark:text-slate-400\">{title}</span>\r\n        <div className=\"flex items-end justify-between\">\r\n            <span className=\"text-2xl font-bold text-slate-800 dark:text-slate-100\">{value}</span>\r\n            {change && (\r\n                <span className={`flex items-center text-xs font-bold px-1.5 py-0.5 rounded ${isPositive ? 'text-green-700 bg-green-100' : 'text-red-700 bg-red-100'}`}>\r\n                    {isPositive ? <TrendingUp size={12} className=\"mr-1\" /> : <TrendingDown size={12} className=\"mr-1\" />}\r\n                    {change}\r\n                </span>\r\n            )}\r\n        </div>\r\n    </div>\r\n);\r\n\r\nconst Dashboard = () => {\r\n    const { patients, tasks, updateTask, reviews } = useData();\r\n    const navigate = useNavigate();\r\n\r\n    // Memoized calculations\r\n    const { activePatients, pendingRenewals, expiredPlans, marketingCount } = useMemo(() => {\r\n        const today = new Date();\r\n        const warningDate = addDays(today, 7);\r\n\r\n        const pending = patients.filter(p => {\r\n            if (!p.subscription?.endDate) return false;\r\n            const end = parseISO(p.subscription.endDate);\r\n            return isBefore(end, warningDate) && !isBefore(end, today);\r\n        }).length;\r\n\r\n        const expired = patients.filter(p => {\r\n            if (!p.subscription?.endDate) return false;\r\n            const end = parseISO(p.subscription.endDate);\r\n            return isBefore(end, today);\r\n        }).length;\r\n\r\n        return {\r\n            activePatients: patients.length,\r\n            pendingRenewals: pending,\r\n            expiredPlans: expired\r\n        };\r\n\r\n    }, [patients]);\r\n\r\n    // Calculate Today's Reviews\r\n    const todaysReviews = useMemo(() => {\r\n        const today = new Date();\r\n        return patients.flatMap(patient => {\r\n            if (!patient.subscription?.startDate) return [];\r\n            if (patient.subscription?.status === 'paused') return [];\r\n\r\n            const start = parseISO(patient.subscription.startDate);\r\n            const end = patient.subscription.endDate ? parseISO(patient.subscription.endDate) : addDays(start, 30);\r\n\r\n            // Check specific review dates\r\n            let reviewDate = addDays(start, 7);\r\n            const patientReviews = [];\r\n\r\n            while (reviewDate <= end) {\r\n                if (isSameDay(reviewDate, today)) {\r\n                    const reviewId = `review_${patient.id}_${format(reviewDate, 'yyyy-MM-dd')}`;\r\n                    const isCompleted = reviews?.[reviewId]?.completed || false;\r\n\r\n                    patientReviews.push({\r\n                        patientName: patient.name,\r\n                        patientId: patient.id,\r\n                        date: reviewDate,\r\n                        id: reviewId,\r\n                        completed: isCompleted\r\n                    });\r\n                }\r\n                reviewDate = addDays(reviewDate, 7);\r\n            }\r\n            return patientReviews;\r\n        });\r\n    }, [patients, reviews]);\r\n\r\n    return (\r\n        <div className=\"dashboard-container\">\r\n            {/* Header Section */}\r\n            <div className=\"dashboard-header\">\r\n                <div>\r\n                    <h1 className=\"page-title\">Dashboard</h1>\r\n                    <p className=\"page-subtitle\">Bienvenida, aquí tienes el resumen de tu consulta.</p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main Performance Card */}\r\n            <div className=\"card performance-card\">\r\n                <div className=\"card-header\">\r\n                    <div>\r\n                        <h2 className=\"card-title text-lg font-bold text-slate-800 dark:text-slate-100\">Rendimiento General</h2>\r\n                        <p className=\"card-subtitle text-sm text-slate-500 dark:text-slate-400\">{new Date().toLocaleDateString('es-ES', { dateStyle: 'long' })}</p>\r\n                    </div>\r\n                    <div className=\"card-actions flex gap-2\">\r\n                        <button className=\"btn btn-outline btn-sm\">\r\n                            <Filter size={14} className=\"mr-1\" /> Filtrar\r\n                        </button>\r\n                        <button className=\"btn btn-ghost btn-sm p-1\"><MoreVertical size={16} /></button>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-4\">\r\n                    <MetricItem\r\n                        title=\"Clientes Activos\"\r\n                        value={activePatients}\r\n                        change=\"+12%\"\r\n                        isPositive={true}\r\n                    />\r\n                    <MetricItem\r\n                        title=\"Renovaciones (7d)\"\r\n                        value={pendingRenewals}\r\n                        change={pendingRenewals > 0 ? \"Atención\" : \"Estable\"}\r\n                        isPositive={pendingRenewals === 0}\r\n                    />\r\n\r\n                    <MetricItem\r\n                        title=\"Planes Vencidos\"\r\n                        value={expiredPlans}\r\n                        change={expiredPlans > 0 ? \"-2%\" : \"0%\"}\r\n                        isPositive={expiredPlans === 0}\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                {/* Today's Reviews Section - New */}\r\n                <div className=\"card lg:col-span-2\">\r\n                    <div className=\"card-header border-b border-slate-100 pb-3 mb-3\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <div className=\"p-2 bg-primary-100 text-primary-600 rounded-lg\">\r\n                                <CheckSquare size={20} />\r\n                            </div>\r\n                            <div>\r\n                                <h3 className=\"card-title font-bold text-slate-800 dark:text-slate-100\">Revisiones de Hoy</h3>\r\n                                <p className=\"text-xs text-slate-500\">Pacientes que requieren seguimiento este {new Date().toLocaleDateString('es-ES', { weekday: 'long' })}</p>\r\n                            </div>\r\n                        </div>\r\n                        <Link to=\"/calendar\" className=\"btn btn-ghost btn-sm text-primary-600 font-medium\">Ver Calendario</Link>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-3\">\r\n                        {todaysReviews.length > 0 ? (\r\n                            todaysReviews.map((review, idx) => (\r\n                                <div key={idx} className=\"flex justify-between items-center p-4 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl shadow-sm hover:border-primary-200 transition-colors\">\r\n                                    <div className=\"flex items-center gap-4\">\r\n                                        <div className=\"w-10 h-10 rounded-full bg-primary-50 flex items-center justify-center text-primary-700 font-bold border border-primary-100\">\r\n                                            {review.patientName.charAt(0)}\r\n                                        </div>\r\n                                        <div>\r\n                                            <h4 className=\"font-bold text-slate-800 dark:text-slate-100\">{review.patientName}</h4>\r\n                                            <p className=\"text-xs text-slate-500\">Revisión Semanal</p>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-3\">\r\n                                        {review.completed ? (\r\n                                            <span className=\"badge badge-success flex items-center gap-1\">\r\n                                                <CheckSquare size={14} /> Completada\r\n                                            </span>\r\n                                        ) : (\r\n                                            <span className=\"badge bg-amber-100 text-amber-700 flex items-center gap-1\">\r\n                                                <Clock size={14} /> Pendiente\r\n                                            </span>\r\n                                        )}\r\n                                        <button\r\n                                            onClick={() => navigate(`/patients/${review.patientId}`)}\r\n                                            className=\"btn btn-sm btn-outline\"\r\n                                        >\r\n                                            Ver Perfil\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            ))\r\n                        ) : (\r\n                            <div className=\"text-center py-8 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-dashed border-slate-200 dark:border-slate-700\">\r\n                                <CheckSquare size={32} className=\"mx-auto text-slate-300 mb-2\" />\r\n                                <p className=\"text-slate-500 font-medium\">¡No hay revisiones programadas para hoy!</p>\r\n                                <p className=\"text-xs text-slate-400 mt-1\">Disfruta de tu día libre de seguimientos.</p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n\r\n\r\n                {/* Renewals Mini View */}\r\n                <div className=\"card\">\r\n                    <div className=\"card-header\">\r\n                        <h3 className=\"card-title font-bold text-slate-800 dark:text-slate-100\">Renovaciones</h3>\r\n                        <div className=\"card-actions\">\r\n                            <button className=\"btn-ghost btn-sm p-1\"><ChevronDown size={16} /></button>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex justify-between mb-6\">\r\n                        {['L', 'M', 'X', 'J', 'V', 'S', 'D'].map((d, i) => (\r\n                            <div key={i} className={`flex flex-col items-center p-1 rounded-md ${i === 3 ? 'bg-primary-50 text-primary-700' : 'text-slate-400'}`}>\r\n                                <span className=\"text-xs font-bold\">{d}</span>\r\n                                <span className=\"text-sm font-medium\">{15 + i}</span>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                    <div className=\"bg-amber-50 border border-amber-100 rounded-lg p-4 dark:bg-amber-900/10 dark:border-amber-900/30\">\r\n                        <h4 className=\"flex items-center gap-2 text-amber-800 font-bold text-sm mb-1 dark:text-amber-500\">\r\n                            <AlertTriangle size={14} /> Revisión de Planes\r\n                        </h4>\r\n                        <p className=\"text-xs text-amber-700 dark:text-amber-400\">Revisar los {pendingRenewals} planes próximos a vencer.</p>\r\n                    </div>\r\n                </div>\r\n\r\n\r\n                {/* Tasks Mini View */}\r\n                <div className=\"card\">\r\n                    <div className=\"card-header\">\r\n                        <h3 className=\"card-title font-bold text-slate-800 dark:text-slate-100\">Tareas Pendientes</h3>\r\n                        <div className=\"card-actions\">\r\n                            <Link to=\"/tasks\" className=\"btn btn-ghost btn-sm p-1 text-primary-600 font-bold text-xs uppercase hover:underline\">Ver todas</Link>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-3\">\r\n                        {tasks.filter(t => !t.completed).slice(0, 5).map(task => (\r\n                            <div key={task.id} className=\"flex items-start gap-3 group\">\r\n                                <button\r\n                                    onClick={() => updateTask(task.id, { completed: !task.completed })}\r\n                                    className=\"mt-0.5 text-slate-300 hover:text-primary-500 transition-colors\"\r\n                                >\r\n                                    <Square size={18} />\r\n                                </button>\r\n                                <span className=\"text-sm text-slate-700 font-medium leading-tight group-hover:text-primary-700 transition-colors dark:text-slate-300 dark:group-hover:text-primary-400\">\r\n                                    {task.title}\r\n                                </span>\r\n                            </div>\r\n                        ))}\r\n\r\n                        {tasks.filter(t => !t.completed).length === 0 && (\r\n                            <div className=\"text-center py-6 text-slate-400\">\r\n                                <CheckSquare size={32} className=\"mx-auto mb-2 opacity-20\" />\r\n                                <p className=\"text-xs\">¡Todo al día!</p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div className=\"mt-4 pt-3 border-t border-slate-50 dark:border-slate-800\">\r\n                        <Link to=\"/tasks\" className=\"btn btn-outline btn-sm w-full gap-2 text-slate-500 dark:text-slate-400\">\r\n                            <Plus size={14} /> Añadir Tarea\r\n                        </Link>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Dashboard;\r\n"},{"path":"src/components/Layout.jsx","content":"import { Outlet, useLocation, Link } from 'react-router-dom';\r\nimport {\r\n    LayoutDashboard,\r\n    Users,\r\n    CalendarDays,\r\n\r\n    Settings,\r\n    LogOut,\r\n    Menu,\r\n    X,\r\n    UserCircle,\r\n    Activity,\r\n    Repeat,\r\n    PieChart,\r\n    ClipboardList,\r\n    Wallet\r\n} from 'lucide-react';\r\nimport { UsersRound } from 'lucide-react';\r\nimport { useState } from 'react';\r\nimport { cn } from '../utils/cn';\r\nimport { ThemeToggle } from './ThemeToggle.jsx';\r\n\r\n// Sidebar Item Component\r\n// eslint-disable-next-line no-unused-vars\r\nconst SidebarItem = ({ icon: Icon, label, path, active }) => (\r\n    <Link\r\n        to={path}\r\n        className={cn(\r\n            \"flex items-center space-x-3 px-3 py-2 rounded-lg transition-colors mb-1\",\r\n            active\r\n                ? \"bg-primary-50 text-primary-700 font-medium dark:bg-primary-900/20 dark:text-primary-400\"\r\n                : \"text-slate-600 hover:bg-slate-100 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-50\"\r\n        )}\r\n    >\r\n        <Icon className=\"w-5 h-5\" />\r\n        <span>{label}</span>\r\n    </Link>\r\n);\r\n\r\nconst Sidebar = ({ isOpen, onClose }) => {\r\n    const location = useLocation();\r\n\r\n    // Adapted Navigation Items for Nutri CRM\r\n    const navItems = [\r\n        { icon: LayoutDashboard, label: 'Dashboard', path: '/' },\r\n        { icon: Users, label: 'Clientes', path: '/patients' },\r\n        { icon: UsersRound, label: 'Equipo', path: '/team' },\r\n        { icon: Activity, label: 'Seguimiento', path: '/tracking' },\r\n        { icon: Repeat, label: 'Renovaciones', path: '/renewals' },\r\n        { icon: ClipboardList, label: 'Tareas', path: '/tasks' },\r\n\r\n        { icon: Wallet, label: 'Pagos', path: '/payments' },\r\n\r\n        { icon: PieChart, label: 'Estadísticas', path: '/statistics' },\r\n        { icon: CalendarDays, label: 'Calendario', path: '/calendar' }, // Future feature?\r\n        { icon: Settings, label: 'Configuración', path: '/settings' },\r\n    ];\r\n\r\n    // Handle Closing on Mobile Navigation\r\n    const handleNavClick = () => {\r\n        if (window.innerWidth < 768) {\r\n            onClose();\r\n        }\r\n    };\r\n\r\n    return (\r\n        <>\r\n            {/* Mobile Overlay */}\r\n            {isOpen && (\r\n                <div\r\n                    className=\"fixed inset-0 bg-black/50 z-20 md:hidden transition-opacity\"\r\n                    onClick={onClose}\r\n                />\r\n            )}\r\n\r\n            {/* Sidebar */}\r\n            <div className={cn(\r\n                \"w-64 h-full bg-white border-r border-slate-200 flex flex-col fixed left-0 top-0 transition-transform duration-300 z-30 dark:bg-slate-900 dark:border-slate-800\",\r\n                isOpen ? \"translate-x-0\" : \"-translate-x-full md:translate-x-0\"\r\n            )}>\r\n                <div className=\"p-6 flex items-center justify-between border-b border-slate-100 dark:border-slate-800\">\r\n                    <div className=\"flex items-center justify-center flex-1\">\r\n                        <div className=\"flex flex-col items-center justify-center py-2\">\r\n                            <img src=\"/logo-rosa.png\" alt=\"NutriCRM Logo\" className=\"h-16 w-auto object-contain mb-2\" />\r\n                            <span className=\"text-sm font-bold text-primary-700 tracking-widest uppercase\">Iris Nutrición</span>\r\n                        </div>\r\n                    </div>\r\n                    <button onClick={onClose} className=\"md:hidden p-1 text-slate-500\">\r\n                        <X className=\"w-5 h-5\" />\r\n                    </button>\r\n                </div>\r\n\r\n                <nav className=\"flex-1 overflow-y-auto p-4\">\r\n                    {navItems.map((item) => (\r\n                        <div key={item.path} onClick={handleNavClick}>\r\n                            <SidebarItem\r\n                                icon={item.icon}\r\n                                label={item.label}\r\n                                path={item.path}\r\n                                active={location.pathname === item.path || (item.path !== '/' && location.pathname.startsWith(item.path))}\r\n                            />\r\n                        </div>\r\n                    ))}\r\n                </nav>\r\n\r\n                <div className=\"p-4 border-t border-slate-100 dark:border-slate-800\">\r\n                    <div className=\"flex items-center space-x-3 px-3 py-2\">\r\n                        <div className=\"bg-primary-100 p-2 rounded-full dark:bg-primary-900/30\">\r\n                            <UserCircle className=\"w-5 h-5 text-primary-600 dark:text-primary-400\" />\r\n                        </div>\r\n                        <div className=\"flex-1 min-w-0\">\r\n                            <p className=\"text-sm font-medium text-slate-900 truncate dark:text-slate-200\">Dra. Iris</p>\r\n                            <p className=\"text-xs text-slate-500 truncate capitalize dark:text-slate-400\">Nutricionista</p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </>\r\n    );\r\n};\r\n\r\nexport default function Layout() {\r\n    const [sidebarOpen, setSidebarOpen] = useState(false);\r\n\r\n    // Mock Logout\r\n    const handleLogout = () => {\r\n        console.log(\"Logout clicked\");\r\n        // Could implement real logout if needed\r\n    };\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-50 transition-colors duration-300 dark:bg-slate-950\">\r\n            <Sidebar isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)} />\r\n\r\n            <div className=\"md:pl-64 flex flex-col min-h-screen transition-all duration-300\">\r\n                <header className=\"h-16 bg-white border-b border-slate-200 flex items-center justify-between md:justify-end px-4 md:px-8 sticky top-0 z-10 transition-colors duration-300 gap-4 dark:bg-slate-900 dark:border-slate-800\">\r\n                    {/* Mobile Menu Button */}\r\n                    <button\r\n                        className=\"md:hidden p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg dark:text-slate-400 dark:hover:bg-slate-800\"\r\n                        onClick={() => setSidebarOpen(true)}\r\n                    >\r\n                        <Menu className=\"w-6 h-6\" />\r\n                    </button>\r\n\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <ThemeToggle />\r\n                        <div className=\"h-6 w-px bg-slate-200 dark:bg-slate-700\" aria-hidden=\"true\" />\r\n                        <button\r\n                            onClick={handleLogout}\r\n                            className=\"flex items-center space-x-2 text-sm text-slate-600 hover:text-red-600 transition-colors dark:text-slate-400 dark:hover:text-red-400\"\r\n                        >\r\n                            <LogOut className=\"w-4 h-4\" />\r\n                            <span className=\"hidden sm:inline\">Cerrar Sesión</span>\r\n                        </button>\r\n                    </div>\r\n                </header>\r\n                <main className=\"flex-1 p-4 md:p-8 overflow-x-hidden\">\r\n                    <Outlet />\r\n                </main>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n"},{"path":"src/components/ThemeToggle.jsx","content":"import { Moon, Sun } from \"lucide-react\";\r\nimport { useTheme } from \"../context/ThemeContext\";\r\n\r\nexport function ThemeToggle() {\r\n    const { setTheme, theme } = useTheme();\r\n\r\n    return (\r\n        <button\r\n            onClick={() => setTheme(theme === \"light\" ? \"dark\" : \"light\")}\r\n            title=\"Cambiar tema\"\r\n            className=\"relative inline-flex items-center justify-center p-2 rounded-lg text-slate-500 hover:bg-slate-100 hover:text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors\"\r\n        >\r\n            <Sun className=\"h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0\" />\r\n            <Moon className=\"absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100\" />\r\n            <span className=\"sr-only\">Cambiar tema</span>\r\n        </button>\r\n    );\r\n}\r\n"},{"path":"src/components/Patients/EditPauseModal.jsx","content":"import { useState, useEffect } from 'react';\r\nimport { X, Calendar, Save } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\n\r\nconst EditPauseModal = ({ isOpen, onClose, pause, patientName }) => {\r\n    const { updatePatientPause } = useData();\r\n    const [startDate, setStartDate] = useState('');\r\n    const [endDate, setEndDate] = useState('');\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    useEffect(() => {\r\n        console.log('EditPauseModal EFFECT. pause:', pause, 'isOpen:', isOpen);\r\n        if (pause) {\r\n            setStartDate(pause.start_date.split('T')[0]);\r\n            setEndDate(pause.end_date ? pause.end_date.split('T')[0] : '');\r\n        }\r\n    }, [pause, isOpen]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    // Fallback if pause is not yet loaded but modal is open\r\n    if (!pause) {\r\n        return (\r\n            <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\">\r\n                <div className=\"bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-sm p-6 text-center\">\r\n                    <p>Cargando datos de la pausa...</p>\r\n                    <button onClick={onClose} className=\"mt-4 btn btn-ghost btn-sm\">Cerrar</button>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n        setLoading(true);\r\n        try {\r\n            const updates = {\r\n                start_date: startDate,\r\n                end_date: endDate || null\r\n            };\r\n            await updatePatientPause(pause.id, updates);\r\n            onClose();\r\n        } catch (error) {\r\n            console.error(\"Error updating pause:\", error);\r\n            alert(\"Error al actualizar la pausa\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-sm overflow-hidden animate-fade-in\">\r\n                <div className=\"p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center\">\r\n                    <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">\r\n                        Editar Pausa\r\n                    </h3>\r\n                    <button onClick={onClose} className=\"text-slate-400 hover:text-slate-600 dark:hover:text-slate-200\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit} className=\"p-6 space-y-4\">\r\n                    <p className=\"text-sm text-slate-600 dark:text-slate-300\">\r\n                        Editando pausa de <strong>{patientName}</strong>.\r\n                    </p>\r\n\r\n                    <div>\r\n                        <label className=\"form-label flex items-center gap-2\">\r\n                            <Calendar size={16} /> Fecha de Inicio\r\n                        </label>\r\n                        <input\r\n                            type=\"date\"\r\n                            className=\"form-input\"\r\n                            value={startDate}\r\n                            onChange={e => setStartDate(e.target.value)}\r\n                            required\r\n                        />\r\n                    </div>\r\n\r\n                    <div>\r\n                        <label className=\"form-label flex items-center gap-2\">\r\n                            <Calendar size={16} /> Fecha de Fin\r\n                        </label>\r\n                        <input\r\n                            type=\"date\"\r\n                            className=\"form-input\"\r\n                            value={endDate}\r\n                            onChange={e => setEndDate(e.target.value)}\r\n                            placeholder=\"En curso\"\r\n                        />\r\n                        <p className=\"text-xs text-slate-500 mt-1\">Dejar vacío si la pausa sigue activa.</p>\r\n                    </div>\r\n\r\n                    <div className=\"pt-2 flex gap-3\">\r\n                        <button type=\"button\" onClick={onClose} className=\"btn btn-outline flex-1\">\r\n                            Cancelar\r\n                        </button>\r\n                        <button type=\"submit\" disabled={loading} className=\"btn btn-primary flex-1\">\r\n                            {loading ? 'Guardando...' : 'Guardar Cambios'}\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default EditPauseModal;\r\n"},{"path":"src/components/Patients/PatientDetail.jsx","content":"import { useState, useMemo } from 'react';\r\nimport { useParams, useNavigate } from 'react-router-dom';\r\nimport { useData } from '../../context/DataContext';\r\nimport { ArrowLeft, User, Activity, Image as ImageIcon, Wallet, Play, Clock, RefreshCw, Edit2, Trash2, Calendar as CalendarIcon, Copy } from 'lucide-react';\r\nimport { format, parseISO } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\n\r\nimport MeasurementModal from '../Tracking/MeasurementModal';\r\nimport PaymentModal from '../Payments/PaymentModal';\r\nimport RenewalModal from './RenewalModal';\r\nimport PlanStartModal from './PlanStartModal';\r\nimport PatientForm from './PatientForm';\r\nimport SubscriptionEditModal from './SubscriptionEditModal';\r\n\r\nimport { calculateSubscriptionTerms } from '../../utils/subscriptionUtils';\r\nimport { safeFormat } from '../../utils/dateUtils';\r\n\r\n// Tabs\r\nimport InformationTab from './Tabs/InformationTab';\r\nimport ReviewsTab from './Tabs/ReviewsTab';\r\nimport TrackingTab from './Tabs/TrackingTab';\r\nimport PhotosTab from './Tabs/PhotosTab';\r\nimport PaymentsTab from './Tabs/PaymentsTab';\r\n\r\n// Modals\r\nimport EditExtensionModal from './Modals/EditExtensionModal';\r\nimport ExtendSubscriptionModal from './Modals/ExtendSubscriptionModal';\r\nimport ExtensionHistoryModal from './Modals/ExtensionHistoryModal';\r\n\r\nconst PatientDetail = () => {\r\n    const { id } = useParams();\r\n    const navigate = useNavigate();\r\n    const { patients, deleteMeasurement, extendSubscription, loading: contextLoading, deletePatient, addMeasurement, updateMeasurement, payments = [], paymentMethods = [], paymentCategories = [], updateSubscriptionHistory, deleteSubscription, deletePayment, subscriptionExtensions = [], updateSubscriptionExtension, deleteSubscriptionExtension } = useData() || {};\r\n\r\n    // Modals State\r\n    const [isRenewalModalOpen, setIsRenewalModalOpen] = useState(false);\r\n    const [isPlanStartModalOpen, setIsPlanStartModalOpen] = useState(false);\r\n    const [activeTab, setActiveTab] = useState('info');\r\n    const [actionLoading, setActionLoading] = useState(false);\r\n\r\n    // Measurement Modal State\r\n    const [isMeasurementModalOpen, setIsMeasurementModalOpen] = useState(false);\r\n    const [editingMeasurement, setEditingMeasurement] = useState(null);\r\n\r\n    // Payment Modal State\r\n    const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);\r\n    const [editingPayment, setEditingPayment] = useState(null);\r\n\r\n    // Patient Form Modal State\r\n    const [isEditModalOpen, setIsEditModalOpen] = useState(false);\r\n    const [isSubscriptionEditModalOpen, setIsSubscriptionEditModalOpen] = useState(false);\r\n    const [subscriptionEditData, setSubscriptionEditData] = useState(null);\r\n\r\n    // Extend Subscription Modal State\r\n    const [isExtendModalOpen, setIsExtendModalOpen] = useState(false);\r\n    const [isExtensionHistoryModalOpen, setIsExtensionHistoryModalOpen] = useState(false);\r\n    const [isEditExtensionModalOpen, setIsEditExtensionModalOpen] = useState(false);\r\n    const [editingExtension, setEditingExtension] = useState(null);\r\n\r\n    const patient = (patients || []).find(p => String(p.id) === String(id));\r\n\r\n    const handleDeletePayment = async (paymentId) => {\r\n        if (window.confirm('¿Estás seguro de que deseas eliminar este pago? Esta acción no se puede deshacer.')) {\r\n            await deletePayment(paymentId);\r\n        }\r\n    };\r\n\r\n    const subscriptionTerms = useMemo(() => {\r\n        return calculateSubscriptionTerms(patient, payments);\r\n    }, [patient, payments]);\r\n\r\n    // Suggested Start Date for Renewals/New Plans\r\n    const suggestedStartDate = useMemo(() => {\r\n        if (!patient || !patient.subscriptionHistory || patient.subscriptionHistory.length === 0) {\r\n            return new Date().toISOString().split('T')[0];\r\n        }\r\n        const sortedHistory = [...patient.subscriptionHistory].sort((a, b) => {\r\n            const dateA = new Date(a.end_date || a.start_date);\r\n            const dateB = new Date(b.end_date || b.start_date);\r\n            return dateB - dateA;\r\n        });\r\n\r\n        const latestSub = sortedHistory[0];\r\n        if (!latestSub.end_date) return new Date().toISOString().split('T')[0];\r\n        const lastEnd = parseISO(latestSub.end_date);\r\n        return format(lastEnd, 'yyyy-MM-dd');\r\n    }, [patient]);\r\n\r\n\r\n    if (contextLoading || actionLoading) {\r\n        return (\r\n            <div className=\"dashboard-container flex items-center justify-center min-h-[400px]\">\r\n                <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600\"></div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!patient) {\r\n        return (\r\n            <div className=\"dashboard-container\">\r\n                <div className=\"text-center py-12\">\r\n                    <h2 className=\"text-2xl font-bold text-gray-800 dark:text-gray-200\">Cliente no encontrado</h2>\r\n                    <button onClick={() => navigate('/patients')} className=\"btn btn-primary mt-4\">\r\n                        <ArrowLeft size={16} /> Volver a la lista\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const handleExtendSubscription = async (days) => {\r\n        if (!days) return;\r\n        setActionLoading(true);\r\n        setIsExtendModalOpen(false);\r\n        const success = await extendSubscription(patient.id, days);\r\n        if (success) {\r\n            console.log(\"Subscription extended successfully\");\r\n        } else {\r\n            alert(\"Error al extender la suscripción\");\r\n        }\r\n        setActionLoading(false);\r\n    };\r\n\r\n    const handleSaveMeasurement = async (data) => {\r\n        setActionLoading(true);\r\n        try {\r\n            if (editingMeasurement) {\r\n                await updateMeasurement(editingMeasurement.id, patient.id, data);\r\n            } else {\r\n                await addMeasurement(patient.id, data);\r\n            }\r\n            setIsMeasurementModalOpen(false);\r\n            setEditingMeasurement(null);\r\n        } catch (error) {\r\n            console.error('Error saving measurement:', error);\r\n            alert('Error al guardar la medición');\r\n        } finally {\r\n            setActionLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleEditMeasurement = (measurement) => {\r\n        setEditingMeasurement(measurement);\r\n        setIsMeasurementModalOpen(true);\r\n    };\r\n\r\n    const handleEditSubscription = (data = null, isHistory = false) => {\r\n        if (data) {\r\n            setSubscriptionEditData(data);\r\n        } else {\r\n            const today = new Date().toISOString().split('T')[0];\r\n            const activeSub = patient.subscriptionHistory?.find(s =>\r\n                s.status === 'active' ||\r\n                (s.start_date <= today && (!s.end_date || s.end_date >= today))\r\n            );\r\n\r\n            if (activeSub) {\r\n                setSubscriptionEditData(activeSub);\r\n            } else {\r\n                setSubscriptionEditData(null);\r\n            }\r\n        }\r\n        setIsSubscriptionEditModalOpen(true);\r\n    };\r\n\r\n    const handleDelete = () => {\r\n        if (confirm('¿Seguro que deseas eliminar este cliente?')) {\r\n            deletePatient(id);\r\n            navigate('/patients');\r\n        }\r\n    };\r\n\r\n    // Helper for status badge\r\n    // (This logic might be duplicated in InformationTab, but needed here for header?\r\n    // Actually header uses payment category label, not subscription status directly, except for plan type)\r\n\r\n    return (\r\n        <div className=\"dashboard-container\">\r\n            {/* Header */}\r\n            <div className=\"dashboard-header mb-6\">\r\n                <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <button onClick={() => navigate('/patients')} className=\"btn btn-ghost btn-icon\">\r\n                            <ArrowLeft size={24} />\r\n                        </button>\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <div className=\"profile-initials text-white flex items-center justify-center rounded-full bg-primary font-bold shadow-lg shadow-primary/30\" style={{ width: '48px', height: '48px', fontSize: '1.25rem' }}>\r\n                                {(patient.name || 'C').charAt(0).toUpperCase()}\r\n                            </div>\r\n                            <div>\r\n                                <div className=\"flex flex-col\">\r\n                                    <div className=\"flex items-center gap-2 flex-wrap\">\r\n                                        <h1 className=\"text-2xl font-bold leading-tight dark:text-white\">\r\n                                            {patient.first_name || patient.name?.split(' ')[0] || 'Cliente'}\r\n                                        </h1>\r\n                                        {(() => {\r\n                                            const category = paymentCategories?.find(c => c.id === patient.payment_category_id);\r\n                                            if (category) {\r\n                                                return (\r\n                                                    <span className={`text-xs px-2 py-0.5 rounded-full border font-medium ${category.color || 'bg-gray-100 text-gray-600 border-gray-200'}`}>\r\n                                                        {category.label}\r\n                                                    </span>\r\n                                                );\r\n                                            }\r\n                                            return null;\r\n                                        })()}\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <h2 className=\"text-xl font-medium text-slate-600 dark:text-slate-300\">\r\n                                            {patient.last_name || patient.name?.split(' ').slice(1).join(' ') || ''}\r\n                                        </h2>\r\n                                    </div>\r\n                                    {patient.subscription?.type && (\r\n                                        <p className=\"text-sm text-slate-400 mt-0.5 capitalize\">Plan {patient.subscription.type}</p>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"header-controls flex gap-2 flex-wrap justify-end\">\r\n                        {patient.subscription?.status === 'active' && (\r\n                            <button\r\n                                onClick={() => setIsExtendModalOpen(true)}\r\n                                className=\"btn btn-outline text-amber-600 border-amber-200 hover:bg-amber-50\"\r\n                                title=\"Extender suscripción\"\r\n                            >\r\n                                <Clock size={16} className=\"md:mr-1\" /> <span className=\"hidden md:inline\">Extender</span>\r\n                            </button>\r\n                        )}\r\n\r\n                        {(!patient.subscriptionHistory || patient.subscriptionHistory.length === 0) && patient.subscription?.status !== 'active' && (\r\n                            <button\r\n                                onClick={() => setIsPlanStartModalOpen(true)}\r\n                                className=\"btn btn-primary\"\r\n                            >\r\n                                <Play size={16} className=\"md:mr-1\" /> <span className=\"hidden md:inline\">Iniciar Plan</span>\r\n                            </button>\r\n                        )}\r\n\r\n                        {(patient.subscription?.status === 'active' || (patient.subscriptionHistory && patient.subscriptionHistory.length > 0)) && (\r\n                            <button\r\n                                onClick={() => setIsRenewalModalOpen(true)}\r\n                                className=\"btn btn-outline text-blue-600 border-blue-200 hover:bg-blue-50\"\r\n                            >\r\n                                <RefreshCw size={16} className=\"md:mr-1\" /> <span className=\"hidden md:inline\">Renovar</span>\r\n                            </button>\r\n                        )}\r\n\r\n                        <button onClick={() => setIsEditModalOpen(true)} className=\"btn btn-outline\" title=\"Editar datos\">\r\n                            <Edit2 size={16} className=\"md:mr-1\" /> <span className=\"hidden md:inline\">Editar</span>\r\n                        </button>\r\n\r\n                        <button onClick={handleDelete} className=\"btn btn-outline text-danger border-red-200 hover:bg-red-50\" title=\"Eliminar cliente\">\r\n                            <Trash2 size={16} />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Tabs */}\r\n            <div className=\"mb-6 border-b border-gray-200 dark:border-gray-700\">\r\n                <nav className=\"flex gap-6 overflow-x-auto pb-1 no-scrollbar\">\r\n                    <button\r\n                        onClick={() => setActiveTab('info')}\r\n                        className={`pb-3 px-1 font-medium text-sm transition-all border-b-2 whitespace-nowrap ${activeTab === 'info' ? 'border-primary text-primary dark:text-primary-400 dark:border-primary-400' : 'border-transparent text-muted hover:text-gray-800 dark:text-slate-400 dark:hover:text-slate-200'}`}\r\n                    >\r\n                        <div className=\"flex items-center gap-2\"><User size={18} /> Ficha Cliente</div>\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('tracking')}\r\n                        className={`pb-3 px-1 font-medium text-sm transition-all border-b-2 whitespace-nowrap ${activeTab === 'tracking' ? 'border-primary text-primary dark:text-primary-400 dark:border-primary-400' : 'border-transparent text-muted hover:text-gray-800 dark:text-slate-400 dark:hover:text-slate-200'}`}\r\n                    >\r\n                        <div className=\"flex items-center gap-2\"><Activity size={18} /> Mediciones</div>\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('reviews')}\r\n                        className={`pb-3 px-1 font-medium text-sm transition-all border-b-2 whitespace-nowrap ${activeTab === 'reviews' ? 'border-primary text-primary dark:text-primary-400 dark:border-primary-400' : 'border-transparent text-muted hover:text-gray-800 dark:text-slate-400 dark:hover:text-slate-200'}`}\r\n                    >\r\n                        <div className=\"flex items-center gap-2\"><CalendarIcon size={18} /> Revisiones</div>\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('photos')}\r\n                        className={`pb-3 px-1 font-medium text-sm transition-all border-b-2 whitespace-nowrap ${activeTab === 'photos' ? 'border-primary text-primary dark:text-primary-400 dark:border-primary-400' : 'border-transparent text-muted hover:text-gray-800 dark:text-slate-400 dark:hover:text-slate-200'}`}\r\n                    >\r\n                        <div className=\"flex items-center gap-2\"><ImageIcon size={18} /> Fotos</div>\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('payments')}\r\n                        className={`pb-3 px-1 font-medium text-sm transition-all border-b-2 whitespace-nowrap ${activeTab === 'payments' ? 'border-primary text-primary dark:text-primary-400 dark:border-primary-400' : 'border-transparent text-muted hover:text-gray-800 dark:text-slate-400 dark:hover:text-slate-200'}`}\r\n                    >\r\n                        <div className=\"flex items-center gap-2\"><Wallet size={18} /> Pagos y Renovaciones</div>\r\n                    </button>\r\n                </nav>\r\n            </div>\r\n\r\n            {/* Content */}\r\n            <div className=\"animate-fade-in relative\">\r\n                {activeTab === 'info' && <InformationTab patient={patient} onEditSubscription={() => handleEditSubscription()} />}\r\n\r\n                {activeTab === 'tracking' && (\r\n                    <TrackingTab\r\n                        patient={patient}\r\n                        onAddMeasurement={() => {\r\n                            setEditingMeasurement(null);\r\n                            setIsMeasurementModalOpen(true);\r\n                        }}\r\n                        onEditMeasurement={handleEditMeasurement}\r\n                        onDeleteMeasurement={(id) => deleteMeasurement(id, patient.id)}\r\n                    />\r\n                )}\r\n\r\n                {activeTab === 'reviews' && <ReviewsTab patient={patient} />}\r\n\r\n                {activeTab === 'photos' && <PhotosTab patient={patient} />}\r\n\r\n                {activeTab === 'payments' && (\r\n                    <PaymentsTab\r\n                        patientId={patient.id}\r\n                        subscriptionTerms={subscriptionTerms}\r\n                        onAddPayment={(initialData = null) => {\r\n                            setEditingPayment(initialData);\r\n                            setIsPaymentModalOpen(true);\r\n                        }}\r\n                        onEditPayment={(payment) => {\r\n                            setEditingPayment(payment);\r\n                            setIsPaymentModalOpen(true);\r\n                        }}\r\n                        onDeletePayment={handleDeletePayment}\r\n                        onEditSubscription={handleEditSubscription}\r\n                        onEditExtension={(ext) => {\r\n                            setEditingExtension(ext);\r\n                            setIsEditExtensionModalOpen(true);\r\n                        }}\r\n                    />\r\n                )}\r\n            </div>\r\n\r\n            {/* Modals */}\r\n            {isEditModalOpen && (\r\n                <PatientForm\r\n                    isOpen={isEditModalOpen}\r\n                    onClose={() => setIsEditModalOpen(false)}\r\n                    initialData={patient}\r\n                />\r\n            )}\r\n\r\n            {isRenewalModalOpen && (\r\n                <RenewalModal\r\n                    isOpen={isRenewalModalOpen}\r\n                    onClose={() => setIsRenewalModalOpen(false)}\r\n                    patient={patient}\r\n                    suggestedStartDate={suggestedStartDate}\r\n                />\r\n            )}\r\n\r\n            {isSubscriptionEditModalOpen && (\r\n                <SubscriptionEditModal\r\n                    isOpen={isSubscriptionEditModalOpen}\r\n                    onClose={() => {\r\n                        setIsSubscriptionEditModalOpen(false);\r\n                        setSubscriptionEditData(null);\r\n                    }}\r\n                    patient={patient}\r\n                    subscriptionData={subscriptionEditData}\r\n                    onSave={subscriptionEditData ? async (updates) => {\r\n                        const result = await updateSubscriptionHistory(subscriptionEditData.id, updates);\r\n                        if (result) {\r\n                            console.log(\"Updated\", subscriptionEditData.id);\r\n                        } else {\r\n                            alert(\"Error al actualizar la suscripción\");\r\n                        }\r\n                    } : null}\r\n                />\r\n            )}\r\n\r\n            <MeasurementModal\r\n                isOpen={isMeasurementModalOpen}\r\n                onClose={() => {\r\n                    setIsMeasurementModalOpen(false);\r\n                    setEditingMeasurement(null);\r\n                }}\r\n                onSave={handleSaveMeasurement}\r\n                initialData={editingMeasurement}\r\n            />\r\n\r\n            <PaymentModal\r\n                isOpen={isPaymentModalOpen}\r\n                onClose={() => {\r\n                    setIsPaymentModalOpen(false);\r\n                    setEditingPayment(null);\r\n                }}\r\n                defaultPatientId={id}\r\n                initialData={editingPayment}\r\n                subscriptionTerms={subscriptionTerms}\r\n            />\r\n\r\n            <ExtendSubscriptionModal\r\n                isOpen={isExtendModalOpen}\r\n                onClose={() => setIsExtendModalOpen(false)}\r\n                onConfirm={handleExtendSubscription}\r\n                onViewHistory={() => {\r\n                    setIsExtendModalOpen(false);\r\n                    setIsExtensionHistoryModalOpen(true);\r\n                }}\r\n            />\r\n\r\n            <ExtensionHistoryModal\r\n                isOpen={isExtensionHistoryModalOpen}\r\n                onClose={() => setIsExtensionHistoryModalOpen(false)}\r\n                extensions={subscriptionExtensions.filter(ext => ext.patient_id === id)}\r\n            />\r\n\r\n            <EditExtensionModal\r\n                isOpen={isEditExtensionModalOpen}\r\n                onClose={() => {\r\n                    setIsEditExtensionModalOpen(false);\r\n                    setEditingExtension(null);\r\n                }}\r\n                extension={editingExtension}\r\n                onConfirm={async (id, days) => {\r\n                    await updateSubscriptionExtension(id, days);\r\n                    setIsEditExtensionModalOpen(false);\r\n                    setEditingExtension(null);\r\n                }}\r\n            />\r\n\r\n            <PlanStartModal\r\n                isOpen={isPlanStartModalOpen}\r\n                onClose={() => setIsPlanStartModalOpen(false)}\r\n                patientId={id}\r\n                suggestedStartDate={suggestedStartDate}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PatientDetail;\r\n"}]