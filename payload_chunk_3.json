[{"path":"src/components/Patients/PatientForm.jsx","content":"import { useState, useEffect } from 'react';\r\nimport { useNavigate, useParams } from 'react-router-dom';\r\nimport { useData } from '../../context/DataContext';\r\nimport { Save, ArrowLeft, User, Activity, Heart } from 'lucide-react';\r\n\r\nconst PatientForm = ({ isOpen, onClose, initialData }) => {\r\n    const { id } = useParams();\r\n    const navigate = useNavigate();\r\n    const { patients, addPatient, updatePatient, plans, referralSources, paymentCategories, clinicalCategories, subscriptionTypes, paymentRates, nutritionists } = useData();\r\n\r\n    // Determine if we are in edit mode (either by ID param or initialData prop)\r\n    const isEdit = !!id || !!initialData;\r\n    const patientId = id || initialData?.id;\r\n\r\n    // ... (keep state)\r\n    const [formData, setFormData] = useState({\r\n        firstName: '',\r\n        lastName: '',\r\n        birthDate: '',\r\n        sex: 'mujer', // Default\r\n        city: '',\r\n        phone: '',\r\n        email: '',\r\n        height: '',\r\n        weight: '', // Initial weight\r\n        goals: '',\r\n        allergies: '',\r\n        pathologies: '',\r\n        dislikedFoods: '',\r\n\r\n        referralSource: '',\r\n        nutritionistId: '',\r\n        reviewDay: '',\r\n    });\r\n\r\n    // Set default keys when lists load (only for NEW patients)\r\n    // This useEffect is now empty as subscription-related defaults are removed.\r\n    useEffect(() => {\r\n    }, [isEdit, subscriptionTypes, paymentRates, formData.subscriptionTypeId]);\r\n\r\n    useEffect(() => {\r\n        if (isEdit) {\r\n            const patient = initialData || patients.find(p => p.id === patientId);\r\n            if (patient) {\r\n                // eslint-disable-next-line react-hooks/set-state-in-effect\r\n                setFormData({\r\n                    firstName: patient.first_name || patient.name?.split(' ')[0] || '',\r\n                    lastName: patient.last_name || patient.name?.split(' ').slice(1).join(' ') || '',\r\n                    birthDate: patient.birth_date || '',\r\n                    sex: patient.sex || 'mujer',\r\n                    city: patient.city || '',\r\n                    phone: patient.phone || '',\r\n                    email: patient.email || '',\r\n                    height: patient.height || '',\r\n                    weight: patient.weight || '',\r\n                    goals: patient.goals || '',\r\n                    allergies: patient.allergies || '',\r\n                    pathologies: patient.pathologies || '',\r\n                    dislikedFoods: patient.disliked_foods || '',\r\n                    // Dynamic categories fallback\r\n                    ...clinicalCategories.reduce((acc, cat) => {\r\n                        const key = cat.id === 'pathology' ? 'pathologies' :\r\n                            cat.id === 'dislike' ? 'dislikedFoods' :\r\n                                cat.id;\r\n\r\n                        // Check various possible keys (snake_case from DB, camelCase from local)\r\n                        let val = patient[key] || patient[cat.id] || patient.clinical_data?.[cat.id];\r\n                        if (!val && key === 'dislikedFoods') val = patient.disliked_foods;\r\n\r\n                        acc[key] = val || '';\r\n                        return acc;\r\n                    }, {}),\r\n\r\n                    referralSource: (() => {\r\n                        const val = patient.referral_source || patient.referralSource;\r\n                        if (!val) return '';\r\n                        // Try to find direct ID match\r\n                        if (referralSources.some(r => r.id === val)) return val;\r\n                        // Try to find by label (case-insensitive)\r\n                        const found = referralSources.find(r => r.label.toLowerCase() === val.toLowerCase());\r\n                        return found ? found.id : '';\r\n                    })(),\r\n                    paymentCategoryId: (() => {\r\n                        const val = patient.payment_category_id || patient.paymentCategoryId;\r\n                        if (!val) return '';\r\n                        if (paymentCategories.some(c => c.id === val)) return val;\r\n                        const found = paymentCategories.find(c => c.label.toLowerCase() === val.toLowerCase());\r\n                        return found ? found.id : '';\r\n                    })(),\r\n                    nutritionistId: patient.nutritionist_id || '',\r\n                    reviewDay: patient.review_day ? String(patient.review_day) : '',\r\n                });\r\n            }\r\n        }\r\n    }, [isEdit, patientId, patients, plans, initialData, clinicalCategories]);\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n\r\n        let patientData = { ...formData };\r\n\r\n        // Only handle subscription for NEW patients\r\n        // For existing patients, subscription changes are handled via RenewalModal or special actions\r\n        // For existing patients, subscription changes are handled via RenewalModal or special actions\r\n        // Subscription logic removed as per instructions.\r\n\r\n        if (isEdit) {\r\n            // Remove subscription-related fields from update payload to be safe\r\n            // Remove subscription-related fields from update payload to be safe\r\n            // Subscription-related fields are no longer in formData, so no need to delete.\r\n\r\n            await updatePatient(patientId, patientData);\r\n            if (onClose) {\r\n                onClose();\r\n            } else {\r\n                navigate(`/patients/${patientId}`);\r\n            }\r\n        } else {\r\n            const newPatientId = await addPatient(patientData);\r\n            if (newPatientId) {\r\n                if (onClose) {\r\n                    onClose();\r\n                } else {\r\n                    navigate(`/patients/${newPatientId}`);\r\n                }\r\n            } else {\r\n                alert('Error al guardar el cliente. Por favor, verifica los datos e inténtalo de nuevo.');\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleChange = (e) => {\r\n        const { name, value } = e.target;\r\n        setFormData(prev => ({ ...prev, [name]: value }));\r\n    };\r\n\r\n    const formContent = (\r\n        <form onSubmit={handleSubmit} className={`card max-w-4xl mx-auto ${onClose ? 'w-full shadow-none border-0' : ''}`}>\r\n            {/* If Modal, Add Header here inside card if needed, or keep external */}\r\n            {onClose && (\r\n                <div className=\"flex justify-between items-center mb-6 pb-4 border-b border-slate-100\">\r\n                    <div>\r\n                        <h2 className=\"text-xl font-bold text-slate-900\">{isEdit ? 'Editar Cliente' : 'Nuevo Cliente'}</h2>\r\n                        <p className=\"text-sm text-slate-500\">Complete la ficha técnica</p>\r\n                    </div>\r\n                    <button type=\"button\" onClick={onClose} className=\"p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400 hover:text-slate-600\">\r\n                        <ArrowLeft size={20} className=\"rotate-180\" /> {/* Using generic close icon behavior or X */}\r\n                    </button>\r\n                </div>\r\n            )}\r\n\r\n            {/* Personal Data */}\r\n            <div className=\"text-lg font-bold text-slate-800 border-b border-slate-100 pb-2 mb-4 flex items-center gap-2\">\r\n                <User size={18} className=\"text-primary-600\" /> Datos Personales\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8\">\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">Nombre</label>\r\n                    <input\r\n                        className=\"form-input\"\r\n                        name=\"firstName\"\r\n                        value={formData.firstName}\r\n                        onChange={handleChange}\r\n                        placeholder=\"Ej. Ana\"\r\n                    />\r\n                </div>\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">Apellidos</label>\r\n                    <input\r\n                        className=\"form-input\"\r\n                        name=\"lastName\"\r\n                        value={formData.lastName}\r\n                        onChange={handleChange}\r\n                        placeholder=\"Ej. López\"\r\n                    />\r\n                </div>\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">Fecha de Nacimiento</label>\r\n                    <input\r\n                        className=\"form-input\"\r\n                        name=\"birthDate\"\r\n                        type=\"date\"\r\n                        value={formData.birthDate}\r\n                        onChange={handleChange}\r\n                    />\r\n                </div>\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">Sexo</label>\r\n                    <select\r\n                        className=\"form-select\"\r\n                        name=\"sex\"\r\n                        value={formData.sex}\r\n                        onChange={handleChange}\r\n                    >\r\n                        <option value=\"mujer\">Mujer</option>\r\n                        <option value=\"hombre\">Hombre</option>\r\n                        <option value=\"otro\">Otro</option>\r\n                    </select>\r\n                </div>\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">Ciudad / Localidad</label>\r\n                    <input\r\n                        className=\"form-input\"\r\n                        name=\"city\"\r\n                        value={formData.city}\r\n                        onChange={handleChange}\r\n                        placeholder=\"Ej. Madrid\"\r\n                    />\r\n                </div>\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">Teléfono</label>\r\n                    <input\r\n                        className=\"form-input\"\r\n                        name=\"phone\"\r\n                        type=\"tel\"\r\n                        value={formData.phone}\r\n                        onChange={handleChange}\r\n                        placeholder=\"Ej. 600 123 456\"\r\n                    />\r\n                </div>\r\n                <div className=\"form-group md:col-span-2\">\r\n                    <label className=\"form-label\">Email</label>\r\n                    <input\r\n                        className=\"form-input\"\r\n                        name=\"email\"\r\n                        type=\"email\"\r\n                        value={formData.email}\r\n                        onChange={handleChange}\r\n                        placeholder=\"ejemplo@email.com\"\r\n                    />\r\n                </div>\r\n                <div className=\"form-group md:col-span-2\">\r\n                    <label className=\"form-label\">Centro / Etiqueta</label>\r\n                    <select\r\n                        className=\"form-select\"\r\n                        name=\"paymentCategoryId\"\r\n                        value={formData.paymentCategoryId || ''}\r\n                        onChange={handleChange}\r\n                    >\r\n                        <option value=\"\">-- Sin asignar --</option>\r\n                        {paymentCategories.filter(c => c.is_active !== false).map(c => (\r\n                            <option key={c.id} value={c.id}>{c.label}</option>\r\n                        ))}\r\n                    </select>\r\n                    <p className=\"text-xs text-gray-400 mt-1\">Esta etiqueta se asignará automáticamente a los pagos de este cliente.</p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Physical Data */}\r\n            <div className=\"text-lg font-bold text-slate-800 border-b border-slate-100 pb-2 mb-4 flex items-center gap-2\">\r\n                <Activity size={18} className=\"text-primary-600\" /> Datos Físicos Iniciales\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8\">\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">Altura (cm)</label>\r\n                    <input\r\n                        className=\"form-input\"\r\n                        name=\"height\"\r\n                        type=\"number\"\r\n                        value={formData.height}\r\n                        onChange={handleChange}\r\n                        placeholder=\"Ej. 165\"\r\n                    />\r\n                </div>\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">Peso Actual (kg)</label>\r\n                    <input\r\n                        className=\"form-input\"\r\n                        name=\"weight\"\r\n                        type=\"number\"\r\n                        step=\"0.1\"\r\n                        value={formData.weight}\r\n                        onChange={handleChange}\r\n                        placeholder=\"Ej. 65.5\"\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            {/* Goals & Medical */}\r\n            <div className=\"text-lg font-bold text-slate-800 border-b border-slate-100 pb-2 mb-4 flex items-center gap-2\">\r\n                <Heart size={18} className=\"text-primary-600\" /> Objetivos y Salud\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8\">\r\n                <div className=\"form-group md:col-span-2\">\r\n                    <label className=\"form-label\">Objetivos Nutricionales</label>\r\n                    <textarea\r\n                        className=\"form-textarea\"\r\n                        name=\"goals\"\r\n                        rows=\"3\"\r\n                        value={formData.goals}\r\n                        onChange={handleChange}\r\n                        placeholder=\"Ej. Perder grasa, aumentar masa muscular...\"\r\n                    />\r\n                </div>\r\n                <div className=\"form-group md:col-span-2\">\r\n                    <label className=\"form-label\">Alergias / Intolerancias</label>\r\n                    <textarea\r\n                        className=\"form-textarea\"\r\n                        name=\"allergies\"\r\n                        rows=\"2\"\r\n                        value={formData.allergies}\r\n                        onChange={handleChange}\r\n                        placeholder=\"Ej. Intolerancia a la lactosa, alergia a nueces...\"\r\n                    />\r\n                </div>\r\n                {clinicalCategories?.map(category => {\r\n                    // Map category ID to formData field name\r\n                    // Mappings: pathology -> pathologies, dislike -> dislikedFoods, else -> category.id\r\n                    let fieldName = category.id;\r\n                    if (category.id === 'pathology') fieldName = 'pathologies';\r\n                    if (category.id === 'dislike') fieldName = 'dislikedFoods';\r\n\r\n                    // Ensure full width for pathology, half for others by default or custom logic\r\n                    const isFullWidth = category.id === 'pathology' || category.id === 'platos_que_no_pueden_faltar';\r\n\r\n                    return (\r\n                        <div key={category.id} className={`form-group ${isFullWidth ? 'md:col-span-2' : ''}`}>\r\n                            <label className=\"form-label\">{category.label}</label>\r\n                            <textarea\r\n                                className=\"form-textarea\"\r\n                                name={fieldName}\r\n                                rows=\"2\"\r\n                                value={formData[fieldName] || ''}\r\n                                onChange={handleChange}\r\n                                placeholder={`Escribe aquí ${category.label.toLowerCase()}...`}\r\n                            />\r\n                        </div>\r\n                    );\r\n                })}\r\n\r\n            </div>\r\n\r\n            {/* Marketing */}\r\n            <div className=\"text-lg font-bold text-slate-800 border-b border-slate-100 pb-2 mb-4 flex items-center gap-2\">\r\n                <Heart size={18} className=\"text-primary-600\" /> Otros Datos\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8\">\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">¿Cómo nos conoció?</label>\r\n                    <select\r\n                        className=\"form-select\"\r\n                        name=\"referralSource\"\r\n                        value={formData.referralSource}\r\n                        onChange={handleChange}\r\n                    >\r\n                        <option value=\"\">Seleccionar...</option>\r\n                        {referralSources && referralSources.map(source => (\r\n                            <option key={source.id} value={source.id}>\r\n                                {source.label}\r\n                            </option>\r\n                        ))}\r\n                    </select>\r\n                </div>\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">Nutricionista Asignado</label>\r\n                    <select\r\n                        className=\"form-select\"\r\n                        name=\"nutritionistId\"\r\n                        value={formData.nutritionistId}\r\n                        onChange={handleChange}\r\n                    >\r\n                        <option value=\"\">-- Sin asignar --</option>\r\n                        {nutritionists && nutritionists.filter(n => n.is_active !== false).map(n => (\r\n                            <option key={n.id} value={n.id}>\r\n                                {n.label}\r\n                            </option>\r\n                        ))}\r\n                    </select>\r\n                </div>\r\n                <div className=\"form-group\">\r\n                    <label className=\"form-label\">Día de Revisión Habitual</label>\r\n                    <select\r\n                        className=\"form-select\"\r\n                        name=\"reviewDay\"\r\n                        value={formData.reviewDay}\r\n                        onChange={handleChange}\r\n                    >\r\n                        <option value=\"\">-- Sin definir --</option>\r\n                        <option value=\"1\">Lunes</option>\r\n                        <option value=\"2\">Martes</option>\r\n                        <option value=\"3\">Miércoles</option>\r\n                        <option value=\"4\">Jueves</option>\r\n                        <option value=\"5\">Viernes</option>\r\n                    </select>\r\n                    <p className=\"text-xs text-slate-400 mt-1\">El sistema calculará las próximas revisiones basándose en este día.</p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Subscription - Only for NEW patients */}\r\n\r\n\r\n            <div className=\"flex justify-end gap-4 mt-8 pt-4 border-t border-slate-100\">\r\n                <button type=\"button\" onClick={() => onClose ? onClose() : navigate(-1)} className=\"btn btn-ghost text-slate-500 hover:text-slate-700\">\r\n                    Cancelar\r\n                </button>\r\n                <button type=\"submit\" className=\"btn btn-primary bg-primary-600 hover:bg-primary-700 text-white shadow-lg shadow-primary/30 min-w-[120px]\">\r\n                    <Save size={18} />\r\n                    Guardar Ficha\r\n                </button>\r\n            </div>\r\n\r\n        </form>\r\n    );\r\n\r\n    if (onClose) {\r\n        if (!isOpen) return null;\r\n        return (\r\n            <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in\">\r\n                <div className=\"w-full max-w-4xl max-h-[90vh] overflow-y-auto bg-white rounded-xl shadow-2xl\">\r\n                    <div className=\"p-6\">\r\n                        {formContent}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"dashboard-container\">\r\n            <div className=\"dashboard-header\">\r\n                <div className=\"flex items-center gap-4\">\r\n                    <button onClick={() => navigate(-1)} className=\"btn btn-ghost btn-icon\">\r\n                        <ArrowLeft size={24} />\r\n                    </button>\r\n                    <div>\r\n                        <h1 className=\"page-title\">{isEdit ? 'Editar Cliente' : 'Nuevo Cliente'}</h1>\r\n                        <p className=\"page-subtitle\">Complete la ficha técnica</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            {formContent}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PatientForm;\r\n"},{"path":"src/components/Patients/PatientList.jsx","content":"import { useState, useMemo } from 'react';\r\nimport { Link, useNavigate } from 'react-router-dom';\r\nimport { useData } from '../../context/DataContext';\r\nimport { Search, Plus, Filter, Trash2, CheckCircle, LayoutGrid, List, ChevronRight, Play } from 'lucide-react';\r\nimport { format, parseISO } from 'date-fns';\r\nimport PlanStartModal from './PlanStartModal';\r\n\r\nconst PatientList = () => {\r\n    const { patients, updatePatient } = useData();\r\n    const navigate = useNavigate(); // Hook initialized\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [draggedPatientId, setDraggedPatientId] = useState(null);\r\n    const [viewMode, setViewMode] = useState('board'); // 'list' or 'board'\r\n    const [filterStatus, setFilterStatus] = useState('all');\r\n    const [planStartModalOpen, setPlanStartModalOpen] = useState(false);\r\n    const [selectedPatientId, setSelectedPatientId] = useState(null);\r\n    const [sortOption, setSortOption] = useState('name');\r\n\r\n    // ... (logic)\r\n\r\n    // In the return ...\r\n    // Status mapping logic\r\n    const getPatientStatus = (patient) => {\r\n        if (['pending_payment', 'paused', 'finished'].includes(patient.status)) {\r\n            return patient.status;\r\n        }\r\n\r\n        const today = new Date();\r\n        today.setHours(0, 0, 0, 0);\r\n        const endDate = patient.subscription?.endDate ? new Date(patient.subscription.endDate) : null;\r\n        const startDate = patient.subscription?.startDate ? new Date(patient.subscription.startDate) : null;\r\n\r\n        const warningDate = new Date(today);\r\n        warningDate.setDate(today.getDate() + 7);\r\n\r\n        if (!startDate || !endDate) return 'waiting';\r\n\r\n        if (startDate > today) {\r\n            // Check for any currently active subscription in history\r\n            const activeSub = patient.subscriptionHistory?.find(sub =>\r\n                sub.status === 'active' &&\r\n                new Date(sub.start_date) <= today &&\r\n                (!sub.end_date || new Date(sub.end_date) >= today)\r\n            );\r\n\r\n            if (activeSub) return 'active';\r\n\r\n            return 'waiting';\r\n        }\r\n        if (endDate < today) return 'expired';\r\n        if (endDate <= warningDate) return 'warning';\r\n\r\n        return 'active';\r\n    };\r\n\r\n    const columns = {\r\n        waiting: { title: 'A la espera', color: 'border-l-4 border-gray-400' },\r\n        active: { title: 'Activo', color: 'border-l-4 border-green-500' },\r\n        warning: { title: 'Última semana', color: 'border-l-4 border-yellow-500' },\r\n        pending_payment: { title: 'Pendiente Pago', color: 'border-l-4 border-orange-500' },\r\n        paused: { title: 'Pausado', color: 'border-l-4 border-blue-500' },\r\n        expired: { title: 'Caducado', color: 'border-l-4 border-red-500' },\r\n        finished: { title: 'Finalizado / Inactivo', color: 'border-l-4 border-slate-400' }\r\n    };\r\n\r\n    // Group patients by status\r\n    const groupedPatients = useMemo(() => {\r\n        const groups = { waiting: [], active: [], warning: [], pending_payment: [], paused: [], finished: [], expired: [] };\r\n\r\n        patients.forEach(p => {\r\n            // Search Filter\r\n            if (searchTerm && !p.name.toLowerCase().includes(searchTerm.toLowerCase())) return;\r\n\r\n            const status = getPatientStatus(p);\r\n            if (groups[status]) {\r\n                groups[status].push(p);\r\n            }\r\n        });\r\n        return groups;\r\n    }, [patients, searchTerm]);\r\n\r\n    // List View Filtered Data\r\n    const filteredListPatients = useMemo(() => {\r\n        let result = patients.filter(p => {\r\n            const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n                p.email?.toLowerCase().includes(searchTerm.toLowerCase());\r\n            const status = getPatientStatus(p);\r\n\r\n            if (filterStatus === 'all') return matchesSearch; // Show ALL, including finished\r\n            return matchesSearch && status === filterStatus;\r\n        });\r\n\r\n        // Sorting\r\n        return result.sort((a, b) => {\r\n            if (sortOption === 'name') return a.name.localeCompare(b.name);\r\n            if (sortOption === 'date_desc') return new Date(b.created_at || 0) - new Date(a.created_at || 0);\r\n            if (sortOption === 'date_asc') return new Date(a.created_at || 0) - new Date(b.created_at || 0);\r\n            return 0;\r\n        });\r\n    }, [patients, searchTerm, filterStatus, sortOption]);\r\n\r\n    // Drag Handlers\r\n    const handleDragStart = (e, patientId) => {\r\n        setDraggedPatientId(patientId);\r\n        e.dataTransfer.setData('patientId', patientId);\r\n        e.dataTransfer.effectAllowed = 'move';\r\n        document.body.classList.add('is-dragging');\r\n    };\r\n\r\n    const handleDragEnd = () => {\r\n        setDraggedPatientId(null);\r\n        document.body.classList.remove('is-dragging');\r\n    };\r\n\r\n    const handleDrop = (e, targetStatus) => {\r\n        e.preventDefault();\r\n        const pid = e.dataTransfer.getData('patientId');\r\n        if (pid) {\r\n            updatePatient(pid, { status: targetStatus });\r\n        }\r\n    };\r\n\r\n    const handleDragOver = (e) => {\r\n        e.preventDefault();\r\n    };\r\n\r\n    return (\r\n        <div className=\"dashboard-container relative h-full\">\r\n            <div className=\"flex flex-col gap-6 mb-6\">\r\n                <div>\r\n                    <h1 className=\"page-title\">Clientes</h1>\r\n                    <p className=\"page-subtitle\">Tablero de Gestión</p>\r\n                </div>\r\n\r\n                {/* Toolbar: Search Left, Buttons Right */}\r\n                <div className=\"flex flex-col md:flex-row justify-between items-center gap-4\">\r\n                    <div className=\"flex items-center px-3 py-2 bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 rounded-lg w-full md:w-auto focus-within:ring-2 focus-within:ring-primary-500 focus-within:border-primary-500 transition-all\" style={{ minWidth: '320px' }}>\r\n                        <Search className=\"text-slate-400 mr-2\" size={18} />\r\n                        <input\r\n                            className=\"bg-transparent border-none outline-none text-sm text-slate-700 dark:text-slate-200 w-full placeholder-slate-400\"\r\n                            placeholder=\"Buscar...\"\r\n                            value={searchTerm}\r\n                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center gap-3 w-full md:w-auto justify-end\">\r\n                        <div className=\"bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm p-1 rounded-lg flex\">\r\n                            <button\r\n                                onClick={() => setViewMode('list')}\r\n                                className={`p-1.5 rounded-md transition-colors ${viewMode === 'list' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}\r\n                                title=\"Vista de Lista\"\r\n                            >\r\n                                <List size={18} />\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setViewMode('board')}\r\n                                className={`p-1.5 rounded-md transition-colors ${viewMode === 'board' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}\r\n                                title=\"Vista de Tablero\"\r\n                            >\r\n                                <LayoutGrid size={18} />\r\n                            </button>\r\n                        </div>\r\n\r\n                        <Link to=\"/patients/new\" className=\"btn btn-primary shadow-md btn-sm text-sm\" style={{ padding: '0.5rem 1rem' }}>\r\n                            <Plus size={16} /> Nuevo\r\n                        </Link>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {viewMode === 'board' ? (\r\n                <div className=\"flex flex-col h-full overflow-hidden\">\r\n                    {/* Drop Zone for Finished - Only visible when dragging */}\r\n                    <div\r\n                        className={`transition-all duration-300 overflow-hidden ${draggedPatientId ? 'max-h-20 mb-4 opacity-100' : 'max-h-0 opacity-0'}`}\r\n                    >\r\n                        <div\r\n                            className=\"bg-primary-50 border-2 border-dashed border-primary-300 rounded-xl p-4 flex items-center justify-center text-primary-700 font-medium h-20\"\r\n                            onDragOver={handleDragOver}\r\n                            onDrop={(e) => handleDrop(e, 'finished')}\r\n                        >\r\n                            <CheckCircle className=\"mr-2\" size={24} /> Soltar para Finalizar / Archivar\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex-1 overflow-x-auto overflow-y-hidden pb-4\">\r\n                        <div className=\"flex gap-6 h-full min-w-max\">\r\n                            {Object.entries(columns).map(([statusKey, config]) => (\r\n                                <div\r\n                                    key={statusKey}\r\n                                    className={`w-64 flex flex-col bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-700 h-full ${config.color}`}\r\n                                    onDragOver={handleDragOver}\r\n                                    onDrop={(e) => handleDrop(e, statusKey)}\r\n                                >\r\n                                    {/* Column Header */}\r\n                                    <div className=\"p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-800 rounded-t-xl\">\r\n                                        <span className=\"text-sm font-bold uppercase tracking-wider text-slate-700 dark:text-slate-300\">{config.title}</span>\r\n                                        <span className=\"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-0.5 rounded-full text-xs font-bold border border-slate-200 dark:border-slate-600\">\r\n                                            {groupedPatients[statusKey]?.length || 0}\r\n                                        </span>\r\n                                    </div>\r\n\r\n                                    {/* Column Content */}\r\n                                    <div className=\"p-3 flex-1 overflow-y-auto space-y-3 scrollbar-thin\">\r\n                                        {groupedPatients[statusKey]?.map(patient => (\r\n                                            <div\r\n                                                key={patient.id}\r\n                                                className={`bg-white dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all cursor-pointer group relative ${draggedPatientId === patient.id ? 'opacity-50' : ''}`}\r\n                                                draggable\r\n                                                onDragStart={(e) => handleDragStart(e, patient.id)}\r\n                                                onDragEnd={handleDragEnd}\r\n                                                onClick={() => navigate(`/patients/${patient.id}`)}\r\n                                            >\r\n                                                {/* Card Header */}\r\n                                                <div className=\"flex justify-between items-start mb-1\">\r\n                                                    <span className=\"font-semibold text-sm text-slate-800 dark:text-slate-200 hover:text-primary-600 dark:hover:text-primary-400 transition-colors line-clamp-1\">\r\n                                                        {patient.name}\r\n                                                    </span>\r\n\r\n                                                    {/* Quick Action: Finish (Visible on hover) */}\r\n                                                    <button\r\n                                                        onClick={(e) => {\r\n                                                            e.stopPropagation();\r\n                                                            updatePatient(patient.id, { status: 'finished' });\r\n                                                        }}\r\n                                                        className=\"opacity-0 group-hover:opacity-100 text-slate-400 hover:text-primary-600 dark:hover:text-primary-400 transition-opacity p-0.5\"\r\n                                                        title=\"Finalizar/Archivar\"\r\n                                                    >\r\n                                                        <CheckCircle size={12} />\r\n                                                    </button>\r\n                                                </div>\r\n\r\n                                                {/* Start Plan Button for Waiting Patients without a plan */}\r\n                                                {statusKey === 'waiting' && !patient.subscription?.type && (\r\n                                                    <button\r\n                                                        onClick={(e) => {\r\n                                                            e.stopPropagation();\r\n                                                            setSelectedPatientId(patient.id);\r\n                                                            setPlanStartModalOpen(true);\r\n                                                        }}\r\n                                                        className=\"w-full mt-1.5 mb-1.5 flex items-center justify-center gap-1.5 py-1 px-2 bg-primary-50 dark:bg-primary-900/30 hover:bg-primary-100 dark:hover:bg-primary-900/50 text-primary-700 dark:text-primary-300 rounded-md text-xs font-semibold transition-colors\"\r\n                                                    >\r\n                                                        <Play size={12} /> Seleccionar Plan\r\n                                                    </button>\r\n                                                )}\r\n\r\n                                                {/* Card Details */}\r\n                                                <div className=\"text-xs text-slate-500 dark:text-slate-400 flex flex-col gap-0.5\">\r\n                                                    <div className=\"flex justify-between\">\r\n                                                        <span className=\"capitalize font-medium text-slate-600 dark:text-slate-400\">{patient.subscription?.type || '-'}</span>\r\n                                                        {patient.subscription?.endDate && (\r\n                                                            <span className={`${getPatientStatus(patient) === 'warning' ? 'text-amber-600 font-bold' : ''}`}>\r\n                                                                {format(parseISO(patient.subscription.endDate), 'dd/MM/yyyy')}\r\n                                                            </span>\r\n                                                        )}\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            ) : (\r\n                /* LIST VIEW */\r\n                <div className=\"card\">\r\n                    {/* Toolbar */}\r\n                    <div className=\"card-header flex flex-col md:flex-row gap-4 mb-4 justify-between items-center\" style={{ alignItems: 'center' }}>\r\n                        <div className=\"flex gap-4 w-full md:w-auto\">\r\n                            <select\r\n                                className=\"form-select text-sm w-full md:w-48\"\r\n                                value={filterStatus}\r\n                                onChange={(e) => setFilterStatus(e.target.value)}\r\n                            >\r\n                                <option value=\"all\">Todos los Estados</option>\r\n                                <option value=\"active\">Activos</option>\r\n                                <option value=\"waiting\">A la espera</option>\r\n                                <option value=\"warning\">Última Semana</option>\r\n                                <option value=\"pending_payment\">Pendiente Pago</option>\r\n                                <option value=\"paused\">Pausados</option>\r\n                                <option value=\"expired\">Caducados</option>\r\n                                <option value=\"finished\">Finalizados</option>\r\n                            </select>\r\n\r\n                            <select\r\n                                className=\"form-select text-sm w-full md:w-48\"\r\n                                value={sortOption}\r\n                                onChange={(e) => setSortOption(e.target.value)}\r\n                            >\r\n                                <option value=\"name\">Nombre (A-Z)</option>\r\n                                <option value=\"date_desc\">Más recientes</option>\r\n                                <option value=\"date_asc\">Más antiguos</option>\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"table-responsive\">\r\n                        <table className=\"data-table\">\r\n                            <thead>\r\n                                <tr>\r\n                                    <th>Cliente</th>\r\n                                    <th>Estado</th>\r\n                                    <th>Plan</th>\r\n                                    <th>Renovación</th>\r\n                                    <th>Acciones</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                {filteredListPatients.length === 0 ? (\r\n                                    <tr>\r\n                                        <td colSpan=\"5\" className=\"text-center py-8 text-muted\">No se encontraron clientes.</td>\r\n                                    </tr>\r\n                                ) : (\r\n                                    filteredListPatients.map(p => (\r\n                                        <tr key={p.id}>\r\n                                            <td>\r\n                                                <div className=\"flex items-center gap-3\">\r\n                                                    <div className=\"profile-initials\" style={{ width: '36px', height: '36px', fontSize: '0.9rem' }}>\r\n                                                        {p.name.charAt(0)}\r\n                                                    </div>\r\n                                                    <div>\r\n                                                        <div className=\"font-semibold\">{p.name}</div>\r\n                                                        <div className=\"text-xs text-muted\">{p.email}</div>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </td>\r\n                                            <td>\r\n                                                <span className={`badge badge-${getPatientStatus(p) === 'active' ? 'success' : 'warning'}`}>\r\n                                                    {columns[getPatientStatus(p)]?.title || getPatientStatus(p)}\r\n                                                </span>\r\n                                            </td>\r\n                                            <td className=\"capitalize text-sm\">{p.subscription?.type || '-'}</td>\r\n                                            <td className=\"text-sm font-mono text-muted\">\r\n                                                {p.subscription?.endDate ? format(parseISO(p.subscription.endDate), 'dd/MM/yyyy') : '-'}\r\n                                            </td>\r\n                                            <td>\r\n                                                <Link to={`/patients/${p.id}`} className=\"btn btn-ghost btn-sm btn-icon\">\r\n                                                    <ChevronRight size={18} />\r\n                                                </Link>\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))\r\n                                )}\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <PlanStartModal\r\n                isOpen={planStartModalOpen}\r\n                onClose={() => {\r\n                    setPlanStartModalOpen(false);\r\n                    setSelectedPatientId(null);\r\n                }}\r\n                patientId={selectedPatientId}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PatientList;\r\n"},{"path":"src/components/Patients/PauseModal.jsx","content":"import { useState } from 'react';\r\nimport { X, Calendar, Play } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\n\r\nconst PauseModal = ({ isOpen, onClose, patient }) => {\r\n    const { togglePatientPause } = useData();\r\n    const [date, setDate] = useState(new Date().toISOString().split('T')[0]);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    if (!isOpen || !patient) return null;\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n        setLoading(true);\r\n        try {\r\n            await togglePatientPause(patient.id, date);\r\n            onClose();\r\n        } catch (error) {\r\n            console.error(\"Error pausing subscription:\", error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-sm overflow-hidden animate-fade-in\">\r\n                <div className=\"p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center\">\r\n                    <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">\r\n                        Pausar Suscripción\r\n                    </h3>\r\n                    <button onClick={onClose} className=\"text-slate-400 hover:text-slate-600 dark:hover:text-slate-200\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit} className=\"p-6 space-y-4\">\r\n                    <p className=\"text-sm text-slate-600 dark:text-slate-300\">\r\n                        Selecciona la fecha de inicio de la pausa para <strong>{patient.name}</strong>.\r\n                    </p>\r\n\r\n                    <div>\r\n                        <label className=\"form-label flex items-center gap-2\">\r\n                            <Calendar size={16} /> Fecha de Inicio\r\n                        </label>\r\n                        <input\r\n                            type=\"date\"\r\n                            className=\"form-input\"\r\n                            value={date}\r\n                            onChange={e => setDate(e.target.value)}\r\n                            required\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"pt-2 flex gap-3\">\r\n                        <button type=\"button\" onClick={onClose} className=\"btn btn-outline flex-1\">\r\n                            Cancelar\r\n                        </button>\r\n                        <button type=\"submit\" disabled={loading} className=\"btn btn-primary flex-1 bg-amber-600 hover:bg-amber-700 border-amber-600 text-white\">\r\n                            {loading ? 'Guardando...' : 'Confirmar Pausa'}\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PauseModal;\r\n"},{"path":"src/components/Patients/PlanStartModal.jsx","content":"import { useState, useEffect } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { X, Calendar, CreditCard, Clock, Users } from 'lucide-react';\r\nimport { addDays, addMonths, format } from 'date-fns';\r\n\r\nconst PlanStartModal = ({ isOpen, onClose, patientId, suggestedStartDate }) => {\r\n    const { patients, updatePatient, subscriptionTypes, paymentRates, addSubscriptionHistory, nutritionists } = useData();\r\n    const [formData, setFormData] = useState({\r\n        subscriptionTypeId: '',\r\n        paymentRateId: '',\r\n        nutritionistId: '',\r\n        startDate: suggestedStartDate || new Date().toISOString().split('T')[0],\r\n        reviewDay: ''\r\n    });\r\n\r\n    const patient = patients.find(p => p.id === patientId);\r\n\r\n    // Set defaults\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                startDate: suggestedStartDate || prev.startDate || new Date().toISOString().split('T')[0],\r\n                subscriptionTypeId: prev.subscriptionTypeId || (subscriptionTypes[0]?.id || ''),\r\n                paymentRateId: prev.paymentRateId || (paymentRates[0]?.id || ''),\r\n                nutritionistId: prev.nutritionistId || patient?.nutritionist_id || '',\r\n                reviewDay: ''\r\n            }));\r\n        }\r\n    }, [isOpen, subscriptionTypes, paymentRates, suggestedStartDate]);\r\n\r\n    if (!isOpen || !patient) return null;\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n\r\n        const selectedType = subscriptionTypes.find(t => t.id === formData.subscriptionTypeId);\r\n        const selectedRate = paymentRates.find(r => r.id === formData.paymentRateId);\r\n\r\n        if (!selectedType || !selectedRate) return;\r\n\r\n        const durationMonths = selectedType.months;\r\n        const endDate = addMonths(new Date(formData.startDate), durationMonths).toISOString().split('T')[0];\r\n\r\n        // 1. Create History Record (Initial Subscription)\r\n        const newHistoryItem = {\r\n            patient_id: patient.id,\r\n            plan_name: selectedType.label, // Legacy/Display\r\n            subscription_type_id: selectedType.id,\r\n            payment_rate_id: selectedRate.id,\r\n            start_date: formData.startDate,\r\n            end_date: endDate,\r\n            price: selectedRate.amount,\r\n            status: 'active'\r\n        };\r\n\r\n        await addSubscriptionHistory(newHistoryItem);\r\n\r\n        // 2. Update Patient Current State (subscription + nutritionist)\r\n        const subscriptionUpdates = {\r\n            subscription: {\r\n                type: selectedType.label,\r\n                subscriptionTypeId: selectedType.id,\r\n                paymentRateId: selectedRate.id,\r\n                startDate: formData.startDate,\r\n                reviewDay: formData.reviewDay || null,\r\n                endDate: endDate,\r\n                status: 'active',\r\n                price: selectedRate.amount\r\n            },\r\n            nutritionistId: formData.nutritionistId || null\r\n        };\r\n\r\n        await updatePatient(patient.id, subscriptionUpdates);\r\n        onClose();\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-md overflow-hidden animate-fade-in\">\r\n                <div className=\"p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center\">\r\n                    <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">\r\n                        Seleccionar Plan: <span className=\"text-primary-600\">{patient.name}</span>\r\n                    </h3>\r\n                    <button onClick={onClose} className=\"text-slate-400 hover:text-slate-600 dark:hover:text-slate-200\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\r\n                    <div className=\"grid grid-cols-1 gap-4\">\r\n                        <div>\r\n                            <label className=\"form-label flex items-center gap-2\">\r\n                                <Clock size={16} /> Tipo de Suscripción\r\n                            </label>\r\n                            <select\r\n                                className=\"form-select\"\r\n                                value={formData.subscriptionTypeId}\r\n                                onChange={e => {\r\n                                    const newTypeId = e.target.value;\r\n                                    // Find valid rates for this new type\r\n                                    const validRates = paymentRates.filter(r => !r.subscription_type_id || r.subscription_type_id === newTypeId);\r\n                                    const activeRates = validRates.filter(r => r.is_active !== false);\r\n\r\n                                    setFormData({\r\n                                        ...formData,\r\n                                        subscriptionTypeId: newTypeId,\r\n                                        // Auto-select the first valid rate for this type to avoid mismatch\r\n                                        paymentRateId: activeRates.length > 0 ? activeRates[0].id : (validRates.length > 0 ? validRates[0].id : '')\r\n                                    });\r\n                                }}\r\n                                required\r\n                            >\r\n                                <option value=\"\" disabled>Seleccionar...</option>\r\n                                {subscriptionTypes.map(t => (\r\n                                    <option key={t.id} value={t.id}>{t.label} ({t.months} meses)</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"form-label flex items-center gap-2\">\r\n                                <CreditCard size={16} /> Tarifa Aplicable\r\n                            </label>\r\n                            <select\r\n                                className=\"form-select\"\r\n                                value={formData.paymentRateId}\r\n                                onChange={e => setFormData({ ...formData, paymentRateId: e.target.value })}\r\n                                required\r\n                            >\r\n                                <option value=\"\" disabled>Seleccionar...</option>\r\n                                {(() => {\r\n                                    const filtered = paymentRates.filter(r => !r.subscription_type_id || r.subscription_type_id === formData.subscriptionTypeId);\r\n                                    const active = filtered.filter(r => r.is_active !== false);\r\n                                    const archived = filtered.filter(r => r.is_active === false);\r\n\r\n                                    return (\r\n                                        <>\r\n                                            <optgroup label=\"Actuales\">\r\n                                                {active.length > 0 ? (\r\n                                                    active.map(r => (\r\n                                                        <option key={r.id} value={r.id}>\r\n                                                            {r.label} - {r.amount}€\r\n                                                        </option>\r\n                                                    ))\r\n                                                ) : (\r\n                                                    <option disabled>Sin tarifas actuales</option>\r\n                                                )}\r\n                                            </optgroup>\r\n                                            {archived.length > 0 && (\r\n                                                <optgroup label=\"Archivadas\">\r\n                                                    {archived.map(r => (\r\n                                                        <option key={r.id} value={r.id} className=\"text-gray-500\">\r\n                                                            {r.label} - {r.amount}€ (Archivada)\r\n                                                        </option>\r\n                                                    ))}\r\n                                                </optgroup>\r\n                                            )}\r\n                                        </>\r\n                                    );\r\n                                })()}\r\n                            </select>\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"form-label flex items-center gap-2\">\r\n                                <Users size={16} /> Nutricionista Asignado\r\n                            </label>\r\n                            <select\r\n                                className=\"form-select\"\r\n                                value={formData.nutritionistId}\r\n                                onChange={e => setFormData({ ...formData, nutritionistId: e.target.value })}\r\n                            >\r\n                                <option value=\"\">-- Sin asignar --</option>\r\n                                {nutritionists.filter(n => n.is_active !== false).map(n => (\r\n                                    <option key={n.id} value={n.id}>{n.label}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div>\r\n                        <label className=\"form-label flex items-center gap-2\">\r\n                            <Calendar size={16} /> Fecha de Inicio\r\n                        </label>\r\n                        <input\r\n                            type=\"date\"\r\n                            className=\"form-input\"\r\n                            value={formData.startDate}\r\n                            onChange={e => setFormData({ ...formData, startDate: e.target.value })}\r\n                            required\r\n                        />\r\n                    </div>\r\n\r\n                    <div>\r\n                        <label className=\"form-label flex items-center gap-2\">\r\n                            <Calendar size={16} /> Día de Revisión (Opcional)\r\n                        </label>\r\n                        <select\r\n                            className=\"form-select\"\r\n                            value={formData.reviewDay}\r\n                            onChange={e => setFormData({ ...formData, reviewDay: e.target.value })}\r\n                        >\r\n                            <option value=\"\">Automático (Mismo día que inicio)</option>\r\n                            <option value=\"1\">Lunes</option>\r\n                            <option value=\"2\">Martes</option>\r\n                            <option value=\"3\">Miércoles</option>\r\n                            <option value=\"4\">Jueves</option>\r\n                            <option value=\"5\">Viernes</option>\r\n                        </select>\r\n                        <p className=\"text-xs text-gray-500 mt-1\">Si seleccionas un día, todas las revisiones se moverán a ese día de la semana.</p>\r\n                    </div>\r\n\r\n                    <div className=\"pt-2 flex gap-3\">\r\n                        <button type=\"button\" onClick={onClose} className=\"btn btn-outline flex-1\">\r\n                            Cancelar\r\n                        </button>\r\n                        <button type=\"submit\" className=\"btn btn-primary flex-1\">\r\n                            Guardar e Iniciar\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PlanStartModal;\r\n"},{"path":"src/components/Patients/RenewalModal.jsx","content":"\r\nimport { useState, useEffect } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { X, RefreshCw, CreditCard, Clock } from 'lucide-react';\r\nimport { addMonths, format, parseISO, addDays } from 'date-fns';\r\n\r\nconst RenewalModal = ({ isOpen, onClose, patient, suggestedStartDate }) => {\r\n    const { updatePatient, subscriptionTypes, paymentRates, addSubscriptionHistory } = useData();\r\n    const [formData, setFormData] = useState({\r\n        subscriptionTypeId: '',\r\n        paymentRateId: '',\r\n        paymentRateId: '',\r\n        renewal_date: '',\r\n        price: '',\r\n        reviewDay: ''\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (patient && isOpen) {\r\n            // Default renewal date calculation\r\n            let defaultDate = new Date().toISOString().split('T')[0];\r\n\r\n            if (suggestedStartDate) {\r\n                defaultDate = suggestedStartDate;\r\n            } else if (patient.subscription?.endDate) {\r\n                const endDate = parseISO(patient.subscription.endDate);\r\n                // Default to SAME DAY as current subscription ends (to avoid drift)\r\n                defaultDate = format(endDate, 'yyyy-MM-dd');\r\n            }\r\n\r\n            // Defaults for type/rate\r\n            const currentTypeId = patient.subscription?.subscriptionTypeId || (subscriptionTypes.length > 0 ? subscriptionTypes[0].id : '');\r\n            const currentRateId = patient.subscription?.paymentRateId || (paymentRates.length > 0 ? paymentRates[0].id : '');\r\n\r\n            // Default price: either from current sub or from the defaulted rate\r\n            let currentPrice = '';\r\n            if (patient.subscription?.price) {\r\n                currentPrice = patient.subscription.price;\r\n            } else if (currentRateId) {\r\n                const rate = paymentRates.find(r => r.id === currentRateId);\r\n                if (rate) currentPrice = rate.amount;\r\n            }\r\n\r\n            setFormData({\r\n                subscriptionTypeId: currentTypeId,\r\n                paymentRateId: currentRateId,\r\n                paymentRateId: currentRateId,\r\n                renewal_date: defaultDate,\r\n                price: currentPrice,\r\n                reviewDay: patient.review_day || ''\r\n            });\r\n        }\r\n    }, [patient, isOpen, subscriptionTypes, paymentRates]);\r\n\r\n    // Update price when rate changes manually\r\n    const handleRateChange = (e) => {\r\n        const newRateId = e.target.value;\r\n        const rate = paymentRates.find(r => r.id === newRateId);\r\n        setFormData(prev => ({\r\n            ...prev,\r\n            paymentRateId: newRateId,\r\n            price: rate ? rate.amount : prev.price\r\n        }));\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n\r\n        const selectedType = subscriptionTypes.find(t => t.id === formData.subscriptionTypeId);\r\n        if (!selectedType) return;\r\n\r\n        const startDate = parseISO(formData.renewal_date);\r\n        const endDate = addMonths(startDate, selectedType.months);\r\n\r\n        // 1. Create NEW subscription record in history/subscriptions table\r\n        const newSubscription = {\r\n            patient_id: patient.id,\r\n            plan_name: selectedType.label,\r\n            subscription_type_id: selectedType.id,\r\n            payment_rate_id: formData.paymentRateId,\r\n            start_date: formData.renewal_date,\r\n            end_date: format(endDate, 'yyyy-MM-dd'),\r\n            price: parseFloat(formData.price),\r\n            status: 'active'\r\n        };\r\n\r\n        await addSubscriptionHistory(newSubscription);\r\n\r\n        // 2. Update Patient 'current' subscription cache\r\n        const updatedSubscriptionCache = {\r\n            type: selectedType.label,\r\n            subscriptionTypeId: selectedType.id,\r\n            paymentRateId: formData.paymentRateId,\r\n            price: parseFloat(formData.price),\r\n            startDate: formData.renewal_date,\r\n            endDate: format(endDate, 'yyyy-MM-dd'),\r\n            status: 'active',\r\n            endDate: format(endDate, 'yyyy-MM-dd'),\r\n            status: 'active',\r\n            paymentStatus: 'pending',\r\n            reviewDay: formData.reviewDay || patient.review_day // Keep existing if not changed (form doesn't have selector yet, so keep patient's)\r\n        };\r\n\r\n        await updatePatient(patient.id, { subscription: updatedSubscriptionCache });\r\n\r\n        onClose();\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-md overflow-hidden animate-fade-in\">\r\n                <div className=\"p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-primary/5\">\r\n                    <h3 className=\"text-lg font-bold text-primary flex items-center gap-2\">\r\n                        <RefreshCw size={20} /> Renovar Suscripción\r\n                    </h3>\r\n                    <button onClick={onClose} className=\"text-slate-400 hover:text-slate-600 dark:hover:text-slate-200\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit} className=\"p-6 space-y-4\">\r\n                    <div className=\"bg-blue-50 text-blue-800 p-3 rounded-lg text-sm mb-4 border border-blue-100\">\r\n                        Al renovar, se reiniciará el ciclo de facturación desde la fecha seleccionada.\r\n                    </div>\r\n\r\n                    {/* Type and Rate Selection */}\r\n                    <div className=\"grid grid-cols-1 gap-4\">\r\n                        <div>\r\n                            <label className=\"form-label flex items-center gap-2\">\r\n                                <Clock size={16} /> Tipo de Renovación\r\n                            </label>\r\n                            <select\r\n                                className=\"form-select\"\r\n                                value={formData.subscriptionTypeId}\r\n                                onChange={e => {\r\n                                    const newTypeId = e.target.value;\r\n                                    // Find valid rates for this new type\r\n                                    const validRates = paymentRates.filter(r => !r.subscription_type_id || r.subscription_type_id === newTypeId);\r\n                                    const activeRates = validRates.filter(r => r.is_active !== false);\r\n\r\n                                    const newRate = activeRates.length > 0 ? activeRates[0] : (validRates.length > 0 ? validRates[0] : null);\r\n\r\n                                    setFormData({\r\n                                        ...formData,\r\n                                        subscriptionTypeId: newTypeId,\r\n                                        paymentRateId: newRate ? newRate.id : '',\r\n                                        price: newRate ? newRate.amount : ''\r\n                                    });\r\n                                }}\r\n                                required\r\n                            >\r\n                                <option value=\"\" disabled>Seleccionar...</option>\r\n                                {subscriptionTypes.map(t => (\r\n                                    <option key={t.id} value={t.id}>{t.label} ({t.months} meses)</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"form-label flex items-center gap-2\">\r\n                                <CreditCard size={16} /> Tarifa Aplicable\r\n                            </label>\r\n                            <select\r\n                                className=\"form-select\"\r\n                                value={formData.paymentRateId}\r\n                                onChange={handleRateChange}\r\n                                required\r\n                            >\r\n                                <option value=\"\" disabled>Seleccionar...</option>\r\n                                {(() => {\r\n                                    const filtered = paymentRates.filter(r => !r.subscription_type_id || r.subscription_type_id === formData.subscriptionTypeId);\r\n                                    const active = filtered.filter(r => r.is_active !== false);\r\n                                    const archived = filtered.filter(r => r.is_active === false);\r\n\r\n                                    return (\r\n                                        <>\r\n                                            <optgroup label=\"Actuales\">\r\n                                                {active.length > 0 ? (\r\n                                                    active.map(r => (\r\n                                                        <option key={r.id} value={r.id}>\r\n                                                            {r.label} - {r.amount}€\r\n                                                        </option>\r\n                                                    ))\r\n                                                ) : (\r\n                                                    <option disabled>Sin tarifas actuales</option>\r\n                                                )}\r\n                                            </optgroup>\r\n                                            {archived.length > 0 && (\r\n                                                <optgroup label=\"Archivadas\">\r\n                                                    {archived.map(r => (\r\n                                                        <option key={r.id} value={r.id} className=\"text-gray-500\">\r\n                                                            {r.label} - {r.amount}€ (Archivada)\r\n                                                        </option>\r\n                                                    ))}\r\n                                                </optgroup>\r\n                                            )}\r\n                                        </>\r\n                                    );\r\n                                })()}\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        {/* Fecha Renovación */}\r\n                        <div>\r\n                            <label className=\"form-label\">Fecha Inicio Renovación</label>\r\n                            <input\r\n                                type=\"date\"\r\n                                className=\"form-input\"\r\n                                value={formData.renewal_date}\r\n                                onChange={e => setFormData({ ...formData, renewal_date: e.target.value })}\r\n                                required\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Precio */}\r\n                        <div>\r\n                            <label className=\"form-label\">Precio (€)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                step=\"0.01\"\r\n                                className=\"form-input\"\r\n                                value={formData.price}\r\n                                onChange={e => setFormData({ ...formData, price: e.target.value })}\r\n                                required\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex justify-end gap-3 mt-6\">\r\n                        <button type=\"button\" onClick={onClose} className=\"btn btn-secondary\">\r\n                            Cancelar\r\n                        </button>\r\n                        <button type=\"submit\" className=\"btn btn-primary\">\r\n                            Confirmar Renovación\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default RenewalModal;\r\n"},{"path":"src/components/Patients/ResumeModal.jsx","content":"import { useState, useMemo } from 'react';\r\nimport { X, Calendar, Play } from 'lucide-react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { differenceInDays, addDays, parseISO, format } from 'date-fns';\r\n\r\nconst ResumeModal = ({ isOpen, onClose, patient }) => {\r\n    const { togglePatientPause } = useData();\r\n    const [date, setDate] = useState(new Date().toISOString().split('T')[0]);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    const calculation = useMemo(() => {\r\n        if (!patient) return null;\r\n\r\n        try {\r\n            const openPause = patient.subscriptionPauses?.find(p => !p.end_date);\r\n            const pauseStart = patient.pause_start_date || patient.subscription?.pauseStartDate ?\r\n                parseISO(patient.pause_start_date || patient.subscription.pauseStartDate) : (openPause ? parseISO(openPause.start_date) : new Date());\r\n\r\n            const resumeDateObj = new Date(date);\r\n            if (isNaN(resumeDateObj.getTime())) return null;\r\n\r\n            const daysPaused = Math.max(0, differenceInDays(resumeDateObj, pauseStart));\r\n\r\n            const currentEndDate = patient.subscription_end || patient.subscription?.endDate ?\r\n                parseISO(patient.subscription_end || patient.subscription.endDate) : new Date();\r\n\r\n            const newEndDate = addDays(currentEndDate, daysPaused);\r\n\r\n            if (isNaN(newEndDate.getTime())) return null;\r\n\r\n            return {\r\n                pauseStart,\r\n                daysPaused,\r\n                originalEndDate: currentEndDate,\r\n                newEndDate\r\n            };\r\n        } catch (e) {\r\n            console.error(\"Error calculating resume dates:\", e);\r\n            return null;\r\n        }\r\n    }, [patient, date]);\r\n\r\n    if (!isOpen || !patient) return null;\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n        setLoading(true);\r\n        try {\r\n            await togglePatientPause(patient.id, date);\r\n            onClose();\r\n        } catch (error) {\r\n            console.error(\"Error resuming subscription:\", error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-sm overflow-hidden animate-fade-in\">\r\n                <div className=\"p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center\">\r\n                    <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">\r\n                        Reanudar Suscripción\r\n                    </h3>\r\n                    <button onClick={onClose} className=\"text-slate-400 hover:text-slate-600 dark:hover:text-slate-200\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit} className=\"p-6 space-y-4\">\r\n                    <div className=\"bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg text-sm text-blue-800 dark:text-blue-300\">\r\n                        <p>La fecha de fin se extenderá automáticamente según los días pausados.</p>\r\n                    </div>\r\n\r\n                    <div>\r\n                        <label className=\"form-label flex items-center gap-2\">\r\n                            <Calendar size={16} /> Fecha de Reanudación\r\n                        </label>\r\n                        <input\r\n                            type=\"date\"\r\n                            className=\"form-input\"\r\n                            value={date}\r\n                            onChange={e => setDate(e.target.value)}\r\n                            required\r\n                        />\r\n                    </div>\r\n\r\n                    {calculation && (\r\n                        <div className=\"space-y-2 text-sm border-t border-slate-100 dark:border-slate-700 pt-3\">\r\n                            <div className=\"flex justify-between\">\r\n                                <span className=\"text-slate-500\">Días pausados:</span>\r\n                                <span className=\"font-medium text-slate-700 dark:text-slate-200\">{calculation.daysPaused} días</span>\r\n                            </div>\r\n                            <div className=\"flex justify-between\">\r\n                                <span className=\"text-slate-500\">Fin anterior:</span>\r\n                                <span className=\"font-medium text-slate-700 dark:text-slate-200\">{format(calculation.originalEndDate, 'dd/MM/yyyy')}</span>\r\n                            </div>\r\n                            <div className=\"flex justify-between\">\r\n                                <span className=\"text-slate-500\">Nuevo fin:</span>\r\n                                <span className=\"font-bold text-green-600 dark:text-green-400\">{format(calculation.newEndDate, 'dd/MM/yyyy')}</span>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    <div className=\"pt-2 flex gap-3\">\r\n                        <button type=\"button\" onClick={onClose} className=\"btn btn-outline flex-1\">\r\n                            Cancelar\r\n                        </button>\r\n                        <button type=\"submit\" disabled={loading} className=\"btn btn-primary flex-1\">\r\n                            {loading ? 'Guardando...' : 'Confirmar'}\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ResumeModal;\r\n"},{"path":"src/components/Patients/SubscriptionEditModal.jsx","content":"import { useState, useEffect } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { X, AlertTriangle, Save } from 'lucide-react';\r\nimport { addDays, addMonths, format, parseISO, differenceInDays } from 'date-fns';\r\n\r\nconst SubscriptionEditModal = ({ isOpen, onClose, patient, subscriptionData, onSave }) => {\r\n    const { updatePatient, plans, subscriptionTypes, paymentRates } = useData();\r\n    const [formData, setFormData] = useState({\r\n        subscriptionTypeId: '',\r\n        paymentRateId: '',\r\n        startDate: '',\r\n        endDate: '',\r\n        status: ''\r\n    });\r\n\r\n    useEffect(() => {\r\n        const source = subscriptionData || (patient && patient.subscription);\r\n        if (source) {\r\n            // Attempt to match existing data to new IDs if possible, or fallback to defaults\r\n            // Logic: match type label -> subscriptionType\r\n            // Logic: match price/name -> paymentRate\r\n            const sourceTypeName = source.plan_name || source.type; // \"Mensual\", etc.\r\n            const matchedType = subscriptionTypes.find(t => t.label === sourceTypeName) || subscriptionTypes[0];\r\n\r\n            // For rate, we might need to guess or pick one. If we have a stored ID uses it.\r\n            // If migrating, we might not have IDs yet on the patient, but we populated the tables.\r\n            // We can match by price if available, or just pick the first standard one.\r\n            const sourcePrice = source.price || 0;\r\n            const matchedRate = paymentRates.find(r => r.amount === sourcePrice) || paymentRates[0];\r\n\r\n            const start = source.start_date || source.startDate;\r\n            const end = source.end_date || source.endDate;\r\n            const status = source.status || 'active';\r\n\r\n            setFormData({\r\n                subscriptionTypeId: source.subscription_type_id || matchedType?.id || '',\r\n                paymentRateId: source.payment_rate_id || matchedRate?.id || '',\r\n                startDate: start || '',\r\n                endDate: end || '',\r\n                status: status\r\n            });\r\n        } else if (isOpen) {\r\n            // Defaults for new subscription\r\n            if (subscriptionTypes.length > 0 && paymentRates.length > 0) {\r\n                setFormData(prev => ({\r\n                    ...prev,\r\n                    subscriptionTypeId: prev.subscriptionTypeId || subscriptionTypes[0].id,\r\n                    paymentRateId: prev.paymentRateId || paymentRates[0].id\r\n                }));\r\n            }\r\n        }\r\n    }, [patient, subscriptionData, subscriptionTypes, paymentRates, isOpen]);\r\n\r\n    // Auto-calculate end date when start date or type changes\r\n    useEffect(() => {\r\n        if (formData.startDate && formData.subscriptionTypeId) {\r\n            const type = subscriptionTypes.find(t => t.id === formData.subscriptionTypeId);\r\n            if (type && type.months) {\r\n                const newEndDate = addMonths(parseISO(formData.startDate), type.months);\r\n                setFormData(prev => ({\r\n                    ...prev,\r\n                    endDate: format(newEndDate, 'yyyy-MM-dd')\r\n                }));\r\n            }\r\n        }\r\n    }, [formData.startDate, formData.subscriptionTypeId, subscriptionTypes]);\r\n\r\n    if (!isOpen || !patient) return null;\r\n\r\n    const selectedType = subscriptionTypes.find(t => t.id === formData.subscriptionTypeId);\r\n    const selectedRate = paymentRates.find(r => r.id === formData.paymentRateId);\r\n\r\n    // Preview changes logic\r\n    const oldStartDate = patient.subscription?.startDate;\r\n    const itemsChanged = [];\r\n    if (!subscriptionData && oldStartDate && formData.startDate !== oldStartDate) {\r\n        itemsChanged.push(\"Las fechas de las mensualidades se recalcularán.\");\r\n    }\r\n    // Simplification: just warn if core values change\r\n    if (!subscriptionData && (patient.subscription?.type !== selectedType?.label || patient.subscription?.price !== selectedRate?.amount)) {\r\n        itemsChanged.push(\"El tipo de suscripción o precio cambiarán.\");\r\n    }\r\n\r\n    const handleSave = async (e) => {\r\n        if (e) e.preventDefault();\r\n\r\n        if (!selectedType || !selectedRate || !formData.startDate) return;\r\n\r\n        // Common payload data\r\n        const payload = {\r\n            subscription_type_id: formData.subscriptionTypeId,\r\n            payment_rate_id: formData.paymentRateId,\r\n            plan_name: selectedType.label, // Legacy/Display\r\n            type: selectedType.label,     // Legacy/Display\r\n            price: selectedRate.amount,\r\n            start_date: formData.startDate,\r\n            end_date: formData.endDate,\r\n            status: formData.status\r\n        };\r\n\r\n        if (onSave) {\r\n            await onSave(payload);\r\n        } else {\r\n            // Prepare updated subscription object for normalized patient\r\n            const updatedSubscription = {\r\n                ...patient.subscription,\r\n                type: selectedType.label,\r\n                subscriptionTypeId: formData.subscriptionTypeId,\r\n                paymentRateId: formData.paymentRateId,\r\n                startDate: formData.startDate,\r\n                endDate: formData.endDate,\r\n                status: formData.status,\r\n                price: selectedRate.amount\r\n            };\r\n\r\n            await updatePatient(patient.id, {\r\n                subscription: updatedSubscription,\r\n                // Update new DB columns\r\n                subscription_type_id: formData.subscriptionTypeId,\r\n                payment_rate_id: formData.paymentRateId,\r\n                // Legacy columns update\r\n                subscription_type: selectedType.label,\r\n                subscription_start: formData.startDate,\r\n                subscription_end: formData.endDate,\r\n                subscription_status: formData.status\r\n            });\r\n        }\r\n        onClose();\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]\">\r\n                <div className=\"p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center\">\r\n                    <div>\r\n                        <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">Editar Suscripción</h3>\r\n                        <p className=\"text-sm text-slate-500 dark:text-slate-400\">Modificar condiciones del contrato</p>\r\n                    </div>\r\n                    <button onClick={onClose} className=\"text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSave} className=\"p-6 overflow-y-auto space-y-6\">\r\n\r\n                    {itemsChanged.length > 0 && (\r\n                        <div className=\"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 text-sm text-amber-800 dark:text-amber-200 flex gap-2 items-start\">\r\n                            <AlertTriangle size={16} className=\"mt-0.5 shrink-0\" />\r\n                            <div>\r\n                                <p className=\"font-bold mb-1\">Atención:</p>\r\n                                <ul className=\"list-disc pl-4 space-y-1\">\r\n                                    {itemsChanged.map((msg, i) => <li key={i}>{msg}</li>)}\r\n                                </ul>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    <div className=\"grid grid-cols-1 gap-4\">\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div className=\"form-group\">\r\n                                <label className=\"form-label\">Tipo de Suscripción</label>\r\n                                <select\r\n                                    className=\"form-select\"\r\n                                    value={formData.subscriptionTypeId}\r\n                                    onChange={(e) => setFormData(prev => ({ ...prev, subscriptionTypeId: e.target.value }))}\r\n                                    required\r\n                                >\r\n                                    <option value=\"\" disabled>Seleccionar...</option>\r\n                                    {subscriptionTypes.map(t => (\r\n                                        <option key={t.id} value={t.id}>{t.label} ({t.months} {t.months === 1 ? 'mes' : 'meses'})</option>\r\n                                    ))}\r\n                                </select>\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label className=\"form-label\">Tarifa Aplicable</label>\r\n                                <select\r\n                                    className=\"form-select\"\r\n                                    value={formData.paymentRateId}\r\n                                    onChange={(e) => setFormData(prev => ({ ...prev, paymentRateId: e.target.value }))}\r\n                                    required\r\n                                >\r\n                                    <option value=\"\" disabled>Seleccionar...</option>\r\n                                    {paymentRates.map(r => {\r\n                                        // Show if:\r\n                                        // 1. It is the currently selected one (even if inactive/wrong type)\r\n                                        // 2. OR it is Active AND matches the type (or is generic)\r\n                                        const isSelected = r.id === formData.paymentRateId;\r\n                                        const isActive = r.is_active !== false;\r\n                                        const isLinkedOrGeneric = !r.subscription_type_id || r.subscription_type_id === formData.subscriptionTypeId;\r\n\r\n                                        if (isSelected || (isActive && isLinkedOrGeneric)) {\r\n                                            return (\r\n                                                <option key={r.id} value={r.id}>\r\n                                                    {r.label} - {r.amount}€\r\n                                                    {!isActive ? ' (Archivada)' : ''}\r\n                                                    {r.subscription_type_id && r.subscription_type_id !== formData.subscriptionTypeId ? ' (Otro Plan)' : ''}\r\n                                                </option>\r\n                                            );\r\n                                        }\r\n                                        return null;\r\n                                    })}\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div className=\"form-group\">\r\n                                <label className=\"form-label\">Fecha Inicio</label>\r\n                                <input\r\n                                    type=\"date\"\r\n                                    className=\"form-input\"\r\n                                    value={formData.startDate}\r\n                                    onChange={(e) => setFormData(prev => ({ ...prev, startDate: e.target.value }))}\r\n                                    required\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label className=\"form-label flex justify-between\">\r\n                                    Fecha Fin\r\n                                    <span className=\"text-xs font-normal text-slate-400\">Calculada automáticamente</span>\r\n                                </label>\r\n                                <input\r\n                                    type=\"date\"\r\n                                    className=\"form-input bg-slate-50 text-slate-500\"\r\n                                    value={formData.endDate}\r\n                                    onChange={(e) => setFormData(prev => ({ ...prev, endDate: e.target.value }))}\r\n                                    required\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"form-group\">\r\n                            <label className=\"form-label\">Estado</label>\r\n                            <select\r\n                                className=\"form-select\"\r\n                                value={formData.status}\r\n                                onChange={(e) => setFormData(prev => ({ ...prev, status: e.target.value }))}\r\n                            >\r\n                                <option value=\"active\">Activo</option>\r\n                                <option value=\"paused\">Pausado</option>\r\n                                <option value=\"finished\">Finalizado</option>\r\n                                <option value=\"archived\">Archivado (Histórico)</option>\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n                </form>\r\n\r\n                <div className=\"p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex justify-end gap-3\">\r\n                    <button type=\"button\" onClick={onClose} className=\"btn btn-ghost text-slate-500 hover:text-slate-700\">\r\n                        Cancelar\r\n                    </button>\r\n                    <button onClick={() => handleSave()} className=\"btn btn-primary\">\r\n                        <Save size={18} /> Guardar Cambios\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SubscriptionEditModal;\r\n"},{"path":"src/components/Patients/Modals/EditExtensionModal.jsx","content":"import { useState, useEffect } from 'react';\r\n\r\nconst EditExtensionModal = ({ isOpen, onClose, extension, onConfirm }) => {\r\n    const [days, setDays] = useState(0);\r\n\r\n    useEffect(() => {\r\n        if (extension) {\r\n            setDays(extension.days_added);\r\n        }\r\n    }, [extension]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-2xl shadow-xl max-w-md w-full p-6\">\r\n                <h3 className=\"text-lg font-bold text-slate-900 dark:text-white mb-4\">Editar Extensión</h3>\r\n                <p className=\"text-slate-600 dark:text-slate-300 mb-6 text-sm\">\r\n                    Modificar los días añadidos ajustará automáticamente la fecha de fin del cliente.\r\n                </p>\r\n\r\n                <div className=\"mb-6\">\r\n                    <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\r\n                        Días añadidos\r\n                    </label>\r\n                    <input\r\n                        type=\"number\"\r\n                        min=\"1\"\r\n                        value={days}\r\n                        onChange={(e) => setDays(e.target.value)}\r\n                        className=\"w-full px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-primary-500 outline-none transition-all\"\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"flex justify-end gap-3\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"px-4 py-2 text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 rounded-xl transition-colors\"\r\n                    >\r\n                        Cancelar\r\n                    </button>\r\n                    <button\r\n                        onClick={() => onConfirm(extension.id, days)}\r\n                        className=\"px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-xl shadow-lg shadow-primary-600/20 transition-all font-medium\"\r\n                    >\r\n                        Guardar Cambios\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default EditExtensionModal;\r\n"},{"path":"src/components/Patients/Modals/ExtendSubscriptionModal.jsx","content":"import { useState } from 'react';\r\nimport { Clock } from 'lucide-react';\r\n\r\nconst ExtendSubscriptionModal = ({ isOpen, onClose, onConfirm, onViewHistory }) => {\r\n    const [days, setDays] = useState(7);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-2xl shadow-xl max-w-md w-full p-6\">\r\n                <div className=\"flex justify-between items-start mb-4\">\r\n                    <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">Extender Suscripción</h3>\r\n                    <button onClick={onViewHistory} className=\"text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1 font-medium bg-primary-50 px-2 py-1 rounded-lg\">\r\n                        <Clock size={12} /> Ver Historial\r\n                    </button>\r\n                </div>\r\n\r\n                <p className=\"text-slate-600 dark:text-slate-300 mb-6\">\r\n                    Añade días extra a la suscripción actual para compensar vacaciones o pausas.\r\n                    La fecha de fin se moverá hacia adelante.\r\n                </p>\r\n\r\n                <div className=\"mb-6\">\r\n                    <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\r\n                        Días a añadir\r\n                    </label>\r\n                    <input\r\n                        type=\"number\"\r\n                        min=\"1\"\r\n                        value={days}\r\n                        onChange={(e) => setDays(e.target.value)}\r\n                        className=\"w-full px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-primary-500 outline-none transition-all\"\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"flex justify-end gap-3\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"px-4 py-2 text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 rounded-xl transition-colors\"\r\n                    >\r\n                        Cancelar\r\n                    </button>\r\n                    <button\r\n                        onClick={() => onConfirm(days)}\r\n                        className=\"px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-xl shadow-lg shadow-primary-600/20 transition-all font-medium\"\r\n                    >\r\n                        Añadir Días\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ExtendSubscriptionModal;\r\n"},{"path":"src/components/Patients/Modals/ExtensionHistoryModal.jsx","content":"import { Clock, XCircle } from 'lucide-react';\r\nimport { format, parseISO } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\n\r\nconst ExtensionHistoryModal = ({ isOpen, onClose, extensions }) => {\r\n    if (!isOpen) return null;\r\n\r\n    // Use es locale for displaying dates but ensure default formatter works if es is null? \r\n    // Usually pass locale prop to format.\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-2xl shadow-xl max-w-lg w-full p-6\">\r\n                <div className=\"flex justify-between items-center mb-6\">\r\n                    <h3 className=\"text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2\">\r\n                        <Clock size={20} className=\"text-primary-500\" />\r\n                        Historial de Extensiones\r\n                    </h3>\r\n                    <button onClick={onClose} className=\"p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors\">\r\n                        <XCircle size={20} className=\"text-slate-400\" />\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"max-h-[60vh] overflow-y-auto pr-2\">\r\n                    {extensions && extensions.length > 0 ? (\r\n                        <div className=\"space-y-3\">\r\n                            {extensions.map((ext) => (\r\n                                <div key={ext.id} className=\"bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700\">\r\n                                    <div className=\"flex justify-between items-start mb-2\">\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            <span className=\"text-2xl font-bold text-primary-600\">+{ext.days_added}</span>\r\n                                            <span className=\"text-sm font-medium text-slate-600 dark:text-slate-400\">días añadidos</span>\r\n                                        </div>\r\n                                        <div className=\"text-xs text-slate-400\">\r\n                                            {format(parseISO(ext.created_at), 'dd MMM yyyy, HH:mm', { locale: es })}\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-4 text-xs text-slate-500 dark:text-slate-400 mt-2 pt-2 border-t border-slate-200 dark:border-slate-700\">\r\n                                        <div>\r\n                                            <span className=\"block mb-0.5 text-[10px] uppercase tracking-wider text-slate-400\">Fin Anterior</span>\r\n                                            <span className=\"font-mono\">{format(parseISO(ext.previous_end_date), 'dd/MM/yyyy')}</span>\r\n                                        </div>\r\n                                        <div className=\"text-slate-300\">→</div>\r\n                                        <div>\r\n                                            <span className=\"block mb-0.5 text-[10px] uppercase tracking-wider text-primary-500\">Nuevo Fin</span>\r\n                                            <span className=\"font-mono font-medium text-slate-700 dark:text-slate-300\">{format(parseISO(ext.new_end_date), 'dd/MM/yyyy')}</span>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"text-center py-8 text-slate-500 dark:text-slate-400\">\r\n                            No hay extensiones registradas.\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"mt-6 flex justify-end\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-xl transition-colors font-medium\"\r\n                    >\r\n                        Cerrar\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ExtensionHistoryModal;\r\n"},{"path":"src/components/Patients/Tabs/InformationTab.jsx","content":"import { Edit2, PenLine } from 'lucide-react';\r\nimport { useData } from '../../../context/DataContext';\r\nimport { safeFormat, calculateAge } from '../../../utils/dateUtils';\r\nimport { differenceInDays, parseISO } from 'date-fns';\r\n\r\nconst InformationTab = ({ patient, onEditSubscription }) => {\r\n    const { clinicalCategories, updatePatient, referralSources, nutritionists } = useData();\r\n\r\n    const getStatusInfo = (patient) => {\r\n        const today = new Date().toISOString().split('T')[0];\r\n        const { startDate, endDate, status } = patient.subscription || {};\r\n\r\n        if (startDate && startDate > today) {\r\n            // Check for any currently active subscription in history\r\n            const activeSub = patient.subscriptionHistory?.find(sub =>\r\n                sub.status === 'active' &&\r\n                sub.start_date <= today &&\r\n                (!sub.end_date || sub.end_date >= today)\r\n            );\r\n\r\n            if (activeSub) {\r\n                return {\r\n                    label: 'Activo',\r\n                    badgeClass: 'badge badge-success'\r\n                };\r\n            }\r\n\r\n            return {\r\n                label: 'Esperando inicio',\r\n                badgeClass: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300'\r\n            };\r\n        }\r\n\r\n        const isExpired = endDate && endDate < today && status === 'active';\r\n        const displayStatus = isExpired ? 'expired' : (status || 'inactive');\r\n\r\n        const classes = {\r\n            'active': 'success',\r\n            'paused': 'warning',\r\n            'cancelled': 'danger',\r\n            'expired': 'secondary',\r\n            'inactive': 'secondary'\r\n        }[displayStatus] || 'secondary';\r\n\r\n        const labels = {\r\n            'active': 'Activo',\r\n            'paused': 'Pausado',\r\n            'cancelled': 'Cancelado',\r\n            'expired': 'Caducado',\r\n            'inactive': 'A la espera'\r\n        }[displayStatus] || displayStatus;\r\n\r\n        return {\r\n            label: labels,\r\n            badgeClass: `badge badge-${classes} ${displayStatus === 'expired' ? 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300' : ''}`\r\n        };\r\n    };\r\n\r\n    const statusInfo = getStatusInfo(patient);\r\n\r\n    return (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto\">\r\n            <div className=\"card\">\r\n                <div className=\"card-header border-b border-gray-100 dark:border-gray-700\">\r\n                    <h3 className=\"card-title text-primary dark:text-primary-400 font-bold\">Información Personal</h3>\r\n                </div>\r\n                <dl className=\"space-y-4 p-6\">\r\n                    <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                        <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Fecha de Nacimiento</dt>\r\n                        <dd className=\"font-medium text-slate-800 dark:text-slate-200\">\r\n                            {patient.birth_date ? (\r\n                                <>\r\n                                    {safeFormat(patient.birth_date)}\r\n                                    <span className=\"text-slate-500 dark:text-slate-400 ml-2\">({calculateAge(patient.birth_date)} años)</span>\r\n                                </>\r\n                            ) : '-'}\r\n                        </dd>\r\n                    </div>\r\n                    {/* ... (rest of personal info content identical to original, just ensuring correct imports) ... */}\r\n                    <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                        <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Teléfono</dt>\r\n                        <dd className=\"font-medium text-slate-800 dark:text-slate-200\">{patient.phone}</dd>\r\n                    </div>\r\n                    <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                        <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Email</dt>\r\n                        <dd className=\"font-medium text-slate-800 dark:text-slate-200\">{patient.email}</dd>\r\n                    </div>\r\n                    <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                        <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Ciudad</dt>\r\n                        <dd className=\"font-medium text-slate-800 dark:text-slate-200\">{patient.city || '-'}</dd>\r\n                    </div>\r\n                    <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                        <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Cómo nos conoció</dt>\r\n                        <dd className=\"font-medium text-slate-800 dark:text-slate-200\">\r\n                            {referralSources?.find(r => r.id === patient.referral_source)?.label || patient.referral_source || '-'}\r\n                        </dd>\r\n                    </div>\r\n                    <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                        <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Nutricionista</dt>\r\n                        <dd className=\"font-medium text-slate-800 dark:text-slate-200\">\r\n                            {nutritionists?.find(n => n.id === patient.nutritionist_id)?.label || '-'}\r\n                        </dd>\r\n                    </div>\r\n                    <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                        <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Día de Revisión</dt>\r\n                        <dd className=\"font-medium text-slate-800 dark:text-slate-200\">\r\n                            {patient.review_day ? ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'][parseInt(patient.review_day) - 1] || 'Sin definir' : '-'}\r\n                        </dd>\r\n                    </div>\r\n                </dl>\r\n            </div>\r\n\r\n            <div className=\"card relative group\">\r\n                <div className=\"card-header border-b border-gray-100 dark:border-gray-700 flex justify-between items-center\">\r\n                    <h3 className=\"card-title text-primary dark:text-primary-400 font-bold\">Suscripción</h3>\r\n                    <button\r\n                        onClick={() => onEditSubscription()}\r\n                        className=\"p-1 text-slate-400 hover:text-primary-600 transition-colors rounded hover:bg-slate-100 dark:hover:bg-slate-700\"\r\n                        title=\"Editar suscripción\"\r\n                    >\r\n                        <Edit2 size={16} />\r\n                    </button>\r\n                </div>\r\n                <dl className=\"space-y-4 p-6\">\r\n                    <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                        <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Plan</dt>\r\n                        <dd className=\"font-medium capitalize text-slate-800 dark:text-slate-200\">{patient.subscription?.type}</dd>\r\n                    </div>\r\n                    <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                        <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Inicio</dt>\r\n                        <dd className=\"font-medium text-slate-800 dark:text-slate-200\">\r\n                            {safeFormat(patient.subscription?.startDate, 'dd/MM/yyyy')}\r\n                        </dd>\r\n                    </div>\r\n                    <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                        <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Fin</dt>\r\n                        <dd className=\"font-medium text-slate-800 dark:text-slate-200\">\r\n                            {safeFormat(patient.subscription?.endDate, 'dd/MM/yyyy')}\r\n                        </dd>\r\n                    </div>\r\n                    {patient.days_remaining !== undefined && patient.days_remaining !== null && (\r\n                        <div className=\"flex justify-between border-b border-gray-50 dark:border-slate-700 pb-2\">\r\n                            <dt className=\"text-slate-500 dark:text-slate-400 text-sm\">Días Restantes</dt>\r\n                            <dd className={`font-bold ${patient.days_remaining < 0 ? 'text-red-500' : patient.days_remaining <= 5 ? 'text-amber-500' : 'text-green-600'}`}>\r\n                                {patient.days_remaining < 0 ? `Vencido hace ${Math.abs(patient.days_remaining)} días` : `${patient.days_remaining} días`}\r\n                            </dd>\r\n                        </div>\r\n                    )}\r\n                    <div className=\"flex justify-between pt-2\">\r\n                        <dt className=\"text-muted text-sm\">Estado</dt>\r\n                        <dd>\r\n                            <span className={statusInfo.badgeClass}>\r\n                                {statusInfo.label}\r\n                            </span>\r\n                        </dd>\r\n                    </div>\r\n                </dl>\r\n            </div>\r\n\r\n            {/* Notas / Anotaciones */}\r\n            <div className=\"card md:col-span-2\">\r\n                <div className=\"card-header border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-amber-50/50 dark:bg-amber-900/10\">\r\n                    <h3 className=\"card-title text-amber-700 dark:text-amber-500 font-bold flex items-center gap-2\">\r\n                        <PenLine size={18} /> Anotaciones\r\n                    </h3>\r\n                    <span className=\"text-xs text-amber-600/60 dark:text-amber-500/60 font-medium\">Se guarda automáticamente</span>\r\n                </div>\r\n                <div className=\"p-0\">\r\n                    <textarea\r\n                        className=\"w-full min-h-[120px] p-6 text-sm text-slate-700 dark:text-slate-300 bg-transparent border-none focus:ring-0 focus:bg-amber-50/30 dark:focus:bg-amber-900/20 transition-colors resize-y outline-none placeholder:text-slate-300 dark:placeholder:text-slate-600\"\r\n                        placeholder=\"Escribe aquí notas privadas sobre el seguimiento, detalles importantes o recordatorios...\"\r\n                        defaultValue={patient.notes || ''}\r\n                        onBlur={(e) => {\r\n                            if (e.target.value !== (patient.notes || '')) {\r\n                                updatePatient(patient.id, { notes: e.target.value });\r\n                            }\r\n                        }}\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"card md:col-span-2\">\r\n                <div className=\"card-header border-b border-gray-100 dark:border-gray-700\">\r\n                    <h3 className=\"card-title text-primary dark:text-primary-400 font-bold\">Objetivos y Salud</h3>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 p-6\">\r\n                    <div>\r\n                        <h4 className=\"text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2\">Objetivo Nutricional</h4>\r\n                        <p className=\"bg-gray-50 dark:bg-slate-700/30 p-4 rounded-lg text-sm leading-relaxed text-slate-700 dark:text-slate-300\">{patient.goals || 'No especificado'}</p>\r\n                    </div>\r\n                    <div>\r\n                        <h4 className=\"text-xs font-bold text-red-500 uppercase mb-2\">Alergias / Intolerancias</h4>\r\n                        <div className=\"bg-red-50 dark:bg-red-900/20 p-4 rounded-lg text-sm text-red-800 dark:text-red-300 border border-red-100 dark:border-red-800/30\">\r\n                            {patient.allergies || 'Ninguna conocida'}\r\n                        </div>\r\n                    </div>\r\n                    {clinicalCategories?.map(category => {\r\n                        let fieldName = category.id;\r\n                        if (category.id === 'pathology') fieldName = 'pathologies';\r\n                        if (category.id === 'dislike') fieldName = 'disliked_foods';\r\n\r\n                        const value = patient[fieldName] || patient[category.id] || patient.clinical_data?.[category.id];\r\n\r\n                        if (!category.is_active && !value) return null;\r\n\r\n                        return (\r\n                            <div key={category.id}>\r\n                                <h4 className={`text-xs font-bold uppercase mb-2 ${category.color ? category.color.replace('bg-', 'text-').replace('100', '500') : 'text-slate-500 dark:text-slate-400'}`}>\r\n                                    {category.label}\r\n                                </h4>\r\n                                <div className={`p-4 rounded-lg text-sm border ${category.color ? category.color.replace('text-', 'text-opacity-80 text-') : 'bg-slate-50 dark:bg-slate-700/30 text-slate-700 dark:text-slate-300 border-slate-100 dark:border-slate-700'}`}>\r\n                                    {value || 'No especificado'}\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default InformationTab;\r\n"},{"path":"src/components/Patients/Tabs/PaymentsTab.jsx","content":"import { useData } from '../../../context/DataContext';\r\nimport { safeFormat } from '../../../utils/dateUtils';\r\nimport { Wallet, Plus, CheckCircle, Clock, Edit2, Trash2 } from 'lucide-react';\r\nimport { parseISO, format } from 'date-fns';\r\n\r\nconst PaymentsTab = ({ patientId, onAddPayment, onEditPayment, onDeletePayment, onEditSubscription, subscriptionTerms = [], onEditExtension }) => {\r\n    const { payments = [], paymentMethods = [], patients = [], paymentRates = [], deleteSubscription, subscriptionExtensions = [], deleteSubscriptionExtension } = useData() || {};\r\n\r\n    // Sort payments\r\n    const patientPayments = (payments || []).filter(p => p && p.patient_id === patientId)\r\n        .sort((a, b) => {\r\n            if (!a?.date || !b?.date) return 0;\r\n            return new Date(b.date) - new Date(a.date);\r\n        });\r\n\r\n    const totalPaid = (patientPayments || []).filter(p => p.status === 'pagado').reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);\r\n\r\n    // Calculate pending from existing payments\r\n    const pendingPaymentsAmount = (patientPayments || []).filter(p => p.status === 'pendiente').reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);\r\n\r\n    // Calculate pending from unpaid subscriptions (that don't have a pending payment record yet)\r\n    const unpaidSubscriptionsAmount = subscriptionTerms\r\n        .filter(term => !term.isPaid && term.status !== 'archived' && term.status !== 'cancelled')\r\n        .reduce((sum, term) => {\r\n            // Check if this term already has a payment record (even if pending) to avoid double counting\r\n            const hasPaymentRecord = (patientPayments || []).some(p => p.subscription_id === term.id);\r\n            if (!hasPaymentRecord) {\r\n                return sum + (parseFloat(term.price) || parseFloat(term.amount) || 0);\r\n            }\r\n            return sum;\r\n        }, 0);\r\n\r\n    const totalPending = pendingPaymentsAmount + unpaidSubscriptionsAmount;\r\n\r\n    if ((patientPayments || []).length === 0 && subscriptionTerms.length === 0) {\r\n        return (\r\n            <div className=\"text-center py-16 bg-white dark:bg-slate-800 rounded-xl border border-dashed border-gray-200 dark:border-slate-700\">\r\n                <Wallet className=\"text-gray-300 dark:text-slate-600 mb-4 mx-auto\" size={48} />\r\n                <p className=\"text-gray-500 dark:text-slate-400 font-medium\">No hay pagos ni suscripción activa.</p>\r\n                <p className=\"text-sm text-gray-400 dark:text-slate-500 mb-4\">Los pagos de este cliente aparecerán aquí.</p>\r\n                <button onClick={() => onAddPayment()} className=\"btn btn-primary\">\r\n                    <Plus size={18} /> Registrar Primer Pago\r\n                </button>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Summary Cards */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                <div className=\"card flex items-center justify-between\">\r\n                    <div>\r\n                        <p className=\"text-sm text-slate-500 dark:text-slate-400 font-medium\">Total Pagado</p>\r\n                        <h3 className=\"text-xl font-bold text-green-600 dark:text-green-400\">€{totalPaid.toFixed(2)}</h3>\r\n                    </div>\r\n                    <div className=\"bg-green-100 dark:bg-green-900/30 p-2 rounded-full text-green-600 dark:text-green-400\">\r\n                        <CheckCircle size={20} />\r\n                    </div>\r\n                </div>\r\n                <div className=\"card flex items-center justify-between\">\r\n                    <div>\r\n                        <p className=\"text-sm text-slate-500 dark:text-slate-400 font-medium\">Pendiente</p>\r\n                        <h3 className=\"text-xl font-bold text-amber-600 dark:text-amber-400\">€{totalPending.toFixed(2)}</h3>\r\n                    </div>\r\n                    <div className=\"bg-amber-100 dark:bg-amber-900/30 p-2 rounded-full text-amber-600 dark:text-amber-400\">\r\n                        <Clock size={20} />\r\n                    </div>\r\n                </div>\r\n                <div className=\"card flex items-center justify-between\">\r\n                    <div>\r\n                        <p className=\"text-sm text-slate-500 dark:text-slate-400 font-medium\">Transacciones</p>\r\n                        <h3 className=\"text-xl font-bold text-slate-900 dark:text-white\">{(patientPayments || []).length}</h3>\r\n                    </div>\r\n                    <div className=\"bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-600 dark:text-slate-400\">\r\n                        <Wallet size={20} />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Billing Periods (Renovations) Table */}\r\n            {subscriptionTerms.length > 0 ? (\r\n                <div className=\"card overflow-hidden p-0 mb-6\">\r\n                    <div className=\"card-header border-b border-gray-100 dark:border-gray-700 bg-slate-50 dark:bg-slate-800/50 px-4 py-3\">\r\n                        <h3 className=\"card-title text-sm font-bold text-slate-700 dark:text-slate-300\">Renovaciones y Periodos</h3>\r\n                    </div>\r\n                    <div className=\"overflow-x-auto\">\r\n                        <table className=\"w-full text-sm text-left\">\r\n                            <thead className=\"bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-b border-gray-100 dark:border-gray-700\">\r\n                                <tr>\r\n                                    <th className=\"py-3 px-4 font-medium\">Renovación / Plan</th>\r\n                                    <th className=\"py-3 px-4 font-medium\">Días Extra</th>\r\n                                    <th className=\"py-3 px-4 font-medium\">Estado</th>\r\n                                    <th className=\"py-3 px-4 font-medium\">Tarifa</th>\r\n                                    <th className=\"py-3 px-4 font-medium text-right\">Acción</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody className=\"divide-y divide-gray-100 dark:divide-gray-700\">\r\n                                {subscriptionTerms.map(term => {\r\n                                    const isCurrent = term.type === 'current';\r\n\r\n                                    return (\r\n                                        <tr key={term.id} className={`hover:bg-slate-50 dark:hover:bg-slate-800/50 ${isCurrent ? 'bg-amber-50/50 dark:bg-amber-900/10' : ''} ${term.status === 'archived' ? 'bg-gray-50/50 dark:bg-gray-800/30' : ''}`}>\r\n                                            <td className=\"py-3 px-4 font-medium text-slate-700 dark:text-slate-200\">\r\n                                                <div className=\"flex flex-col gap-0.5\">\r\n                                                    <div className=\"font-bold flex flex-wrap items-center gap-2\">\r\n                                                        <span>{term.label}</span>\r\n                                                        {term.status === 'archived' && <span className=\"text-[10px] uppercase bg-slate-200 text-slate-500 rounded px-1.5 py-0.5 whitespace-nowrap\">Archivado</span>}\r\n                                                        {isCurrent && <span className=\"text-[10px] uppercase bg-primary-100 text-primary-700 rounded px-1.5 py-0.5 whitespace-nowrap\">Actual</span>}\r\n                                                    </div>\r\n                                                    <span className=\"text-xs text-slate-500 font-normal\">\r\n                                                        {safeFormat(term.start, 'dd/MM/yyyy')} - {safeFormat(term.end, 'dd/MM/yyyy')}\r\n                                                    </span>\r\n                                                </div>\r\n                                            </td>\r\n                                            <td className=\"py-3 px-4\">\r\n                                                {(() => {\r\n                                                    const extraDays = subscriptionExtensions\r\n                                                        .filter(e => e.patient_id === patientId)\r\n                                                        .filter(e => {\r\n                                                            if (!e.previous_end_date || !e.new_end_date) return false;\r\n\r\n                                                            const extPrev = parseISO(e.previous_end_date);\r\n                                                            const extNew = parseISO(e.new_end_date);\r\n                                                            const termStart = term.start instanceof Date ? term.start : parseISO(term.start); // Ensure Date\r\n                                                            const termEnd = term.end instanceof Date ? term.end : parseISO(term.end); // Ensure Date\r\n\r\n                                                            const isPrevInTerm = extPrev > termStart && extPrev <= termEnd;\r\n                                                            const isNewInTerm = extNew > termStart && extNew <= termEnd;\r\n\r\n                                                            return isPrevInTerm || isNewInTerm;\r\n                                                        })\r\n                                                        .reduce((sum, e) => sum + (parseInt(e.days_added) || 0), 0);\r\n\r\n                                                    if (extraDays > 0) {\r\n                                                        return <span className=\"font-bold text-amber-600\">+{extraDays}</span>;\r\n                                                    } else if (extraDays < 0) {\r\n                                                        return <span className=\"font-bold text-red-500\">{extraDays}</span>;\r\n                                                    }\r\n                                                    return <span className=\"text-slate-300\">-</span>;\r\n                                                })()}\r\n                                            </td>\r\n                                            <td className=\"py-3 px-4\">\r\n                                                {term.isPaid ? (\r\n                                                    <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border border-green-200 dark:border-green-800\">\r\n                                                        <CheckCircle size={12} /> Pagado\r\n                                                    </span>\r\n                                                ) : (\r\n                                                    <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 border border-amber-200 dark:border-amber-800\">\r\n                                                        <Clock size={12} /> Pendiente\r\n                                                    </span>\r\n                                                )}\r\n                                            </td>\r\n                                            <td className=\"py-3 px-4 text-slate-600 dark:text-slate-400\">\r\n                                                {(() => {\r\n                                                    const rate = term.payment_rate_id ? paymentRates.find(r => r.id === term.payment_rate_id) : null;\r\n                                                    return rate ? (\r\n                                                        <span>{rate.label} - {rate.amount}€</span>\r\n                                                    ) : (\r\n                                                        <span className=\"text-gray-400 text-xs\">-</span>\r\n                                                    );\r\n                                                })()}\r\n                                            </td>\r\n                                            <td className=\"py-3 px-4 text-right flex justify-end gap-2 items-center\">\r\n                                                {(!term.isPaid && term.status !== 'archived') && (\r\n                                                    <button\r\n                                                        onClick={() => {\r\n                                                            const safeDate = term.start instanceof Date && !isNaN(term.start)\r\n                                                                ? format(term.start, 'yyyy-MM-dd')\r\n                                                                : new Date().toISOString().split('T')[0];\r\n\r\n                                                            const safeAmount = term.price || term.amount || 0;\r\n\r\n                                                            onAddPayment({\r\n                                                                subscription_id: term.id,\r\n                                                                plan_id: term.payment_rate_id,\r\n                                                                concept: `Renovación: ${term.label}`,\r\n                                                                amount: safeAmount,\r\n                                                                date: safeDate\r\n                                                            });\r\n                                                        }}\r\n                                                        className=\"px-3 py-1.5 rounded-md text-xs font-medium transition-colors bg-primary-600 text-white border-transparent hover:bg-primary-700 shadow-sm\"\r\n                                                    >\r\n                                                        Registrar Pago\r\n                                                    </button>\r\n                                                )}\r\n                                                <button\r\n                                                    onClick={() => onEditSubscription(term.originalData, term.type === 'history')}\r\n                                                    className=\"p-1.5 rounded-md text-xs font-medium transition-colors border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800\"\r\n                                                    title=\"Editar suscripción\"\r\n                                                >\r\n                                                    <Edit2 size={16} />\r\n                                                </button>\r\n\r\n                                                {(!term.isPaid) && (\r\n                                                    <button\r\n                                                        onClick={async (e) => {\r\n                                                            e.stopPropagation();\r\n                                                            if (window.confirm('¿Estás seguro de que deseas eliminar esta suscripción? Esta acción no se puede deshacer.')) {\r\n                                                                try {\r\n                                                                    const result = await deleteSubscription(term.id);\r\n                                                                    if (result?.success) {\r\n                                                                        alert('Suscripción eliminada correctamente.');\r\n                                                                    } else {\r\n                                                                        if (result?.error?.code === '23503') {\r\n                                                                            alert('No se puede eliminar esta suscripción porque tiene pagos asociados. Por favor, elimina primero los pagos correspondientes.');\r\n                                                                        } else {\r\n                                                                            alert('Error al eliminar la suscripción: ' + (result?.error?.message || 'Error desconocido'));\r\n                                                                        }\r\n                                                                    }\r\n                                                                } catch (err) {\r\n                                                                    alert('Excepción al eliminar: ' + err.message);\r\n                                                                }\r\n                                                            }\r\n                                                        }}\r\n                                                        className=\"p-1.5 rounded-md text-xs font-medium transition-colors border border-red-200 dark:border-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20\"\r\n                                                        title=\"Eliminar suscripción\"\r\n                                                    >\r\n                                                        <Trash2 size={16} />\r\n                                                    </button>\r\n                                                )}\r\n                                            </td>\r\n                                        </tr>\r\n                                    );\r\n                                })}\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n            ) : (\r\n                <div className=\"card mb-6 p-6 bg-slate-50 dark:bg-slate-800/50 border-dashed border-2 border-slate-200 dark:border-slate-700 rounded-lg text-center\">\r\n                    <p className=\"text-sm font-medium text-slate-600 dark:text-slate-300\">No hay renovaciones registradas</p>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"flex justify-end mb-4\">\r\n                <button onClick={() => onAddPayment()} className=\"btn btn-primary\">\r\n                    <Plus size={18} /> Registrar Pago\r\n                </button>\r\n            </div>\r\n\r\n            {/* Extension History Table */}\r\n            {subscriptionExtensions && subscriptionExtensions.filter(e => e.patient_id === patientId).length > 0 && (\r\n                <div className=\"card overflow-hidden p-0 mb-6 mt-6\">\r\n                    <div className=\"card-header border-b border-gray-100 dark:border-gray-700 bg-slate-50 dark:bg-slate-800/50 px-4 py-3\">\r\n                        <h3 className=\"card-title text-sm font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2\">\r\n                            <Clock size={16} className=\"text-amber-500\" />\r\n                            Historial de Compensaciones / Extensiones\r\n                        </h3>\r\n                    </div>\r\n                    <div className=\"overflow-x-auto\">\r\n                        <table className=\"w-full text-sm text-left\">\r\n                            <thead className=\"bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-b border-gray-100 dark:border-gray-700\">\r\n                                <tr>\r\n                                    <th className=\"py-3 px-4 font-medium\">Fecha Registro</th>\r\n                                    <th className=\"py-3 px-4 font-medium\">Días Añadidos</th>\r\n                                    <th className=\"py-3 px-4 font-medium\">Cambio de Fecha</th>\r\n                                    <th className=\"py-3 px-4 font-medium text-right\">Acción</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody className=\"divide-y divide-gray-100 dark:divide-gray-700\">\r\n                                {subscriptionExtensions\r\n                                    .filter(e => e.patient_id === patientId)\r\n                                    .map(ext => (\r\n                                        <tr key={ext.id} className=\"hover:bg-slate-50 dark:hover:bg-slate-800/50\">\r\n                                            <td className=\"py-3 px-4 text-slate-600 dark:text-slate-400\">\r\n                                                {format(parseISO(ext.created_at), 'dd/MM/yyyy HH:mm')}\r\n                                            </td>\r\n                                            <td className=\"py-3 px-4 font-bold text-slate-700 dark:text-slate-300\">\r\n                                                +{ext.days_added} días\r\n                                            </td>\r\n                                            <td className=\"py-3 px-4 text-xs text-slate-500\">\r\n                                                <span className=\"font-mono\">{format(parseISO(ext.previous_end_date), 'dd/MM/yyyy')}</span>\r\n                                                <span className=\"mx-2 text-slate-300\">→</span>\r\n                                                <span className=\"font-mono font-medium text-slate-700 dark:text-slate-300\">{format(parseISO(ext.new_end_date), 'dd/MM/yyyy')}</span>\r\n                                            </td>\r\n                                            <td className=\"py-3 px-4 text-right flex justify-end gap-2\">\r\n                                                <button\r\n                                                    onClick={() => {\r\n                                                        onEditExtension(ext);\r\n                                                    }}\r\n                                                    className=\"p-1 text-slate-400 hover:text-blue-600 transition-colors\"\r\n                                                    title=\"Editar extensión\"\r\n                                                >\r\n                                                    <Edit2 size={16} />\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={async () => {\r\n                                                        if (window.confirm('¿Seguro que quieres eliminar esta extensión? Se restarán los días añadidos a la fecha de fin actual.')) {\r\n                                                            const success = await deleteSubscriptionExtension(ext.id);\r\n                                                            if (!success) {\r\n                                                                alert('Error al eliminar extensión');\r\n                                                            }\r\n                                                        }\r\n                                                    }}\r\n                                                    className=\"p-1 text-slate-400 hover:text-red-600 transition-colors\"\r\n                                                    title=\"Eliminar extensión\"\r\n                                                >\r\n                                                    <Trash2 size={16} />\r\n                                                </button>\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Payments Table */}\r\n            <div className=\"card overflow-hidden p-0\">\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"data-table\">\r\n                        <thead className=\"bg-slate-50 dark:bg-slate-800\">\r\n                            <tr>\r\n                                <th className=\"text-left py-3 px-4 text-slate-500 dark:text-slate-400 font-medium\">Fecha</th>\r\n                                <th className=\"text-left py-3 px-4 text-slate-500 dark:text-slate-400 font-medium\">Periodo / Concepto</th>\r\n                                <th className=\"text-left py-3 px-4 text-slate-500 dark:text-slate-400 font-medium\">Método</th>\r\n                                <th className=\"text-left py-3 px-4 text-slate-500 dark:text-slate-400 font-medium\">Total</th>\r\n                                <th className=\"text-left py-3 px-4 text-slate-500 dark:text-slate-400 font-medium\">Estado</th>\r\n                                <th className=\"text-right py-3 px-4 text-slate-500 dark:text-slate-400 font-medium\">Acciones</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className=\"divide-y divide-slate-100 dark:divide-slate-700\">\r\n                            {patientPayments.map(p => (\r\n                                <tr key={p.id} className=\"hover:bg-slate-50 dark:hover:bg-slate-800/50\">\r\n                                    <td className=\"whitespace-nowrap text-sm text-slate-600 dark:text-slate-300 py-3 px-4\">\r\n                                        {safeFormat(p.date)}\r\n                                    </td>\r\n                                    <td className=\"text-sm text-slate-600 dark:text-slate-300 py-3 px-4\">\r\n                                        <div className=\"flex flex-col\">\r\n                                            <span>{p.concept || '-'}</span>\r\n                                            {p.billing_period && <span className=\"text-xs text-slate-400\">Periodo {p.billing_period}</span>}\r\n                                            {!p.subscription_id && (\r\n                                                <span className=\"inline-flex items-center gap-1 mt-0.5 text-[10px] font-medium text-amber-600 dark:text-amber-400\">\r\n                                                    <Clock size={10} /> Sin asignar a periodo\r\n                                                </span>\r\n                                            )}\r\n                                        </div>\r\n                                    </td>\r\n                                    <td className=\"capitalize text-slate-600 dark:text-slate-300 py-3 px-4\">\r\n                                        {paymentMethods.find(m => m.id === p.payment_method)?.label || p.payment_method}\r\n                                    </td>\r\n                                    <td className=\"font-semibold text-slate-900 dark:text-white py-3 px-4\">\r\n                                        €{parseFloat(p.amount).toFixed(2)}\r\n                                    </td>\r\n                                    <td className=\"py-3 px-4\">\r\n                                        {p.status === 'pagado' ? (\r\n                                            <span className=\"inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400\">\r\n                                                Pagado\r\n                                            </span>\r\n                                        ) : (\r\n                                            <span className=\"inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400\">\r\n                                                Pendiente\r\n                                            </span>\r\n                                        )}\r\n                                    </td>\r\n                                    <td className=\"py-3 px-4 text-right\">\r\n                                        <button\r\n                                            onClick={() => onEditPayment(p)}\r\n                                            className=\"p-1 text-slate-400 hover:text-primary-600 transition-colors\"\r\n                                            title=\"Editar pago\"\r\n                                        >\r\n                                            <Edit2 size={16} />\r\n                                        </button>\r\n                                        <button\r\n                                            onClick={() => onDeletePayment(p.id)}\r\n                                            className=\"p-1 text-slate-400 hover:text-red-600 transition-colors ml-1\"\r\n                                            title=\"Eliminar pago\"\r\n                                        >\r\n                                            <Trash2 size={16} />\r\n                                        </button>\r\n                                    </td>\r\n                                </tr>\r\n                            ))}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PaymentsTab;\r\n"},{"path":"src/components/Patients/Tabs/PhotosTab.jsx","content":"import { Image as ImageIcon } from 'lucide-react';\r\nimport { safeFormat } from '../../../utils/dateUtils';\r\n\r\nconst PhotosTab = ({ patient }) => {\r\n    const photos = patient.measurements?.filter(m => m.photo).sort((a, b) => new Date(b.date) - new Date(a.date)) || [];\r\n\r\n    if (photos.length === 0) return (\r\n        <div className=\"text-center py-16 bg-white rounded-xl border border-dashed border-gray-200\">\r\n            <ImageIcon className=\"text-gray-300 mb-4 mx-auto\" size={48} />\r\n            <p className=\"text-gray-500 font-medium\">No hay fotos de progreso.</p>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6\">\r\n            {photos.map(p => (\r\n                <div key={p.id} className=\"card p-3 group relative cursor-pointer hover:-translate-y-1 transition-transform\">\r\n                    <div className=\"aspect-[3/4] overflow-hidden rounded-lg bg-gray-100 mb-3\">\r\n                        <img src={p.photo} alt={`Progreso ${p.date}`} className=\"w-full h-full object-cover\" />\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                        <div className=\"text-sm font-bold text-gray-800\">{safeFormat(p.date)}</div>\r\n                        <div className=\"text-xs text-muted\">{p.weight} kg</div>\r\n                    </div>\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PhotosTab;\r\n"},{"path":"src/components/Patients/Tabs/ReviewsTab.jsx","content":"import { useState } from 'react';\r\nimport { useData } from '../../../context/DataContext';\r\nimport { safeFormat } from '../../../utils/dateUtils';\r\nimport { addDays, parseISO, format } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\nimport { ArrowLeft, CheckSquare, Square, PenLine, Calendar as CalendarIcon } from 'lucide-react';\r\n\r\nconst ReviewsTab = ({ patient }) => {\r\n    const { reviews, saveReview } = useData();\r\n    const [currentDate, setCurrentDate] = useState(new Date());\r\n\r\n    // Helper to find next specific day of week (0=Sun, 1=Mon...)\r\n    const getNextDayOfWeek = (date, dayOfWeek) => {\r\n        const resultDate = new Date(date.getTime());\r\n        resultDate.setDate(date.getDate() + (7 + dayOfWeek - date.getDay()) % 7);\r\n        if (resultDate <= date) {\r\n            resultDate.setDate(resultDate.getDate() + 7);\r\n        }\r\n        return resultDate;\r\n    };\r\n\r\n    if (!patient.subscription?.startDate) {\r\n        return (\r\n            <div className=\"text-center py-16 bg-white rounded-xl border border-dashed border-gray-200\">\r\n                <CalendarIcon className=\"text-gray-300 mb-4 mx-auto\" size={48} />\r\n                <p className=\"text-gray-500 font-medium\">No hay suscripción activa.</p>\r\n                <p className=\"text-sm text-gray-400\">Configura una fecha de inicio para ver las revisiones.</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // 1. Get ALL reviews from history (saved in DB)\r\n    const historyReviews = Object.values(reviews || {}).filter(r =>\r\n        r.id.startsWith(`review_${patient.id}_`)\r\n    ).map(r => ({\r\n        sysId: r.id,\r\n        date: parseISO(r.date), // Ensure date is parsed\r\n        type: 'Revisión',\r\n        completed: r.completed || false,\r\n        notes: r.notes || ''\r\n    }));\r\n\r\n    // 2. Generate scheduled reviews from CURRENT subscription\r\n    const scheduledReviews = [];\r\n    const start = parseISO(patient.subscription.startDate);\r\n    const end = patient.subscription.endDate ? parseISO(patient.subscription.endDate) : addDays(start, 30);\r\n\r\n\r\n    let reviewDate;\r\n    if (patient.review_day) {\r\n        // Find first review day AFTER start date\r\n        // review_day is 1-5 (Mon-Fri).\r\n        reviewDate = getNextDayOfWeek(start, parseInt(patient.review_day));\r\n    } else {\r\n        // Default to start date + 7 days if no review day is set\r\n        reviewDate = addDays(start, 7);\r\n    }\r\n\r\n    while (reviewDate <= end) {\r\n        const reviewId = `review_${patient.id}_${format(reviewDate, 'yyyy-MM-dd')}`;\r\n        // Only add if NOT already in history (prefer history data)\r\n        const inHistory = historyReviews.some(h => h.sysId === reviewId);\r\n\r\n        if (!inHistory) {\r\n            const savedData = reviews?.[reviewId] || {}; // Redundant check but safe\r\n            scheduledReviews.push({\r\n                sysId: reviewId,\r\n                date: reviewDate,\r\n                type: 'Revisión',\r\n                completed: savedData.completed || false,\r\n                notes: savedData.notes || ''\r\n            });\r\n        }\r\n        reviewDate = addDays(reviewDate, 7);\r\n    }\r\n\r\n    // 3. Merge and Filter by Month\r\n    const allEvents = [...historyReviews, ...scheduledReviews].sort((a, b) => a.date - b.date);\r\n\r\n    // Filter for current view month\r\n    const startOfMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);\r\n    const endOfMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);\r\n\r\n    const visibleEvents = allEvents.filter(evt =>\r\n        evt.date >= startOfMonthDate && evt.date <= endOfMonthDate\r\n    );\r\n\r\n    const handleToggleComplete = (sysId, currentStatus) => {\r\n        saveReview(sysId, { completed: !currentStatus });\r\n    };\r\n\r\n    const handleNotesChange = (sysId, note) => {\r\n        saveReview(sysId, { notes: note });\r\n    };\r\n\r\n    const changeMonth = (increment) => {\r\n        setCurrentDate(prev => {\r\n            const newDate = new Date(prev);\r\n            newDate.setMonth(prev.getMonth() + increment);\r\n            return newDate;\r\n        });\r\n    };\r\n\r\n    return (\r\n        <div className=\"card h-full flex flex-col\">\r\n            <div className=\"card-header flex justify-between items-center\">\r\n                <h3 className=\"card-title text-primary dark:text-primary-400\">Revisiones Semanales</h3>\r\n                <div className=\"flex items-center gap-4 bg-slate-50 dark:bg-slate-800 rounded-lg p-1\">\r\n                    <button onClick={() => changeMonth(-1)} className=\"p-1 hover:bg-white dark:hover:bg-slate-700 rounded-md shadow-sm transition-all text-slate-500\">\r\n                        <ArrowLeft size={18} />\r\n                    </button>\r\n                    <span className=\"text-sm font-semibold w-32 text-center capitalize text-slate-700 dark:text-slate-300\">\r\n                        {safeFormat(currentDate, 'MMMM yyyy', { locale: es })}\r\n                    </span>\r\n                    <button onClick={() => changeMonth(1)} className=\"p-1 hover:bg-white dark:hover:bg-slate-700 rounded-md shadow-sm transition-all text-slate-500\">\r\n                        <ArrowLeft size={18} className=\"rotate-180\" />\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {visibleEvents.length === 0 ? (\r\n                <div className=\"text-center py-12\">\r\n                    <p className=\"text-gray-400 italic\">No hay revisiones en este mes.</p>\r\n                </div>\r\n            ) : (\r\n                <div className=\"table-responsive flex-1\">\r\n                    <table className=\"data-table\">\r\n                        <thead>\r\n                            <tr>\r\n                                <th className=\"w-12 text-center\">Estado</th>\r\n                                <th className=\"w-40\">Fecha</th>\r\n                                <th>Notas de Revisión</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {visibleEvents.map((evt) => (\r\n                                <tr key={evt.sysId} className={`${evt.completed ? 'bg-slate-50 dark:bg-slate-800/50' : 'hover:bg-primary-50 dark:hover:bg-primary-900/10'} border-b border-slate-100 dark:border-slate-800 last:border-0`}>\r\n                                    <td className=\"text-center\">\r\n                                        <button\r\n                                            onClick={() => handleToggleComplete(evt.sysId, evt.completed)}\r\n                                            className={`p-1 rounded transition-colors ${evt.completed ? 'text-green-600 hover:text-green-700' : 'text-slate-300 hover:text-slate-500'}`}\r\n                                            title={evt.completed ? \"Marcar como pendiente\" : \"Marcar como hecho\"}\r\n                                        >\r\n                                            {evt.completed ? <CheckSquare size={20} /> : <Square size={20} />}\r\n                                        </button>\r\n                                    </td>\r\n                                    <td className={`font-medium ${evt.completed ? 'text-slate-400 dark:text-slate-600 line-through' : 'text-slate-600 dark:text-slate-300'}`}>\r\n                                        {safeFormat(evt.date, 'dd/MM/yyyy')}\r\n                                    </td>\r\n                                    <td>\r\n                                        <div className=\"relative group w-full\">\r\n                                            <input\r\n                                                type=\"text\"\r\n                                                defaultValue={evt.notes}\r\n                                                onBlur={(e) => handleNotesChange(evt.sysId, e.target.value)}\r\n                                                onKeyDown={(e) => {\r\n                                                    if (e.key === 'Enter') {\r\n                                                        e.currentTarget.blur();\r\n                                                    }\r\n                                                }}\r\n                                                className={`w-full bg-transparent border-b border-transparent hover:border-slate-200 dark:hover:border-slate-600 focus:border-primary-400 outline-none py-1.5 px-2 text-sm transition-all ${evt.completed ? 'text-slate-400 dark:text-slate-600' : 'text-slate-700 dark:text-slate-200'}`}\r\n                                                placeholder=\"Escribe notas...\"\r\n                                            />\r\n                                            <PenLine size={14} className=\"absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\" />\r\n                                        </div>\r\n                                    </td>\r\n                                </tr>\r\n                            ))}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ReviewsTab;\r\n"},{"path":"src/components/Patients/Tabs/TrackingTab.jsx","content":"import { useState, useRef } from 'react';\r\nimport { generateMeasurementsPDF } from '../../../utils/measurementsPdfGenerator';\r\nimport { safeFormat } from '../../../utils/dateUtils';\r\nimport PdfExportModal from '../../Tracking/PdfExportModal';\r\nimport EvolutionChart from '../../Tracking/EvolutionChart';\r\nimport { FileDown, Plus, Activity, Edit2, Trash2, Image as ImageIcon } from 'lucide-react';\r\n\r\nconst TrackingTab = ({ patient, onAddMeasurement, onEditMeasurement, onDeleteMeasurement }) => {\r\n    const hasHistory = patient.measurements && patient.measurements.length > 0;\r\n\r\n    // Create refs for all charts\r\n    const chartRefs = {\r\n        weight: useRef(null),\r\n        pecho: useRef(null),\r\n        cadera: useRef(null),\r\n        sobre_ombligo: useRef(null),\r\n        ombligo: useRef(null),\r\n        bajo_ombligo: useRef(null),\r\n        brazo_izq: useRef(null),\r\n        brazo_der: useRef(null),\r\n        muslo_izq: useRef(null),\r\n        muslo_der: useRef(null)\r\n    };\r\n\r\n    // Handle PDF export\r\n    const [isPdfModalOpen, setIsPdfModalOpen] = useState(false);\r\n\r\n    const handleExportPDF = async (selectedCharts) => {\r\n        try {\r\n            await generateMeasurementsPDF(patient, chartRefs, selectedCharts);\r\n        } catch (error) {\r\n            console.error('Error generating PDF:', error);\r\n            alert('Hubo un error al generar el PDF. Por favor, inténtalo de nuevo.');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex justify-end gap-3\">\r\n                {hasHistory && (\r\n                    <button\r\n                        onClick={() => setIsPdfModalOpen(true)}\r\n                        className=\"btn btn-secondary flex items-center gap-2\"\r\n                        title=\"Exportar mediciones a PDF\"\r\n                    >\r\n                        <FileDown size={18} /> Exportar PDF\r\n                    </button>\r\n                )}\r\n                <button onClick={onAddMeasurement} className=\"btn btn-primary\">\r\n                    <Plus size={18} /> Nueva Medición\r\n                </button>\r\n            </div>\r\n\r\n            {!hasHistory ? (\r\n                <div className=\"text-center py-16 bg-white dark:bg-slate-800 rounded-xl border border-dashed border-gray-200 dark:border-slate-700\">\r\n                    <Activity className=\"text-gray-300 mb-4 mx-auto\" size={48} />\r\n                    <p className=\"text-gray-500 font-medium\">No hay registros de evolución aún.</p>\r\n                    <p className=\"text-sm text-gray-400\">Añade la primera medición para ver gráficas.</p>\r\n                </div>\r\n            ) : (\r\n                <>\r\n                    {/* Charts Grid */}\r\n                    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                        <div className=\"card\">\r\n                            <div className=\"card-header\"><h4 className=\"card-title text-primary dark:text-primary-400\">Peso</h4></div>\r\n                            <EvolutionChart\r\n                                measurements={patient.measurements}\r\n                                dataKey=\"weight\"\r\n                                label=\"Peso (kg)\"\r\n                                color=\"#28483a\"\r\n                                chartRef={chartRefs.weight}\r\n                            />\r\n                        </div>\r\n                        <div className=\"card\">\r\n                            <div className=\"card-header\"><h4 className=\"card-title text-blue-600\">Pecho</h4></div>\r\n                            <EvolutionChart\r\n                                measurements={patient.measurements}\r\n                                dataKey=\"pecho\"\r\n                                label=\"Pecho (cm)\"\r\n                                color=\"#2563EB\"\r\n                                chartRef={chartRefs.pecho}\r\n                            />\r\n                        </div>\r\n                        <div className=\"card\">\r\n                            <div className=\"card-header\"><h4 className=\"card-title text-purple-600\">Cadera</h4></div>\r\n                            <EvolutionChart\r\n                                measurements={patient.measurements}\r\n                                dataKey=\"cadera\"\r\n                                label=\"Cadera (cm)\"\r\n                                color=\"#9333EA\"\r\n                                chartRef={chartRefs.cadera}\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Abdomen */}\r\n                        <div className=\"card\">\r\n                            <div className=\"card-header\"><h4 className=\"card-title text-orange-600\">Abdomen (Sobre)</h4></div>\r\n                            <EvolutionChart\r\n                                measurements={patient.measurements}\r\n                                dataKey=\"sobre_ombligo\"\r\n                                label=\"Sobre Ombligo (cm)\"\r\n                                color=\"#EA580C\"\r\n                                chartRef={chartRefs.sobre_ombligo}\r\n                            />\r\n                        </div>\r\n                        <div className=\"card\">\r\n                            <div className=\"card-header\"><h4 className=\"card-title text-orange-600\">Abdomen (Ombligo)</h4></div>\r\n                            <EvolutionChart\r\n                                measurements={patient.measurements}\r\n                                dataKey=\"ombligo\"\r\n                                label=\"Ombligo (cm)\"\r\n                                color=\"#EA580C\"\r\n                                chartRef={chartRefs.ombligo}\r\n                            />\r\n                        </div>\r\n                        <div className=\"card\">\r\n                            <div className=\"card-header\"><h4 className=\"card-title text-orange-600\">Abdomen (Bajo)</h4></div>\r\n                            <EvolutionChart\r\n                                measurements={patient.measurements}\r\n                                dataKey=\"bajo_ombligo\"\r\n                                label=\"Bajo Ombligo (cm)\"\r\n                                color=\"#EA580C\"\r\n                                chartRef={chartRefs.bajo_ombligo}\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Extremidades */}\r\n                        <div className=\"card\">\r\n                            <div className=\"card-header\"><h4 className=\"card-title text-amber-700\">Brazo Izquierdo</h4></div>\r\n                            <EvolutionChart\r\n                                measurements={patient.measurements}\r\n                                dataKey=\"brazo_izq\"\r\n                                label=\"Brazo Izq (cm)\"\r\n                                color=\"#B45309\"\r\n                                chartRef={chartRefs.brazo_izq}\r\n                            />\r\n                        </div>\r\n                        <div className=\"card\">\r\n                            <div className=\"card-header\"><h4 className=\"card-title text-amber-700\">Brazo Derecho</h4></div>\r\n                            <EvolutionChart\r\n                                measurements={patient.measurements}\r\n                                dataKey=\"brazo_der\"\r\n                                label=\"Brazo Der (cm)\"\r\n                                color=\"#B45309\"\r\n                                chartRef={chartRefs.brazo_der}\r\n                            />\r\n                        </div>\r\n                        <div className=\"card\">\r\n                            <div className=\"card-header\"><h4 className=\"card-title text-cyan-600\">Muslo Izquierdo</h4></div>\r\n                            <EvolutionChart\r\n                                measurements={patient.measurements}\r\n                                dataKey=\"muslo_izq\"\r\n                                label=\"Muslo Izq (cm)\"\r\n                                color=\"#0891B2\"\r\n                                chartRef={chartRefs.muslo_izq}\r\n                            />\r\n                        </div>\r\n                        <div className=\"card\">\r\n                            <div className=\"card-header\"><h4 className=\"card-title text-cyan-600\">Muslo Derecho</h4></div>\r\n                            <EvolutionChart\r\n                                measurements={patient.measurements}\r\n                                dataKey=\"muslo_der\"\r\n                                label=\"Muslo Der (cm)\"\r\n                                color=\"#0891B2\"\r\n                                chartRef={chartRefs.muslo_der}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* History Table */}\r\n                    <div className=\"card\">\r\n                        <div className=\"card-header\">\r\n                            <h3 className=\"card-title\">Historial Completo</h3>\r\n                        </div>\r\n                        <div className=\"table-responsive\">\r\n                            <table className=\"data-table\">\r\n                                <thead>\r\n                                    <tr>\r\n                                        <th className=\"text-left py-2 px-3 text-slate-500 dark:text-slate-400 font-medium text-xs uppercase tracking-wider\">Fecha</th>\r\n                                        <th className=\"text-center py-2 px-2 text-slate-500 dark:text-slate-400 font-medium text-xs uppercase tracking-wider\">Peso</th>\r\n                                        <th className=\"text-center py-2 px-2 text-slate-500 dark:text-slate-400 font-medium text-xs uppercase tracking-wider\">Pecho</th>\r\n                                        <th className=\"text-center py-2 px-2 text-slate-500 dark:text-slate-400 font-medium text-xs uppercase tracking-wider\">Brazos (I | D)</th>\r\n                                        <th className=\"text-center py-2 px-2 text-slate-500 dark:text-slate-400 font-medium text-xs uppercase tracking-wider\">Abdomen (S | O | I)</th>\r\n                                        <th className=\"text-center py-2 px-2 text-slate-500 dark:text-slate-400 font-medium text-xs uppercase tracking-wider\">Cadera</th>\r\n                                        <th className=\"text-center py-2 px-2 text-slate-500 dark:text-slate-400 font-medium text-xs uppercase tracking-wider\">Muslos (I | D)</th>\r\n                                        <th className=\"text-center py-2 px-2 text-slate-500 dark:text-slate-400 font-medium text-xs uppercase tracking-wider\">Foto</th>\r\n                                        <th className=\"text-right py-2 px-3 text-slate-500 dark:text-slate-400 font-medium text-xs uppercase tracking-wider\">Acciones</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody className=\"divide-y divide-slate-100 dark:divide-slate-700\">\r\n                                    {patient.measurements.sort((a, b) => new Date(b.date) - new Date(a.date)).map((m) => (\r\n                                        <tr key={m.id} className=\"hover:bg-slate-50 dark:hover:bg-slate-800/50 text-xs\">\r\n                                            <td className=\"py-2 px-3 text-slate-700 dark:text-slate-300 font-medium whitespace-nowrap\">{safeFormat(m.date)}</td>\r\n                                            <td className=\"py-2 px-2 text-center font-bold text-slate-800 dark:text-white\">{m.weight} kg</td>\r\n                                            <td className=\"py-2 px-2 text-center text-slate-600 dark:text-slate-400\">{m.pecho || '-'}</td>\r\n                                            <td className=\"py-2 px-2 text-center text-slate-600 dark:text-slate-400\">\r\n                                                <span className=\"text-slate-500\">I:</span> {m.brazo_izq || '-'} <span className=\"text-slate-300 mx-1\">|</span> <span className=\"text-slate-500\">D:</span> {m.brazo_der || '-'}\r\n                                            </td>\r\n                                            <td className=\"py-2 px-2 text-center text-slate-600 dark:text-slate-400\">\r\n                                                {m.sobre_ombligo || '-'} <span className=\"text-slate-300 mx-1\">|</span> {m.ombligo || '-'} <span className=\"text-slate-300 mx-1\">|</span> {m.bajo_ombligo || '-'}\r\n                                            </td>\r\n                                            <td className=\"py-2 px-2 text-center text-slate-600 dark:text-slate-400\">{m.cadera || '-'}</td>\r\n                                            <td className=\"py-2 px-2 text-center text-slate-600 dark:text-slate-400\">\r\n                                                <span className=\"text-slate-500\">I:</span> {m.muslo_izq || '-'} <span className=\"text-slate-300 mx-1\">|</span> <span className=\"text-slate-500\">D:</span> {m.muslo_der || '-'}\r\n                                            </td>\r\n                                            <td className=\"py-2 px-2 text-center\">{m.photo ? <ImageIcon size={14} className=\"text-primary inline\" /> : '-'}</td>\r\n                                            <td className=\"py-2 px-3 flex justify-end gap-1\">\r\n                                                <button\r\n                                                    onClick={() => onEditMeasurement(m)}\r\n                                                    className=\"p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors text-slate-500 hover:text-primary\"\r\n                                                    title=\"Editar medición\"\r\n                                                >\r\n                                                    <Edit2 size={16} />\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={() => onDeleteMeasurement(m.id)}\r\n                                                    className=\"p-1 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full transition-colors text-slate-400 hover:text-red-500\"\r\n                                                    title=\"Eliminar medición\"\r\n                                                >\r\n                                                    <Trash2 size={16} />\r\n                                                </button>\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n                </>\r\n            )}\r\n\r\n            <PdfExportModal\r\n                isOpen={isPdfModalOpen}\r\n                onClose={() => setIsPdfModalOpen(false)}\r\n                onExport={handleExportPDF}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default TrackingTab;\r\n"},{"path":"src/components/Payments/PaymentModal.jsx","content":"import { useState, useEffect, useMemo } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { X } from 'lucide-react';\r\nimport { addDays, format, parseISO } from 'date-fns';\r\n\r\nconst PaymentModal = ({ isOpen, onClose, initialData = null, defaultPatientId = null, subscriptionTerms = [] }) => {\r\n    const { addPayment, updatePayment, patients, plans, paymentMethods, paymentCategories, paymentRates } = useData();\r\n    const [formData, setFormData] = useState({\r\n        patient_id: defaultPatientId || '',\r\n        date: new Date().toISOString().split('T')[0],\r\n        amount: '',\r\n        plan_id: '',\r\n        payment_method: 'efectivo',\r\n        concept: '',\r\n        status: 'pagado',\r\n        category: '',\r\n        billing_period: null\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (initialData) {\r\n            // If initialData exists, use it. But if category is missing, try to augment it from patient default.\r\n            let category = initialData.category || '';\r\n            const targetPatientId = initialData.patient_id || defaultPatientId;\r\n\r\n            if (!category && targetPatientId) {\r\n                const pat = patients.find(p => p.id === targetPatientId);\r\n                if (pat?.payment_category_id) {\r\n                    category = pat.payment_category_id;\r\n                }\r\n            }\r\n\r\n            setFormData({\r\n                ...initialData,\r\n                plan_id: initialData.payment_rate_id || initialData.plan_id || '',\r\n                patient_id: targetPatientId || '', // Fix: ensure patient_id is set\r\n                category: category,\r\n                category: category,\r\n                status: initialData.status || 'pagado',\r\n                payment_method: initialData.payment_method || 'efectivo',\r\n                billing_period: initialData.billing_period || null,\r\n                subscription_id: initialData.subscription_id || ''\r\n            });\r\n        } else {\r\n            // Find default patient to get their category if available\r\n            let defaultCategory = '';\r\n            if (defaultPatientId) {\r\n                const defPatient = patients.find(p => p.id === defaultPatientId);\r\n                if (defPatient?.payment_category_id) {\r\n                    defaultCategory = defPatient.payment_category_id;\r\n                }\r\n            }\r\n\r\n            setFormData({\r\n                patient_id: defaultPatientId || '',\r\n                date: new Date().toISOString().split('T')[0],\r\n                amount: '',\r\n                plan_id: '',\r\n                payment_method: 'efectivo',\r\n                concept: '',\r\n                status: 'pagado',\r\n                category: defaultCategory,\r\n                billing_period: null,\r\n                subscription_id: ''\r\n            });\r\n        }\r\n    }, [initialData, defaultPatientId, isOpen, patients]);\r\n\r\n    // Calculate billing periods for selected patient based on ACTUAL subscription history\r\n    const billingPeriods = useMemo(() => {\r\n        // If specific terms are provided (from PatientDetail payments tab), use those\r\n        if (subscriptionTerms && subscriptionTerms.length > 0) {\r\n            return subscriptionTerms.map((term, index) => ({\r\n                id: term.id, // This is the subscription PK\r\n                label: `${term.label} (${format(term.start, 'dd/MM/yyyy')} - ${format(term.end, 'dd/MM/yyyy')}) ${term.isPaid ? '✅' : '⏳'}`,\r\n                value: term.id,\r\n                start: term.start,\r\n                isPaid: term.isPaid,\r\n                payment_rate_id: term.payment_rate_id,\r\n                amount: term.price\r\n            }));\r\n        }\r\n\r\n        // Prioritize defaultPatientId if present (when opening from PatientDetail)\r\n        // Otherwise use the selected patient from the dropdown\r\n        const targetPatientId = defaultPatientId || formData.patient_id;\r\n\r\n        if (!targetPatientId) return [];\r\n\r\n        const patient = patients.find(p => p.id === targetPatientId);\r\n        if (!patient?.subscriptionHistory?.length) return [];\r\n\r\n        // Auto-select category if not set\r\n        if (patient?.payment_category_id && !formData.category) {\r\n            // We use a timeout or check if we are not in an infinite loop\r\n            // Better to do this in a useEffect actually.\r\n        }\r\n\r\n        // Map history to selectable options\r\n        return patient.subscriptionHistory.filter(sub => sub && sub.start_date).map(sub => {\r\n            const start = parseISO(sub.start_date);\r\n            const end = sub.end_date ? parseISO(sub.end_date) : addDays(start, 30);\r\n            return {\r\n                id: sub.id,\r\n                label: `${sub.plan_name} (${format(start, 'dd/MM/yyyy')} - ${format(end, 'dd/MM/yyyy')})`,\r\n                value: sub.id,\r\n                start: start,\r\n                payment_rate_id: sub.payment_rate_id,\r\n                amount: sub.price || sub.amount\r\n            };\r\n        }).sort((a, b) => b.start - a.start); // Newest first\r\n\r\n    }, [formData.patient_id, defaultPatientId, patients, subscriptionTerms]);\r\n\r\n    // Check if patient has subscription but no periods generated (debugging/info)\r\n    const selectedPatient = patients.find(p => p.id === (defaultPatientId || formData.patient_id));\r\n    const hasSubscription = selectedPatient?.subscription?.startDate;\r\n\r\n    // Auto-select Patient's Center (Category)\r\n\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n        const dataToSave = {\r\n            ...formData,\r\n            amount: parseFloat(formData.amount),\r\n            payment_rate_id: formData.plan_id || null, // Map plan_id (holding rate ID) to payment_rate_id\r\n            category: formData.category || null,       // Ensure empty string is null (UUID error fix)\r\n            subscription_id: formData.subscription_id || null // Ensure empty string is null (UUID error fix)\r\n        };\r\n\r\n        // Remove legacy and UI-only fields\r\n        delete dataToSave.plan_id;\r\n        delete dataToSave.billing_period;\r\n\r\n        if (initialData?.id) {\r\n            await updatePayment(initialData.id, dataToSave);\r\n        } else {\r\n            await addPayment(dataToSave);\r\n        }\r\n        onClose();\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-md overflow-hidden animate-fade-in\">\r\n                <div className=\"p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center\">\r\n                    <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">\r\n                        {initialData ? 'Editar Pago' : 'Registrar Nuevo Pago'}\r\n                    </h3>\r\n                    <button onClick={onClose} className=\"text-slate-400 hover:text-slate-600 dark:hover:text-slate-200\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit} className=\"p-6 space-y-4\">\r\n                    {/* Cliente */}\r\n                    {!defaultPatientId && (\r\n                        <div>\r\n                            {initialData?.payer_email && (\r\n                                <div className=\"mb-2 p-2 bg-yellow-50 text-yellow-800 text-sm rounded border border-yellow-200\">\r\n                                    Email de origen: <strong>{initialData.payer_email}</strong>\r\n                                </div>\r\n                            )}\r\n                            <label className=\"form-label\">Cliente</label>\r\n                            <select\r\n                                className=\"form-select\"\r\n                                value={formData.patient_id}\r\n                                onChange={e => {\r\n                                    const newPatientId = e.target.value;\r\n                                    const selectedP = patients.find(p => p.id === newPatientId);\r\n                                    setFormData({\r\n                                        ...formData,\r\n                                        patient_id: newPatientId,\r\n                                        category: selectedP?.payment_category_id || '' // Auto-select category\r\n                                    });\r\n                                }}\r\n                                required\r\n                            >\r\n                                <option value=\"\">Seleccionar cliente...</option>\r\n                                {patients.sort((a, b) => a.name.localeCompare(b.name)).map(p => (\r\n                                    <option key={p.id} value={p.id}>{p.name}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                    )}\r\n\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        {/* Fecha */}\r\n                        <div>\r\n                            <label className=\"form-label\">Fecha</label>\r\n                            <input\r\n                                type=\"date\"\r\n                                className=\"form-input\"\r\n                                value={formData.date}\r\n                                onChange={e => setFormData({ ...formData, date: e.target.value })}\r\n                                required\r\n                            />\r\n                        </div>\r\n                        {/* Total */}\r\n                        <div>\r\n                            <label className=\"form-label\">Total (€)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                step=\"0.01\"\r\n                                className=\"form-input\"\r\n                                value={formData.amount}\r\n                                onChange={e => setFormData({ ...formData, amount: e.target.value })}\r\n                                required\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Tarifa / Plan */}\r\n                    <div>\r\n                        <label className=\"form-label\">Tarifa / Plan</label>\r\n                        <select\r\n                            className=\"form-select\"\r\n                            value={formData.plan_id || ''}\r\n                            onChange={e => {\r\n                                const selectedId = e.target.value;\r\n                                const rate = paymentRates.find(r => r.id === selectedId);\r\n                                setFormData(prev => ({\r\n                                    ...prev,\r\n                                    plan_id: selectedId,\r\n                                    amount: rate ? rate.amount : prev.amount\r\n                                }));\r\n                            }}\r\n                        >\r\n                            <option value=\"\">Ninguno / Personalizado</option>\r\n                            {(() => {\r\n                                const active = paymentRates.filter(r => r.is_active !== false);\r\n                                const archived = paymentRates.filter(r => r.is_active === false);\r\n\r\n                                const renderOption = (r, isArchived = false) => {\r\n                                    const isSelected = formData.plan_id === r.id;\r\n                                    const currentAmount = parseFloat(formData.amount || 0);\r\n                                    const rateAmount = parseFloat(r.amount || 0);\r\n                                    // Check for mismatch (allow small float diff), only if selected\r\n                                    const isMismatch = isSelected && Math.abs(currentAmount - rateAmount) > 0.01;\r\n\r\n                                    const displayAmount = isMismatch ? currentAmount : rateAmount;\r\n\r\n                                    let extraText = '';\r\n                                    if (isMismatch) extraText = ' (Precio guardado)';\r\n                                    else if (isArchived) extraText = ' (Archivada)';\r\n\r\n                                    return (\r\n                                        <option key={r.id} value={r.id} className={isArchived ? \"text-gray-500\" : \"\"}>\r\n                                            {r.label} - {displayAmount}€{extraText}\r\n                                        </option>\r\n                                    );\r\n                                };\r\n\r\n                                return (\r\n                                    <>\r\n                                        {active.length > 0 && (\r\n                                            <optgroup label=\"Tarifas Actuales\">\r\n                                                {active.map(r => renderOption(r, false))}\r\n                                            </optgroup>\r\n                                        )}\r\n                                        {archived.length > 0 && (\r\n                                            <optgroup label=\"Tarifas Antiguas\">\r\n                                                {archived.map(r => renderOption(r, true))}\r\n                                            </optgroup>\r\n                                        )}\r\n                                    </>\r\n                                );\r\n                            })()}\r\n                        </select>\r\n                    </div>\r\n\r\n                    {/* Periodo de Facturación / Suscripción */}\r\n                    {billingPeriods.length > 0 && (\r\n                        <div>\r\n                            <label className=\"form-label\">Periodo de Suscripción</label>\r\n                            <select\r\n                                className=\"form-select\"\r\n                                value={formData.subscription_id || ''}\r\n                                onChange={e => {\r\n                                    const val = e.target.value; // UUID string\r\n                                    const period = billingPeriods.find(p => p.value === val);\r\n\r\n                                    const updates = { subscription_id: val };\r\n                                    if (period) {\r\n                                        // Auto-link concept and date for better association\r\n                                        // Auto-link concept if not already set\r\n                                        if (!formData.concept) {\r\n                                            updates.concept = `Pago: ${period.label.split('(')[0].trim()}`;\r\n                                        }\r\n\r\n                                        // Auto-select Rate and Price if linked\r\n                                        if (period.payment_rate_id) {\r\n                                            updates.plan_id = period.payment_rate_id;\r\n                                        } else {\r\n                                            // Fallback: Try to match by label + amount if ID is missing (legacy)\r\n                                            const pAmount = parseFloat(period.amount || 0);\r\n                                            const matchedRate = paymentRates.find(r =>\r\n                                                (period.label.toLowerCase().includes(r.label.toLowerCase())) &&\r\n                                                (Math.abs(parseFloat(r.amount) - pAmount) < 0.1)\r\n                                            );\r\n\r\n                                            if (matchedRate) {\r\n                                                updates.plan_id = matchedRate.id;\r\n                                            } else {\r\n                                                // If no match, force \"Custom\" so we don't accidentally select the first rate in the list\r\n                                                updates.plan_id = '';\r\n                                            }\r\n                                        }\r\n\r\n                                        // Only auto-fill amount if the payment doesn't already have one\r\n                                        // (e.g. new payment from period). Preserve existing amounts (e.g. Stripe payments).\r\n                                        if (period.amount && !formData.amount) {\r\n                                            updates.amount = parseFloat(period.amount);\r\n                                        }\r\n                                    }\r\n                                    setFormData({ ...formData, ...updates });\r\n                                }}\r\n                            >\r\n                                <option value=\"\">General / Sin asignar</option>\r\n                                {billingPeriods.map(period => (\r\n                                    <option key={period.value} value={period.value}>\r\n                                        {period.label}\r\n                                    </option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Mensaje de ayuda si no hay periodos pero hay cliente seleccionado */}\r\n                    {selectedPatient && !billingPeriods.length && (\r\n                        <div className=\"text-xs text-amber-600 bg-amber-50 p-2 rounded\">\r\n                            {!hasSubscription\r\n                                ? \"Este cliente no tiene fecha de inicio de suscripción configurada.\"\r\n                                : \"No hay periodos de facturación disponibles para las fechas actuales.\"}\r\n                        </div>\r\n                    )}\r\n                    {/* Método y Estado */}\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"form-label\">Método</label>\r\n                            <select\r\n                                className=\"form-select\"\r\n                                value={formData.payment_method}\r\n                                onChange={e => setFormData({ ...formData, payment_method: e.target.value })}\r\n                            >\r\n                                {paymentMethods.filter(m => m.is_active !== false).map(m => (\r\n                                    <option key={m.id} value={m.id}>{m.label}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"form-label\">Estado</label>\r\n                            <select\r\n                                className=\"form-select\"\r\n                                value={formData.status}\r\n                                onChange={e => setFormData({ ...formData, status: e.target.value })}\r\n                            >\r\n                                <option value=\"pagado\">Pagado</option>\r\n                                <option value=\"pendiente\">Pendiente</option>\r\n                                <option value=\"cancelado\">Cancelado</option>\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Concepto */}\r\n                    <div>\r\n                        <label className=\"form-label\">Concepto (Opcional)</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            className=\"form-input\"\r\n                            placeholder=\"Ej. Consulta primera vez\"\r\n                            value={formData.concept || ''}\r\n                            onChange={e => setFormData({ ...formData, concept: e.target.value })}\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Categoría */}\r\n                    <div>\r\n                        <label className=\"form-label\">Categoría</label>\r\n                        <select\r\n                            className=\"form-select\"\r\n                            value={formData.category || ''}\r\n                            onChange={e => setFormData({ ...formData, category: e.target.value })}\r\n                        >\r\n                            <option value=\"\">Sin categoría</option>\r\n                            {paymentCategories.filter(c => c.is_active !== false).map(c => (\r\n                                <option key={c.id} value={c.id}>{c.label}</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n\r\n                    <div className=\"pt-4 flex gap-3\">\r\n                        <button type=\"button\" onClick={onClose} className=\"btn btn-outline flex-1\">\r\n                            Cancelar\r\n                        </button>\r\n                        <button type=\"submit\" className=\"btn btn-primary flex-1\">\r\n                            Guardar\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PaymentModal;\r\n"},{"path":"src/components/Payments/Payments.jsx","content":"import { useState, useMemo } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport {\r\n    Wallet, Plus, Filter, Search, Trash2, Edit2, CheckCircle,\r\n    Clock, XCircle\r\n} from 'lucide-react';\r\nimport { format, parseISO, isWithinInterval } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\n\r\nimport PaymentModal from './PaymentModal';\r\n\r\nconst Payments = () => {\r\n    const { payments, deletePayment, patients, paymentMethods, paymentCategories } = useData();\r\n    const [isModalOpen, setIsModalOpen] = useState(false);\r\n    const [editingPayment, setEditingPayment] = useState(null);\r\n    const [filters, setFilters] = useState({\r\n        search: '',\r\n        status: 'all',\r\n        method: 'all',\r\n        category: 'all',\r\n        startDate: '',\r\n        endDate: '',\r\n    });\r\n\r\n    // Filtros\r\n    const filteredPayments = useMemo(() => {\r\n        return payments.filter(payment => {\r\n            const patientName = patients.find(p => p.id === payment.patient_id)?.name?.toLowerCase() || '';\r\n            const matchesSearch = patientName.includes(filters.search.toLowerCase()) ||\r\n                payment.concept?.toLowerCase().includes(filters.search.toLowerCase());\r\n\r\n            const matchesStatus = filters.status === 'all' || payment.status === filters.status;\r\n            const matchesMethod = filters.method === 'all' || payment.payment_method === filters.method;\r\n            const matchesCategory = filters.category === 'all' || payment.category === filters.category;\r\n\r\n            const paymentDate = parseISO(payment.date);\r\n            const start = filters.startDate ? parseISO(filters.startDate) : null;\r\n            const end = filters.endDate ? parseISO(filters.endDate) : null;\r\n\r\n            let matchesDate = true;\r\n            if (start && end) {\r\n                matchesDate = isWithinInterval(paymentDate, { start, end });\r\n            } else if (start) {\r\n                matchesDate = paymentDate >= start;\r\n            } else if (end) {\r\n                matchesDate = paymentDate <= end;\r\n            }\r\n\r\n            return matchesSearch && matchesStatus && matchesMethod && matchesCategory && matchesDate;\r\n        }).sort((a, b) => new Date(b.date) - new Date(a.date));\r\n    }, [payments, patients, filters]);\r\n\r\n    // Totales\r\n    const totalAmount = filteredPayments\r\n        .filter(p => p.status === 'pagado')\r\n        .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);\r\n\r\n    const pendingAmount = filteredPayments\r\n        .filter(p => p.status === 'pendiente')\r\n        .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);\r\n\r\n    const handleEdit = (payment) => {\r\n        setEditingPayment(payment);\r\n        setIsModalOpen(true);\r\n    };\r\n\r\n    const handleDelete = (id) => {\r\n        if (confirm('¿Estás seguro de eliminar este pago?')) {\r\n            deletePayment(id);\r\n        }\r\n    };\r\n\r\n    const handleCreate = () => {\r\n        setEditingPayment(null);\r\n        setIsModalOpen(true);\r\n    };\r\n\r\n    const getStatusBadge = (status) => {\r\n        switch (status) {\r\n            case 'pagado': return <span className=\"badge badge-success flex items-center gap-1\"><CheckCircle size={12} /> Pagado</span>;\r\n            case 'pendiente': return <span className=\"badge badge-warning flex items-center gap-1\"><Clock size={12} /> Pendiente</span>;\r\n            case 'cancelado': return <span className=\"badge bg-red-100 text-red-800 flex items-center gap-1\"><XCircle size={12} /> Cancelado</span>;\r\n            default: return <span className=\"badge bg-slate-100 text-slate-600\">{status}</span>;\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"dashboard-container\">\r\n            <div className=\"dashboard-header\">\r\n                <div>\r\n                    <h1 className=\"page-title\">Gestión de Pagos</h1>\r\n                    <p className=\"page-subtitle\">Registra y consulta tus ingresos</p>\r\n                </div>\r\n                <button onClick={handleCreate} className=\"btn btn-primary\">\r\n                    <Plus size={20} /> Nuevo Pago\r\n                </button>\r\n            </div>\r\n\r\n            {/* Stats Cards */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8\">\r\n                <div className=\"card flex items-center justify-between\">\r\n                    <div>\r\n                        <p className=\"text-sm text-slate-500 font-medium\">Total Recaudado (Periodo)</p>\r\n                        <h3 className=\"text-2xl font-bold text-slate-900 dark:text-white\">€{totalAmount.toFixed(2)}</h3>\r\n                    </div>\r\n                    <div className=\"bg-green-100 p-3 rounded-full text-green-600\">\r\n                        <Wallet size={24} />\r\n                    </div>\r\n                </div>\r\n                <div className=\"card flex items-center justify-between\">\r\n                    <div>\r\n                        <p className=\"text-sm text-slate-500 font-medium\">Pendiente de Cobro</p>\r\n                        <h3 className=\"text-2xl font-bold text-amber-600\">€{pendingAmount.toFixed(2)}</h3>\r\n                    </div>\r\n                    <div className=\"bg-amber-100 p-3 rounded-full text-amber-600\">\r\n                        <Clock size={24} />\r\n                    </div>\r\n                </div>\r\n                <div className=\"card flex items-center justify-between\">\r\n                    <div>\r\n                        <p className=\"text-sm text-slate-500 font-medium\">Transacciones</p>\r\n                        <h3 className=\"text-2xl font-bold text-slate-900 dark:text-white\">{filteredPayments.length}</h3>\r\n                    </div>\r\n                    <div className=\"bg-blue-100 p-3 rounded-full text-blue-600\">\r\n                        <Filter size={24} />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Filters Bar */}\r\n            <div className=\"card p-4 space-y-4 md:space-y-0 md:flex md:items-center md:gap-4 flex-wrap\">\r\n                <div className=\"flex-1 relative\">\r\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        placeholder=\"Buscar cliente o concepto...\"\r\n                        className=\"form-input pl-10\"\r\n                        value={filters.search}\r\n                        onChange={e => setFilters({ ...filters, search: e.target.value })}\r\n                    />\r\n                </div>\r\n                <select\r\n                    className=\"form-select w-full md:w-40\"\r\n                    value={filters.status}\r\n                    onChange={e => setFilters({ ...filters, status: e.target.value })}\r\n                >\r\n                    <option value=\"all\">Todos Estados</option>\r\n                    <option value=\"pagado\">Pagado</option>\r\n                    <option value=\"pendiente\">Pendiente</option>\r\n                    <option value=\"cancelado\">Cancelado</option>\r\n                </select>\r\n                <select\r\n                    className=\"form-select w-full md:w-40\"\r\n                    value={filters.method}\r\n                    onChange={e => setFilters({ ...filters, method: e.target.value })}\r\n                >\r\n                    <option value=\"all\">Todo Método</option>\r\n                    {paymentMethods.map(m => (\r\n                        <option key={m.id} value={m.id}>{m.label}</option>\r\n                    ))}\r\n                </select>\r\n                <select\r\n                    className=\"form-select w-full md:w-40\"\r\n                    value={filters.category}\r\n                    onChange={e => setFilters({ ...filters, category: e.target.value })}\r\n                >\r\n                    <option value=\"all\">Todas Categorías</option>\r\n                    {paymentCategories.map(c => (\r\n                        <option key={c.id} value={c.id}>{c.label}</option>\r\n                    ))}\r\n                </select>\r\n                <div className=\"flex items-center gap-2\">\r\n                    <input\r\n                        type=\"date\"\r\n                        className=\"form-input\"\r\n                        value={filters.startDate}\r\n                        onChange={e => setFilters({ ...filters, startDate: e.target.value })}\r\n                    />\r\n                    <span className=\"text-slate-400\">-</span>\r\n                    <input\r\n                        type=\"date\"\r\n                        className=\"form-input\"\r\n                        value={filters.endDate}\r\n                        onChange={e => setFilters({ ...filters, endDate: e.target.value })}\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            {/* Table */}\r\n            <div className=\"card overflow-hidden p-0\">\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"data-table\">\r\n                        <thead className=\"bg-slate-50 dark:bg-slate-800\">\r\n                            <tr>\r\n                                <th>Fecha</th>\r\n                                <th>Cliente</th>\r\n                                <th>Concepto</th>\r\n                                <th>Método</th>\r\n                                <th>Categoría</th>\r\n                                <th>Periodo</th>\r\n                                <th>Total</th>\r\n                                <th>Estado</th>\r\n                                <th className=\"text-right\">Acciones</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className=\"divide-y divide-slate-100 dark:divide-slate-700\">\r\n                            {filteredPayments.length === 0 ? (\r\n                                <tr>\r\n                                    <td colSpan=\"9\" className=\"text-center py-8 text-slate-500\">\r\n                                        No se encontraron pagos con los filtros actuales.\r\n                                    </td>\r\n                                </tr>\r\n                            ) : (\r\n                                filteredPayments.map(p => {\r\n                                    const patient = patients.find(pt => pt.id === p.patient_id);\r\n                                    return (\r\n                                        <tr key={p.id}>\r\n                                            <td className=\"whitespace-nowrap text-sm text-slate-600 dark:text-slate-400\">\r\n                                                {format(parseISO(p.date), 'dd/MM/yyyy')}\r\n                                            </td>\r\n                                            <td className=\"font-medium text-slate-900 dark:text-white\">\r\n                                                {patient?.name || (p.payer_email ? <span className=\"text-slate-500 italic\" title=\"Cliente no encontrado\">{p.payer_email}</span> : 'Cliente desconocido')}\r\n                                            </td>\r\n                                            <td className=\"text-sm text-slate-600 dark:text-slate-400 max-w-xs truncate\">\r\n                                                {p.concept || '-'}\r\n                                            </td>\r\n                                            <td className=\"capitalize text-slate-600 dark:text-slate-400\">\r\n                                                {paymentMethods.find(m => m.id === p.payment_method)?.label || p.payment_method}\r\n                                            </td>\r\n                                            <td>\r\n                                                {(() => {\r\n                                                    const cat = paymentCategories.find(c => c.id === p.category);\r\n                                                    return cat ? (\r\n                                                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${cat.color}`}>\r\n                                                            {cat.label}\r\n                                                        </span>\r\n                                                    ) : <span className=\"text-slate-400\">-</span>;\r\n                                                })()}\r\n                                            </td>\r\n                                            <td className=\"text-sm text-slate-500\">\r\n                                                {p.billing_period ? (\r\n                                                    <span className=\"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-0.5 rounded text-xs\">\r\n                                                        P{p.billing_period}\r\n                                                    </span>\r\n                                                ) : '-'}\r\n                                            </td>\r\n                                            <td className=\"font-semibold text-slate-900 dark:text-white\">\r\n                                                €{parseFloat(p.amount).toFixed(2)}\r\n                                            </td>\r\n                                            <td>\r\n                                                {getStatusBadge(p.status)}\r\n                                            </td>\r\n                                            <td className=\"text-right\">\r\n                                                <div className=\"flex items-center justify-end gap-2\">\r\n                                                    <button\r\n                                                        onClick={() => handleEdit(p)}\r\n                                                        className=\"p-1 text-slate-400 hover:text-primary-600 transition-colors\"\r\n                                                        title=\"Editar\"\r\n                                                    >\r\n                                                        <Edit2 size={16} />\r\n                                                    </button>\r\n                                                    <button\r\n                                                        onClick={() => handleDelete(p.id)}\r\n                                                        className=\"p-1 text-slate-400 hover:text-red-600 transition-colors\"\r\n                                                        title=\"Eliminar\"\r\n                                                    >\r\n                                                        <Trash2 size={16} />\r\n                                                    </button>\r\n                                                </div>\r\n                                            </td>\r\n                                        </tr>\r\n                                    );\r\n                                })\r\n                            )}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Modal */}\r\n            {isModalOpen && (\r\n                <PaymentModal\r\n                    isOpen={isModalOpen}\r\n                    onClose={() => setIsModalOpen(false)}\r\n                    initialData={editingPayment}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Payments;\r\n"},{"path":"src/components/Renewals/Renewals.jsx","content":"import { useData } from '../../context/DataContext';\r\nimport { calculateSubscriptionTerms } from '../../utils/subscriptionUtils';\r\nimport { addDays, format, isBefore, parseISO, startOfMonth, endOfMonth, eachDayOfInterval, isSameDay } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\nimport { Calendar, AlertTriangle, Clock, ChevronLeft, ChevronRight, CreditCard } from 'lucide-react';\r\nimport { useState } from 'react';\r\nimport { Link } from 'react-router-dom';\r\n\r\nconst Renewals = () => {\r\n    const { patients, payments } = useData();\r\n    const [currentMonth] = useState(new Date());\r\n\r\n    // Filter patients with subscriptions and valid end date\r\n    const activeSubs = patients.filter(p => p.subscription && p.subscription.endDate);\r\n\r\n    // Logic for status\r\n    const getStatus = (endDate) => {\r\n        const end = parseISO(endDate);\r\n        const today = new Date();\r\n        const warningDate = addDays(today, 7);\r\n\r\n        if (isBefore(end, today)) return 'expired';\r\n        if (isBefore(end, warningDate)) return 'warning';\r\n        return 'active';\r\n    };\r\n\r\n    const upcomingRenewals = activeSubs.filter(p => {\r\n        const status = getStatus(p.subscription.endDate);\r\n        return status === 'warning';\r\n    });\r\n\r\n    const expiredRenewals = activeSubs.filter(p => {\r\n        const status = getStatus(p.subscription.endDate);\r\n        return status === 'expired';\r\n    });\r\n\r\n    const unpaidRenewals = patients.filter(p => {\r\n        const terms = calculateSubscriptionTerms(p, payments);\r\n        return terms.some(t => t.status === 'active' && !t.isPaid);\r\n    });\r\n\r\n    // Calendar Logic\r\n    const monthStart = startOfMonth(currentMonth);\r\n    const monthEnd = endOfMonth(monthStart);\r\n    const calendarDays = eachDayOfInterval({ start: monthStart, end: monthEnd });\r\n\r\n    return (\r\n        <div className=\"dashboard-container\">\r\n            <div className=\"dashboard-header\">\r\n                <div>\r\n                    <h1 className=\"page-title\">Renovaciones</h1>\r\n                    <p className=\"page-subtitle\">Control de vencimientos y calendario</p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Alerts Section */}\r\n            <div className=\"form-grid mb-8\">\r\n                <div className=\"card\" style={{ borderLeft: '4px solid #f59e0b' }}>\r\n                    <div className=\"card-header\">\r\n                        <h3 className=\"card-title flex items-center gap-2 text-amber-600\">\r\n                            <CreditCard size={20} className=\"text-amber-600\" /> Pendiente de Pago\r\n                        </h3>\r\n                    </div>\r\n                    {unpaidRenewals.length === 0 ? (\r\n                        <p className=\"text-muted text-sm\">Todo al día.</p>\r\n                    ) : (\r\n                        <ul className=\"space-y-2\">\r\n                            {unpaidRenewals.map(p => (\r\n                                <Link to={`/patients/${p.id}?tab=payments`} key={p.id} className=\"flex justify-between items-center bg-amber-50 p-3 rounded-md hover:bg-amber-100 transition-colors\">\r\n                                    <span className=\"font-medium text-sm text-amber-900\">{p.name}</span>\r\n                                    <span className=\"text-xs bg-amber-200 text-amber-900 px-2 py-1 rounded-full\">Ver Ficha</span>\r\n                                </Link>\r\n                            ))}\r\n                        </ul>\r\n                    )}\r\n                </div>\r\n                <div className=\"card\" style={{ borderLeft: '4px solid var(--color-warning)' }}>\r\n                    <div className=\"card-header\">\r\n                        <h3 className=\"card-title flex items-center gap-2 text-warning\">\r\n                            <Clock size={20} className=\"text-warning\" /> Próximos a Vencer (7 días)\r\n                        </h3>\r\n                    </div>\r\n                    {upcomingRenewals.length === 0 ? (\r\n                        <p className=\"text-muted text-sm\">No hay renovaciones próximas.</p>\r\n                    ) : (\r\n                        <ul className=\"space-y-2\">\r\n                            {upcomingRenewals.map(p => (\r\n                                <li key={p.id} className=\"flex justify-between items-center bg-yellow-50 p-3 rounded-md\">\r\n                                    <span className=\"font-medium text-sm\">{p.name}</span>\r\n                                    <span className=\"badge badge-warning\">{format(parseISO(p.subscription.endDate), 'dd/MM')}</span>\r\n                                </li>\r\n                            ))}\r\n                        </ul>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"card\" style={{ borderLeft: '4px solid var(--color-danger)' }}>\r\n                    <div className=\"card-header\">\r\n                        <h3 className=\"card-title flex items-center gap-2 text-danger\">\r\n                            <AlertTriangle size={20} className=\"text-danger\" /> Planes Vencidos\r\n                        </h3>\r\n                    </div>\r\n                    {expiredRenewals.length === 0 ? (\r\n                        <p className=\"text-muted text-sm\">No hay planes vencidos.</p>\r\n                    ) : (\r\n                        <ul className=\"space-y-2\">\r\n                            {expiredRenewals.map(p => (\r\n                                <Link to={`/patients/${p.id}`} key={p.id} className=\"flex justify-between items-center bg-red-50 p-3 rounded-md hover:bg-red-100 transition-colors\">\r\n                                    <span className=\"font-medium text-sm\">{p.name}</span>\r\n                                    <span className=\"badge badge-expired\">{format(parseISO(p.subscription.endDate), 'dd/MM')}</span>\r\n                                </Link>\r\n                            ))}\r\n                        </ul>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Calendar View */}\r\n            <div className=\"card\">\r\n                <div className=\"card-header\">\r\n                    <h3 className=\"card-title flex items-center gap-2\">\r\n                        <Calendar size={20} /> Calendario - {format(currentMonth, 'MMMM yyyy', { locale: es })}\r\n                    </h3>\r\n                    <div className=\"flex gap-2\">\r\n                        {/* Mock navigation for now */}\r\n                        <button className=\"btn btn-ghost btn-icon\"><ChevronLeft size={18} /></button>\r\n                        <button className=\"btn btn-ghost btn-icon\"><ChevronRight size={18} /></button>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden\">\r\n                    {['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'].map(d => (\r\n                        <div key={d} className=\"bg-gray-50 p-2 text-center text-xs font-semibold text-muted uppercase tracking-wider\">\r\n                            {d}\r\n                        </div>\r\n                    ))}\r\n\r\n                    {/* Pad start */}\r\n                    {Array(calendarDays[0].getDay()).fill(null).map((_, i) => (\r\n                        <div key={`pad-${i}`} className=\"bg-white min-h-[100px]\"></div>\r\n                    ))}\r\n\r\n                    {calendarDays.map(day => {\r\n                        const dayRenewals = activeSubs.filter(p => isSameDay(parseISO(p.subscription.endDate), day));\r\n                        const isToday = isSameDay(day, new Date());\r\n                        return (\r\n                            <div key={day.toString()} className={`bg-white min-h-[100px] p-2 hover:bg-gray-50 transition-colors ${isToday ? 'bg-green-50' : ''}`}>\r\n                                <div className={`text-right text-xs font-bold mb-1 ${isToday ? 'text-primary' : 'text-gray-400'}`}>\r\n                                    {format(day, 'd')}\r\n                                </div>\r\n                                <div className=\"space-y-1\">\r\n                                    {dayRenewals.map(p => (\r\n                                        <div key={p.id} className=\"text-[10px] bg-red-100 text-red-800 rounded px-1 py-0.5 truncate border border-red-200\" title={`Vence: ${p.name}`}>\r\n                                            {p.name}\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Renewals;\r\n"},{"path":"src/components/Settings/Settings.jsx","content":"import { useState } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport {\r\n    Plus, Trash2, Edit2, Check, X, Settings as SettingsIcon, CreditCard, User, Database,\r\n    Download, Upload, ArrowDown, ArrowUp, Tag, Wallet, ChevronDown, ChevronRight, Layers, Heart, Users\r\n} from 'lucide-react';\r\n\r\nconst Settings = () => {\r\n    const {\r\n        subscriptionTypes, addSubscriptionType, updateSubscriptionType, deleteSubscriptionType,\r\n        paymentRates, addPaymentRate, updatePaymentRate, deletePaymentRate,\r\n        exportData, importData,\r\n        taskCategories, addTaskCategory, updateTaskCategory, deleteTaskCategory,\r\n        taskTypes, addTaskType, updateTaskType, deleteTaskType,\r\n        userProfile, updateUserProfile,\r\n        paymentMethods, addPaymentMethod, updatePaymentMethod, deletePaymentMethod,\r\n        paymentCategories, addPaymentCategory, updatePaymentCategory, deletePaymentCategory,\r\n        referralSources, addReferralSource, updateReferralSource, deleteReferralSource,\r\n        clinicalOptions, addClinicalOption, updateClinicalOption, deleteClinicalOption,\r\n        clinicalCategories, addClinicalCategory, updateClinicalCategory, deleteClinicalCategory,\r\n        nutritionists, addNutritionist, updateNutritionist, deleteNutritionist\r\n    } = useData();\r\n\r\n    // Active section for accordion\r\n    const [activeSection, setActiveSection] = useState(null);\r\n\r\n    const [isEditingSubType, setIsEditingSubType] = useState(null);\r\n    const [subTypeForm, setSubTypeForm] = useState({ label: '', months: 1 });\r\n\r\n    const [isEditingRate, setIsEditingRate] = useState(null);\r\n    const [rateForm, setRateForm] = useState({ label: '', amount: 0, subscription_type_id: null, is_active: true });\r\n\r\n    // Task Category State (Now Tags)\r\n    const [isEditingCategory, setIsEditingCategory] = useState(null);\r\n    const [categoryForm, setCategoryForm] = useState({ label: '', color: 'bg-slate-100 text-slate-700' });\r\n\r\n    // Task Type State\r\n    const [isEditingType, setIsEditingType] = useState(null);\r\n    const [typeForm, setTypeForm] = useState({ label: '' });\r\n\r\n    // Profile State\r\n    const [isEditingProfile, setIsEditingProfile] = useState(false);\r\n    const [profileForm, setProfileForm] = useState({ name: '', email: '', initials: '' });\r\n\r\n    // Payment Method State\r\n    const [isEditingPaymentMethod, setIsEditingPaymentMethod] = useState(null);\r\n    const [paymentMethodForm, setPaymentMethodForm] = useState({ id: '', label: '' });\r\n\r\n    // Payment Category State\r\n    const [isEditingPaymentCategory, setIsEditingPaymentCategory] = useState(null);\r\n    const [paymentCategoryForm, setPaymentCategoryForm] = useState({ id: '', label: '', color: 'bg-slate-100 text-slate-700' });\r\n\r\n    // Referral Source State\r\n    const [isEditingReferral, setIsEditingReferral] = useState(null);\r\n    const [referralForm, setReferralForm] = useState({ id: '', label: '' });\r\n\r\n    // Clinical Options State\r\n    const [isEditingClinical, setIsEditingClinical] = useState(null);\r\n    const [clinicalForm, setClinicalForm] = useState({ id: '', label: '', category: 'pathology' });\r\n\r\n    // Clinical Categories State\r\n    const [isEditingClinicalCategory, setIsEditingClinicalCategory] = useState(null);\r\n    const [clinicalCategoryForm, setClinicalCategoryForm] = useState({ id: '', label: '', color: 'bg-slate-100 text-slate-700' });\r\n\r\n    // Nutritionist State\r\n    const [isEditingNutritionist, setIsEditingNutritionist] = useState(null);\r\n    const [nutriForm, setNutriForm] = useState({ id: '', label: '', email: '', phone: '' });\r\n\r\n    const colorOptions = [\r\n        { label: 'Gris', value: 'bg-slate-100 text-slate-700' },\r\n        { label: 'Rojo', value: 'bg-red-100 text-red-700' },\r\n        { label: 'Azul', value: 'bg-blue-100 text-blue-700' },\r\n        { label: 'Verde', value: 'bg-green-100 text-green-700' },\r\n        { label: 'Morado', value: 'bg-purple-100 text-purple-700' },\r\n        { label: 'Naranja', value: 'bg-orange-100 text-orange-700' },\r\n    ];\r\n\r\n    // Section definitions\r\n    const sections = [\r\n        { id: 'tarifas', label: 'Tarifas y Planes', icon: CreditCard, description: 'Planes de suscripción' },\r\n        { id: 'pagos', label: 'Pagos', icon: Wallet, description: 'Métodos y categorías de pago' },\r\n        { id: 'equipo', label: 'Equipo', icon: Users, description: 'Nutricionistas y empleados' },\r\n        { id: 'marketing', label: 'Captación', icon: User, description: 'Fuentes de captación de clientes' },\r\n        { id: 'tareas', label: 'Tareas', icon: Tag, description: 'Etiquetas y tipos de tarea' },\r\n        { id: 'perfil', label: 'Perfil', icon: User, description: 'Tu información profesional' },\r\n        { id: 'clinical', label: 'Datos Clínicos', icon: Heart, description: 'Opciones de patologías y alimentos' },\r\n        { id: 'datos', label: 'Datos', icon: Database, description: 'Copias de seguridad' },\r\n    ];\r\n\r\n    // --- HANDLERS ---\r\n    const handleEditCategory = (category) => {\r\n        setIsEditingCategory(category.id);\r\n        setCategoryForm({ label: category.label, color: category.color });\r\n    };\r\n\r\n    const handleSaveCategory = () => {\r\n        if (!categoryForm.label) return;\r\n        if (isEditingCategory === 'new') {\r\n            addTaskCategory(categoryForm);\r\n        } else {\r\n            updateTaskCategory(isEditingCategory, categoryForm);\r\n        }\r\n        setIsEditingCategory(null);\r\n        setCategoryForm({ label: '', color: 'bg-slate-100 text-slate-700' });\r\n    };\r\n\r\n    const startNewCategory = () => {\r\n        setIsEditingCategory('new');\r\n        setCategoryForm({ label: '', color: 'bg-slate-100 text-slate-700' });\r\n    };\r\n\r\n    const handleDeleteCategory = (id) => {\r\n        if (confirm('¿Seguro que deseas eliminar esta etiqueta?')) {\r\n            deleteTaskCategory(id);\r\n        }\r\n    };\r\n\r\n    const handleSaveType = () => {\r\n        if (!typeForm.label) return;\r\n        if (isEditingType === 'new') {\r\n            addTaskType(typeForm);\r\n        } else {\r\n            updateTaskType(isEditingType, typeForm);\r\n        }\r\n        setIsEditingType(null);\r\n        setTypeForm({ label: '' });\r\n    };\r\n\r\n    const handleDeleteType = (id) => {\r\n        if (confirm('¿Seguro que deseas eliminar este tipo de tarea?')) {\r\n            deleteTaskType(id);\r\n        }\r\n    };\r\n\r\n    const startEditProfile = () => {\r\n        setProfileForm(userProfile);\r\n        setIsEditingProfile(true);\r\n    };\r\n\r\n    const saveProfile = () => {\r\n        updateUserProfile(profileForm);\r\n        setIsEditingProfile(false);\r\n    };\r\n\r\n    const handleSaveSubType = () => {\r\n        if (!subTypeForm.label) return;\r\n        if (isEditingSubType === 'new') {\r\n            addSubscriptionType(subTypeForm);\r\n        } else {\r\n            updateSubscriptionType(isEditingSubType, subTypeForm);\r\n        }\r\n        setIsEditingSubType(null);\r\n        setSubTypeForm({ label: '', months: 1 });\r\n    };\r\n\r\n    const handleDeleteSubType = (id) => {\r\n        if (confirm('¿Eliminar este tipo de suscripción?')) {\r\n            deleteSubscriptionType(id);\r\n        }\r\n    };\r\n\r\n    const handleSaveRate = () => {\r\n        if (!rateForm.label) return;\r\n        if (isEditingRate === 'new') {\r\n            addPaymentRate(rateForm);\r\n        } else {\r\n            updatePaymentRate(isEditingRate, rateForm);\r\n        }\r\n        setIsEditingRate(null);\r\n        setRateForm({ label: '', amount: 0 });\r\n    };\r\n\r\n    const handleDeleteRate = (id) => {\r\n        if (confirm('¿Eliminar esta tarifa?')) {\r\n            deletePaymentRate(id);\r\n        }\r\n    };\r\n\r\n    const handleSavePaymentMethod = () => {\r\n        if (!paymentMethodForm.label) return;\r\n        const idToSave = paymentMethodForm.id || paymentMethodForm.label.toLowerCase().replace(/\\s+/g, '_');\r\n        if (isEditingPaymentMethod === 'new') {\r\n            addPaymentMethod({ id: idToSave, label: paymentMethodForm.label, is_active: true });\r\n        } else {\r\n            updatePaymentMethod(isEditingPaymentMethod, { label: paymentMethodForm.label });\r\n        }\r\n        setIsEditingPaymentMethod(null);\r\n        setPaymentMethodForm({ id: '', label: '' });\r\n    };\r\n\r\n    const handleDeletePaymentMethod = (id) => {\r\n        if (confirm('¿Seguro que deseas eliminar este método de pago?')) {\r\n            deletePaymentMethod(id);\r\n        }\r\n    };\r\n\r\n    const handleSavePaymentCategory = () => {\r\n        if (!paymentCategoryForm.label) return;\r\n        const idToSave = paymentCategoryForm.id || paymentCategoryForm.label.toLowerCase().replace(/\\s+/g, '_');\r\n        if (isEditingPaymentCategory === 'new') {\r\n            addPaymentCategory({ id: idToSave, label: paymentCategoryForm.label, color: paymentCategoryForm.color, is_active: true });\r\n        } else {\r\n            updatePaymentCategory(isEditingPaymentCategory, { label: paymentCategoryForm.label, color: paymentCategoryForm.color });\r\n        }\r\n        setIsEditingPaymentCategory(null);\r\n        setPaymentCategoryForm({ id: '', label: '', color: 'bg-slate-100 text-slate-700' });\r\n    };\r\n\r\n    const handleDeletePaymentCategory = (id) => {\r\n        if (confirm('¿Seguro que deseas eliminar esta categoría de pago?')) {\r\n            deletePaymentCategory(id);\r\n        }\r\n    };\r\n\r\n    const handleSaveReferral = () => {\r\n        if (!referralForm.label) return;\r\n        const idToSave = referralForm.id || referralForm.label.toLowerCase().trim().replace(/\\s+/g, '_');\r\n        if (isEditingReferral === 'new') {\r\n            addReferralSource({ id: idToSave, label: referralForm.label, is_active: true });\r\n        } else {\r\n            updateReferralSource(isEditingReferral, { label: referralForm.label });\r\n        }\r\n        setIsEditingReferral(null);\r\n        setReferralForm({ id: '', label: '' });\r\n    };\r\n\r\n    const handleDeleteReferral = (id) => {\r\n        if (confirm('¿Seguro que deseas eliminar esta opción?')) {\r\n            deleteReferralSource(id);\r\n        }\r\n    };\r\n\r\n    const handleSaveClinical = () => {\r\n        if (!clinicalForm.label) return;\r\n        const idToSave = clinicalForm.id || clinicalForm.label.toLowerCase().trim().replace(/\\s+/g, '_');\r\n\r\n        const payload = {\r\n            id: idToSave,\r\n            label: clinicalForm.label,\r\n            category: clinicalForm.category,\r\n            is_active: true\r\n        };\r\n\r\n        if (isEditingClinical === 'new') {\r\n            addClinicalOption(payload);\r\n        } else {\r\n            updateClinicalOption(isEditingClinical, { label: clinicalForm.label, category: clinicalForm.category });\r\n        }\r\n        setIsEditingClinical(null);\r\n        setClinicalForm({ id: '', label: '', category: 'pathology' });\r\n    };\r\n\r\n    const handleDeleteClinical = (id) => {\r\n        if (confirm('¿Seguro que deseas eliminar esta opción?')) {\r\n            deleteClinicalOption(id);\r\n        }\r\n    };\r\n\r\n    const handleSaveClinicalCategory = () => {\r\n        if (!clinicalCategoryForm.label) return;\r\n        const idToSave = clinicalCategoryForm.id || clinicalCategoryForm.label.toLowerCase().trim().replace(/\\s+/g, '_');\r\n\r\n        if (isEditingClinicalCategory === 'new') {\r\n            addClinicalCategory({ id: idToSave, label: clinicalCategoryForm.label, color: clinicalCategoryForm.color, is_active: true });\r\n        } else {\r\n            updateClinicalCategory(isEditingClinicalCategory, { label: clinicalCategoryForm.label, color: clinicalCategoryForm.color });\r\n        }\r\n        setIsEditingClinicalCategory(null);\r\n        setClinicalCategoryForm({ id: '', label: '', color: 'bg-slate-100 text-slate-700' });\r\n    };\r\n\r\n    const handleDeleteClinicalCategory = (id) => {\r\n        if (confirm('¿Seguro que deseas eliminar esta categoría? Se ocultarán las opciones asociadas.')) {\r\n            deleteClinicalCategory(id);\r\n        }\r\n    };\r\n\r\n    const toggleSection = (sectionId) => {\r\n        setActiveSection(activeSection === sectionId ? null : sectionId);\r\n    };\r\n\r\n    // Nutritionist Handlers\r\n    const handleSaveNutritionist = () => {\r\n        if (!nutriForm.label) return;\r\n        const idToSave = nutriForm.id || nutriForm.label.toLowerCase().trim().replace(/\\s+/g, '_');\r\n        if (isEditingNutritionist === 'new') {\r\n            addNutritionist({ id: idToSave, label: nutriForm.label, email: nutriForm.email || null, phone: nutriForm.phone || null, is_active: true });\r\n        } else {\r\n            updateNutritionist(isEditingNutritionist, { label: nutriForm.label, email: nutriForm.email || null, phone: nutriForm.phone || null });\r\n        }\r\n        setIsEditingNutritionist(null);\r\n        setNutriForm({ id: '', label: '', email: '', phone: '' });\r\n    };\r\n\r\n    const handleDeleteNutritionist = (id) => {\r\n        if (confirm('¿Seguro que deseas eliminar este nutricionista?')) {\r\n            deleteNutritionist(id);\r\n        }\r\n    };\r\n\r\n    // --- RENDER SECTIONS ---\r\n    const renderTarifasSection = () => (\r\n        <div className=\"space-y-12\">\r\n            {/* Subscription Types */}\r\n            <div>\r\n                <div className=\"flex justify-between items-center mb-6\">\r\n                    <div>\r\n                        <h4 className=\"font-bold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                            <Layers size={18} /> Tipos de Suscripción\r\n                        </h4>\r\n                        <p className=\"text-sm text-gray-500 mt-1\">Define la periodicidad (Mensual, Trimestral, etc.).</p>\r\n                    </div>\r\n                    <button onClick={() => { setIsEditingSubType('new'); setSubTypeForm({ label: '', months: 1 }); }} className=\"btn btn-outline shadow-sm\" disabled={isEditingSubType !== null}>\r\n                        <Plus size={18} /> Nuevo Tipo\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                    {subscriptionTypes.map(type => (\r\n                        <div key={type.id} className=\"relative p-6 rounded-2xl border border-gray-100 bg-white dark:bg-slate-800 dark:border-slate-700 hover:shadow-lg transition-all\">\r\n                            {isEditingSubType === type.id ? (\r\n                                <div className=\"space-y-4\">\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Nombre</label>\r\n                                        <input className=\"form-input mt-1\" value={subTypeForm.label} onChange={e => setSubTypeForm({ ...subTypeForm, label: e.target.value })} autoFocus />\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Meses</label>\r\n                                        <input type=\"number\" className=\"form-input mt-1\" value={subTypeForm.months} onChange={e => setSubTypeForm({ ...subTypeForm, months: parseInt(e.target.value) || 1 })} />\r\n                                    </div>\r\n                                    <div className=\"flex gap-2 justify-end pt-2\">\r\n                                        <button onClick={() => setIsEditingSubType(null)} className=\"btn btn-sm btn-ghost\">Cancelar</button>\r\n                                        <button onClick={handleSaveSubType} className=\"btn btn-sm btn-primary\"><Check size={16} /></button>\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <>\r\n                                    <div className=\"flex justify-between items-start mb-2\">\r\n                                        <span className=\"px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold uppercase dark:bg-blue-900/30 dark:text-blue-300\">\r\n                                            {type.months} {type.months === 1 ? 'Mes' : 'Meses'}\r\n                                        </span>\r\n                                        <div className=\"flex gap-1\">\r\n                                            <button onClick={() => { setIsEditingSubType(type.id); setSubTypeForm({ label: type.label, months: type.months }); }} className=\"p-1.5 text-slate-400 hover:text-primary-600 rounded-md transition-colors\"><Edit2 size={16} /></button>\r\n                                            <button onClick={() => handleDeleteSubType(type.id)} className=\"p-1.5 text-slate-400 hover:text-red-500 rounded-md transition-colors\"><Trash2 size={16} /></button>\r\n                                        </div>\r\n                                    </div>\r\n                                    <h4 className=\"text-lg font-bold text-gray-800 dark:text-gray-100\">{type.label}</h4>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                    {isEditingSubType === 'new' && (\r\n                        <div className=\"p-6 rounded-2xl border border-primary-500 bg-primary-50/20 ring-2 ring-primary-100 dark:ring-primary-900/30\">\r\n                            <h4 className=\"font-bold text-primary-700 mb-4 text-sm flex items-center gap-2\"><Plus size={16} /> Nuevo Tipo</h4>\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Nombre</label>\r\n                                    <input className=\"form-input mt-1\" value={subTypeForm.label} onChange={e => setSubTypeForm({ ...subTypeForm, label: e.target.value })} placeholder=\"Ej. Semestral\" autoFocus />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Duración (Meses)</label>\r\n                                    <input type=\"number\" className=\"form-input mt-1\" value={subTypeForm.months} onChange={e => setSubTypeForm({ ...subTypeForm, months: parseInt(e.target.value) || 1 })} />\r\n                                </div>\r\n                                <div className=\"flex gap-2 justify-end pt-2\">\r\n                                    <button onClick={() => setIsEditingSubType(null)} className=\"btn btn-sm btn-ghost\">Cancelar</button>\r\n                                    <button onClick={handleSaveSubType} className=\"btn btn-sm btn-primary\">Crear</button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            <hr className=\"border-gray-100 dark:border-slate-700\" />\r\n\r\n            {/* Payment Rates */}\r\n            <div>\r\n                <div className=\"flex justify-between items-center mb-6\">\r\n                    <div>\r\n                        <h4 className=\"font-bold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                            <CreditCard size={18} /> Tarifas de Pago\r\n                        </h4>\r\n                        <p className=\"text-sm text-gray-500 mt-1\">Define los precios y opciones de pago (€).</p>\r\n                    </div>\r\n                    <button onClick={() => { setIsEditingRate('new'); setRateForm({ label: '', amount: 0, subscription_type_id: null, is_active: true }); }} className=\"btn btn-outline shadow-sm\" disabled={isEditingRate !== null}>\r\n                        <Plus size={18} /> Nueva Tarifa\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                    {paymentRates.map(rate => (\r\n                        <div key={rate.id} className={`relative p-6 rounded-2xl border transition-all ${rate.is_active ? 'border-gray-100 bg-white dark:bg-slate-800 dark:border-slate-700' : 'border-gray-100 bg-gray-50 opacity-70'} hover:shadow-lg`}>\r\n                            {isEditingRate === rate.id ? (\r\n                                <div className=\"space-y-4\">\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Etiqueta</label>\r\n                                        <input className=\"form-input mt-1\" value={rateForm.label} onChange={e => setRateForm({ ...rateForm, label: e.target.value })} autoFocus />\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Precio (€)</label>\r\n                                        <input type=\"number\" className=\"form-input mt-1\" value={rateForm.amount} onChange={e => setRateForm({ ...rateForm, amount: parseFloat(e.target.value) || 0 })} />\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Vinculado a Plan</label>\r\n                                        <select\r\n                                            className=\"form-select mt-1\"\r\n                                            value={rateForm.subscription_type_id || ''}\r\n                                            onChange={e => setRateForm({ ...rateForm, subscription_type_id: e.target.value || null })}\r\n                                        >\r\n                                            <option value=\"\">-- No vinculado (General) --</option>\r\n                                            {subscriptionTypes.map(t => (\r\n                                                <option key={t.id} value={t.id}>{t.label}</option>\r\n                                            ))}\r\n                                        </select>\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <input\r\n                                            type=\"checkbox\"\r\n                                            id={`rateActive-${rate.id}`}\r\n                                            checked={rateForm.is_active !== false}\r\n                                            onChange={e => setRateForm({ ...rateForm, is_active: e.target.checked })}\r\n                                            className=\"rounded border-gray-300 text-primary-600 focus:ring-primary-500\"\r\n                                        />\r\n                                        <label htmlFor={`rateActive-${rate.id}`} className=\"text-sm text-gray-700 dark:text-gray-300\">Tarifa Activa</label>\r\n                                    </div>\r\n                                    <div className=\"flex gap-2 justify-end pt-2\">\r\n                                        <button onClick={() => setIsEditingRate(null)} className=\"btn btn-sm btn-ghost\">Cancelar</button>\r\n                                        <button onClick={handleSaveRate} className=\"btn btn-sm btn-primary\"><Check size={16} /></button>\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <>\r\n                                    <div className=\"flex justify-between items-start mb-2\">\r\n                                        <div className=\"p-2 rounded-lg bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400\">\r\n                                            <Wallet size={20} />\r\n                                        </div>\r\n                                        <div className=\"flex gap-1\">\r\n                                            <button onClick={() => {\r\n                                                setIsEditingRate(rate.id);\r\n                                                setRateForm({\r\n                                                    label: rate.label,\r\n                                                    amount: rate.amount,\r\n                                                    subscription_type_id: rate.subscription_type_id || null,\r\n                                                    is_active: rate.is_active\r\n                                                });\r\n                                            }} className=\"p-1.5 text-slate-400 hover:text-primary-600 rounded-md transition-colors\"><Edit2 size={16} /></button>\r\n                                            <button onClick={() => handleDeleteRate(rate.id)} className=\"p-1.5 text-slate-400 hover:text-red-500 rounded-md transition-colors\"><Trash2 size={16} /></button>\r\n                                        </div>\r\n                                    </div>\r\n                                    <h4 className=\"text-lg font-bold text-gray-800 dark:text-gray-100 mb-1\">{rate.label}</h4>\r\n                                    <p className=\"text-2xl font-bold text-green-600 dark:text-green-400\">{rate.amount}€</p>\r\n\r\n                                    {rate.subscription_type_id && (\r\n                                        <div className=\"mt-2 text-xs text-blue-600 bg-blue-50 dark:text-blue-300 dark:bg-blue-900/30 px-2 py-1 rounded inline-block\">\r\n                                            {subscriptionTypes.find(t => t.id === rate.subscription_type_id)?.label || 'Plan vinculado'}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {rate.is_active === false && <span className=\"block mt-2 text-xs text-red-500 font-bold uppercase border border-red-200 bg-red-50 px-2 py-1 rounded w-fit\">Archivado</span>}\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                    {isEditingRate === 'new' && (\r\n                        <div className=\"p-6 rounded-2xl border border-primary-500 bg-primary-50/20 ring-2 ring-primary-100 dark:ring-primary-900/30\">\r\n                            <h4 className=\"font-bold text-primary-700 mb-4 text-sm flex items-center gap-2\"><Plus size={16} /> Nueva Tarifa</h4>\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Etiqueta</label>\r\n                                    <input className=\"form-input mt-1\" value={rateForm.label} onChange={e => setRateForm({ ...rateForm, label: e.target.value })} placeholder=\"Ej. General 2026\" autoFocus />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Precio (€)</label>\r\n                                    <input type=\"number\" className=\"form-input mt-1\" value={rateForm.amount} onChange={e => setRateForm({ ...rateForm, amount: parseFloat(e.target.value) || 0 })} />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Vinculado a Plan</label>\r\n                                    <select\r\n                                        className=\"form-select mt-1\"\r\n                                        value={rateForm.subscription_type_id || ''}\r\n                                        onChange={e => setRateForm({ ...rateForm, subscription_type_id: e.target.value || null })}\r\n                                    >\r\n                                        <option value=\"\">-- No vinculado (General) --</option>\r\n                                        {subscriptionTypes.map(t => (\r\n                                            <option key={t.id} value={t.id}>{t.label}</option>\r\n                                        ))}\r\n                                    </select>\r\n                                </div>\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <input\r\n                                        type=\"checkbox\"\r\n                                        id=\"newRateActive\"\r\n                                        checked={rateForm.is_active !== false}\r\n                                        onChange={e => setRateForm({ ...rateForm, is_active: e.target.checked })}\r\n                                        className=\"rounded border-gray-300 text-primary-600 focus:ring-primary-500\"\r\n                                    />\r\n                                    <label htmlFor=\"newRateActive\" className=\"text-sm text-gray-700 dark:text-gray-300\">Tarifa Activa</label>\r\n                                </div>\r\n                                <div className=\"flex gap-2 justify-end pt-2\">\r\n                                    <button onClick={() => setIsEditingRate(null)} className=\"btn btn-sm btn-ghost\">Cancelar</button>\r\n                                    <button onClick={handleSaveRate} className=\"btn btn-sm btn-primary\">Crear</button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    const renderPagosSection = () => (\r\n        <div className=\"space-y-8\">\r\n            {/* Payment Methods */}\r\n            <div>\r\n                <div className=\"flex justify-between items-center mb-4\">\r\n                    <div>\r\n                        <h4 className=\"font-bold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                            <Wallet size={18} /> Métodos de Pago\r\n                        </h4>\r\n                        <p className=\"text-sm text-gray-500 mt-1\">Configura los métodos de pago disponibles.</p>\r\n                    </div>\r\n                    <button onClick={() => { setIsEditingPaymentMethod('new'); setPaymentMethodForm({ id: '', label: '' }); }} className=\"btn btn-outline shadow-sm\" disabled={isEditingPaymentMethod !== null}>\r\n                        <Plus size={18} /> Nuevo Método\r\n                    </button>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                    {paymentMethods.map(method => (\r\n                        <div key={method.id} className=\"flex justify-between items-center p-4 rounded-xl border border-gray-100 bg-white dark:bg-slate-800 dark:border-slate-700\">\r\n                            {isEditingPaymentMethod === method.id ? (\r\n                                <div className=\"flex gap-2 w-full\">\r\n                                    <input className=\"form-input h-9 text-sm\" value={paymentMethodForm.label} onChange={e => setPaymentMethodForm({ ...paymentMethodForm, label: e.target.value })} autoFocus />\r\n                                    <button onClick={handleSavePaymentMethod} className=\"btn btn-sm btn-primary\"><Check size={14} /></button>\r\n                                    <button onClick={() => setIsEditingPaymentMethod(null)} className=\"btn btn-sm btn-ghost\"><X size={14} /></button>\r\n                                </div>\r\n                            ) : (\r\n                                <>\r\n                                    <span className=\"font-medium text-slate-700 dark:text-slate-200\">{method.label}</span>\r\n                                    <div className=\"flex gap-1\">\r\n                                        <button onClick={() => { setIsEditingPaymentMethod(method.id); setPaymentMethodForm({ id: method.id, label: method.label }); }} className=\"p-1.5 text-slate-400 hover:text-primary-600 hover:bg-slate-50 rounded\"><Edit2 size={16} /></button>\r\n                                        <button onClick={() => handleDeletePaymentMethod(method.id)} className=\"p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded\"><Trash2 size={16} /></button>\r\n                                    </div>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                    {isEditingPaymentMethod === 'new' && (\r\n                        <div className=\"flex gap-2 w-full p-4 rounded-xl border border-primary-500 bg-primary-50/50\">\r\n                            <input className=\"form-input h-9 text-sm\" value={paymentMethodForm.label} onChange={e => setPaymentMethodForm({ ...paymentMethodForm, label: e.target.value })} placeholder=\"Nombre del método...\" autoFocus />\r\n                            <button onClick={handleSavePaymentMethod} className=\"btn btn-sm btn-primary\"><Check size={14} /></button>\r\n                            <button onClick={() => setIsEditingPaymentMethod(null)} className=\"btn btn-sm btn-ghost\"><X size={14} /></button>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Payment Categories */}\r\n            <div className=\"border-t border-slate-100 dark:border-slate-700 pt-8\">\r\n                <div className=\"flex justify-between items-center mb-4\">\r\n                    <div>\r\n                        <h4 className=\"font-bold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                            <Layers size={18} /> Categorías de Pago\r\n                        </h4>\r\n                        <p className=\"text-sm text-gray-500 mt-1\">Clasifica tus pagos por categoría (Online, Hawk, Maroon, etc.).</p>\r\n                    </div>\r\n                    <button onClick={() => { setIsEditingPaymentCategory('new'); setPaymentCategoryForm({ id: '', label: '', color: 'bg-slate-100 text-slate-700' }); }} className=\"btn btn-outline shadow-sm\" disabled={isEditingPaymentCategory !== null}>\r\n                        <Plus size={18} /> Nueva Categoría\r\n                    </button>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                    {paymentCategories.map(cat => (\r\n                        <div key={cat.id} className={`relative p-4 rounded-xl border transition-all duration-300 ${isEditingPaymentCategory === cat.id ? 'border-primary-500 bg-primary-50/50 ring-2 ring-primary-100 dark:bg-primary-900/30' : 'border-gray-100 bg-white dark:bg-slate-800 dark:border-slate-700 hover:border-gray-300 dark:hover:border-slate-600'}`}>\r\n                            {isEditingPaymentCategory === cat.id ? (\r\n                                <div className=\"space-y-4\">\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Nombre</label>\r\n                                        <input className=\"form-input mt-1 bg-white h-9\" value={paymentCategoryForm.label} onChange={e => setPaymentCategoryForm({ ...paymentCategoryForm, label: e.target.value })} autoFocus />\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Color</label>\r\n                                        <div className=\"flex flex-wrap gap-2 mt-2\">\r\n                                            {colorOptions.map(option => (\r\n                                                <button\r\n                                                    key={option.value}\r\n                                                    onClick={() => setPaymentCategoryForm({ ...paymentCategoryForm, color: option.value })}\r\n                                                    className={`w-6 h-6 rounded-full border-2 ${paymentCategoryForm.color === option.value ? 'border-slate-600 scale-110' : 'border-transparent hover:scale-110'} transition-transform`}\r\n                                                    style={{ backgroundColor: option.value.includes('slate') ? '#f1f5f9' : option.value.includes('red') ? '#fee2e2' : option.value.includes('blue') ? '#dbeafe' : option.value.includes('green') ? '#dcfce7' : option.value.includes('purple') ? '#f3e8ff' : '#ffedd5' }}\r\n                                                    title={option.label}\r\n                                                />\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"flex gap-2 justify-end pt-2\">\r\n                                        <button onClick={() => setIsEditingPaymentCategory(null)} className=\"btn btn-sm btn-ghost text-gray-500 hover:bg-white\">Cancelar</button>\r\n                                        <button onClick={handleSavePaymentCategory} className=\"btn btn-sm btn-primary\"><Check size={16} /> Guardar</button>\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <div className=\"flex items-center justify-between\">\r\n                                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${cat.color}`}>{cat.label}</span>\r\n                                    <div className=\"flex gap-1\">\r\n                                        <button onClick={() => { setIsEditingPaymentCategory(cat.id); setPaymentCategoryForm({ id: cat.id, label: cat.label, color: cat.color }); }} className=\"p-1.5 text-slate-400 hover:text-primary-600 hover:bg-slate-50 rounded-md transition-colors\"><Edit2 size={16} /></button>\r\n                                        <button onClick={() => handleDeletePaymentCategory(cat.id)} className=\"p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors\"><Trash2 size={16} /></button>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n\r\n                    {isEditingPaymentCategory === 'new' && (\r\n                        <div className=\"p-4 rounded-xl border border-primary-500 bg-primary-50/50 ring-2 ring-primary-100 animate-fade-in\">\r\n                            <h4 className=\"font-bold text-primary-700 mb-3 text-sm flex items-center gap-2\"><Plus size={16} /> Nueva Categoría</h4>\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Nombre</label>\r\n                                    <input className=\"form-input mt-1 bg-white h-9\" value={paymentCategoryForm.label} onChange={e => setPaymentCategoryForm({ ...paymentCategoryForm, label: e.target.value })} placeholder=\"Ej. Online\" autoFocus />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Color</label>\r\n                                    <div className=\"flex flex-wrap gap-2 mt-2\">\r\n                                        {colorOptions.map(option => (\r\n                                            <button\r\n                                                key={option.value}\r\n                                                onClick={() => setPaymentCategoryForm({ ...paymentCategoryForm, color: option.value })}\r\n                                                className={`w-6 h-6 rounded-full border-2 ${paymentCategoryForm.color === option.value ? 'border-slate-600 scale-110' : 'border-transparent hover:scale-110'} transition-transform`}\r\n                                                style={{ backgroundColor: option.value.includes('slate') ? '#f1f5f9' : option.value.includes('red') ? '#fee2e2' : option.value.includes('blue') ? '#dbeafe' : option.value.includes('green') ? '#dcfce7' : option.value.includes('purple') ? '#f3e8ff' : '#ffedd5' }}\r\n                                                title={option.label}\r\n                                            />\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"flex gap-2 justify-end pt-2\">\r\n                                    <button onClick={() => setIsEditingPaymentCategory(null)} className=\"btn btn-sm btn-ghost text-gray-500 hover:bg-white dark:text-slate-400 dark:hover:bg-slate-700\">Cancelar</button>\r\n                                    <button onClick={handleSavePaymentCategory} className=\"btn btn-sm btn-primary\">Crear</button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    const renderMarketingSection = () => (\r\n        <div className=\"space-y-8\">\r\n            <div>\r\n                <div className=\"flex justify-between items-center mb-4\">\r\n                    <div>\r\n                        <h4 className=\"font-bold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                            <User size={18} /> Fuentes de Captación\r\n                        </h4>\r\n                        <p className=\"text-sm text-gray-500 mt-1\">¿Cómo te conocen tus clientes?</p>\r\n                    </div>\r\n                    <button onClick={() => { setIsEditingReferral('new'); setReferralForm({ id: '', label: '' }); }} className=\"btn btn-outline shadow-sm\" disabled={isEditingReferral !== null}>\r\n                        <Plus size={18} /> Nueva Opción\r\n                    </button>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                    {referralSources.map(source => (\r\n                        <div key={source.id} className=\"flex justify-between items-center p-4 rounded-xl border border-gray-100 bg-white dark:bg-slate-800 dark:border-slate-700\">\r\n                            {isEditingReferral === source.id ? (\r\n                                <div className=\"flex gap-2 w-full\">\r\n                                    <input className=\"form-input h-9 text-sm\" value={referralForm.label} onChange={e => setReferralForm({ ...referralForm, label: e.target.value })} autoFocus />\r\n                                    <button onClick={handleSaveReferral} className=\"btn btn-sm btn-primary\"><Check size={14} /></button>\r\n                                    <button onClick={() => setIsEditingReferral(null)} className=\"btn btn-sm btn-ghost\"><X size={14} /></button>\r\n                                </div>\r\n                            ) : (\r\n                                <>\r\n                                    <span className=\"font-medium text-slate-700 dark:text-slate-200\">{source.label}</span>\r\n                                    <div className=\"flex gap-1\">\r\n                                        <button onClick={() => { setIsEditingReferral(source.id); setReferralForm({ id: source.id, label: source.label }); }} className=\"p-1.5 text-slate-400 hover:text-primary-600 hover:bg-slate-50 rounded\"><Edit2 size={16} /></button>\r\n                                        <button onClick={() => handleDeleteReferral(source.id)} className=\"p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded\"><Trash2 size={16} /></button>\r\n                                    </div>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                    {isEditingReferral === 'new' && (\r\n                        <div className=\"flex gap-2 w-full p-4 rounded-xl border border-primary-500 bg-primary-50/50\">\r\n                            <input className=\"form-input h-9 text-sm\" value={referralForm.label} onChange={e => setReferralForm({ ...referralForm, label: e.target.value })} placeholder=\"Ej. Instagram, Google...\" autoFocus />\r\n                            <button onClick={handleSaveReferral} className=\"btn btn-sm btn-primary\"><Check size={14} /></button>\r\n                            <button onClick={() => setIsEditingReferral(null)} className=\"btn btn-sm btn-ghost\"><X size={14} /></button>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    const renderTareasSection = () => (\r\n        <div className=\"space-y-8\">\r\n            {/* Task Categories (Tags) */}\r\n            <div>\r\n                <div className=\"flex justify-between items-center mb-4\">\r\n                    <div>\r\n                        <h4 className=\"font-bold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                            <Tag size={18} /> Etiquetas de Tareas\r\n                        </h4>\r\n                        <p className=\"text-sm text-gray-500 mt-1\">Etiquetas de color para priorizar y organizar.</p>\r\n                    </div>\r\n                    <button onClick={startNewCategory} className=\"btn btn-outline shadow-sm\" disabled={isEditingCategory !== null}>\r\n                        <Plus size={18} /> Nueva Etiqueta\r\n                    </button>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                    {taskCategories.map(category => (\r\n                        <div key={category.id} className={`relative p-4 rounded-xl border transition-all duration-300 ${isEditingCategory === category.id ? 'border-primary-500 bg-primary-50/50 ring-2 ring-primary-100 dark:bg-primary-900/30' : 'border-gray-100 bg-white dark:bg-slate-800 dark:border-slate-700 hover:border-gray-300 dark:hover:border-slate-600'}`}>\r\n                            {isEditingCategory === category.id ? (\r\n                                <div className=\"space-y-4\">\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Nombre</label>\r\n                                        <input className=\"form-input mt-1 bg-white h-9\" value={categoryForm.label} onChange={e => setCategoryForm({ ...categoryForm, label: e.target.value })} autoFocus />\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Color</label>\r\n                                        <div className=\"flex flex-wrap gap-2 mt-2\">\r\n                                            {colorOptions.map(option => (\r\n                                                <button\r\n                                                    key={option.value}\r\n                                                    onClick={() => setCategoryForm({ ...categoryForm, color: option.value })}\r\n                                                    className={`w-6 h-6 rounded-full border-2 ${categoryForm.color === option.value ? 'border-slate-600 scale-110' : 'border-transparent hover:scale-110'} transition-transform`}\r\n                                                    style={{ backgroundColor: option.value.includes('slate') ? '#f1f5f9' : option.value.includes('red') ? '#fee2e2' : option.value.includes('blue') ? '#dbeafe' : option.value.includes('green') ? '#dcfce7' : option.value.includes('purple') ? '#f3e8ff' : '#ffedd5' }}\r\n                                                    title={option.label}\r\n                                                />\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"flex gap-2 justify-end pt-2\">\r\n                                        <button onClick={() => setIsEditingCategory(null)} className=\"btn btn-sm btn-ghost text-gray-500 hover:bg-white\">Cancelar</button>\r\n                                        <button onClick={handleSaveCategory} className=\"btn btn-sm btn-primary\"><Check size={16} /> Guardar</button>\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <div className=\"flex items-center justify-between\">\r\n                                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${category.color}`}>{category.label}</span>\r\n                                    <div className=\"flex gap-1\">\r\n                                        <button onClick={() => handleEditCategory(category)} className=\"p-1.5 text-slate-400 hover:text-primary-600 hover:bg-slate-50 rounded-md transition-colors\"><Edit2 size={16} /></button>\r\n                                        <button onClick={() => handleDeleteCategory(category.id)} className=\"p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors\"><Trash2 size={16} /></button>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n\r\n                    {isEditingCategory === 'new' && (\r\n                        <div className=\"p-4 rounded-xl border border-primary-500 bg-primary-50/50 ring-2 ring-primary-100 animate-fade-in\">\r\n                            <h4 className=\"font-bold text-primary-700 mb-3 text-sm flex items-center gap-2\"><Plus size={16} /> Nueva Etiqueta</h4>\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Nombre</label>\r\n                                    <input className=\"form-input mt-1 bg-white h-9\" value={categoryForm.label} onChange={e => setCategoryForm({ ...categoryForm, label: e.target.value })} placeholder=\"Ej. Personal\" autoFocus />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Color</label>\r\n                                    <div className=\"flex flex-wrap gap-2 mt-2\">\r\n                                        {colorOptions.map(option => (\r\n                                            <button\r\n                                                key={option.value}\r\n                                                onClick={() => setCategoryForm({ ...categoryForm, color: option.value })}\r\n                                                className={`w-6 h-6 rounded-full border-2 ${categoryForm.color === option.value ? 'border-slate-600 scale-110' : 'border-transparent hover:scale-110'} transition-transform`}\r\n                                                style={{ backgroundColor: option.value.includes('slate') ? '#f1f5f9' : option.value.includes('red') ? '#fee2e2' : option.value.includes('blue') ? '#dbeafe' : option.value.includes('green') ? '#dcfce7' : option.value.includes('purple') ? '#f3e8ff' : '#ffedd5' }}\r\n                                                title={option.label}\r\n                                            />\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"flex gap-2 justify-end pt-2\">\r\n                                    <button onClick={() => setIsEditingCategory(null)} className=\"btn btn-sm btn-ghost text-gray-500 hover:bg-white\">Cancelar</button>\r\n                                    <button onClick={handleSaveCategory} className=\"btn btn-sm btn-primary\">Crear</button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Task Types */}\r\n            <div className=\"border-t border-slate-100 dark:border-slate-700 pt-8\">\r\n                <div className=\"flex justify-between items-center mb-4\">\r\n                    <div>\r\n                        <h4 className=\"font-bold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                            <Database size={18} /> Tipos de Tarea\r\n                        </h4>\r\n                        <p className=\"text-sm text-gray-500 mt-1\">Define los grandes grupos de tareas (Marketing, Clientes, etc).</p>\r\n                    </div>\r\n                    <button onClick={() => { setIsEditingType('new'); setTypeForm({ label: '' }); }} className=\"btn btn-outline shadow-sm\" disabled={isEditingType !== null}>\r\n                        <Plus size={18} /> Nuevo Tipo\r\n                    </button>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                    {taskTypes.map(type => (\r\n                        <div key={type.id} className=\"flex justify-between items-center p-4 rounded-xl border border-gray-100 bg-white dark:bg-slate-800 dark:border-slate-700\">\r\n                            {isEditingType === type.id ? (\r\n                                <div className=\"flex gap-2 w-full\">\r\n                                    <input className=\"form-input h-9 text-sm\" value={typeForm.label} onChange={e => setTypeForm({ ...typeForm, label: e.target.value })} autoFocus />\r\n                                    <button onClick={handleSaveType} className=\"btn btn-sm btn-primary\"><Check size={14} /></button>\r\n                                    <button onClick={() => setIsEditingType(null)} className=\"btn btn-sm btn-ghost\"><X size={14} /></button>\r\n                                </div>\r\n                            ) : (\r\n                                <>\r\n                                    <span className=\"font-medium text-slate-700 dark:text-slate-200\">{type.label}</span>\r\n                                    <div className=\"flex gap-1\">\r\n                                        <button onClick={() => { setIsEditingType(type.id); setTypeForm({ label: type.label }); }} className=\"p-1.5 text-slate-400 hover:text-primary-600 hover:bg-slate-50 rounded\"><Edit2 size={16} /></button>\r\n                                        <button onClick={() => handleDeleteType(type.id)} className=\"p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded\"><Trash2 size={16} /></button>\r\n                                    </div>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                    {isEditingType === 'new' && (\r\n                        <div className=\"flex gap-2 w-full p-4 rounded-xl border border-primary-500 bg-primary-50/50\">\r\n                            <input className=\"form-input h-9 text-sm\" value={typeForm.label} onChange={e => setTypeForm({ ...typeForm, label: e.target.value })} placeholder=\"Nombre del tipo...\" autoFocus />\r\n                            <button onClick={handleSaveType} className=\"btn btn-sm btn-primary\"><Check size={14} /></button>\r\n                            <button onClick={() => setIsEditingType(null)} className=\"btn btn-sm btn-ghost\"><X size={14} /></button>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    const renderPerfilSection = () => (\r\n        <div>\r\n            {isEditingProfile ? (\r\n                <div className=\"space-y-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700\">\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"form-label\">Nombre</label>\r\n                            <input className=\"form-input\" value={profileForm.name} onChange={e => setProfileForm({ ...profileForm, name: e.target.value })} />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"form-label\">Email</label>\r\n                            <input className=\"form-input\" value={profileForm.email} onChange={e => setProfileForm({ ...profileForm, email: e.target.value })} />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"form-label\">Iniciales</label>\r\n                            <input className=\"form-input\" value={profileForm.initials} onChange={e => setProfileForm({ ...profileForm, initials: e.target.value })} maxLength={2} />\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex justify-end gap-2 pt-2\">\r\n                        <button onClick={() => setIsEditingProfile(false)} className=\"btn btn-ghost text-slate-500\">Cancelar</button>\r\n                        <button onClick={saveProfile} className=\"btn btn-primary\">Guardar Cambios</button>\r\n                    </div>\r\n                </div>\r\n            ) : (\r\n                <div className=\"flex items-center gap-6 p-4\">\r\n                    <div className=\"w-20 h-20 rounded-full bg-secondary-400 flex items-center justify-center text-white text-2xl font-bold shadow-md\">\r\n                        {userProfile?.initials}\r\n                    </div>\r\n                    <div className=\"flex-1\">\r\n                        <h4 className=\"text-lg font-bold text-primary-900 dark:text-white\">{userProfile?.name}</h4>\r\n                        <p className=\"text-slate-500 dark:text-slate-400\">{userProfile?.email}</p>\r\n                        <div className=\"mt-2 text-xs bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 py-1 px-3 rounded-full inline-block\">\r\n                            Versión {userProfile?.version}\r\n                        </div>\r\n                    </div>\r\n                    <button onClick={startEditProfile} className=\"btn btn-sm btn-outline\">\r\n                        <Edit2 size={16} className=\"mr-2\" /> Editar Perfil\r\n                    </button>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n\r\n    const renderDatosSection = () => (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n            <div className=\"p-6 rounded-2xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/50 flex flex-col items-center text-center\">\r\n                <div className=\"p-3 bg-white dark:bg-slate-800 rounded-full text-blue-500 mb-3 shadow-sm\"><Download size={24} /></div>\r\n                <h4 className=\"font-bold text-gray-800 dark:text-white mb-2\">Exportar Copia de Seguridad</h4>\r\n                <p className=\"text-sm text-gray-500 dark:text-slate-400 mb-4\">Descarga un archivo .json con todos tus clientes y configuraciones.</p>\r\n                <button onClick={exportData} className=\"btn btn-primary bg-blue-600 hover:bg-blue-700 border-none w-full shadow-md shadow-blue-900/10\">Descargar Copia</button>\r\n            </div>\r\n\r\n            <div className=\"p-6 rounded-2xl bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800/50 flex flex-col items-center text-center\">\r\n                <div className=\"p-3 bg-white dark:bg-slate-800 rounded-full text-orange-500 mb-3 shadow-sm\"><Upload size={24} /></div>\r\n                <h4 className=\"font-bold text-gray-800 dark:text-white mb-2\">Importar Datos</h4>\r\n                <p className=\"text-sm text-gray-500 dark:text-slate-400 mb-4\">Restaura una copia de seguridad seleccionando un archivo .json.</p>\r\n                <label className=\"btn btn-outline border-orange-200 text-orange-600 hover:bg-orange-600 hover:text-white hover:border-orange-600 w-full cursor-pointer transition-colors\">\r\n                    Seleccionar Archivo\r\n                    <input\r\n                        type=\"file\"\r\n                        accept=\".json\"\r\n                        className=\"hidden\"\r\n                        onChange={(e) => {\r\n                            const file = e.target.files[0];\r\n                            if (file) {\r\n                                const reader = new FileReader();\r\n                                reader.onload = (event) => importData(event.target.result);\r\n                                reader.readAsText(file);\r\n                            }\r\n                        }}\r\n                    />\r\n                </label>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    const renderClinicalSection = () => {\r\n        const categories = clinicalCategories && clinicalCategories.length > 0 ? clinicalCategories : [\r\n            { id: 'pathology', label: 'Patologías', color: 'bg-orange-100 text-orange-800' },\r\n            { id: 'dislike', label: 'Alimentos NO gustan', color: 'bg-slate-100 text-slate-700' },\r\n            { id: 'favorite', label: 'Alimentos Favoritos', color: 'bg-green-100 text-green-800' }\r\n        ];\r\n\r\n        return (\r\n            <div className=\"space-y-8\">\r\n                <div>\r\n                    <div className=\"flex justify-between items-center mb-4\">\r\n                        <div>\r\n                            <h4 className=\"font-bold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                                <Heart size={18} /> Opciones Clínicas\r\n                            </h4>\r\n                            <p className=\"text-sm text-gray-500 mt-1\">Configura las categorías y opciones para autocompletar.</p>\r\n                        </div>\r\n                        <div className=\"flex gap-2\">\r\n                            <button\r\n                                onClick={() => {\r\n                                    setIsEditingClinicalCategory('new');\r\n                                    setClinicalCategoryForm({ id: '', label: '', color: 'bg-slate-100 text-slate-700' });\r\n                                }}\r\n                                className=\"btn btn-outline shadow-sm\"\r\n                                disabled={isEditingClinicalCategory !== null}\r\n                            >\r\n                                <Tag size={16} className=\"mr-2\" /> Nueva Categoría\r\n                            </button>\r\n                            <button\r\n                                onClick={() => {\r\n                                    setIsEditingClinical('new');\r\n                                    setClinicalForm({ id: '', label: '', category: categories[0]?.id || 'pathology' });\r\n                                }}\r\n                                className=\"btn btn-outline shadow-sm\"\r\n                                disabled={isEditingClinical !== null}\r\n                            >\r\n                                <Plus size={16} className=\"mr-2\" /> Nueva Opción\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {isEditingClinicalCategory === 'new' && (\r\n                        <div className=\"mb-6 p-4 rounded-xl border border-dashed border-slate-300 bg-slate-50 dark:bg-slate-800/50 dark:border-slate-700 animate-fade-in\">\r\n                            <h4 className=\"font-bold text-slate-700 dark:text-slate-300 mb-3 text-sm\">Nueva Categoría</h4>\r\n                            <div className=\"flex flex-col md:flex-row gap-3 items-center\">\r\n                                <input\r\n                                    className=\"form-input text-sm flex-1 w-full\"\r\n                                    placeholder=\"Nombre de categoría...\"\r\n                                    value={clinicalCategoryForm.label}\r\n                                    onChange={e => setClinicalCategoryForm({ ...clinicalCategoryForm, label: e.target.value })}\r\n                                    autoFocus\r\n                                />\r\n                                <div className=\"flex gap-1\">\r\n                                    {colorOptions.map(co => (\r\n                                        <button\r\n                                            key={co.value}\r\n                                            onClick={() => setClinicalCategoryForm({ ...clinicalCategoryForm, color: co.value })}\r\n                                            className={`w-8 h-8 rounded-full border ${co.value} ${clinicalCategoryForm.color === co.value ? 'ring-2 ring-offset-1 ring-slate-400' : ''}`}\r\n                                        />\r\n                                    ))}\r\n                                </div>\r\n                                <div className=\"flex gap-2\">\r\n                                    <button onClick={handleSaveClinicalCategory} className=\"btn btn-primary btn-sm\">Guardar</button>\r\n                                    <button onClick={() => setIsEditingClinicalCategory(null)} className=\"btn btn-ghost btn-sm\">Cancelar</button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                        {categories.map(cat => (\r\n                            <div key={cat.id} className=\"space-y-3\">\r\n                                {isEditingClinicalCategory === cat.id ? (\r\n                                    <div className=\"p-3 border rounded-lg bg-white dark:bg-slate-800 shadow-sm space-y-3\">\r\n                                        <input\r\n                                            className=\"form-input text-xs w-full\"\r\n                                            value={clinicalCategoryForm.label}\r\n                                            onChange={e => setClinicalCategoryForm({ ...clinicalCategoryForm, label: e.target.value })}\r\n                                        />\r\n                                        <div className=\"flex items-center justify-between\">\r\n                                            <div className=\"flex gap-1 flex-wrap\">\r\n                                                {colorOptions.map(co => (\r\n                                                    <button\r\n                                                        key={co.value}\r\n                                                        onClick={() => setClinicalCategoryForm({ ...clinicalCategoryForm, color: co.value })}\r\n                                                        className={`w-5 h-5 rounded-full border ${co.value} ${clinicalCategoryForm.color === co.value ? 'ring-1 ring-offset-1 ring-slate-400' : ''}`}\r\n                                                    />\r\n                                                ))}\r\n                                            </div>\r\n                                            <div className=\"flex gap-1\">\r\n                                                <button onClick={handleSaveClinicalCategory} className=\"p-1 hover:bg-green-50 text-green-600 rounded bg-slate-50 border\"><Check size={14} /></button>\r\n                                                <button onClick={() => setIsEditingClinicalCategory(null)} className=\"p-1 hover:bg-slate-50 text-slate-500 rounded bg-slate-50 border\"><X size={14} /></button>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"flex justify-between items-center group/cat\">\r\n                                        <h5 className={`text-xs font-bold uppercase tracking-wider px-2 py-1 rounded-md inline-block ${cat.color}`}>\r\n                                            {cat.label}\r\n                                        </h5>\r\n                                        <div className=\"flex gap-1 opacity-0 group-hover/cat:opacity-100 transition-opacity\">\r\n                                            <button\r\n                                                onClick={() => {\r\n                                                    setIsEditingClinicalCategory(cat.id);\r\n                                                    setClinicalCategoryForm({ id: cat.id, label: cat.label, color: cat.color });\r\n                                                }}\r\n                                                className=\"p-1 text-slate-400 hover:text-primary-600 hover:bg-slate-100 rounded\"\r\n                                            >\r\n                                                <Edit2 size={12} />\r\n                                            </button>\r\n                                            <button\r\n                                                onClick={() => handleDeleteClinicalCategory(cat.id)}\r\n                                                className=\"p-1 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded\"\r\n                                            >\r\n                                                <Trash2 size={12} />\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                <div className=\"space-y-2\">\r\n                                    {clinicalOptions?.filter(opt => opt.category === cat.id).map(opt => (\r\n                                        <div key={opt.id} className=\"flex justify-between items-center p-3 rounded-lg border border-gray-100 bg-white dark:bg-slate-800 dark:border-slate-700 hover:shadow-sm transition-shadow\">\r\n                                            {isEditingClinical === opt.id ? (\r\n                                                <div className=\"flex gap-1 w-full items-center\">\r\n                                                    <select\r\n                                                        className=\"form-select h-8 text-xs py-0 pl-2 pr-6 w-32 bg-slate-50 border-slate-200\"\r\n                                                        value={clinicalForm.category}\r\n                                                        onChange={e => setClinicalForm({ ...clinicalForm, category: e.target.value })}\r\n                                                    >\r\n                                                        {categories.map(c => <option key={c.id} value={c.id}>{c.label}</option>)}\r\n                                                    </select>\r\n                                                    <input\r\n                                                        className=\"form-input h-8 text-xs p-1 flex-1\"\r\n                                                        value={clinicalForm.label}\r\n                                                        onChange={e => setClinicalForm({ ...clinicalForm, label: e.target.value })}\r\n                                                        autoFocus\r\n                                                    />\r\n                                                    <button onClick={handleSaveClinical} className=\"btn btn-xs btn-primary h-8 w-8 p-0 flex items-center justify-center\"><Check size={14} /></button>\r\n                                                    <button onClick={() => setIsEditingClinical(null)} className=\"btn btn-xs btn-ghost h-8 w-8 p-0 flex items-center justify-center\"><X size={14} /></button>\r\n                                                </div>\r\n                                            ) : (\r\n                                                <>\r\n                                                    <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">{opt.label}</span>\r\n                                                    <div className=\"flex gap-1\">\r\n                                                        <button\r\n                                                            onClick={() => {\r\n                                                                setIsEditingClinical(opt.id);\r\n                                                                setClinicalForm({ id: opt.id, label: opt.label, category: opt.category });\r\n                                                            }}\r\n                                                            className=\"p-1 text-slate-400 hover:text-primary-600 rounded bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100\"\r\n                                                        >\r\n                                                            <Edit2 size={14} />\r\n                                                        </button>\r\n                                                        <button\r\n                                                            onClick={() => handleDeleteClinical(opt.id)}\r\n                                                            className=\"p-1 text-slate-400 hover:text-red-500 rounded bg-slate-50 dark:bg-slate-700/50 hover:bg-red-50\"\r\n                                                        >\r\n                                                            <Trash2 size={14} />\r\n                                                        </button>\r\n                                                    </div>\r\n                                                </>\r\n                                            )}\r\n                                        </div>\r\n                                    ))}\r\n                                    {clinicalOptions?.filter(opt => opt.category === cat.id).length === 0 && (\r\n                                        <div className=\"text-xs text-slate-400 italic p-2\">Sin opciones configuradas</div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {isEditingClinical === 'new' && (\r\n                        <div className=\"mt-6 p-4 rounded-xl border border-primary-500 bg-primary-50/50 ring-2 ring-primary-100 animate-fade-in max-w-md mx-auto\">\r\n                            <h4 className=\"font-bold text-primary-700 mb-3 text-sm flex items-center gap-2\"><Plus size={16} /> Nueva Opción</h4>\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Categoría</label>\r\n                                    <select\r\n                                        className=\"form-select mt-1 bg-white h-9 text-sm\"\r\n                                        value={clinicalForm.category}\r\n                                        onChange={e => setClinicalForm({ ...clinicalForm, category: e.target.value })}\r\n                                    >\r\n                                        {categories.map(c => <option key={c.id} value={c.id}>{c.label}</option>)}\r\n                                    </select>\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Nombre</label>\r\n                                    <input\r\n                                        className=\"form-input mt-1 bg-white h-9 text-sm\"\r\n                                        value={clinicalForm.label}\r\n                                        onChange={e => setClinicalForm({ ...clinicalForm, label: e.target.value })}\r\n                                        placeholder=\"Ej. Hipertensión, Brócoli...\"\r\n                                        autoFocus\r\n                                    />\r\n                                </div>\r\n                                <div className=\"flex gap-2 justify-end pt-2\">\r\n                                    <button onClick={() => setIsEditingClinical(null)} className=\"btn btn-sm btn-ghost text-gray-500 hover:bg-white dark:text-slate-400 dark:hover:bg-slate-700\">Cancelar</button>\r\n                                    <button onClick={handleSaveClinical} className=\"btn btn-sm btn-primary\">Crear</button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        );\r\n    };\r\n\r\n    const renderEquipoSection = () => (\r\n        <div className=\"space-y-8\">\r\n            <div>\r\n                <div className=\"flex justify-between items-center mb-4\">\r\n                    <div>\r\n                        <h4 className=\"font-bold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                            <Users size={18} /> Nutricionistas\r\n                        </h4>\r\n                        <p className=\"text-sm text-gray-500 mt-1\">Gestiona tu equipo de nutricionistas y empleados.</p>\r\n                    </div>\r\n                    <button onClick={() => { setIsEditingNutritionist('new'); setNutriForm({ id: '', label: '', email: '', phone: '' }); }} className=\"btn btn-outline shadow-sm\" disabled={isEditingNutritionist !== null}>\r\n                        <Plus size={18} /> Nuevo Nutricionista\r\n                    </button>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                    {nutritionists.map(nutri => (\r\n                        <div key={nutri.id} className=\"relative p-6 rounded-2xl border border-gray-100 bg-white dark:bg-slate-800 dark:border-slate-700 hover:shadow-lg transition-all\">\r\n                            {isEditingNutritionist === nutri.id ? (\r\n                                <div className=\"space-y-4\">\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Nombre</label>\r\n                                        <input className=\"form-input mt-1\" value={nutriForm.label} onChange={e => setNutriForm({ ...nutriForm, label: e.target.value })} autoFocus />\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Email</label>\r\n                                        <input type=\"email\" className=\"form-input mt-1\" value={nutriForm.email} onChange={e => setNutriForm({ ...nutriForm, email: e.target.value })} />\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Teléfono</label>\r\n                                        <input className=\"form-input mt-1\" value={nutriForm.phone} onChange={e => setNutriForm({ ...nutriForm, phone: e.target.value })} />\r\n                                    </div>\r\n                                    <div className=\"flex gap-2 justify-end pt-2\">\r\n                                        <button onClick={() => setIsEditingNutritionist(null)} className=\"btn btn-sm btn-ghost\">Cancelar</button>\r\n                                        <button onClick={handleSaveNutritionist} className=\"btn btn-sm btn-primary\"><Check size={16} /></button>\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <>\r\n                                    <div className=\"flex justify-between items-start mb-2\">\r\n                                        <div className=\"p-2 rounded-lg bg-primary-50 text-primary-600 dark:bg-primary-900/30 dark:text-primary-400\">\r\n                                            <User size={20} />\r\n                                        </div>\r\n                                        <div className=\"flex gap-1\">\r\n                                            <button onClick={() => { setIsEditingNutritionist(nutri.id); setNutriForm({ id: nutri.id, label: nutri.label, email: nutri.email || '', phone: nutri.phone || '' }); }} className=\"p-1.5 text-slate-400 hover:text-primary-600 rounded-md transition-colors\"><Edit2 size={16} /></button>\r\n                                            <button onClick={() => handleDeleteNutritionist(nutri.id)} className=\"p-1.5 text-slate-400 hover:text-red-500 rounded-md transition-colors\"><Trash2 size={16} /></button>\r\n                                        </div>\r\n                                    </div>\r\n                                    <h4 className=\"text-lg font-bold text-gray-800 dark:text-gray-100 mb-1\">{nutri.label}</h4>\r\n                                    {nutri.email && <p className=\"text-sm text-slate-500 dark:text-slate-400\">{nutri.email}</p>}\r\n                                    {nutri.phone && <p className=\"text-sm text-slate-500 dark:text-slate-400\">{nutri.phone}</p>}\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                    {isEditingNutritionist === 'new' && (\r\n                        <div className=\"p-6 rounded-2xl border border-primary-500 bg-primary-50/20 ring-2 ring-primary-100 dark:ring-primary-900/30\">\r\n                            <h4 className=\"font-bold text-primary-700 mb-4 text-sm flex items-center gap-2\"><Plus size={16} /> Nuevo Nutricionista</h4>\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Nombre</label>\r\n                                    <input className=\"form-input mt-1\" value={nutriForm.label} onChange={e => setNutriForm({ ...nutriForm, label: e.target.value })} placeholder=\"Ej. Ana García\" autoFocus />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Email</label>\r\n                                    <input type=\"email\" className=\"form-input mt-1\" value={nutriForm.email} onChange={e => setNutriForm({ ...nutriForm, email: e.target.value })} placeholder=\"ana@nutricion.com\" />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold uppercase text-gray-400 tracking-wider\">Teléfono</label>\r\n                                    <input className=\"form-input mt-1\" value={nutriForm.phone} onChange={e => setNutriForm({ ...nutriForm, phone: e.target.value })} placeholder=\"+34 600 000 000\" />\r\n                                </div>\r\n                                <div className=\"flex gap-2 justify-end pt-2\">\r\n                                    <button onClick={() => setIsEditingNutritionist(null)} className=\"btn btn-sm btn-ghost\">Cancelar</button>\r\n                                    <button onClick={handleSaveNutritionist} className=\"btn btn-sm btn-primary\">Crear</button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    const getSectionContent = (sectionId) => {\r\n        switch (sectionId) {\r\n            case 'tarifas': return renderTarifasSection();\r\n            case 'pagos': return renderPagosSection();\r\n            case 'equipo': return renderEquipoSection();\r\n            case 'marketing': return renderMarketingSection();\r\n            case 'tareas': return renderTareasSection();\r\n            case 'perfil': return renderPerfilSection();\r\n            case 'clinical': return renderClinicalSection();\r\n            case 'datos': return renderDatosSection();\r\n            default: return null;\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"dashboard-container\">\r\n            <div className=\"dashboard-header\">\r\n                <div>\r\n                    <h1 className=\"page-title\">Configuración</h1>\r\n                    <p className=\"page-subtitle\">Gestiona las tarifas, pagos y preferencias</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"max-w-5xl mx-auto space-y-4\">\r\n                {sections.map(section => (\r\n                    <div key={section.id} className=\"card overflow-hidden dark:bg-slate-800/50 dark:border-slate-700\">\r\n                        {/* Section Header (Accordion Trigger) */}\r\n                        <button\r\n                            onClick={() => toggleSection(section.id)}\r\n                            className=\"w-full p-6 flex items-center justify-between hover:bg-slate-50/50 dark:hover:bg-slate-700/50 transition-colors\"\r\n                        >\r\n                            <div className=\"flex items-center gap-4\">\r\n                                <div className={`p-3 rounded-xl ${activeSection === section.id ? 'bg-primary-100 text-primary-600 dark:bg-primary-900/40 dark:text-primary-400' : 'bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-400'} transition-colors`}>\r\n                                    <section.icon size={24} />\r\n                                </div>\r\n                                <div className=\"text-left\">\r\n                                    <h3 className=\"text-lg font-bold text-slate-800 dark:text-white\">{section.label}</h3>\r\n                                    <p className=\"text-sm text-slate-500 dark:text-slate-400\">{section.description}</p>\r\n                                </div>\r\n                            </div>\r\n                            <div className={`p-2 rounded-full ${activeSection === section.id ? 'bg-primary-100 text-primary-600 dark:bg-primary-900/40 dark:text-primary-400' : 'bg-slate-100 text-slate-400 dark:bg-slate-700 dark:text-slate-500'} transition-all`}>\r\n                                {activeSection === section.id ? <ChevronDown size={20} /> : <ChevronRight size={20} />}\r\n                            </div>\r\n                        </button>\r\n\r\n                        {/* Section Content (Accordion Panel) */}\r\n                        {activeSection === section.id && (\r\n                            <div className=\"border-t border-slate-100 dark:border-slate-700 p-6 bg-slate-50/30 dark:bg-slate-800/30 animate-fade-in\">\r\n                                {getSectionContent(section.id)}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Settings;\r\n"},{"path":"src/components/Settings/Statistics.jsx","content":"import { useData } from '../../context/DataContext';\r\nimport {\r\n    Chart as ChartJS,\r\n    CategoryScale,\r\n    LinearScale,\r\n    BarElement,\r\n    Title,\r\n    Tooltip,\r\n    Legend,\r\n    ArcElement\r\n} from 'chart.js';\r\nimport { Bar, Doughnut, Pie } from 'react-chartjs-2';\r\nimport { Users, MapPin, Target, Share2 } from 'lucide-react';\r\n\r\nChartJS.register(\r\n    CategoryScale,\r\n    LinearScale,\r\n    BarElement,\r\n    Title,\r\n    Tooltip,\r\n    Legend,\r\n    ArcElement\r\n);\r\n\r\nconst Statistics = () => {\r\n    const { patients } = useData();\r\n\r\n    // --- Data Processing ---\r\n\r\n    // 1. Age Distribution\r\n    const ageData = {\r\n        '18-25': 0,\r\n        '26-35': 0,\r\n        '36-45': 0,\r\n        '46-55': 0,\r\n        '56+': 0\r\n    };\r\n\r\n    patients.forEach(p => {\r\n        const age = parseInt(p.age);\r\n        if (age >= 18 && age <= 25) ageData['18-25']++;\r\n        else if (age >= 26 && age <= 35) ageData['26-35']++;\r\n        else if (age >= 36 && age <= 45) ageData['36-45']++;\r\n        else if (age >= 46 && age <= 55) ageData['46-55']++;\r\n        else if (age >= 56) ageData['56+']++;\r\n    });\r\n\r\n    const ageChartData = {\r\n        labels: Object.keys(ageData),\r\n        datasets: [{\r\n            label: 'Clientes',\r\n            data: Object.values(ageData),\r\n            backgroundColor: '#28483a', // Primary\r\n            borderRadius: 4,\r\n        }]\r\n    };\r\n\r\n    // 2. Sex Distribution\r\n    const sexData = {\r\n        'Mujer': 0,\r\n        'Hombre': 0,\r\n        'Otro': 0\r\n    };\r\n\r\n    patients.forEach(p => {\r\n        const sex = p.sex?.toLowerCase();\r\n        if (sex === 'mujer') sexData['Mujer']++;\r\n        else if (sex === 'hombre') sexData['Hombre']++;\r\n        else sexData['Otro']++;\r\n    });\r\n\r\n    const sexChartData = {\r\n        labels: Object.keys(sexData),\r\n        datasets: [{\r\n            data: Object.values(sexData),\r\n            backgroundColor: ['#d09a84', '#28483a', '#e5e7eb'], // Secondary, Primary, Gray\r\n            borderWidth: 0,\r\n        }]\r\n    };\r\n\r\n    // 3. City Distribution (Top 5)\r\n    const cityCount = {};\r\n    patients.forEach(p => {\r\n        const city = p.city?.trim() || 'No especificado';\r\n        cityCount[city] = (cityCount[city] || 0) + 1;\r\n    });\r\n\r\n    // Sort and get top 5\r\n    const sortedCities = Object.entries(cityCount)\r\n        .sort((a, b) => b[1] - a[1])\r\n        .slice(0, 5);\r\n\r\n    const cityChartData = {\r\n        labels: sortedCities.map(([city]) => city),\r\n        datasets: [{\r\n            label: 'Clientes',\r\n            data: sortedCities.map(([, count]) => count),\r\n            backgroundColor: '#d09a84', // Secondary\r\n            borderRadius: 4,\r\n        }]\r\n    };\r\n\r\n    // 4. Referral Source\r\n    const referralCount = {};\r\n    patients.forEach(p => {\r\n        const source = p.referral_source || p.referralSource || 'No especificado';\r\n        // Capitalize first letter\r\n        const label = source.charAt(0).toUpperCase() + source.slice(1);\r\n        referralCount[label] = (referralCount[label] || 0) + 1;\r\n    });\r\n\r\n    const referralChartData = {\r\n        labels: Object.keys(referralCount),\r\n        datasets: [{\r\n            data: Object.values(referralCount),\r\n            backgroundColor: [\r\n                '#28483a', // Primary\r\n                '#d09a84', // Secondary\r\n                '#a8b3cf', // Slate-ish\r\n                '#e5e7eb', // Gray\r\n                '#fcd34d'  // Yellow\r\n            ],\r\n            borderWidth: 0,\r\n        }]\r\n    };\r\n\r\n    const cardClass = \"bg-white p-6 rounded-xl border border-slate-100 shadow-sm\";\r\n    const headerClass = \"flex items-center gap-2 font-bold text-slate-700 mb-6\";\r\n\r\n    return (\r\n        <div className=\"dashboard-container\">\r\n            <div className=\"dashboard-header\">\r\n                <div>\r\n                    <h1 className=\"page-title\">Estadísticas de Clientes</h1>\r\n                    <p className=\"page-subtitle\">Análisis demográfico y de captación</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in\">\r\n\r\n                {/* Age Chart */}\r\n                <div className={cardClass}>\r\n                    <div className={headerClass}>\r\n                        <Users size={20} className=\"text-primary-600\" /> Distribución por Edad\r\n                    </div>\r\n                    <div className=\"h-64 flex justify-center\">\r\n                        <Bar\r\n                            data={ageChartData}\r\n                            options={{\r\n                                responsive: true,\r\n                                maintainAspectRatio: false,\r\n                                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }\r\n                            }}\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Sex Chart */}\r\n                <div className={cardClass}>\r\n                    <div className={headerClass}>\r\n                        <Users size={20} className=\"text-secondary-600\" /> Distribución por Sexo\r\n                    </div>\r\n                    <div className=\"h-64 flex justify-center relative\">\r\n                        <div className=\"w-64 h-64\">\r\n                            <Doughnut\r\n                                data={sexChartData}\r\n                                options={{\r\n                                    responsive: true,\r\n                                    maintainAspectRatio: false,\r\n                                    plugins: { legend: { position: 'right' } }\r\n                                }}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* City Chart */}\r\n                <div className={cardClass}>\r\n                    <div className={headerClass}>\r\n                        <MapPin size={20} className=\"text-primary-600\" /> Top Ciudades\r\n                    </div>\r\n                    <div className=\"h-64 flex justify-center\">\r\n                        <Bar\r\n                            data={cityChartData}\r\n                            options={{\r\n                                indexAxis: 'y',\r\n                                responsive: true,\r\n                                maintainAspectRatio: false,\r\n                                scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }\r\n                            }}\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Referral Chart */}\r\n                <div className={cardClass}>\r\n                    <div className={headerClass}>\r\n                        <Share2 size={20} className=\"text-secondary-600\" /> Canal de Captación\r\n                    </div>\r\n                    <div className=\"h-64 flex justify-center\">\r\n                        <div className=\"w-64 h-64\">\r\n                            <Pie\r\n                                data={referralChartData}\r\n                                options={{\r\n                                    responsive: true,\r\n                                    maintainAspectRatio: false,\r\n                                    plugins: { legend: { position: 'right' } }\r\n                                }}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Statistics;\r\n"},{"path":"src/components/Tasks/Tasks.jsx","content":"import { useState } from 'react';\r\nimport { useData } from '../../context/DataContext';\r\nimport { CheckSquare, Square, Trash2, Plus, Tag, Filter, Calendar as CalendarIcon, List } from 'lucide-react';\r\nimport { format, startOfWeek, endOfWeek, eachDayOfInterval, isSameDay, isToday, addDays, parseISO } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\n\r\nconst Tasks = () => {\r\n    const { tasks, addTask, updateTask, deleteTask, taskCategories, taskTypes, addTaskType } = useData();\r\n    const [newTaskTitle, setNewTaskTitle] = useState('');\r\n    const [selectedTag, setSelectedTag] = useState('hawk');\r\n    const [selectedType, setSelectedType] = useState('general');\r\n    const [dueDate, setDueDate] = useState('');\r\n    const [viewMode, setViewMode] = useState('list'); // 'list' or 'calendar'\r\n    const [filter, setFilter] = useState('all');\r\n    const [typeFilter, setTypeFilter] = useState('all');\r\n    const [tagFilter, setTagFilter] = useState('all');\r\n    const [isAddingType, setIsAddingType] = useState(false);\r\n    const [newTypeName, setNewTypeName] = useState('');\r\n\r\n    const handleAddTask = (e) => {\r\n        e.preventDefault();\r\n        if (!newTaskTitle.trim()) return;\r\n\r\n        addTask({\r\n            title: newTaskTitle,\r\n            tag: selectedTag,\r\n            type: selectedType,\r\n            dueDate: dueDate || null\r\n        });\r\n        setNewTaskTitle('');\r\n        setDueDate('');\r\n    };\r\n\r\n    const handleAddNewType = async () => {\r\n        if (!newTypeName.trim()) return;\r\n        const id = newTypeName.toLowerCase().trim().replace(/\\s+/g, '_');\r\n\r\n        const existing = taskTypes.find(t => t.id === id);\r\n        if (existing) {\r\n            setSelectedType(id);\r\n            setNewTypeName('');\r\n            setIsAddingType(false);\r\n            return;\r\n        }\r\n\r\n        await addTaskType({ id, label: newTypeName.trim() });\r\n        setNewTypeName('');\r\n        setIsAddingType(false);\r\n        setSelectedType(id);\r\n    };\r\n\r\n    const handleToggle = (task) => {\r\n        updateTask(task.id, { completed: !task.completed });\r\n    };\r\n\r\n    const filteredTasks = tasks.filter(task => {\r\n        // Status Filter\r\n        if (filter === 'pending' && task.completed) return false;\r\n        if (filter === 'completed' && !task.completed) return false;\r\n\r\n        // Type Filter\r\n        const typeId = task.type_id || task.type;\r\n        if (typeFilter !== 'all' && typeId !== typeFilter) return false;\r\n\r\n        // Tag Filter\r\n        const tagId = task.tag_id || task.tag;\r\n        if (tagFilter !== 'all' && tagId !== tagFilter) return false;\r\n\r\n        return true;\r\n    }).sort((a, b) => {\r\n        // Sort: Pending first, then by date\r\n        if (a.completed === b.completed) {\r\n            const dateA = new Date(a.created_at || a.createdAt || 0);\r\n            const dateB = new Date(b.created_at || b.createdAt || 0);\r\n            return dateB - dateA;\r\n        }\r\n        return a.completed ? 1 : -1;\r\n    });\r\n\r\n    const activeCount = tasks.filter(t => !t.completed).length;\r\n\r\n    return (\r\n        <div className=\"dashboard-container\">\r\n            <div className=\"dashboard-header\">\r\n                <div>\r\n                    <h1 className=\"page-title dark:text-white\">Mis Tareas</h1>\r\n                    <p className=\"page-subtitle dark:text-slate-400\">Organiza tu día a día</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in\">\r\n\r\n                {/* Task Input Card */}\r\n                <div className=\"card lg:col-span-1 h-fit\">\r\n                    <div className=\"card-header\">\r\n                        <h3 className=\"card-title text-primary dark:text-primary-400\">Nueva Tarea</h3>\r\n                    </div>\r\n                    <form onSubmit={handleAddTask} className=\"space-y-4\">\r\n                        <div>\r\n                            <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block\">Título</label>\r\n                            <input\r\n                                type=\"text\"\r\n                                className=\"form-input\"\r\n                                placeholder=\"Ej. Llamar a Laura...\"\r\n                                value={newTaskTitle}\r\n                                onChange={(e) => setNewTaskTitle(e.target.value)}\r\n                                autoFocus\r\n                            />\r\n                        </div>\r\n\r\n                        <div>\r\n                            <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block\">Fecha Límite (Opcional)</label>\r\n                            <input\r\n                                type=\"date\"\r\n                                className=\"form-input\"\r\n                                value={dueDate}\r\n                                onChange={(e) => setDueDate(e.target.value)}\r\n                            />\r\n                        </div>\r\n\r\n                        <div>\r\n                            <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 block\">Tipo de Tarea</label>\r\n                            <div className=\"flex flex-wrap gap-2\">\r\n                                {taskTypes.map(type => (\r\n                                    <button\r\n                                        key={type.id}\r\n                                        type=\"button\"\r\n                                        onClick={() => setSelectedType(type.id)}\r\n                                        className={`px-3 py-1.5 rounded-lg text-xs font-semibold transition-all border\r\n                                            ${selectedType === type.id ? 'bg-slate-800 dark:bg-slate-700 text-white border-slate-800 dark:border-slate-700' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600'}\r\n                                        `}\r\n                                    >\r\n                                        {type.label}\r\n                                    </button>\r\n                                ))}\r\n                                {!isAddingType ? (\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={() => setIsAddingType(true)}\r\n                                        className=\"px-3 py-1.5 rounded-lg text-xs font-semibold border border-dashed border-slate-300 dark:border-slate-600 text-slate-500 dark:text-slate-400 hover:text-primary-600 hover:border-primary-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all flex items-center gap-1\"\r\n                                    >\r\n                                        <Plus size={14} /> Otro\r\n                                    </button>\r\n                                ) : (\r\n                                    <div className=\"flex items-center gap-2 animate-fade-in\">\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={newTypeName}\r\n                                            onChange={(e) => setNewTypeName(e.target.value)}\r\n                                            className=\"px-2 py-1 text-xs border border-slate-300 dark:border-slate-600 rounded focus:border-primary-500 outline-none w-24 bg-white dark:bg-slate-800 text-slate-900 dark:text-white\"\r\n                                            placeholder=\"Nombre...\"\r\n                                            autoFocus\r\n                                            onKeyDown={(e) => {\r\n                                                if (e.key === 'Enter') {\r\n                                                    e.preventDefault();\r\n                                                    handleAddNewType();\r\n                                                }\r\n                                                if (e.key === 'Escape') setIsAddingType(false);\r\n                                            }}\r\n                                        />\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={handleAddNewType}\r\n                                            disabled={!newTypeName.trim()}\r\n                                            className=\"p-1 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded\"\r\n                                        >\r\n                                            <CheckSquare size={16} />\r\n                                        </button>\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={() => setIsAddingType(false)}\r\n                                            className=\"p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded\"\r\n                                        >\r\n                                            <Trash2 size={16} className=\"rotate-45\" />\r\n                                        </button>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div>\r\n                            <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 block\">Etiqueta</label>\r\n                            <div className=\"flex flex-wrap gap-2\">\r\n                                {taskCategories.map(category => (\r\n                                    <button\r\n                                        key={category.id}\r\n                                        type=\"button\"\r\n                                        onClick={() => setSelectedTag(category.id)}\r\n                                        className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all border-2\r\n                                            ${selectedTag === category.id ? 'border-primary-500 ring-1 ring-primary-200' : 'border-transparent'}\r\n                                            ${category.color}\r\n                                        `}\r\n                                    >\r\n                                        {category.label}\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <button\r\n                            type=\"submit\"\r\n                            className=\"btn btn-primary w-full justify-center\"\r\n                            disabled={!newTaskTitle.trim()}\r\n                        >\r\n                            <Plus size={18} /> Añadir Tarea\r\n                        </button>\r\n                    </form>\r\n                </div>\r\n\r\n                {/* Task List/Calendar */}\r\n                <div className=\"card lg:col-span-2\">\r\n                    <div className=\"flex items-center justify-between mb-6 border-b border-slate-100 dark:border-slate-700 pb-4 flex-wrap gap-4\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <h3 className=\"card-title dark:text-white\">Agenda</h3>\r\n                            <span className=\"badge badge-primary\">{activeCount} pendientes</span>\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center gap-3\">\r\n                            {/* View Toggle */}\r\n                            <div className=\"flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg\">\r\n                                <button\r\n                                    onClick={() => setViewMode('list')}\r\n                                    className={`p-1.5 rounded transition-colors ${viewMode === 'list' ? 'bg-white dark:bg-slate-600 shadow-sm text-primary-600 dark:text-primary-400' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}\r\n                                    title=\"Vista Lista\"\r\n                                >\r\n                                    <List size={18} />\r\n                                </button>\r\n                                <button\r\n                                    onClick={() => setViewMode('calendar')}\r\n                                    className={`p-1.5 rounded transition-colors ${viewMode === 'calendar' ? 'bg-white dark:bg-slate-600 shadow-sm text-primary-600 dark:text-primary-400' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}\r\n                                    title=\"Vista Calendario\"\r\n                                >\r\n                                    <CalendarIcon size={18} />\r\n                                </button>\r\n                            </div>\r\n\r\n                            {/* Additional Filters: Type & Tag (Only in List Mode) */}\r\n                            {viewMode === 'list' && (\r\n                                <div className=\"flex gap-2\">\r\n                                    <select\r\n                                        value={typeFilter}\r\n                                        onChange={(e) => setTypeFilter(e.target.value)}\r\n                                        className=\"form-select text-xs py-1.5 pl-2 pr-6 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-300 focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50\"\r\n                                    >\r\n                                        <option value=\"all\">Tipos</option>\r\n                                        {taskTypes.map(type => (\r\n                                            <option key={type.id} value={type.id}>{type.label}</option>\r\n                                        ))}\r\n                                    </select>\r\n\r\n                                    <select\r\n                                        value={tagFilter}\r\n                                        onChange={(e) => setTagFilter(e.target.value)}\r\n                                        className=\"form-select text-xs py-1.5 pl-2 pr-6 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-300 focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50\"\r\n                                    >\r\n                                        <option value=\"all\">Etiquetas</option>\r\n                                        {taskCategories.map(cat => (\r\n                                            <option key={cat.id} value={cat.id}>{cat.label}</option>\r\n                                        ))}\r\n                                    </select>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Filters (Only for List View usually, but can keep) */}\r\n                            {viewMode === 'list' && (\r\n                                <div className=\"flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg\">\r\n                                    <button\r\n                                        onClick={() => setFilter('all')}\r\n                                        className={`px-3 py-1 rounded text-xs font-bold transition-colors ${filter === 'all' ? 'bg-white dark:bg-slate-600 shadow-sm text-primary-700 dark:text-primary-400' : 'text-slate-500 dark:text-slate-400'}`}\r\n                                    >\r\n                                        Todas\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => setFilter('pending')}\r\n                                        className={`px-3 py-1 rounded text-xs font-bold transition-colors ${filter === 'pending' ? 'bg-white dark:bg-slate-600 shadow-sm text-primary-700 dark:text-primary-400' : 'text-slate-500 dark:text-slate-400'}`}\r\n                                    >\r\n                                        Pendientes\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => setFilter('completed')}\r\n                                        className={`px-3 py-1 rounded text-xs font-bold transition-colors ${filter === 'completed' ? 'bg-white dark:bg-slate-600 shadow-sm text-primary-700 dark:text-primary-400' : 'text-slate-500 dark:text-slate-400'}`}\r\n                                    >\r\n                                        Hechas\r\n                                    </button>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {viewMode === 'calendar' ? (\r\n                        <TaskCalendar tasks={tasks} />\r\n                    ) : (\r\n                        <div className=\"space-y-2\">\r\n                            {filteredTasks.length === 0 ? (\r\n                                <div className=\"text-center py-12 text-slate-400 dark:text-slate-500\">\r\n                                    <CheckSquare size={48} className=\"mx-auto mb-3 opacity-20\" />\r\n                                    <p>No hay tareas en esta vista.</p>\r\n                                </div>\r\n                            ) : filteredTasks.map(task => {\r\n                                // Support both DB columns and legacy/local state properties\r\n                                const tagId = task.tag_id || task.tag;\r\n                                const typeId = task.type_id || task.type;\r\n                                const createdAt = task.created_at || task.createdAt;\r\n\r\n                                const category = taskCategories.find(c => c.id === tagId);\r\n                                const tagStyle = category?.color || 'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400';\r\n                                const tagLabel = category?.label || 'General';\r\n\r\n                                const typeLabel = taskTypes.find(t => t.id === typeId)?.label || 'General';\r\n\r\n                                return (\r\n                                    <div\r\n                                        key={task.id}\r\n                                        className={`group flex items-center p-3 rounded-lg border transition-all\r\n                                        ${task.completed ? 'bg-slate-50 dark:bg-slate-800/50 border-slate-100 dark:border-slate-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:border-primary-200 hover:shadow-sm'}\r\n                                    `}\r\n                                    >\r\n                                        <button\r\n                                            onClick={() => handleToggle(task)}\r\n                                            className={`mr-4 transition-colors ${task.completed ? 'text-green-500' : 'text-slate-300 hover:text-primary-500 dark:text-slate-600 dark:hover:text-primary-400'}`}\r\n                                        >\r\n                                            {task.completed ? <CheckSquare size={22} /> : <Square size={22} />}\r\n                                        </button>\r\n\r\n                                        <div className=\"flex-1 min-w-0\">\r\n                                            <p className={`font-medium truncate transition-all ${task.completed ? 'text-slate-400 dark:text-slate-600 line-through decoration-slate-300 dark:decoration-slate-600' : 'text-slate-800 dark:text-slate-200'}`}>\r\n                                                {task.title}\r\n                                            </p>\r\n\r\n                                            <div className=\"flex items-center gap-2 mt-1 flex-wrap\">\r\n                                                <span className=\"text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 border border-slate-200 dark:border-slate-600\">\r\n                                                    {typeLabel}\r\n                                                </span>\r\n                                                <span className={`text-[10px] uppercase font-bold px-1.5 py-0.5 rounded ${tagStyle}`}>\r\n                                                    {tagLabel}\r\n                                                </span>\r\n                                                {task.dueDate && (\r\n                                                    <span className=\"text-[10px] text-slate-400 dark:text-slate-500 flex items-center gap-1\">\r\n                                                        <CalendarIcon size={10} /> {format(parseISO(task.dueDate), 'dd/MM')}\r\n                                                    </span>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <button\r\n                                            onClick={() => deleteTask(task.id)}\r\n                                            className=\"ml-2 p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded opacity-0 group-hover:opacity-100 transition-all\"\r\n                                            title=\"Eliminar tarea\"\r\n                                        >\r\n                                            <Trash2 size={16} />\r\n                                        </button>\r\n                                    </div>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    )}\r\n                </div >\r\n            </div >\r\n        </div >\r\n    );\r\n};\r\n\r\nconst TaskCalendar = ({ tasks }) => {\r\n    const today = new Date();\r\n    const start = startOfWeek(today, { locale: es, weekStartsOn: 1 });\r\n    const end = endOfWeek(today, { locale: es, weekStartsOn: 1 });\r\n    // Show 2 weeks for better context? Or just 1 week? User asked for calendar view. \r\n    // Let's do a simple month view or weekly view. Let's do Month View logic actually, or simplify to just \"Upcoming Days\".\r\n    // For now, let's implement a simple list of \"Next 7 Days\" grouped by date, which acts like a calendar agenda.\r\n    // Or a grid. Let's try a grid for the current week.\r\n\r\n    const weekDays = eachDayOfInterval({ start, end });\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <div className=\"grid grid-cols-7 gap-1 text-center mb-2\">\r\n                {['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'].map(day => (\r\n                    <div key={day} className=\"text-xs font-bold text-slate-400 dark:text-slate-500 uppercase\">{day}</div>\r\n                ))}\r\n            </div>\r\n            <div className=\"grid grid-cols-7 gap-1\">\r\n                {weekDays.map(day => {\r\n                    const isTodayDate = isToday(day);\r\n                    const tasksForDay = tasks.filter(t => {\r\n                        const d = t.dueDate ? parseISO(t.dueDate) : (t.due_date ? parseISO(t.due_date) : null);\r\n                        return d && isSameDay(d, day);\r\n                    });\r\n\r\n                    return (\r\n                        <div key={day.toString()} className={`min-h-[100px] border rounded-lg p-1 ${isTodayDate ? 'bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-800' : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700'}`}>\r\n                            <div className={`text-xs font-bold mb-1 ${isTodayDate ? 'text-primary-600 dark:text-primary-400' : 'text-slate-500 dark:text-slate-400'}`}>\r\n                                {format(day, 'd')}\r\n                            </div>\r\n                            <div className=\"space-y-1\">\r\n                                {tasksForDay.map(t => (\r\n                                    <div key={t.id} className=\"text-[10px] p-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded shadow-sm truncate dark:text-slate-200\" title={t.title}>\r\n                                        {t.title}\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n            <div className=\"text-xs text-center text-slate-400 dark:text-slate-500 mt-4\">\r\n                * Se muestran tareas para esta semana.\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Tasks;\r\n"},{"path":"src/components/Team/Team.jsx","content":"import { useData } from '../../context/DataContext';\r\nimport { Users, User, Mail, Phone, UserX } from 'lucide-react';\r\nimport { Link } from 'react-router-dom';\r\n\r\nconst Team = () => {\r\n    const { nutritionists, patients } = useData();\r\n\r\n    // Group patients by nutritionist\r\n    const activePatients = patients.filter(p => p.subscription_status === 'active' || p.subscription_status === 'paused');\r\n\r\n    const getNutriPatients = (nutriId) =>\r\n        activePatients.filter(p => p.nutritionist_id === nutriId);\r\n\r\n    const unassigned = activePatients.filter(p => !p.nutritionist_id);\r\n\r\n    const activeNutritionists = nutritionists.filter(n => n.is_active !== false);\r\n\r\n    return (\r\n        <div className=\"dashboard-container\">\r\n            <div className=\"dashboard-header\">\r\n                <div>\r\n                    <h1 className=\"page-title\">Equipo</h1>\r\n                    <p className=\"page-subtitle\">Nutricionistas y sus clientes asignados</p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Summary Stats */}\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8\">\r\n                <div className=\"card p-5 flex items-center gap-4\">\r\n                    <div className=\"p-3 rounded-xl bg-primary-50 text-primary-600 dark:bg-primary-900/30 dark:text-primary-400\">\r\n                        <Users size={24} />\r\n                    </div>\r\n                    <div>\r\n                        <p className=\"text-2xl font-bold text-slate-800 dark:text-white\">{activeNutritionists.length}</p>\r\n                        <p className=\"text-sm text-slate-500 dark:text-slate-400\">Nutricionistas</p>\r\n                    </div>\r\n                </div>\r\n                <div className=\"card p-5 flex items-center gap-4\">\r\n                    <div className=\"p-3 rounded-xl bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400\">\r\n                        <User size={24} />\r\n                    </div>\r\n                    <div>\r\n                        <p className=\"text-2xl font-bold text-slate-800 dark:text-white\">{activePatients.length - unassigned.length}</p>\r\n                        <p className=\"text-sm text-slate-500 dark:text-slate-400\">Clientes asignados</p>\r\n                    </div>\r\n                </div>\r\n                <div className=\"card p-5 flex items-center gap-4\">\r\n                    <div className=\"p-3 rounded-xl bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400\">\r\n                        <UserX size={24} />\r\n                    </div>\r\n                    <div>\r\n                        <p className=\"text-2xl font-bold text-slate-800 dark:text-white\">{unassigned.length}</p>\r\n                        <p className=\"text-sm text-slate-500 dark:text-slate-400\">Sin asignar</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Nutritionist Cards */}\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                {activeNutritionists.map(nutri => {\r\n                    const assigned = getNutriPatients(nutri.id);\r\n                    return (\r\n                        <div key={nutri.id} className=\"card overflow-hidden dark:bg-slate-800/50 dark:border-slate-700\">\r\n                            <div className=\"p-5 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between\">\r\n                                <div className=\"flex items-center gap-4\">\r\n                                    <div className=\"p-3 rounded-xl bg-primary-50 text-primary-600 dark:bg-primary-900/30 dark:text-primary-400\">\r\n                                        <User size={22} />\r\n                                    </div>\r\n                                    <div>\r\n                                        <h3 className=\"text-lg font-bold text-slate-800 dark:text-white\">{nutri.label}</h3>\r\n                                        <div className=\"flex items-center gap-3 text-sm text-slate-500 dark:text-slate-400 mt-0.5\">\r\n                                            {nutri.email && <span className=\"flex items-center gap-1\"><Mail size={13} /> {nutri.email}</span>}\r\n                                            {nutri.phone && <span className=\"flex items-center gap-1\"><Phone size={13} /> {nutri.phone}</span>}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"px-3 py-1.5 rounded-full bg-primary-50 text-primary-700 dark:bg-primary-900/30 dark:text-primary-400 text-sm font-bold\">\r\n                                    {assigned.length} cliente{assigned.length !== 1 ? 's' : ''}\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"p-4\">\r\n                                {assigned.length === 0 ? (\r\n                                    <p className=\"text-sm text-slate-400 italic py-2 text-center\">Sin clientes asignados</p>\r\n                                ) : (\r\n                                    <div className=\"space-y-1 max-h-64 overflow-y-auto\">\r\n                                        {assigned.map(p => (\r\n                                            <Link\r\n                                                key={p.id}\r\n                                                to={`/patients/${p.id}`}\r\n                                                className=\"flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group\"\r\n                                            >\r\n                                                <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors\">\r\n                                                    {p.first_name} {p.last_name}\r\n                                                </span>\r\n                                                <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${p.subscription_status === 'active'\r\n                                                        ? 'bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400'\r\n                                                        : 'bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400'\r\n                                                    }`}>\r\n                                                    {p.subscription_status === 'active' ? 'Activo' : 'Pausado'}\r\n                                                </span>\r\n                                            </Link>\r\n                                        ))}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    );\r\n                })}\r\n\r\n                {/* Unassigned Card */}\r\n                {unassigned.length > 0 && (\r\n                    <div className=\"card overflow-hidden border-dashed border-2 border-amber-200 dark:border-amber-800/50 dark:bg-slate-800/30\">\r\n                        <div className=\"p-5 border-b border-amber-100 dark:border-amber-900/30 flex items-center justify-between\">\r\n                            <div className=\"flex items-center gap-4\">\r\n                                <div className=\"p-3 rounded-xl bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400\">\r\n                                    <UserX size={22} />\r\n                                </div>\r\n                                <div>\r\n                                    <h3 className=\"text-lg font-bold text-slate-800 dark:text-white\">Sin Asignar</h3>\r\n                                    <p className=\"text-sm text-slate-500 dark:text-slate-400\">Clientes sin nutricionista</p>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"px-3 py-1.5 rounded-full bg-amber-50 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 text-sm font-bold\">\r\n                                {unassigned.length} cliente{unassigned.length !== 1 ? 's' : ''}\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"p-4\">\r\n                            <div className=\"space-y-1 max-h-64 overflow-y-auto\">\r\n                                {unassigned.map(p => (\r\n                                    <Link\r\n                                        key={p.id}\r\n                                        to={`/patients/${p.id}`}\r\n                                        className=\"flex items-center justify-between px-3 py-2 rounded-lg hover:bg-amber-50/50 dark:hover:bg-slate-700/50 transition-colors group\"\r\n                                    >\r\n                                        <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300 group-hover:text-amber-600 dark:group-hover:text-amber-400 transition-colors\">\r\n                                            {p.first_name} {p.last_name}\r\n                                        </span>\r\n                                        <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${p.subscription_status === 'active'\r\n                                                ? 'bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400'\r\n                                                : 'bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400'\r\n                                            }`}>\r\n                                            {p.subscription_status === 'active' ? 'Activo' : 'Pausado'}\r\n                                        </span>\r\n                                    </Link>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Team;\r\n"},{"path":"src/components/Tracking/EvolutionChart.jsx","content":"import {\r\n    Chart as ChartJS,\r\n    CategoryScale,\r\n    LinearScale,\r\n    PointElement,\r\n    LineElement,\r\n    Title,\r\n    Tooltip,\r\n    Legend,\r\n} from 'chart.js';\r\nimport { Line } from 'react-chartjs-2';\r\n\r\nChartJS.register(\r\n    CategoryScale,\r\n    LinearScale,\r\n    PointElement,\r\n    LineElement,\r\n    Title,\r\n    Tooltip,\r\n    Legend\r\n);\r\n\r\nconst EvolutionChart = ({ measurements, dataKey, label, color, chartRef }) => {\r\n    // Sort measurements by date\r\n    const sortedData = [...measurements].sort((a, b) => new Date(a.date) - new Date(b.date));\r\n\r\n    const data = {\r\n        labels: sortedData.map(m => new Date(m.date).toLocaleDateString()),\r\n        datasets: [\r\n            {\r\n                label: label,\r\n                data: sortedData.map(m => m[dataKey]),\r\n                borderColor: color,\r\n                backgroundColor: color,\r\n                tension: 0.3,\r\n                spanGaps: true, // Conecta los puntos aunque haya datos faltantes\r\n            },\r\n        ],\r\n    };\r\n\r\n    const options = {\r\n        responsive: true,\r\n        plugins: {\r\n            legend: {\r\n                position: 'top',\r\n            },\r\n            title: {\r\n                display: false,\r\n            },\r\n        },\r\n        scales: {\r\n            y: {\r\n                beginAtZero: false,\r\n            },\r\n            x: {\r\n                ticks: {\r\n                    maxTicksLimit: 5,\r\n                    maxRotation: 0,\r\n                    autoSkip: true\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    return <Line ref={chartRef} options={options} data={data} />;\r\n};\r\n\r\nexport default EvolutionChart;\r\n"},{"path":"src/components/Tracking/MeasurementModal.jsx","content":"import { useState, useEffect } from 'react';\r\nimport { X, Upload, Info } from 'lucide-react';\r\n\r\nconst MeasurementModal = ({ isOpen, onClose, onSave, initialData }) => {\r\n    const [formData, setFormData] = useState({\r\n        date: new Date().toISOString().split('T')[0],\r\n        weight: '',\r\n        // Campos según la imagen de referencia\r\n        pecho: '',           // 1 - Pecho\r\n        brazo_izq: '',       // 2 - Brazo izquierdo\r\n        brazo_der: '',       // 3 - Brazo derecho\r\n        sobre_ombligo: '',   // 4 - 3cm sobre ombligo\r\n        ombligo: '',         // 5 - Ombligo\r\n        bajo_ombligo: '',    // 6 - 3cm bajo ombligo\r\n        cadera: '',          // 7 - Cadera\r\n        muslo_izq: '',       // 8 - Muslo izquierdo\r\n        muslo_der: '',       // 9 - Muslo derecho\r\n        photo: null\r\n    });\r\n\r\n    const [showGuide, setShowGuide] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            if (initialData) {\r\n                setFormData({\r\n                    ...initialData,\r\n                    date: initialData.date ? initialData.date.split('T')[0] : new Date().toISOString().split('T')[0],\r\n                    weight: initialData.weight || '',\r\n                    pecho: initialData.pecho || '',\r\n                    brazo_izq: initialData.brazo_izq || '',\r\n                    brazo_der: initialData.brazo_der || '',\r\n                    sobre_ombligo: initialData.sobre_ombligo || '',\r\n                    ombligo: initialData.ombligo || '',\r\n                    bajo_ombligo: initialData.bajo_ombligo || '',\r\n                    cadera: initialData.cadera || '',\r\n                    muslo_izq: initialData.muslo_izq || '',\r\n                    muslo_der: initialData.muslo_der || '',\r\n                    photo: initialData.photo || null\r\n                });\r\n            } else {\r\n                setFormData({\r\n                    date: new Date().toISOString().split('T')[0],\r\n                    weight: '',\r\n                    pecho: '',\r\n                    brazo_izq: '',\r\n                    brazo_der: '',\r\n                    sobre_ombligo: '',\r\n                    ombligo: '',\r\n                    bajo_ombligo: '',\r\n                    cadera: '',\r\n                    muslo_izq: '',\r\n                    muslo_der: '',\r\n                    photo: null\r\n                });\r\n            }\r\n        }\r\n    }, [isOpen, initialData]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const handleSubmit = (e) => {\r\n        e.preventDefault();\r\n        onSave(formData);\r\n        onClose();\r\n        setFormData({\r\n            date: new Date().toISOString().split('T')[0],\r\n            weight: '',\r\n            pecho: '',\r\n            brazo_izq: '',\r\n            brazo_der: '',\r\n            sobre_ombligo: '',\r\n            ombligo: '',\r\n            bajo_ombligo: '',\r\n            cadera: '',\r\n            muslo_izq: '',\r\n            muslo_der: '',\r\n            photo: null\r\n        });\r\n    };\r\n\r\n    const handleFileChange = (e) => {\r\n        const file = e.target.files[0];\r\n        if (file) {\r\n            const reader = new FileReader();\r\n            reader.onloadend = () => {\r\n                setFormData(prev => ({ ...prev, photo: reader.result }));\r\n            };\r\n            reader.readAsDataURL(file);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n                <div className=\"flex justify-between items-center p-6 border-b border-slate-100 dark:border-slate-700\">\r\n                    <h3 className=\"text-xl font-bold text-[var(--color-primary)] dark:text-primary-400\">{initialData ? 'Editar Medición' : 'Nueva Medición'}</h3>\r\n                    <button onClick={onClose} className=\"text-slate-400 hover:text-slate-600\">\r\n                        <X size={24} />\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\r\n                    {/* Fecha y Peso */}\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium mb-1\">Fecha</label>\r\n                            <input\r\n                                type=\"date\"\r\n                                required\r\n                                className=\"form-input\"\r\n                                value={formData.date}\r\n                                onChange={e => setFormData({ ...formData, date: e.target.value })}\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium mb-1\">Peso (kg)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                step=\"0.1\"\r\n                                className=\"form-input\"\r\n                                value={formData.weight}\r\n                                onChange={e => setFormData({ ...formData, weight: e.target.value })}\r\n                                required\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Sección de Medidas con Guía Visual */}\r\n                    <div className=\"border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden\">\r\n                        <div className=\"bg-slate-50 dark:bg-slate-900/50 px-4 py-3 flex justify-between items-center\">\r\n                            <h4 className=\"text-sm font-bold text-[var(--color-secondary)] uppercase flex items-center gap-2\">\r\n                                📏 Medidas Corporales (cm)\r\n                            </h4>\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={() => setShowGuide(!showGuide)}\r\n                                className=\"btn btn-sm btn-ghost text-primary-600 flex items-center gap-1\"\r\n                            >\r\n                                <Info size={16} />\r\n                                {showGuide ? 'Ocultar guía' : 'Ver guía'}\r\n                            </button>\r\n                        </div>\r\n\r\n                        {/* Imagen de Guía */}\r\n                        {showGuide && (\r\n                            <div className=\"p-4 bg-white dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700\">\r\n                                <img\r\n                                    src=\"/medidas.png\"\r\n                                    alt=\"Guía de medidas corporales\"\r\n                                    className=\"max-w-full h-auto mx-auto rounded-lg shadow-sm\"\r\n                                    style={{ maxHeight: '300px' }}\r\n                                />\r\n                                <p className=\"text-center text-xs text-slate-500 mt-2\">\r\n                                    Usa esta imagen como referencia para tomar las medidas correctamente\r\n                                </p>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Campos de Medidas */}\r\n                        <div className=\"p-4 space-y-4\">\r\n                            {/* Fila 1: Pecho */}\r\n                            <div>\r\n                                <label className=\"block text-sm font-medium mb-1\">\r\n                                    <span className=\"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-600 text-xs font-bold mr-2\">1</span>\r\n                                    Pecho\r\n                                </label>\r\n                                <input\r\n                                    type=\"number\"\r\n                                    step=\"0.5\"\r\n                                    className=\"form-input\"\r\n                                    placeholder=\"cm\"\r\n                                    value={formData.pecho}\r\n                                    onChange={e => setFormData({ ...formData, pecho: e.target.value })}\r\n                                />\r\n                            </div>\r\n\r\n                            {/* Fila 2: Brazos */}\r\n                            <div className=\"grid grid-cols-2 gap-4\">\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium mb-1\">\r\n                                        <span className=\"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-600 text-xs font-bold mr-2\">2</span>\r\n                                        Brazo Izquierdo\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        step=\"0.5\"\r\n                                        className=\"form-input\"\r\n                                        placeholder=\"cm\"\r\n                                        value={formData.brazo_izq}\r\n                                        onChange={e => setFormData({ ...formData, brazo_izq: e.target.value })}\r\n                                    />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium mb-1\">\r\n                                        <span className=\"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-600 text-xs font-bold mr-2\">3</span>\r\n                                        Brazo Derecho\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        step=\"0.5\"\r\n                                        className=\"form-input\"\r\n                                        placeholder=\"cm\"\r\n                                        value={formData.brazo_der}\r\n                                        onChange={e => setFormData({ ...formData, brazo_der: e.target.value })}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Fila 3: Zona Abdominal */}\r\n                            <div className=\"grid grid-cols-3 gap-4\">\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium mb-1\">\r\n                                        <span className=\"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-600 text-xs font-bold mr-2\">4</span>\r\n                                        3cm Sobre Ombligo\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        step=\"0.5\"\r\n                                        className=\"form-input\"\r\n                                        placeholder=\"cm\"\r\n                                        value={formData.sobre_ombligo}\r\n                                        onChange={e => setFormData({ ...formData, sobre_ombligo: e.target.value })}\r\n                                    />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium mb-1\">\r\n                                        <span className=\"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-600 text-xs font-bold mr-2\">5</span>\r\n                                        Ombligo\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        step=\"0.5\"\r\n                                        className=\"form-input\"\r\n                                        placeholder=\"cm\"\r\n                                        value={formData.ombligo}\r\n                                        onChange={e => setFormData({ ...formData, ombligo: e.target.value })}\r\n                                    />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium mb-1\">\r\n                                        <span className=\"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-600 text-xs font-bold mr-2\">6</span>\r\n                                        3cm Bajo Ombligo\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        step=\"0.5\"\r\n                                        className=\"form-input\"\r\n                                        placeholder=\"cm\"\r\n                                        value={formData.bajo_ombligo}\r\n                                        onChange={e => setFormData({ ...formData, bajo_ombligo: e.target.value })}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Fila 4: Cadera */}\r\n                            <div>\r\n                                <label className=\"block text-sm font-medium mb-1\">\r\n                                    <span className=\"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-600 text-xs font-bold mr-2\">7</span>\r\n                                    Cadera\r\n                                </label>\r\n                                <input\r\n                                    type=\"number\"\r\n                                    step=\"0.5\"\r\n                                    className=\"form-input\"\r\n                                    placeholder=\"cm\"\r\n                                    value={formData.cadera}\r\n                                    onChange={e => setFormData({ ...formData, cadera: e.target.value })}\r\n                                />\r\n                            </div>\r\n\r\n                            {/* Fila 5: Muslos */}\r\n                            <div className=\"grid grid-cols-2 gap-4\">\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium mb-1\">\r\n                                        <span className=\"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-600 text-xs font-bold mr-2\">8</span>\r\n                                        Muslo Izquierdo\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        step=\"0.5\"\r\n                                        className=\"form-input\"\r\n                                        placeholder=\"cm\"\r\n                                        value={formData.muslo_izq}\r\n                                        onChange={e => setFormData({ ...formData, muslo_izq: e.target.value })}\r\n                                    />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium mb-1\">\r\n                                        <span className=\"inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-600 text-xs font-bold mr-2\">9</span>\r\n                                        Muslo Derecho\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        step=\"0.5\"\r\n                                        className=\"form-input\"\r\n                                        placeholder=\"cm\"\r\n                                        value={formData.muslo_der}\r\n                                        onChange={e => setFormData({ ...formData, muslo_der: e.target.value })}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Foto de Progreso */}\r\n                    <div>\r\n                        <label className=\"block text-sm font-medium mb-1\">Foto de Progreso (Opcional)</label>\r\n                        <div className=\"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors relative\">\r\n                            <input\r\n                                type=\"file\"\r\n                                accept=\"image/*\"\r\n                                onChange={handleFileChange}\r\n                                className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer\"\r\n                            />\r\n                            {formData.photo ? (\r\n                                <div className=\"text-green-600 font-medium\">¡Foto seleccionada!</div>\r\n                            ) : (\r\n                                <div className=\"flex flex-col items-center text-gray-400\">\r\n                                    <Upload size={24} className=\"mb-2\" />\r\n                                    <span className=\"text-sm\">Click para subir foto</span>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Botones */}\r\n                    <div className=\"flex justify-end gap-3 pt-4 border-t border-slate-100\">\r\n                        <button type=\"button\" onClick={onClose} className=\"btn btn-outline\">Cancelar</button>\r\n                        <button type=\"submit\" className=\"btn btn-primary\">{initialData ? 'Guardar Cambios' : 'Guardar Registro'}</button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MeasurementModal;\r\n"},{"path":"src/components/Tracking/PdfExportModal.jsx","content":"import { useState } from 'react';\r\nimport { X, FileDown, Check, BarChart3 } from 'lucide-react';\r\n\r\nconst ALL_CHARTS = [\r\n    { key: 'weight', label: 'Peso (kg)' },\r\n    { key: 'pecho', label: 'Pecho (cm)' },\r\n    { key: 'cadera', label: 'Cadera (cm)' },\r\n    { key: 'sobre_ombligo', label: 'Abd. Sobre Ombligo (cm)' },\r\n    { key: 'ombligo', label: 'Abd. Ombligo (cm)' },\r\n    { key: 'bajo_ombligo', label: 'Abd. Bajo Ombligo (cm)' },\r\n    { key: 'brazo_izq', label: 'Brazo Izquierdo (cm)' },\r\n    { key: 'brazo_der', label: 'Brazo Derecho (cm)' },\r\n    { key: 'muslo_izq', label: 'Muslo Izquierdo (cm)' },\r\n    { key: 'muslo_der', label: 'Muslo Derecho (cm)' }\r\n];\r\n\r\nconst PdfExportModal = ({ isOpen, onClose, onExport }) => {\r\n    const [selectedCharts, setSelectedCharts] = useState(\r\n        ALL_CHARTS.map(c => c.key)\r\n    );\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const allSelected = selectedCharts.length === ALL_CHARTS.length;\r\n\r\n    const toggleChart = (key) => {\r\n        setSelectedCharts(prev =>\r\n            prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]\r\n        );\r\n    };\r\n\r\n    const toggleAll = () => {\r\n        setSelectedCharts(allSelected ? [] : ALL_CHARTS.map(c => c.key));\r\n    };\r\n\r\n    const handleExport = () => {\r\n        onExport(selectedCharts);\r\n        onClose();\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4\">\r\n            <div className=\"bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-md overflow-hidden animate-fade-in\">\r\n                <div className=\"p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"p-2 rounded-lg bg-primary-50 text-primary-600 dark:bg-primary-900/30 dark:text-primary-400\">\r\n                            <FileDown size={20} />\r\n                        </div>\r\n                        <div>\r\n                            <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">Exportar PDF</h3>\r\n                            <p className=\"text-sm text-slate-500 dark:text-slate-400\">Selecciona los gráficos a incluir</p>\r\n                        </div>\r\n                    </div>\r\n                    <button onClick={onClose} className=\"text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 p-1\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"p-5 space-y-4\">\r\n                    {/* Select All Toggle */}\r\n                    <button\r\n                        onClick={toggleAll}\r\n                        className=\"w-full flex items-center justify-between px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors\"\r\n                    >\r\n                        <span className=\"text-sm font-bold text-slate-700 dark:text-slate-200\">\r\n                            {allSelected ? 'Deseleccionar todo' : 'Seleccionar todo'}\r\n                        </span>\r\n                        <div className={`w-5 h-5 rounded flex items-center justify-center transition-colors ${allSelected ? 'bg-primary-600 text-white' : 'border-2 border-slate-300 dark:border-slate-500'\r\n                            }`}>\r\n                            {allSelected && <Check size={14} />}\r\n                        </div>\r\n                    </button>\r\n\r\n                    {/* Chart Checkboxes */}\r\n                    <div className=\"grid grid-cols-1 gap-1.5 max-h-64 overflow-y-auto\">\r\n                        {ALL_CHARTS.map(chart => {\r\n                            const isSelected = selectedCharts.includes(chart.key);\r\n                            return (\r\n                                <button\r\n                                    key={chart.key}\r\n                                    onClick={() => toggleChart(chart.key)}\r\n                                    className={`flex items-center justify-between px-3 py-2.5 rounded-lg transition-colors text-left ${isSelected\r\n                                            ? 'bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800'\r\n                                            : 'bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50'\r\n                                        }`}\r\n                                >\r\n                                    <div className=\"flex items-center gap-2.5\">\r\n                                        <BarChart3 size={16} className={isSelected ? 'text-primary-600 dark:text-primary-400' : 'text-slate-400'} />\r\n                                        <span className={`text-sm font-medium ${isSelected ? 'text-primary-700 dark:text-primary-300' : 'text-slate-600 dark:text-slate-400'\r\n                                            }`}>\r\n                                            {chart.label}\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className={`w-5 h-5 rounded flex items-center justify-center transition-colors ${isSelected ? 'bg-primary-600 text-white' : 'border-2 border-slate-300 dark:border-slate-500'\r\n                                        }`}>\r\n                                        {isSelected && <Check size={14} />}\r\n                                    </div>\r\n                                </button>\r\n                            );\r\n                        })}\r\n                    </div>\r\n\r\n                    <p className=\"text-xs text-slate-400 text-center\">\r\n                        {selectedCharts.length} de {ALL_CHARTS.length} gráficos seleccionados.\r\n                        El resumen de evolución (primera vs última medición) se incluye siempre.\r\n                    </p>\r\n                </div>\r\n\r\n                <div className=\"p-4 border-t border-slate-100 dark:border-slate-700 flex gap-3\">\r\n                    <button onClick={onClose} className=\"btn btn-outline flex-1\">\r\n                        Cancelar\r\n                    </button>\r\n                    <button onClick={handleExport} className=\"btn btn-primary flex-1\">\r\n                        <FileDown size={18} /> Generar PDF\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PdfExportModal;\r\n"},{"path":"src/components/Tracking/TrackingCalendar.jsx","content":"import { useState } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useData } from '../../context/DataContext';\r\nimport { addDays, format, startOfWeek, endOfWeek, startOfMonth, endOfMonth, eachDayOfInterval, isSameMonth, isSameDay, parseISO } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\nimport { ChevronLeft, ChevronRight, Calendar as CalendarIcon, List, LayoutGrid, CheckSquare, Square, PenLine } from 'lucide-react';\r\n\r\nconst TrackingCalendar = () => {\r\n    const { patients, reviews, saveReview } = useData();\r\n    const navigate = useNavigate();\r\n    const [currentDate, setCurrentDate] = useState(new Date());\r\n    const [viewMode, setViewMode] = useState('week'); // Default to 'week'\r\n    const [onlyReviews, setOnlyReviews] = useState(false); // Filter to show only reviews\r\n\r\n    // Event type styles\r\n    const eventStyles = {\r\n        inicio: { label: '🚀 Inicio', bg: 'bg-blue-50 dark:bg-blue-900/30', text: 'text-blue-700 dark:text-blue-300', border: 'border-blue-200 dark:border-blue-800' },\r\n        semana: { label: '📅 7 días', bg: 'bg-purple-50 dark:bg-purple-900/30', text: 'text-purple-700 dark:text-purple-300', border: 'border-purple-200 dark:border-purple-800' },\r\n        alerta5: { label: '⚠️ 5 días', bg: 'bg-amber-50 dark:bg-amber-900/30', text: 'text-amber-700 dark:text-amber-300', border: 'border-amber-200 dark:border-amber-800' },\r\n        alerta1: { label: '🔔 Último día', bg: 'bg-red-50 dark:bg-red-900/30', text: 'text-red-700 dark:text-red-300', border: 'border-red-200 dark:border-red-800' },\r\n        revision: { label: 'Revisión', bg: 'bg-primary-50 dark:bg-primary-900/30', text: 'text-primary-700 dark:text-primary-300', border: 'border-primary-100 dark:border-primary-800' }\r\n    };\r\n\r\n    // Generate Review Events AND Milestone Alerts\r\n    const events = patients.flatMap(patient => {\r\n        if (!patient.subscription?.startDate) return [];\r\n        if (patient.subscription?.status === 'paused') return [];\r\n\r\n        const start = parseISO(patient.subscription.startDate);\r\n        const end = patient.subscription.endDate ? parseISO(patient.subscription.endDate) : addDays(start, 30);\r\n        const patientEvents = [];\r\n\r\n        // === MILESTONE ALERTS ===\r\n\r\n        // 1. Start day alert\r\n        // Only show start alert if it's the very first subscription (no previous history)\r\n        const isFirstSubscription = !patient.subscriptionHistory?.some(sub =>\r\n            sub.start_date && parseISO(sub.start_date) < start\r\n        );\r\n\r\n        if (isFirstSubscription) {\r\n            patientEvents.push({\r\n                sysId: `alert_inicio_${patient.id}`,\r\n                date: start,\r\n                patientName: patient.name,\r\n                patientId: patient.id,\r\n                type: 'inicio',\r\n                isAlert: true\r\n            });\r\n        }\r\n\r\n        // 2. 7 days milestone\r\n        const day7 = addDays(start, 7);\r\n        if (day7 <= end) {\r\n            patientEvents.push({\r\n                sysId: `alert_7dias_${patient.id}`,\r\n                date: day7,\r\n                patientName: patient.name,\r\n                patientId: patient.id,\r\n                type: 'semana',\r\n                isAlert: true\r\n            });\r\n        }\r\n\r\n        // 3. 5 days remaining alert\r\n        const fiveDaysLeft = addDays(end, -5);\r\n        if (fiveDaysLeft > start) {\r\n            patientEvents.push({\r\n                sysId: `alert_5dias_${patient.id}`,\r\n                date: fiveDaysLeft,\r\n                patientName: patient.name,\r\n                patientId: patient.id,\r\n                type: 'alerta5',\r\n                isAlert: true\r\n            });\r\n        }\r\n\r\n        // 4. 1 day remaining alert\r\n        const oneDayLeft = addDays(end, -1);\r\n        if (oneDayLeft > start && !isSameDay(oneDayLeft, fiveDaysLeft)) {\r\n            patientEvents.push({\r\n                sysId: `alert_1dia_${patient.id}`,\r\n                date: oneDayLeft,\r\n                patientName: patient.name,\r\n                patientId: patient.id,\r\n                type: 'alerta1',\r\n                isAlert: true\r\n            });\r\n        }\r\n\r\n        // === WEEKLY REVIEWS (existing logic) ===\r\n        let reviewDate = addDays(start, 7);\r\n        while (reviewDate <= end) {\r\n            const reviewId = `review_${patient.id}_${format(reviewDate, 'yyyy-MM-dd')}`;\r\n            const savedData = reviews?.[reviewId] || {};\r\n\r\n            patientEvents.push({\r\n                sysId: reviewId,\r\n                date: reviewDate,\r\n                patientName: patient.name,\r\n                patientId: patient.id,\r\n                type: 'revision',\r\n                completed: savedData.completed || false,\r\n                notes: savedData.notes || '',\r\n                isAlert: false\r\n            });\r\n            reviewDate = addDays(reviewDate, 7);\r\n        }\r\n        return patientEvents;\r\n    });\r\n\r\n    // Toggle Complete\r\n    const handleToggleComplete = (evt) => {\r\n        saveReview(evt.sysId, { completed: !evt.completed });\r\n    };\r\n\r\n    // Save Notes\r\n    const handleNotesChange = (sysId, note) => {\r\n        saveReview(sysId, { notes: note });\r\n    };\r\n\r\n    // Calendar Navigation\r\n    const nextPeriod = () => {\r\n        if (viewMode === 'week' || viewMode === 'list') {\r\n            setCurrentDate(addDays(currentDate, 7));\r\n        } else {\r\n            const next = new Date(currentDate);\r\n            next.setMonth(currentDate.getMonth() + 1);\r\n            setCurrentDate(next);\r\n        }\r\n    };\r\n\r\n    const prevPeriod = () => {\r\n        if (viewMode === 'week' || viewMode === 'list') {\r\n            setCurrentDate(addDays(currentDate, -7));\r\n        } else {\r\n            const prev = new Date(currentDate);\r\n            prev.setMonth(currentDate.getMonth() - 1);\r\n            setCurrentDate(prev);\r\n        }\r\n    };\r\n\r\n    // View Logic Dates\r\n    const monthStart = startOfMonth(currentDate);\r\n    const monthEnd = endOfMonth(monthStart);\r\n    const monthStartDate = startOfWeek(monthStart, { weekStartsOn: 1 });\r\n    const monthEndDate = endOfWeek(monthEnd, { weekStartsOn: 1 });\r\n\r\n    const weekStart = startOfWeek(currentDate, { weekStartsOn: 1 });\r\n\r\n    // Determine days to render based on viewMode\r\n    const calendarDays = viewMode === 'week'\r\n        ? eachDayOfInterval({ start: weekStart, end: endOfWeek(currentDate, { weekStartsOn: 1 }) })\r\n        : eachDayOfInterval({ start: monthStartDate, end: monthEndDate });\r\n\r\n    const weekDays = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];\r\n\r\n    // List View Grouping\r\n    const sortedEvents = [...events].sort((a, b) => a.date - b.date);\r\n\r\n    // Filter events for List View: Only show REVIEWS for the CURRENT selected week (no alerts)\r\n    const validListEvents = sortedEvents.filter(evt => {\r\n        return !evt.isAlert && evt.date >= weekStart && evt.date <= endOfWeek(currentDate, { weekStartsOn: 1 });\r\n    });\r\n\r\n    const eventsByWeek = validListEvents.reduce((acc, event) => {\r\n        const weekKey = `${format(startOfWeek(event.date, { weekStartsOn: 1 }), 'yyyy-MM-dd')}`;\r\n        if (!acc[weekKey]) acc[weekKey] = [];\r\n        acc[weekKey].push(event);\r\n        return acc;\r\n    }, {});\r\n\r\n    const headerTitle = (viewMode === 'week' || viewMode === 'list')\r\n        ? `Semana del ${format(weekStart, 'd MMM', { locale: es })} al ${format(endOfWeek(currentDate, { weekStartsOn: 1 }), 'd MMM', { locale: es })}`\r\n        : format(currentDate, 'MMMM yyyy', { locale: es });\r\n\r\n    return (\r\n        <div className=\"dashboard-container\">\r\n            <div className=\"dashboard-header\">\r\n                <div>\r\n                    <h1 className=\"page-title dark:text-white\">Calendario de Seguimiento</h1>\r\n                    <p className=\"page-subtitle dark:text-slate-400\">Revisiones programadas de clientes</p>\r\n                </div>\r\n                <div className=\"flex bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm p-1 rounded-lg\">\r\n                    <button\r\n                        onClick={() => setViewMode('list')}\r\n                        className={`p-2 rounded-md transition-colors flex gap-2 items-center text-sm font-medium ${viewMode === 'list' ? 'bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}\r\n                    >\r\n                        <List size={18} /> Listado\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setViewMode('week')}\r\n                        className={`p-2 rounded-md transition-colors flex gap-2 items-center text-sm font-medium ${viewMode === 'week' ? 'bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}\r\n                    >\r\n                        <LayoutGrid size={18} /> Semanal\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setViewMode('month')}\r\n                        className={`p-2 rounded-md transition-colors flex gap-2 items-center text-sm font-medium ${viewMode === 'month' ? 'bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}\r\n                    >\r\n                        <CalendarIcon size={18} /> Mensual\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {viewMode !== 'list' ? (\r\n                <div className=\"card\">\r\n                    {/* Header */}\r\n                    <div className=\"flex items-center justify-between mb-8\">\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <h2 className=\"text-xl font-bold text-slate-800 dark:text-white capitalize\">\r\n                                {headerTitle}\r\n                            </h2>\r\n                            <div className=\"flex gap-1\">\r\n                                <button onClick={prevPeriod} className=\"btn btn-sm btn-outline px-2 border-slate-200 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800\">\r\n                                    <ChevronLeft size={16} />\r\n                                </button>\r\n                                <button onClick={() => setCurrentDate(new Date())} className=\"btn btn-sm btn-outline border-slate-200 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800\">\r\n                                    Hoy\r\n                                </button>\r\n                                <button onClick={nextPeriod} className=\"btn btn-sm btn-outline px-2 border-slate-200 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800\">\r\n                                    <ChevronRight size={16} />\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                        <label className=\"flex items-center gap-2 cursor-pointer select-none\">\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                checked={onlyReviews}\r\n                                onChange={(e) => setOnlyReviews(e.target.checked)}\r\n                                className=\"w-4 h-4 rounded border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-primary-600 focus:ring-primary-500\"\r\n                            />\r\n                            <span className=\"text-sm text-slate-600 dark:text-slate-400\">Solo revisiones</span>\r\n                        </label>\r\n                    </div>\r\n\r\n                    {/* Grid */}\r\n                    <div className=\"grid grid-cols-7 mb-2\">\r\n                        {weekDays.map(day => (\r\n                            <div key={day} className=\"text-center text-sm font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider py-2\">\r\n                                {day.substring(0, 3)}\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-7 gap-px bg-slate-200 dark:bg-slate-700 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden\">\r\n                        {calendarDays.map((day) => {\r\n                            const dayEvents = events\r\n                                .filter(e => isSameDay(e.date, day))\r\n                                .filter(e => !onlyReviews || !e.isAlert);\r\n                            const isCurrentMonth = isSameMonth(day, monthStart); // Only relevant for month view styling\r\n                            const isToday = isSameDay(day, new Date());\r\n\r\n                            // Adjust styling for week view vs month view\r\n                            const opacityClass = (viewMode === 'month' && !isCurrentMonth) ? 'bg-slate-50/50 dark:bg-slate-900/50 text-slate-400 dark:text-slate-600' : 'bg-white dark:bg-slate-800';\r\n                            const minHeightClass = viewMode === 'week' ? 'min-h-[500px]' : 'min-h-[160px]';\r\n\r\n                            return (\r\n                                <div\r\n                                    key={day.toString()}\r\n                                    className={`${minHeightClass} ${opacityClass} p-2 transition-colors hover:bg-slate-50 dark:hover:bg-slate-700/50 relative group`}\r\n                                >\r\n                                    <div className={`text-right text-sm font-medium mb-1 ${isToday ? 'bg-primary-600 text-white w-7 h-7 rounded-full flex items-center justify-center ml-auto shadow-sm' : 'text-slate-700 dark:text-slate-300'}`}>\r\n                                        {format(day, 'd')}\r\n                                    </div>\r\n\r\n                                    <div className=\"space-y-1.5 overflow-y-auto max-h-[450px] scrollbar-thin scrollbar-thumb-slate-200 dark:scrollbar-thumb-slate-700\">\r\n                                        {dayEvents.map((evt, i) => {\r\n                                            const style = eventStyles[evt.type] || eventStyles.revision;\r\n                                            const isCompleted = evt.completed && !evt.isAlert;\r\n\r\n                                            return (\r\n                                                <div\r\n                                                    key={i}\r\n                                                    onClick={() => navigate(`/patients/${evt.patientId}`)}\r\n                                                    className={`text-xs p-2 rounded border shadow-sm transition-all cursor-pointer\r\n                                                        ${isCompleted\r\n                                                            ? 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800 opacity-75'\r\n                                                            : `${style.bg} ${style.text} ${style.border} hover:opacity-80`\r\n                                                        }\r\n                                                    `}\r\n                                                    title={`Ver detalle de ${evt.patientName}`}\r\n                                                >\r\n                                                    <div className=\"flex items-center gap-1.5 mb-0.5\">\r\n                                                        {evt.isAlert ? (\r\n                                                            <span className=\"font-semibold whitespace-nowrap\">{style.label}</span>\r\n                                                        ) : (\r\n                                                            <button\r\n                                                                onClick={(e) => { e.stopPropagation(); handleToggleComplete(evt); }}\r\n                                                                className=\"flex-shrink-0 text-current hover:scale-110 transition-transform\"\r\n                                                                title={evt.completed ? \"Marcar como pendiente\" : \"Marcar como hecho\"}\r\n                                                            >\r\n                                                                {evt.completed ? <CheckSquare size={12} /> : <Square size={12} />}\r\n                                                            </button>\r\n                                                        )}\r\n                                                    </div>\r\n                                                    <div className={`font-medium leading-tight break-words ${isCompleted ? 'line-through' : ''}`}>\r\n                                                        {evt.patientName}\r\n                                                    </div>\r\n                                                </div>\r\n                                            );\r\n                                        })}\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                </div>\r\n            ) : (\r\n                /* List View grouped by Week */\r\n                <div className=\"space-y-8\">\r\n                    {/* List View Navigation Header - Copied from Calendar View logic */}\r\n                    <div className=\"flex items-center justify-between mb-4\">\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <h2 className=\"text-xl font-bold text-slate-800 dark:text-white capitalize\">\r\n                                {headerTitle}\r\n                            </h2>\r\n                            <div className=\"flex gap-1\">\r\n                                <button onClick={prevPeriod} className=\"btn btn-sm btn-outline px-2 border-slate-200 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800\">\r\n                                    <ChevronLeft size={16} />\r\n                                </button>\r\n                                <button onClick={() => setCurrentDate(new Date())} className=\"btn btn-sm btn-outline border-slate-200 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800\">\r\n                                    Hoy\r\n                                </button>\r\n                                <button onClick={nextPeriod} className=\"btn btn-sm btn-outline px-2 border-slate-200 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800\">\r\n                                    <ChevronRight size={16} />\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {Object.keys(eventsByWeek).length === 0 ? (\r\n                        <div className=\"card text-center py-10 text-slate-500 dark:text-slate-400\">No hay revisiones programadas para esta semana.</div>\r\n                    ) : Object.keys(eventsByWeek).sort().map(weekKey => {\r\n                        const weekEvents = eventsByWeek[weekKey];\r\n\r\n                        return (\r\n                            <div key={weekKey} className=\"card\">\r\n                                <div className=\"table-responsive\">\r\n                                    <table className=\"data-table\">\r\n                                        <thead>\r\n                                            <tr>\r\n                                                <th className=\"w-12 text-center text-slate-500 dark:text-slate-400\">Estado</th>\r\n                                                <th className=\"w-32 text-slate-500 dark:text-slate-400\">Fecha</th>\r\n                                                <th className=\"w-48 text-slate-500 dark:text-slate-400\">Cliente</th>\r\n                                                <th className=\"text-slate-500 dark:text-slate-400\">Cambios a Realizar / Notas</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody className=\"divide-y divide-slate-100 dark:divide-slate-700\">\r\n                                            {weekEvents.map(evt => (\r\n                                                <tr key={evt.sysId} className={evt.completed ? 'bg-slate-50 dark:bg-slate-800/50' : 'hover:bg-primary-50 dark:hover:bg-primary-900/10'}>\r\n                                                    <td className=\"text-center py-3\">\r\n                                                        <button\r\n                                                            onClick={() => handleToggleComplete(evt)}\r\n                                                            className={`p-1 rounded transition-colors ${evt.completed ? 'text-green-600 hover:text-green-700 dark:text-green-500' : 'text-slate-300 hover:text-slate-500 dark:text-slate-600 dark:hover:text-slate-400'}`}\r\n                                                            title={evt.completed ? \"Marcar como pendiente\" : \"Marcar como hecho\"}\r\n                                                        >\r\n                                                            {evt.completed ? <CheckSquare size={20} /> : <Square size={20} />}\r\n                                                        </button>\r\n                                                    </td>\r\n                                                    <td className={`font-medium text-sm py-3 ${evt.completed ? 'text-slate-400 dark:text-slate-600 line-through' : 'text-slate-600 dark:text-slate-300'}`}>\r\n                                                        {format(evt.date, 'dd/MM/yyyy')}\r\n                                                    </td>\r\n                                                    <td className=\"py-3\">\r\n                                                        <span\r\n                                                            onClick={() => navigate(`/patients/${evt.patientId}`)}\r\n                                                            className={`font-semibold cursor-pointer hover:text-primary transition-colors ${evt.completed ? 'text-slate-400 dark:text-slate-600 line-through' : 'text-slate-700 dark:text-slate-200'}`}\r\n                                                        >\r\n                                                            {evt.patientName}\r\n                                                        </span>\r\n                                                    </td>\r\n                                                    <td className=\"py-3\">\r\n                                                        <div className=\"relative group w-full\">\r\n                                                            <input\r\n                                                                type=\"text\"\r\n                                                                defaultValue={evt.notes}\r\n                                                                onBlur={(e) => handleNotesChange(evt.sysId, e.target.value)}\r\n                                                                onKeyDown={(e) => {\r\n                                                                    if (e.key === 'Enter') {\r\n                                                                        e.currentTarget.blur();\r\n                                                                    }\r\n                                                                }}\r\n                                                                className={`w-full bg-transparent border-b border-transparent hover:border-slate-200 dark:hover:border-slate-600 focus:border-primary-400 outline-none py-1.5 px-2 text-sm transition-all ${evt.completed ? 'text-slate-400 dark:text-slate-600' : 'text-slate-700 dark:text-slate-200'}`}\r\n                                                                placeholder=\"Escribe cambios o notas...\"\r\n                                                            />\r\n                                                            <PenLine size={14} className=\"absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\" />\r\n                                                        </div>\r\n                                                    </td>\r\n                                                </tr>\r\n                                            ))}\r\n                                        </tbody>\r\n                                    </table>\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default TrackingCalendar;\r\n"},{"path":"src/context/DataContext.jsx","content":"import { createContext, useContext, useState, useEffect, useCallback, useMemo } from 'react';\r\nimport { addDays, differenceInDays, parseISO, format } from 'date-fns';\r\nimport { supabase } from '../supabaseClient';\r\n\r\nconst DataContext = createContext();\r\n\r\n// eslint-disable-next-line react-refresh/only-export-components\r\nexport const useData = () => useContext(DataContext);\r\n\r\nexport const DataProvider = ({ children }) => {\r\n    const [loading, setLoading] = useState(true);\r\n    const [patients, setPatients] = useState([]);\r\n\r\n    const [plans, setPlans] = useState([]);\r\n    const [tasks, setTasks] = useState([]);\r\n    const [taskCategories, setTaskCategories] = useState([]);\r\n    const [taskTypes, setTaskTypes] = useState([]);\r\n    const [userProfile, setUserProfile] = useState(null);\r\n    const [reviews, setReviews] = useState({});\r\n    const [payments, setPayments] = useState([]);\r\n    const [paymentMethods, setPaymentMethods] = useState([]);\r\n    const [paymentCategories, setPaymentCategories] = useState([]);\r\n    const [referralSources, setReferralSources] = useState([]);\r\n    const [clinicalOptions, setClinicalOptions] = useState([]);\r\n    const [clinicalCategories, setClinicalCategories] = useState([]);\r\n    const [subscriptionTypes, setSubscriptionTypes] = useState([]);\r\n    const [paymentRates, setPaymentRates] = useState([]);\r\n    const [subscriptionExtensions, setSubscriptionExtensions] = useState([]);\r\n    const [nutritionists, setNutritionists] = useState([]);\r\n\r\n    const fetchData = useCallback(async () => {\r\n        setLoading(true);\r\n        try {\r\n            // Parallel fetching with allSettled to prevent one failure from blocking everything\r\n            const results = await Promise.allSettled([\r\n                supabase.from('patients').select('*, payment_category_id, measurements(*), days_remaining'),\r\n\r\n                supabase.from('plans').select('*'),\r\n                supabase.from('tasks').select('*'),\r\n                supabase.from('task_categories').select('*'),\r\n                supabase.from('task_types').select('*'),\r\n                supabase.from('user_profile').select('*').limit(1).single(),\r\n                supabase.from('reviews').select('*'),\r\n                supabase.from('payments').select('*'),\r\n                supabase.from('payment_methods').select('*'),\r\n                supabase.from('payment_categories').select('*'),\r\n                supabase.from('referral_sources').select('*'),\r\n                supabase.from('clinical_options').select('*'),\r\n                supabase.from('clinical_categories').select('*'),\r\n                supabase.from('patient_subscriptions').select('*'),\r\n                supabase.from('subscription_types').select('*').order('months', { ascending: true }),\r\n                supabase.from('payment_rates').select('*').order('amount', { ascending: true }),\r\n                supabase.from('subscription_extensions').select('*').order('created_at', { ascending: false }),\r\n                supabase.from('nutritionists').select('*').order('label', { ascending: true }),\r\n            ]);\r\n\r\n            const [\r\n                patientsResult,\r\n\r\n                plansResult,\r\n                tasksResult,\r\n                catsResult,\r\n                typesResult,\r\n                profileResult,\r\n                reviewsResult,\r\n                paymentsResult,\r\n                paymentMethodsResult,\r\n                paymentCategoriesResult,\r\n                referralSourcesResult,\r\n                clinicalOptionsResult,\r\n                clinicalCategoriesResult,\r\n                subscriptionsHistoryResult,\r\n                subTypesResult,\r\n                paymentRatesResult,\r\n                subscriptionExtensionsResult,\r\n                nutritionistsResult\r\n            ] = results;\r\n\r\n            // Log errors for debugging\r\n            results.forEach((res, index) => {\r\n                if (res.status === 'rejected') {\r\n                    console.error(`Error fetching data at index ${index}:`, res.reason);\r\n                }\r\n            });\r\n\r\n            // Process Patients (Critical)\r\n            if (patientsResult.status === 'fulfilled' && patientsResult.value.data) {\r\n                const patientsData = patientsResult.value.data;\r\n                const subscriptionsHistoryData = subscriptionsHistoryResult.status === 'fulfilled' ? subscriptionsHistoryResult.value.data : [];\r\n\r\n                const hydratedPatients = patientsData.map(p => ({\r\n                    ...p,\r\n                    name: (p.first_name || p.last_name) ? `${p.first_name || ''} ${p.last_name || ''}`.trim() : (p.name || 'Cliente'),\r\n                    subscriptionHistory: subscriptionsHistoryData ?\r\n                        subscriptionsHistoryData.filter(h => h.patient_id === p.id).sort((a, b) => new Date(b.start_date) - new Date(a.start_date))\r\n                        : [],\r\n                    subscriptionPauses: [],\r\n                    measurements: p.measurements || [],\r\n                    status: p.subscription_status, // Map to top-level status for PatientList compatibility\r\n                    review_day: p.review_day, // Explicitly map to ensure it's available\r\n                    subscription: {\r\n                        type: p.subscription_type,\r\n                        startDate: p.subscription_start,\r\n                        endDate: p.subscription_end,\r\n                        status: p.subscription_status,\r\n                        pauseStartDate: p.pause_start_date,\r\n                        subscriptionTypeId: p.subscription_type_id,\r\n                        paymentRateId: p.payment_rate_id\r\n                    }\r\n                }));\r\n                setPatients(hydratedPatients);\r\n            } else {\r\n                console.error('Critical: Failed to fetch patients', patientsResult.reason);\r\n            }\r\n\r\n            // Process other data safely\r\n\r\n            if (plansResult.status === 'fulfilled') setPlans(plansResult.value.data || []);\r\n            if (tasksResult.status === 'fulfilled') setTasks(tasksResult.value.data || []);\r\n            if (catsResult.status === 'fulfilled') setTaskCategories(catsResult.value.data || []);\r\n            if (typesResult.status === 'fulfilled') setTaskTypes(typesResult.value.data || []);\r\n            if (profileResult.status === 'fulfilled') setUserProfile(profileResult.value.data || null);\r\n            if (paymentsResult.status === 'fulfilled') setPayments(paymentsResult.value.data || []);\r\n            if (paymentMethodsResult.status === 'fulfilled') setPaymentMethods(paymentMethodsResult.value.data || []);\r\n            if (paymentCategoriesResult.status === 'fulfilled') setPaymentCategories(paymentCategoriesResult.value.data || []);\r\n            if (referralSourcesResult.status === 'fulfilled') setReferralSources(referralSourcesResult.value.data || []);\r\n            if (clinicalOptionsResult.status === 'fulfilled') setClinicalOptions(clinicalOptionsResult.value.data || []);\r\n            if (clinicalCategoriesResult.status === 'fulfilled') setClinicalCategories(clinicalCategoriesResult.value.data || []);\r\n            if (subTypesResult.status === 'fulfilled') setSubscriptionTypes(subTypesResult.value.data || []);\r\n            if (subTypesResult.status === 'fulfilled') setSubscriptionTypes(subTypesResult.value.data || []);\r\n            if (paymentRatesResult.status === 'fulfilled') setPaymentRates(paymentRatesResult.value.data || []);\r\n            if (subscriptionExtensionsResult.status === 'fulfilled') setSubscriptionExtensions(subscriptionExtensionsResult.value.data || []);\r\n            if (nutritionistsResult.status === 'fulfilled') setNutritionists(nutritionistsResult.value.data || []);\r\n\r\n            if (reviewsResult.status === 'fulfilled' && reviewsResult.value.data) {\r\n                const reviewsObj = reviewsResult.value.data.reduce((acc, r) => {\r\n                    acc[r.id] = r;\r\n                    return acc;\r\n                }, {});\r\n                setReviews(reviewsObj);\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error('Unexpected error in fetchData:', error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        fetchData();\r\n    }, [fetchData]);\r\n\r\n    // --- Actions ---\r\n\r\n    // PATIENTS\r\n    const addPatient = async (patient) => {\r\n        // Prepare DB object (remove measurements/photos from root if any)\r\n        const dbPatient = {\r\n            first_name: patient.firstName,\r\n            last_name: patient.lastName,\r\n            // name: legacy column not written anymore\r\n            birth_date: patient.birthDate || null,\r\n            email: patient.email,\r\n            phone: patient.phone,\r\n            sex: patient.sex,\r\n            city: patient.city,\r\n            height: parseFloat(patient.height) || 0,\r\n            weight: parseFloat(patient.weight) || 0,\r\n            goals: patient.goals,\r\n            allergies: patient.allergies,\r\n            pathologies: patient.pathologies,\r\n            disliked_foods: patient.dislikedFoods,\r\n            platos_que_no_pueden_faltar: patient.platos_que_no_pueden_faltar || null,\r\n            notes: patient.notes || null,\r\n\r\n            referral_source: patient.referralSource || null, // Ensure empty string becomes null for UUID\r\n            nutritionist_id: patient.nutritionistId || null,\r\n            payment_category_id: patient.paymentCategoryId || null, // Center / Channel\r\n            subscription_type: patient.subscription?.type,\r\n            subscription_type_id: patient.subscription?.subscriptionTypeId || null,\r\n            payment_rate_id: patient.subscription?.paymentRateId || null,\r\n            subscription_start: patient.subscription?.startDate || null,\r\n            subscription_end: patient.subscription?.endDate || null,\r\n            subscription_status: patient.subscription?.status || 'inactive'\r\n        };\r\n\r\n        const { data, error } = await supabase.from('patients').insert([dbPatient]).select().single();\r\n        if (error) {\r\n            console.error(error);\r\n            return null;\r\n        }\r\n\r\n        // Create initial subscription record in patient_subscriptions\r\n        if (patient.subscription?.startDate) {\r\n            const initialSub = {\r\n                patient_id: data.id,\r\n                plan_name: patient.subscription.type,\r\n                subscription_type_id: patient.subscription.subscriptionTypeId || null,\r\n                payment_rate_id: patient.subscription.paymentRateId || null,\r\n                start_date: patient.subscription.startDate,\r\n                end_date: patient.subscription.endDate,\r\n                price: plans.find(p => p.name === patient.subscription.type)?.price || 0,\r\n                status: patient.subscription.status || 'active'\r\n            };\r\n            const { data: subData, error: subError } = await supabase.from('patient_subscriptions').insert([initialSub]).select().single();\r\n\r\n            if (!subError && subData) {\r\n                // We will attach this to the local state below\r\n                data.subscriptionHistory = [subData];\r\n            }\r\n        }\r\n\r\n        // Add empty measurements array for UI compatibility\r\n        const newPatient = {\r\n            ...data,\r\n            name: `${data.first_name || ''} ${data.last_name || ''}`.trim() || data.name,\r\n            measurements: [],\r\n            subscriptionHistory: data.subscriptionHistory || []\r\n        };\r\n        setPatients(prev => [...prev, newPatient]);\r\n        return data.id;\r\n    };\r\n\r\n\r\n\r\n    const addSubscriptionHistory = async (sub) => {\r\n        const { data, error } = await supabase.from('patient_subscriptions').insert([sub]).select().single();\r\n        if (error) {\r\n            console.error('Error adding subscription history:', error);\r\n            return null;\r\n        }\r\n\r\n        // Update local state\r\n        setPatients(prev => prev.map(p => {\r\n            if (p.id === sub.patient_id) {\r\n                // Calculate days remaining if the new subscription is active\r\n                let newDaysRemaining = p.days_remaining;\r\n                let newSubscriptionEnd = p.subscription_end;\r\n\r\n                if (sub.status === 'active') {\r\n                    const endDate = parseISO(sub.end_date);\r\n                    const today = new Date();\r\n                    newDaysRemaining = differenceInDays(endDate, today);\r\n                    newSubscriptionEnd = sub.end_date;\r\n                }\r\n\r\n                return {\r\n                    ...p,\r\n                    subscription_end: newSubscriptionEnd,\r\n                    days_remaining: newDaysRemaining,\r\n                    subscriptionHistory: [data, ...(p.subscriptionHistory || [])],\r\n                    subscription: { // Update nested object too\r\n                        ...p.subscription,\r\n                        type: sub.plan_name,\r\n                        subscriptionTypeId: sub.subscription_type_id,\r\n                        paymentRateId: sub.payment_rate_id,\r\n                        price: sub.price,\r\n                        startDate: sub.start_date,\r\n                        endDate: newSubscriptionEnd,\r\n                        status: sub.status\r\n                    }\r\n                };\r\n            }\r\n            return p;\r\n        }));\r\n        return data;\r\n\r\n    };\r\n\r\n    const updateSubscriptionHistory = async (id, updates) => {\r\n        const { data, error } = await supabase.from('patient_subscriptions').update(updates).eq('id', id).select().single();\r\n        if (!error && data) {\r\n            setPatients(prev => prev.map(p => {\r\n                if (p.id !== data.patient_id) return p;\r\n                // Merge the updated subscription into history\r\n                const updatedHistory = p.subscriptionHistory?.map(h => h.id === id ? data : h) || [];\r\n                return {\r\n                    ...p,\r\n                    subscriptionHistory: updatedHistory,\r\n                };\r\n            }));\r\n        }\r\n    };\r\n\r\n    const deleteSubscription = async (id) => {\r\n        console.log('Attempting to delete subscription:', id);\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('patient_subscriptions')\r\n                .delete()\r\n                .eq('id', id)\r\n                .select();\r\n\r\n            if (error) {\r\n                console.error('Error deleting subscription:', error);\r\n                return { success: false, error };\r\n            }\r\n\r\n            console.log('Subscription deleted successfully. Data:', data);\r\n\r\n            if (!data || data.length === 0) {\r\n                console.warn('No rows deleted. Check if ID exists:', id);\r\n                return { success: false, error: { message: 'No se encontró la suscripción para eliminar.' } };\r\n            }\r\n\r\n            // Recalculate subscriber state based on remaining history\r\n            const patientId = data[0].patient_id;\r\n\r\n            // Fetch updated history to determine new state\r\n            // We use a fresh fetch to ensure we have the latest truth from the DB\r\n            const { data: remainingHistory } = await supabase\r\n                .from('patient_subscriptions')\r\n                .select('*')\r\n                .eq('patient_id', patientId)\r\n                .order('end_date', { ascending: false }); // Latest end date first\r\n\r\n            let patientUpdates = {};\r\n            const cleanHistory = remainingHistory || [];\r\n\r\n            if (cleanHistory.length === 0) {\r\n                // No subscriptions left -> Force reset to inactive\r\n                console.log('No subscriptions remaining. Resetting patient to inactive.');\r\n\r\n                // Also delete any lingering extensions for this patient to prevent zombie status\r\n                // Since extensions are only linked to patient_id, we can only safely mass-delete them \r\n                // when the patient has NO other subscriptions.\r\n                const { error: delExtError } = await supabase\r\n                    .from('subscription_extensions')\r\n                    .delete()\r\n                    .eq('patient_id', patientId);\r\n\r\n                if (delExtError) {\r\n                    console.error('Error cleaning up extensions:', delExtError);\r\n                }\r\n\r\n                patientUpdates = {\r\n                    subscription_status: 'inactive',\r\n                    subscription_type: null,\r\n                    subscription_start: null,\r\n                    subscription_end: null,\r\n                    days_remaining: null,\r\n                    payment_rate_id: null,\r\n                    subscription_type_id: null\r\n                };\r\n            } else {\r\n                // Determine active/latest subscription from remaining history\r\n                // Logic: Access the one with the furthest end date or latest start date\r\n                // For simplicity, we take the top one from the order('end_date', { ascending: false })\r\n                const latest = cleanHistory[0];\r\n                const today = new Date().toISOString().split('T')[0];\r\n\r\n                // Determine status based on dates\r\n                // If the latest one is in the past, it's expired/inactive.\r\n                let newStatus = latest.status;\r\n                if (latest.end_date < today) {\r\n                    newStatus = 'inactive';\r\n                } else if (latest.start_date > today) {\r\n                    newStatus = 'future'; // or whatever status logic uses\r\n                }\r\n\r\n                patientUpdates = {\r\n                    subscription_status: newStatus,\r\n                    subscription_type: latest.plan_name,\r\n                    subscription_type_id: latest.subscription_type_id,\r\n                    payment_rate_id: latest.payment_rate_id,\r\n                    subscription_start: latest.start_date,\r\n                    subscription_end: latest.end_date,\r\n                    days_remaining: differenceInDays(parseISO(latest.end_date), new Date())\r\n                };\r\n            }\r\n\r\n            // Update patient record in DB with the new calculated state\r\n            // We ALWAYS update to sync the cached fields\r\n            const { error: updateError } = await supabase.from('patients').update(patientUpdates).eq('id', patientId);\r\n\r\n            if (updateError) {\r\n                console.error('Error updating patient status after deletion:', updateError);\r\n            }\r\n\r\n            // Update local state\r\n            setPatients(prev => prev.map(p => {\r\n                if (p.id !== patientId) return p;\r\n\r\n                // Re-construct the local 'subscription' object \r\n                const newSubscription = {\r\n                    type: patientUpdates.subscription_type,\r\n                    startDate: patientUpdates.subscription_start,\r\n                    endDate: patientUpdates.subscription_end,\r\n                    status: patientUpdates.subscription_status,\r\n                    subscriptionTypeId: patientUpdates.subscription_type_id,\r\n                    paymentRateId: patientUpdates.payment_rate_id,\r\n                    pauseStartDate: p.subscription?.pauseStartDate // Keep pause if relevant, though logic might need check\r\n                };\r\n\r\n                return {\r\n                    ...p,\r\n                    ...patientUpdates, // Spread flat updates to root\r\n                    subscriptionHistory: cleanHistory,\r\n                    subscription: newSubscription\r\n                };\r\n            }));\r\n\r\n            return { success: true };\r\n        } catch (err) {\r\n            console.error('Unexpected error deleting subscription:', err);\r\n            return { success: false, error: err };\r\n        }\r\n    };\r\n\r\n    const updatePatient = async (id, updates) => {\r\n        // Map UI updates to DB columns if keys differ\r\n        const dbUpdates = {};\r\n        if (updates.firstName !== undefined) dbUpdates.first_name = updates.firstName;\r\n        if (updates.lastName !== undefined) dbUpdates.last_name = updates.lastName;\r\n\r\n        // Update legacy name if we have both or either parts\r\n        if (updates.firstName !== undefined || updates.lastName !== undefined) {\r\n            // Legacy 'name' column is no longer updated to avoid data inconsistency.\r\n            // We rely on first_name and last_name.\r\n        }\r\n        // ... simplistic mapping, assuming keys match mostly. \r\n        // CAUTION: The UI passes \"subscription\" object, DB has flat columns.\r\n        if (updates.subscription) {\r\n            dbUpdates.subscription_type = updates.subscription.type;\r\n            dbUpdates.subscription_start = updates.subscription.startDate || null;\r\n            if (updates.subscription.reviewDay !== undefined) {\r\n                dbUpdates.review_day = updates.subscription.reviewDay ? parseInt(updates.subscription.reviewDay) : null;\r\n            }\r\n            dbUpdates.subscription_end = updates.subscription.endDate || null;\r\n            dbUpdates.subscription_status = updates.subscription.status;\r\n            if (updates.subscription.subscriptionTypeId) dbUpdates.subscription_type_id = updates.subscription.subscriptionTypeId || null;\r\n            if (updates.subscription.paymentRateId) dbUpdates.payment_rate_id = updates.subscription.paymentRateId || null;\r\n\r\n            if (updates.subscription.pauseStartDate !== undefined) dbUpdates.pause_start_date = updates.subscription.pauseStartDate || null;\r\n        }\r\n\r\n        // Handle direct status update (e.g. from Kanban drag & drop)\r\n        if (updates.status !== undefined) {\r\n            dbUpdates.subscription_status = updates.status;\r\n        }\r\n\r\n        if (updates.subscription_type_id) dbUpdates.subscription_type_id = updates.subscription_type_id;\r\n        if (updates.payment_rate_id) dbUpdates.payment_rate_id = updates.payment_rate_id;\r\n        // Spread other safe keys\r\n        ['email', 'phone', 'sex', 'city', 'height', 'weight', 'goals', 'allergies', 'pathologies', 'platos_que_no_pueden_faltar', 'notes'].forEach(k => {\r\n            if (updates[k] !== undefined) dbUpdates[k] = updates[k];\r\n        });\r\n        // Handle birthDate -> birth_date mapping\r\n        if (updates.birthDate !== undefined) {\r\n            // Ensure empty string becomes null to avoid invalid input syntax for type date\r\n            dbUpdates.birth_date = updates.birthDate || null;\r\n        }\r\n        // Handle referralSource -> referral_source mapping\r\n        if (updates.referralSource !== undefined) dbUpdates.referral_source = updates.referralSource || null;\r\n        // Handle nutritionistId -> nutritionist_id mapping\r\n        if (updates.nutritionistId !== undefined) dbUpdates.nutritionist_id = updates.nutritionistId || null;\r\n        // Handle dislikedFoods -> disliked_foods mapping\r\n        if (updates.dislikedFoods !== undefined) dbUpdates.disliked_foods = updates.dislikedFoods;\r\n\r\n        // Handle reviewRequest from PatientForm (top level)\r\n        if (updates.reviewDay !== undefined) {\r\n            dbUpdates.review_day = updates.reviewDay ? parseInt(updates.reviewDay) : null;\r\n        }\r\n        // Handle paymentCategoryId -> payment_category_id mapping (Center)\r\n        // CORRECCIÓN FORZADA: Asegurar que payment_category_id se incluye si está presente\r\n        if (updates.paymentCategoryId !== undefined) {\r\n            dbUpdates.payment_category_id = updates.paymentCategoryId || null;\r\n            console.log(\"Forzando actualización de categoría:\", dbUpdates.payment_category_id);\r\n        }\r\n\r\n        console.log(\"Payload final a Supabase:\", dbUpdates);\r\n\r\n\r\n        const { data, error } = await supabase.from('patients').update(dbUpdates).eq('id', id).select('*').single();\r\n        if (error) {\r\n            console.error(error);\r\n            alert('Error al guardar: ' + error.message);\r\n            return;\r\n        }\r\n\r\n        setPatients(prev => prev.map(p => p.id === id ? {\r\n            ...p,\r\n            ...data,\r\n            // Explicitly ensure the new field is merged into local state (Supabase returns it in 'data' but just to be sure)\r\n            payment_category_id: data.payment_category_id,\r\n            review_day: data.review_day,\r\n            status: data.subscription_status, // Ensure top-level status is updated\r\n            subscription: {\r\n                // ... (keep existing)\r\n                type: data.subscription_type,\r\n                startDate: data.subscription_start,\r\n                endDate: data.subscription_end,\r\n                status: data.subscription_status,\r\n                pauseStartDate: data.pause_start_date,\r\n                // Add missing IDs for local state\r\n                subscriptionTypeId: data.subscription_type_id,\r\n                paymentRateId: data.payment_rate_id,\r\n            },\r\n            // Ensure name is updated in local state too\r\n            name: `${data.first_name || ''} ${data.last_name || ''}`.trim() || data.name\r\n        } : p));\r\n    };\r\n\r\n    const deletePatient = async (id) => {\r\n        if (!confirm('¿Estás seguro de eliminar este cliente?')) return;\r\n        const { error } = await supabase.from('patients').delete().eq('id', id);\r\n        if (!error) {\r\n            setPatients(prev => prev.filter(p => p.id !== id));\r\n        }\r\n    };\r\n\r\n    const togglePatientPause = async (id, pauseDate = null) => {\r\n        // Need current patient state\r\n        const patient = patients.find(p => p.id === id);\r\n        if (!patient) return;\r\n\r\n        const isPaused = patient.subscription_status === 'paused' || patient.subscription?.status === 'paused';\r\n        let dbUpdates = {};\r\n\r\n        if (!isPaused) {\r\n            // Pause\r\n            const dateToUse = pauseDate ? new Date(pauseDate) : new Date();\r\n            dbUpdates = {\r\n                subscription_status: 'paused',\r\n                pause_start_date: dateToUse.toISOString()\r\n            };\r\n\r\n            // Create pause record\r\n            const { error: pauseError } = await supabase.from('subscription_pauses').insert([{\r\n                patient_id: id,\r\n                start_date: dateToUse.toISOString().split('T')[0],\r\n                notes: 'Pausa manual'\r\n            }]);\r\n\r\n            if (pauseError) console.error('Error creating pause record:', pauseError);\r\n\r\n        } else {\r\n            // Resume\r\n            // Find open pause record\r\n            const openPause = patient.subscriptionPauses?.find(p => !p.end_date);\r\n            const pauseStart = patient.pause_start_date || patient.subscription?.pauseStartDate ?\r\n                parseISO(patient.pause_start_date || patient.subscription.pauseStartDate) : (openPause ? parseISO(openPause.start_date) : new Date());\r\n\r\n            const resumeDate = pauseDate ? new Date(pauseDate) : new Date();\r\n            const daysPaused = differenceInDays(resumeDate, pauseStart);\r\n\r\n            const currentEndDate = parseISO(patient.subscription_end || patient.subscription.endDate);\r\n            // Ensure we don't reduce end date if something is weird\r\n            const newEndDate = addDays(currentEndDate, Math.max(0, daysPaused));\r\n\r\n            dbUpdates = {\r\n                subscription_status: 'active',\r\n                subscription_end: newEndDate.toISOString().split('T')[0],\r\n                pause_start_date: null\r\n            };\r\n\r\n            // Close pause record\r\n            if (openPause) {\r\n                const { error: closeError } = await supabase.from('subscription_pauses').update({\r\n                    end_date: resumeDate.toISOString().split('T')[0]\r\n                }).eq('id', openPause.id);\r\n\r\n                if (closeError) console.error('Error closing pause record:', closeError);\r\n            }\r\n        }\r\n\r\n        const { data, error } = await supabase.from('patients').update(dbUpdates).eq('id', id).select().single();\r\n        if (!error && data) {\r\n            // Refetch pauses to get the updated ID or closed status\r\n            const { data: updatedPauses } = await supabase.from('subscription_pauses').select('*').eq('patient_id', id).order('start_date', { ascending: false });\r\n\r\n            setPatients(prev => prev.map(p => p.id === id ? {\r\n                ...p, ...data,\r\n                subscriptionPauses: updatedPauses || [],\r\n                subscription: {\r\n                    type: data.subscription_type,\r\n                    startDate: data.subscription_start,\r\n                    endDate: data.subscription_end,\r\n                    status: data.subscription_status,\r\n                    pauseStartDate: data.pause_start_date\r\n                }\r\n            } : p));\r\n        }\r\n    };\r\n\r\n    const updatePatientPause = async (pauseId, updates) => {\r\n        const { error } = await supabase.from('subscription_pauses').update(updates).eq('id', pauseId);\r\n\r\n        if (error) {\r\n            console.error('Error updating pause:', error);\r\n            throw error;\r\n        }\r\n\r\n        // Ideally we should know the patientId to optimize, but for now we can find it from the pause or just refresh everything.\r\n        // Better: return the updated pause from DB to get patient_id\r\n        const { data: updatedPause } = await supabase.from('subscription_pauses').select('patient_id').eq('id', pauseId).single();\r\n\r\n        if (updatedPause) {\r\n            const patientId = updatedPause.patient_id;\r\n            // Refetch pauses for this patient\r\n            const { data: updatedPauses } = await supabase.from('subscription_pauses').select('*').eq('patient_id', patientId).order('start_date', { ascending: false });\r\n\r\n            setPatients(prev => prev.map(p => p.id === patientId ? {\r\n                ...p,\r\n                subscriptionPauses: updatedPauses || []\r\n            } : p));\r\n        }\r\n    };\r\n\r\n    const deleteSubscriptionPause = async (pauseId) => {\r\n        console.log('deleteSubscriptionPause called with id:', pauseId);\r\n        // Get pause to know patient_id and if it's active\r\n        const { data: pauseToDelete } = await supabase.from('subscription_pauses').select('*').eq('id', pauseId).single();\r\n\r\n        if (!pauseToDelete) return;\r\n\r\n        const { error } = await supabase.from('subscription_pauses').delete().eq('id', pauseId);\r\n\r\n        if (error) {\r\n            console.error('Error deleting pause:', error);\r\n            throw error;\r\n        }\r\n\r\n        const patientId = pauseToDelete.patient_id;\r\n        let dbUpdates = {};\r\n\r\n        // If we deleted an active pause (no end date), we might need to reset the patient status\r\n        // Check if patient is currently paused\r\n        const { data: currentPatient } = await supabase.from('patients').select('subscription_status').eq('id', patientId).single();\r\n\r\n        if (currentPatient && currentPatient.subscription_status === 'paused' && !pauseToDelete.end_date) {\r\n            dbUpdates = {\r\n                subscription_status: 'active',\r\n                pause_start_date: null\r\n            };\r\n            await supabase.from('patients').update(dbUpdates).eq('id', patientId);\r\n        }\r\n\r\n        // Refetch pauses\r\n        const { data: updatedPauses } = await supabase.from('subscription_pauses').select('*').eq('patient_id', patientId).order('start_date', { ascending: false });\r\n\r\n        // Update local state\r\n        setPatients(prev => prev.map(p => p.id === patientId ? {\r\n            ...p,\r\n            ...dbUpdates, // Apply status updates if any\r\n            subscriptionPauses: updatedPauses || [],\r\n            subscription: {\r\n                ...p.subscription,\r\n                status: dbUpdates.subscription_status || p.subscription?.status,\r\n                pauseStartDate: dbUpdates.pause_start_date !== undefined ? dbUpdates.pause_start_date : p.subscription?.pauseStartDate\r\n            }\r\n        } : p));\r\n    };\r\n\r\n    const addMeasurement = async (patientId, measurement) => {\r\n        const dbMeasurement = {\r\n            patient_id: patientId,\r\n            date: measurement.date || new Date().toISOString(),\r\n            weight: parseFloat(measurement.weight) || null,\r\n            // New body measurements\r\n            pecho: parseFloat(measurement.pecho) || null,\r\n            brazo_izq: parseFloat(measurement.brazo_izq) || null,\r\n            brazo_der: parseFloat(measurement.brazo_der) || null,\r\n            sobre_ombligo: parseFloat(measurement.sobre_ombligo) || null,\r\n            ombligo: parseFloat(measurement.ombligo) || null,\r\n            bajo_ombligo: parseFloat(measurement.bajo_ombligo) || null,\r\n            cadera: parseFloat(measurement.cadera) || null,\r\n            muslo_izq: parseFloat(measurement.muslo_izq) || null,\r\n            muslo_der: parseFloat(measurement.muslo_der) || null,\r\n            photo: measurement.photo || null\r\n        };\r\n        const { data, error } = await supabase.from('measurements').insert([dbMeasurement]).select().single();\r\n        if (!error && data) {\r\n            setPatients(prev => prev.map(p => {\r\n                if (p.id !== patientId) return p;\r\n                return { ...p, measurements: [...(p.measurements || []), data] };\r\n            }));\r\n        }\r\n    };\r\n\r\n    const updateMeasurement = async (measurementId, patientId, updates) => {\r\n        const dbUpdates = {\r\n            date: updates.date || undefined,\r\n            weight: updates.weight ? parseFloat(updates.weight) : null,\r\n            pecho: updates.pecho ? parseFloat(updates.pecho) : null,\r\n            brazo_izq: updates.brazo_izq ? parseFloat(updates.brazo_izq) : null,\r\n            brazo_der: updates.brazo_der ? parseFloat(updates.brazo_der) : null,\r\n            sobre_ombligo: updates.sobre_ombligo ? parseFloat(updates.sobre_ombligo) : null,\r\n            ombligo: updates.ombligo ? parseFloat(updates.ombligo) : null,\r\n            bajo_ombligo: updates.bajo_ombligo ? parseFloat(updates.bajo_ombligo) : null,\r\n            cadera: updates.cadera ? parseFloat(updates.cadera) : null,\r\n            muslo_izq: updates.muslo_izq ? parseFloat(updates.muslo_izq) : null,\r\n            muslo_der: updates.muslo_der ? parseFloat(updates.muslo_der) : null,\r\n            photo: updates.photo !== undefined ? updates.photo : undefined\r\n        };\r\n        // Remove undefined values\r\n        Object.keys(dbUpdates).forEach(k => dbUpdates[k] === undefined && delete dbUpdates[k]);\r\n\r\n        const { data, error } = await supabase.from('measurements').update(dbUpdates).eq('id', measurementId).select().single();\r\n        if (!error && data) {\r\n            setPatients(prev => prev.map(p => {\r\n                if (p.id !== patientId) return p;\r\n                return {\r\n                    ...p,\r\n                    measurements: (p.measurements || []).map(m => m.id === measurementId ? data : m)\r\n                };\r\n            }));\r\n        }\r\n    };\r\n\r\n    const deleteMeasurement = async (measurementId, patientId) => {\r\n        if (!confirm('¿Eliminar esta medición?')) return;\r\n        const { error } = await supabase.from('measurements').delete().eq('id', measurementId);\r\n        if (!error) {\r\n            setPatients(prev => prev.map(p => {\r\n                if (p.id !== patientId) return p;\r\n                return {\r\n                    ...p,\r\n                    measurements: (p.measurements || []).filter(m => m.id !== measurementId)\r\n                };\r\n            }));\r\n        }\r\n    };\r\n\r\n\r\n\r\n    // PLANS\r\n    const addPlan = async (plan) => {\r\n        const { data, error } = await supabase.from('plans').insert([{ ...plan, id: plan.name.toLowerCase().replace(/\\s+/g, '_') }]).select().single();\r\n        if (!error) setPlans(prev => [...prev, data]);\r\n    };\r\n    const updatePlan = async (id, updates) => {\r\n        const { data, error } = await supabase.from('plans').update(updates).eq('id', id).select().single();\r\n        if (!error) setPlans(prev => prev.map(p => p.id === id ? data : p));\r\n    };\r\n    const deletePlan = async (id) => {\r\n        const { error } = await supabase.from('plans').delete().eq('id', id);\r\n        if (!error) setPlans(prev => prev.filter(p => p.id !== id));\r\n    };\r\n\r\n    // TASKS\r\n    const addTask = async (task) => {\r\n        // UI uses 'tag', DB uses 'tag_id'.\r\n        const dbTask = {\r\n            title: task.title,\r\n            tag_id: task.tag,\r\n            type_id: task.type,\r\n            due_date: task.dueDate || null,\r\n            completed: false\r\n        };\r\n        const { data, error } = await supabase.from('tasks').insert([dbTask]).select().single();\r\n        if (!error) setTasks(prev => [...prev, { ...data, tag: data.tag_id, type: data.type_id }]);\r\n    };\r\n    const updateTask = async (id, updates) => {\r\n        const dbUpdates = {};\r\n        if (updates.completed !== undefined) dbUpdates.completed = updates.completed;\r\n        if (updates.dueDate !== undefined) dbUpdates.due_date = updates.dueDate;\r\n        const { data, error } = await supabase.from('tasks').update(dbUpdates).eq('id', id).select().single();\r\n        if (!error) setTasks(prev => prev.map(t => t.id === id ? { ...t, ...data, tag: data.tag_id, type: data.type_id } : t));\r\n    };\r\n    const deleteTask = async (id) => {\r\n        const { error } = await supabase.from('tasks').delete().eq('id', id);\r\n        if (!error) setTasks(prev => prev.filter(t => t.id !== id));\r\n    };\r\n\r\n    // REVIEWS\r\n    const saveReview = async (reviewId, data) => {\r\n        // reviewId format: review_{patientId}_{date}\r\n        // Need to extract patientId and date, OR just store reviewId as is?\r\n        // My table schema has: id (text PK).\r\n        const dbEntry = {\r\n            id: reviewId,\r\n            patient_id: reviewId.split('_')[1],\r\n            date: reviewId.split('_')[2], // Assuming YYYY-MM-DD\r\n            ...data\r\n        };\r\n        const { data: res, error } = await supabase.from('reviews').upsert(dbEntry).select().single();\r\n        if (!error) {\r\n            setReviews(prev => ({ ...prev, [reviewId]: res }));\r\n        }\r\n    };\r\n\r\n    // CATEGORIES & TYPES\r\n    const addTaskCategory = async (cat) => {\r\n        const { data, error } = await supabase.from('task_categories').insert([cat]).select().single();\r\n        if (!error) setTaskCategories(prev => [...prev, data]);\r\n    };\r\n    const updateTaskCategory = async (id, updates) => {\r\n        const { data, error } = await supabase.from('task_categories').update(updates).eq('id', id).select().single();\r\n        if (!error) setTaskCategories(prev => prev.map(c => c.id === id ? data : c));\r\n    };\r\n    const deleteTaskCategory = async (id) => {\r\n        const { error } = await supabase.from('task_categories').delete().eq('id', id);\r\n        if (!error) setTaskCategories(prev => prev.filter(c => c.id !== id));\r\n    };\r\n\r\n\r\n\r\n    // TYPE ACTIONS\r\n    const addTaskType = async (type) => {\r\n        const { data, error } = await supabase.from('task_types').insert([type]).select().single();\r\n        if (!error) setTaskTypes(prev => [...prev, data]);\r\n    };\r\n    const updateTaskType = async (id, updates) => {\r\n        const { data, error } = await supabase.from('task_types').update(updates).eq('id', id).select().single();\r\n        if (!error) setTaskTypes(prev => prev.map(t => t.id === id ? data : t));\r\n    };\r\n    const deleteTaskType = async (id) => {\r\n        const { error } = await supabase.from('task_types').delete().eq('id', id);\r\n        if (!error) setTaskTypes(prev => prev.filter(t => t.id !== id));\r\n    };\r\n\r\n    // PAYMENTS\r\n    const addPayment = async (payment) => {\r\n        // Ensure subscription_id is passed if available\r\n        const dbPayment = {\r\n            ...payment,\r\n            subscription_id: payment.subscription_id || null\r\n        };\r\n        const { data, error } = await supabase.from('payments').insert([dbPayment]).select().single();\r\n        if (error) {\r\n            console.error(\"Error adding payment:\", error);\r\n        } else {\r\n            setPayments(prev => [...prev, data]);\r\n        }\r\n    };\r\n    const updatePayment = async (id, updates) => {\r\n        const { data, error } = await supabase.from('payments').update(updates).eq('id', id).select().single();\r\n        if (error) {\r\n            console.error(\"Error updating payment:\", error);\r\n        } else {\r\n            setPayments(prev => prev.map(p => p.id === id ? data : p));\r\n        }\r\n    };\r\n    const deletePayment = async (id) => {\r\n        const { error } = await supabase.from('payments').delete().eq('id', id);\r\n        if (!error) setPayments(prev => prev.filter(p => p.id !== id));\r\n    };\r\n\r\n    // PAYMENT METHODS\r\n    const addPaymentMethod = async (method) => {\r\n        const { data, error } = await supabase.from('payment_methods').insert([method]).select().single();\r\n        if (!error) setPaymentMethods(prev => [...prev, data]);\r\n    };\r\n    const updatePaymentMethod = async (id, updates) => {\r\n        const { data, error } = await supabase.from('payment_methods').update(updates).eq('id', id).select().single();\r\n        if (!error) setPaymentMethods(prev => prev.map(m => m.id === id ? data : m));\r\n    };\r\n    const deletePaymentMethod = async (id) => {\r\n        const { error } = await supabase.from('payment_methods').delete().eq('id', id);\r\n        if (!error) setPaymentMethods(prev => prev.filter(m => m.id !== id));\r\n    };\r\n\r\n    // PAYMENT CATEGORIES\r\n    const addPaymentCategory = async (cat) => {\r\n        const { data, error } = await supabase.from('payment_categories').insert([cat]).select().single();\r\n        if (!error) setPaymentCategories(prev => [...prev, data]);\r\n    };\r\n    const updatePaymentCategory = async (id, updates) => {\r\n        const { data, error } = await supabase.from('payment_categories').update(updates).eq('id', id).select().single();\r\n        if (!error) setPaymentCategories(prev => prev.map(c => c.id === id ? data : c));\r\n    };\r\n    const deletePaymentCategory = async (id) => {\r\n        const { error } = await supabase.from('payment_categories').delete().eq('id', id);\r\n        if (!error) setPaymentCategories(prev => prev.filter(c => c.id !== id));\r\n    };\r\n\r\n    // REFERRAL SOURCES\r\n    const addReferralSource = async (source) => {\r\n        const { data, error } = await supabase.from('referral_sources').insert([source]).select().single();\r\n        if (!error) setReferralSources(prev => [...prev, data]);\r\n    };\r\n    const updateReferralSource = async (id, updates) => {\r\n        const { data, error } = await supabase.from('referral_sources').update(updates).eq('id', id).select().single();\r\n        if (!error) setReferralSources(prev => prev.map(s => s.id === id ? data : s));\r\n    };\r\n    const deleteReferralSource = async (id) => {\r\n        const { error } = await supabase.from('referral_sources').delete().eq('id', id);\r\n        if (!error) setReferralSources(prev => prev.filter(s => s.id !== id));\r\n    };\r\n\r\n    // NUTRITIONISTS\r\n    const addNutritionist = async (nutri) => {\r\n        const { data, error } = await supabase.from('nutritionists').insert([nutri]).select().single();\r\n        if (!error) setNutritionists(prev => [...prev, data]);\r\n    };\r\n    const updateNutritionist = async (id, updates) => {\r\n        const { data, error } = await supabase.from('nutritionists').update(updates).eq('id', id).select().single();\r\n        if (!error) setNutritionists(prev => prev.map(n => n.id === id ? data : n));\r\n    };\r\n    const deleteNutritionist = async (id) => {\r\n        const { error } = await supabase.from('nutritionists').delete().eq('id', id);\r\n        if (!error) setNutritionists(prev => prev.filter(n => n.id !== id));\r\n    };\r\n\r\n    // PROFILE\r\n    const updateUserProfile = async (updates) => {\r\n        // User profile is a singleton row usually. ID=1 (from SQL sequence) or any.\r\n        // Or we key by user email. For now, assume there's one row.\r\n        // We'll update row where id=1 (or whatever we loaded).\r\n        const id = userProfile.id;\r\n        const { data, error } = await supabase.from('user_profile').update(updates).eq('id', id).select().single();\r\n        if (!error) setUserProfile(data);\r\n    };\r\n\r\n    // Memoized computed values\r\n    const normalizedPatients = useMemo(() => patients.map(p => ({\r\n        ...p,\r\n        subscription: {\r\n            type: p.subscription_type,\r\n            startDate: p.subscription_start,\r\n            endDate: p.subscription_end,\r\n            status: p.subscription_status,\r\n            pauseStartDate: p.pause_start_date,\r\n            subscriptionTypeId: p.subscription_type_id,\r\n            paymentRateId: p.payment_rate_id\r\n        }\r\n    })), [patients]);\r\n\r\n    // CLINICAL OPTIONS\r\n    const addClinicalOption = async (option) => {\r\n        const { data, error } = await supabase.from('clinical_options').insert([option]).select().single();\r\n        if (error) {\r\n            console.error(error);\r\n            return;\r\n        }\r\n        setClinicalOptions(prev => [...prev, data]);\r\n    };\r\n\r\n    const updateClinicalOption = async (id, updates) => {\r\n        const { data, error } = await supabase.from('clinical_options').update(updates).eq('id', id).select().single();\r\n        if (error) {\r\n            console.error(error);\r\n            return;\r\n        }\r\n        setClinicalOptions(prev => prev.map(c => c.id === id ? data : c));\r\n    };\r\n\r\n    const deleteClinicalOption = async (id) => {\r\n        const { error } = await supabase.from('clinical_options').delete().eq('id', id);\r\n        if (error) {\r\n            console.error(error);\r\n            return;\r\n        }\r\n        setClinicalOptions(prev => prev.filter(c => c.id !== id));\r\n    };\r\n\r\n    // CLINICAL CATEGORIES\r\n    const addClinicalCategory = async (cat) => {\r\n        const { data, error } = await supabase.from('clinical_categories').insert([cat]).select().single();\r\n        if (!error) setClinicalCategories(prev => [...prev, data]);\r\n    };\r\n    const updateClinicalCategory = async (id, updates) => {\r\n        const { data, error } = await supabase.from('clinical_categories').update(updates).eq('id', id).select().single();\r\n        if (error) {\r\n            console.error('Error updating clinical category:', error);\r\n            return;\r\n        }\r\n        // Handle case where local state might be empty (using fallback) - add if doesn't exist\r\n        setClinicalCategories(prev => {\r\n            const exists = prev.some(c => c.id === id);\r\n            if (exists) {\r\n                return prev.map(c => c.id === id ? data : c);\r\n            } else {\r\n                return [...prev, data];\r\n            }\r\n        });\r\n    };\r\n    const deleteClinicalCategory = async (id) => {\r\n        const { error } = await supabase.from('clinical_categories').delete().eq('id', id);\r\n        if (!error) setClinicalCategories(prev => prev.filter(c => c.id !== id));\r\n    };\r\n\r\n    // SUBSCRIPTION TYPES\r\n    const addSubscriptionType = async (type) => {\r\n        const { data, error } = await supabase.from('subscription_types').insert([type]).select().single();\r\n        if (!error) setSubscriptionTypes(prev => [...prev, data].sort((a, b) => a.months - b.months));\r\n    };\r\n    const updateSubscriptionType = async (id, updates) => {\r\n        const { data, error } = await supabase.from('subscription_types').update(updates).eq('id', id).select().single();\r\n        if (!error) setSubscriptionTypes(prev => prev.map(t => t.id === id ? data : t).sort((a, b) => a.months - b.months));\r\n    };\r\n    const deleteSubscriptionType = async (id) => {\r\n        const { error } = await supabase.from('subscription_types').delete().eq('id', id);\r\n        if (!error) setSubscriptionTypes(prev => prev.filter(t => t.id !== id));\r\n    };\r\n\r\n    // PAYMENT RATES\r\n    const addPaymentRate = async (rate) => {\r\n        const { data, error } = await supabase.from('payment_rates').insert([rate]).select().single();\r\n        if (!error) setPaymentRates(prev => [...prev, data].sort((a, b) => a.amount - b.amount));\r\n    };\r\n    const updatePaymentRate = async (id, updates) => {\r\n        const { data, error } = await supabase.from('payment_rates').update(updates).eq('id', id).select().single();\r\n        if (!error) setPaymentRates(prev => prev.map(r => r.id === id ? data : r).sort((a, b) => a.amount - b.amount));\r\n    };\r\n    const deletePaymentRate = async (id) => {\r\n        const { error } = await supabase.from('payment_rates').delete().eq('id', id);\r\n        if (!error) setPaymentRates(prev => prev.filter(r => r.id !== id));\r\n    };\r\n\r\n    const extendSubscription = async (patientId, daysToAdd) => {\r\n        try {\r\n            const patient = patients.find(p => p.id === patientId);\r\n            if (!patient || !patient.subscription_end) return false;\r\n\r\n            const currentEnd = parseISO(patient.subscription_end);\r\n            const newEnd = addDays(currentEnd, parseInt(daysToAdd));\r\n            const newEndDateStr = format(newEnd, 'yyyy-MM-dd');\r\n\r\n            // 1. Update patient subscription_end\r\n            const { error: patientError } = await supabase\r\n                .from('patients')\r\n                .update({ subscription_end: newEndDateStr })\r\n                .eq('id', patientId);\r\n\r\n            if (patientError) throw patientError;\r\n\r\n            // 2. Update the active subscription history record if it exists\r\n            // Find the active subscription to get its ID\r\n            const { data: activeSubs } = await supabase\r\n                .from('patient_subscriptions')\r\n                .select('id')\r\n                .eq('patient_id', patientId)\r\n                .eq('status', 'active')\r\n                .order('start_date', { ascending: false })\r\n                .limit(1);\r\n\r\n            if (activeSubs && activeSubs.length > 0) {\r\n                await supabase\r\n                    .from('patient_subscriptions')\r\n                    .update({ end_date: newEndDateStr })\r\n                    .eq('id', activeSubs[0].id);\r\n            }\r\n\r\n            // 3. Update local state\r\n            setPatients(prev => prev.map(p => {\r\n                if (p.id === patientId) {\r\n                    const updatedHistory = p.subscriptionHistory ? p.subscriptionHistory.map(sub => {\r\n                        if (activeSubs && activeSubs.length > 0 && sub.id === activeSubs[0].id) {\r\n                            return { ...sub, end_date: newEndDateStr };\r\n                        }\r\n                        return sub;\r\n                    }) : p.subscriptionHistory;\r\n\r\n                    return {\r\n                        ...p,\r\n                        subscription_end: newEndDateStr,\r\n                        days_remaining: differenceInDays(newEnd, new Date()), // Update days_remaining\r\n                        subscriptionHistory: updatedHistory,\r\n                        // Also update nested subscription object for immediate UI reflection\r\n                        subscription: {\r\n                            ...p.subscription,\r\n                            endDate: newEndDateStr\r\n                        }\r\n                    };\r\n                }\r\n                return p;\r\n            }));\r\n\r\n            // 4. Log the extension\r\n            const { data: logData, error: logError } = await supabase\r\n                .from('subscription_extensions')\r\n                .insert([{\r\n                    patient_id: patientId,\r\n                    days_added: parseInt(daysToAdd),\r\n                    previous_end_date: patient.subscription_end,\r\n                    new_end_date: newEndDateStr\r\n                }])\r\n                .select()\r\n                .single();\r\n\r\n            if (!logError && logData) {\r\n                setSubscriptionExtensions(prev => [logData, ...prev]);\r\n            }\r\n\r\n            return true;\r\n        } catch (error) {\r\n            console.error('Error extending subscription:', error);\r\n            return false;\r\n        }\r\n    };\r\n\r\n    const updateSubscriptionExtension = async (id, daysAdded) => {\r\n        try {\r\n            const extension = subscriptionExtensions.find(e => e.id === id);\r\n            if (!extension) return false;\r\n\r\n            const diff = parseInt(daysAdded) - extension.days_added;\r\n            if (diff === 0) return true;\r\n\r\n            // 1. Update the extension record\r\n            const { data: updatedExt, error: extError } = await supabase\r\n                .from('subscription_extensions')\r\n                .update({ days_added: parseInt(daysAdded) })\r\n                .eq('id', id)\r\n                .select()\r\n                .single();\r\n\r\n            if (extError) throw extError;\r\n\r\n            // 2. Adjust patient subscription end date\r\n            const patient = patients.find(p => p.id === extension.patient_id);\r\n            if (patient && patient.subscription_end) {\r\n                // Determine which date to adjust. \r\n                // Creating a new end date based on current end date + difference\r\n                const currentEnd = parseISO(patient.subscription_end);\r\n                const newEnd = addDays(currentEnd, diff);\r\n                const newEndDateStr = format(newEnd, 'yyyy-MM-dd');\r\n\r\n                await supabase.from('patients').update({ subscription_end: newEndDateStr }).eq('id', patient.id);\r\n\r\n                // Also update active history if matches\r\n                const { data: activeSubs } = await supabase\r\n                    .from('patient_subscriptions')\r\n                    .select('id')\r\n                    .eq('patient_id', patient.id)\r\n                    .eq('status', 'active')\r\n                    .order('start_date', { ascending: false })\r\n                    .limit(1);\r\n\r\n                if (activeSubs && activeSubs.length > 0) {\r\n                    await supabase\r\n                        .from('patient_subscriptions')\r\n                        .update({ end_date: newEndDateStr })\r\n                        .eq('id', activeSubs[0].id);\r\n                }\r\n\r\n                // Update local state\r\n                setPatients(prev => prev.map(p => {\r\n                    if (p.id === patient.id) {\r\n                        const newDaysRemaining = differenceInDays(newEnd, new Date());\r\n                        const oldEndDate = patient.subscription_end;\r\n\r\n                        const updatedHistory = p.subscriptionHistory ? p.subscriptionHistory.map(sub => {\r\n                            const isMatch = (activeSubs && activeSubs.length > 0 && sub.id === activeSubs[0].id) ||\r\n                                (sub.end_date === oldEndDate);\r\n                            if (isMatch) {\r\n                                return { ...sub, end_date: newEndDateStr };\r\n                            }\r\n                            return sub;\r\n                        }) : p.subscriptionHistory;\r\n\r\n                        return {\r\n                            ...p,\r\n                            subscription_end: newEndDateStr,\r\n                            days_remaining: newDaysRemaining,\r\n                            subscriptionHistory: updatedHistory,\r\n                            subscription: {\r\n                                ...p.subscription,\r\n                                endDate: newEndDateStr\r\n                            }\r\n                        };\r\n                    }\r\n                    return p;\r\n                }));\r\n            }\r\n\r\n            // Update local extension state\r\n            setSubscriptionExtensions(prev => prev.map(e => e.id === id ? updatedExt : e));\r\n\r\n            return true;\r\n        } catch (error) {\r\n            console.error('Error updating extension:', error);\r\n            return false;\r\n        }\r\n    };\r\n\r\n    const deleteSubscriptionExtension = async (id) => {\r\n        try {\r\n            const extension = subscriptionExtensions.find(e => e.id === id);\r\n            if (!extension) return false;\r\n\r\n            // 1. Delete extension\r\n            const { error } = await supabase.from('subscription_extensions').delete().eq('id', id);\r\n            if (error) throw error;\r\n\r\n            // 2. Revert dates (subtract days_added)\r\n            const patient = patients.find(p => p.id === extension.patient_id);\r\n            if (patient && patient.subscription_end) {\r\n                const currentEnd = parseISO(patient.subscription_end);\r\n                const newEnd = addDays(currentEnd, -extension.days_added);\r\n                const newEndDateStr = format(newEnd, 'yyyy-MM-dd');\r\n\r\n                await supabase.from('patients').update({ subscription_end: newEndDateStr }).eq('id', patient.id);\r\n\r\n                // Also update active history if matches\r\n                const { data: activeSubs } = await supabase\r\n                    .from('patient_subscriptions')\r\n                    .select('id')\r\n                    .eq('patient_id', patient.id)\r\n                    .eq('status', 'active')\r\n                    .order('start_date', { ascending: false })\r\n                    .limit(1);\r\n\r\n                if (activeSubs && activeSubs.length > 0) {\r\n                    await supabase\r\n                        .from('patient_subscriptions')\r\n                        .update({ end_date: newEndDateStr })\r\n                        .eq('id', activeSubs[0].id);\r\n                }\r\n\r\n                // Update local state\r\n                setPatients(prev => prev.map(p => {\r\n                    if (p.id === patient.id) {\r\n                        const newDaysRemaining = differenceInDays(newEnd, new Date());\r\n                        const oldEndDate = patient.subscription_end;\r\n\r\n                        const updatedHistory = p.subscriptionHistory ? p.subscriptionHistory.map(sub => {\r\n                            const isMatch = (activeSubs && activeSubs.length > 0 && sub.id === activeSubs[0].id) ||\r\n                                (sub.end_date === oldEndDate);\r\n                            if (isMatch) {\r\n                                return { ...sub, end_date: newEndDateStr };\r\n                            }\r\n                            return sub;\r\n                        }) : p.subscriptionHistory;\r\n\r\n                        return {\r\n                            ...p,\r\n                            subscription_end: newEndDateStr,\r\n                            days_remaining: newDaysRemaining,\r\n                            subscriptionHistory: updatedHistory,\r\n                            subscription: {\r\n                                ...p.subscription,\r\n                                endDate: newEndDateStr\r\n                            }\r\n                        };\r\n                    }\r\n                    return p;\r\n                }));\r\n            }\r\n\r\n            setSubscriptionExtensions(prev => prev.filter(e => e.id !== id));\r\n            return true;\r\n        } catch (error) {\r\n            console.error('Error deleting extension:', error);\r\n            return false;\r\n        }\r\n    };\r\n\r\n    const normalizedTasks = useMemo(() =>\r\n        tasks.map(t => ({ ...t, tag: t.tag_id, type: t.type_id })),\r\n        [tasks]);\r\n\r\n    return (\r\n        <DataContext.Provider value={{\r\n            loading,\r\n            patients: normalizedPatients,\r\n            addPatient,\r\n            updatePatient,\r\n            deletePatient,\r\n            addMeasurement,\r\n            updateMeasurement,\r\n            deleteMeasurement,\r\n\r\n\r\n\r\n            plans,\r\n            addPlan,\r\n            updatePlan,\r\n            deletePlan,\r\n\r\n            tasks: normalizedTasks,\r\n            addTask,\r\n            updateTask,\r\n            deleteTask,\r\n            addSubscriptionHistory,\r\n            updateSubscriptionHistory,\r\n            deleteSubscription,\r\n\r\n            taskCategories,\r\n            addTaskCategory,\r\n            updateTaskCategory,\r\n            deleteTaskCategory,\r\n\r\n            taskTypes,\r\n            addTaskType,\r\n            updateTaskType,\r\n            deleteTaskType,\r\n\r\n            payments,\r\n            addPayment,\r\n            updatePayment,\r\n            deletePayment,\r\n\r\n            paymentMethods,\r\n            addPaymentMethod,\r\n            updatePaymentMethod,\r\n            deletePaymentMethod,\r\n\r\n            paymentCategories,\r\n            addPaymentCategory,\r\n            updatePaymentCategory,\r\n            deletePaymentCategory,\r\n\r\n            referralSources,\r\n            addReferralSource,\r\n            updateReferralSource,\r\n            deleteReferralSource,\r\n\r\n            nutritionists,\r\n            addNutritionist,\r\n            updateNutritionist,\r\n            deleteNutritionist,\r\n\r\n            clinicalOptions,\r\n            addClinicalOption,\r\n            updateClinicalOption,\r\n            deleteClinicalOption,\r\n\r\n            clinicalCategories,\r\n            addClinicalCategory,\r\n            updateClinicalCategory,\r\n            deleteClinicalCategory,\r\n\r\n            subscriptionTypes,\r\n            addSubscriptionType,\r\n            updateSubscriptionType,\r\n            deleteSubscriptionType,\r\n\r\n            paymentRates,\r\n            addPaymentRate,\r\n            updatePaymentRate,\r\n            deletePaymentRate,\r\n            extendSubscription,\r\n            updateSubscriptionExtension,\r\n            deleteSubscriptionExtension,\r\n            subscriptionExtensions,\r\n\r\n            userProfile,\r\n            updateUserProfile,\r\n\r\n            reviews,\r\n            saveReview,\r\n            refreshData: fetchData\r\n        }}>\r\n            {children}\r\n        </DataContext.Provider>\r\n    );\r\n};\r\n"},{"path":"src/context/ThemeContext.jsx","content":"import { createContext, useContext, useEffect, useState } from 'react';\r\n\r\nconst initialState = {\r\n    theme: 'light',\r\n    setTheme: () => null,\r\n};\r\n\r\nconst ThemeContext = createContext(initialState);\r\n\r\nexport function ThemeProvider({\r\n    children,\r\n    defaultTheme = 'light',\r\n    storageKey = 'vite-ui-theme',\r\n}) {\r\n    const [theme, setTheme] = useState(\r\n        () => localStorage.getItem(storageKey) || defaultTheme\r\n    );\r\n\r\n    useEffect(() => {\r\n        const root = window.document.documentElement;\r\n\r\n        root.classList.remove('light', 'dark');\r\n\r\n        if (theme === 'system') {\r\n            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)')\r\n                .matches\r\n                ? 'dark'\r\n                : 'light';\r\n\r\n            root.classList.add(systemTheme);\r\n            return;\r\n        }\r\n\r\n        root.classList.add(theme);\r\n    }, [theme]);\r\n\r\n    const value = {\r\n        theme,\r\n        setTheme: (theme) => {\r\n            localStorage.setItem(storageKey, theme);\r\n            setTheme(theme);\r\n        },\r\n    };\r\n\r\n    return (\r\n        <ThemeContext.Provider value={value}>\r\n            {children}\r\n        </ThemeContext.Provider>\r\n    );\r\n}\r\n\r\n// eslint-disable-next-line react-refresh/only-export-components\r\nexport const useTheme = () => {\r\n    const context = useContext(ThemeContext);\r\n\r\n    if (context === undefined)\r\n        throw new Error(\"useTheme must be used within a ThemeProvider\");\r\n\r\n    return context;\r\n};\r\n"},{"path":"src/utils/cn.js","content":"import { clsx } from 'clsx';\r\nimport { twMerge } from 'tailwind-merge';\r\n\r\nexport function cn(...inputs) {\r\n    return twMerge(clsx(inputs));\r\n}\r\n"},{"path":"src/utils/dateUtils.js","content":"import { format, parseISO, differenceInYears } from 'date-fns';\r\nimport { es } from 'date-fns/locale'; // Default to spanish if needed, though safeFormat didn't use it directly in the helper logic, but good practice.\r\n\r\n// Helper to calculate age from birth date\r\nexport const calculateAge = (birthDate) => {\r\n    if (!birthDate) return null;\r\n    return differenceInYears(new Date(), parseISO(birthDate));\r\n};\r\n\r\nexport const safeFormat = (dateStr, fmt = 'dd/MM/yyyy', options = {}) => {\r\n    if (!dateStr) return '-';\r\n    // Handle if dateStr is already a Date object\r\n    const date = typeof dateStr === 'string' ? parseISO(dateStr) : dateStr;\r\n    if (date instanceof Date && isNaN(date.getTime())) return '-';\r\n    try {\r\n        return format(date, fmt, options);\r\n    } catch (e) {\r\n        return '-';\r\n    }\r\n};\r\n"},{"path":"src/utils/measurementsPdfGenerator.js","content":"import jsPDF from 'jspdf';\r\nimport autoTable from 'jspdf-autotable';\r\nimport html2canvas from 'html2canvas';\r\n\r\n/**\r\n * Generates a PDF report with patient measurements, including charts and a data table\r\n * @param {Object} patient - Patient object with measurements and personal info\r\n * @param {Object} chartRefs - Object containing refs to chart canvas elements\r\n * @param {Array} selectedCharts - Array of chart keys to include (e.g. ['weight', 'pecho'])\r\n */\r\nexport const generateMeasurementsPDF = async (patient, chartRefs = {}, selectedCharts = null) => {\r\n    const pdf = new jsPDF({\r\n        orientation: 'p',\r\n        unit: 'mm',\r\n        format: 'a4',\r\n        compress: true\r\n    });\r\n    const pageWidth = pdf.internal.pageSize.getWidth();\r\n    const pageHeight = pdf.internal.pageSize.getHeight();\r\n\r\n    const primaryColor = [40, 72, 58]; // Verde #28483a\r\n    const lightGreen = [230, 240, 235];\r\n    const darkGray = [60, 60, 60];\r\n\r\n    let yPosition = 20;\r\n\r\n    // Helper function to add page numbers\r\n    const addPageNumber = () => {\r\n        const pageCount = pdf.internal.getNumberOfPages();\r\n        for (let i = 1; i <= pageCount; i++) {\r\n            pdf.setPage(i);\r\n            pdf.setFontSize(8);\r\n            pdf.setTextColor(150, 150, 150);\r\n            pdf.text(`Página ${i} de ${pageCount}`, pageWidth - 20, pageHeight - 10, { align: 'right' });\r\n        }\r\n    };\r\n\r\n    // === PAGE 1: Header & Patient Info ===\r\n\r\n    // Title\r\n    pdf.setFontSize(24);\r\n    pdf.setTextColor(...primaryColor);\r\n    pdf.setFont('helvetica', 'bold');\r\n    pdf.text('Informe de Mediciones', pageWidth / 2, 25, { align: 'center' });\r\n\r\n    // Separator line (drawn BEFORE logo so logo appears on top)\r\n    pdf.setDrawColor(...primaryColor);\r\n    pdf.setLineWidth(0.5);\r\n    pdf.line(15, 35, pageWidth - 15, 35);\r\n\r\n    // Add logo (drawn AFTER line so it appears on top of it)\r\n    try {\r\n        const logoImg = new Image();\r\n        logoImg.src = '/logo-rosa.png';\r\n        await new Promise((resolve, reject) => {\r\n            logoImg.onload = resolve;\r\n            logoImg.onerror = reject;\r\n        });\r\n        pdf.addImage(logoImg, 'PNG', 15, 10, 30, 30);\r\n    } catch (error) {\r\n        console.warn('Logo could not be loaded:', error);\r\n    }\r\n\r\n    yPosition = 50;\r\n\r\n    // Patient information - inline labels with values\r\n    pdf.setFontSize(12);\r\n    pdf.setTextColor(...darkGray);\r\n\r\n    pdf.setFont('helvetica', 'bold');\r\n    const clienteLabel = 'Cliente: ';\r\n    pdf.text(clienteLabel, 15, yPosition);\r\n    const clienteLabelWidth = pdf.getTextWidth(clienteLabel);\r\n    pdf.setFont('helvetica', 'normal');\r\n    pdf.text(`${patient.first_name} ${patient.last_name}`, 15 + clienteLabelWidth, yPosition);\r\n\r\n    yPosition += 8;\r\n    pdf.setFont('helvetica', 'bold');\r\n    const fechaLabel = 'Fecha del informe: ';\r\n    pdf.text(fechaLabel, 15, yPosition);\r\n    const fechaLabelWidth = pdf.getTextWidth(fechaLabel);\r\n    pdf.setFont('helvetica', 'normal');\r\n    const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });\r\n    pdf.text(today, 15 + fechaLabelWidth, yPosition);\r\n\r\n    // Measurement period\r\n    if (patient.measurements && patient.measurements.length > 0) {\r\n        const sortedMeasurements = [...patient.measurements].sort((a, b) => new Date(a.date) - new Date(b.date));\r\n        const firstDate = new Date(sortedMeasurements[0].date).toLocaleDateString('es-ES');\r\n        const lastDate = new Date(sortedMeasurements[sortedMeasurements.length - 1].date).toLocaleDateString('es-ES');\r\n\r\n        yPosition += 8;\r\n        pdf.setFont('helvetica', 'bold');\r\n        const periodoLabel = 'Período: ';\r\n        pdf.text(periodoLabel, 15, yPosition);\r\n        const periodoLabelWidth = pdf.getTextWidth(periodoLabel);\r\n        pdf.setFont('helvetica', 'normal');\r\n        pdf.text(`${firstDate} - ${lastDate}`, 15 + periodoLabelWidth, yPosition);\r\n    }\r\n\r\n    yPosition += 15;\r\n\r\n    // === EVOLUTION SUMMARY (First vs Last Recorded) ===\r\n    if (patient.measurements && patient.measurements.length >= 2) {\r\n        const sorted = [...patient.measurements].sort((a, b) => new Date(a.date) - new Date(b.date));\r\n\r\n        pdf.setFontSize(16);\r\n        pdf.setTextColor(...primaryColor);\r\n        pdf.setFont('helvetica', 'bold');\r\n        pdf.text('Resumen de Evolución', 15, yPosition);\r\n        yPosition += 3;\r\n\r\n        const metricsConfig = [\r\n            { key: 'weight', label: 'Peso (kg)' },\r\n            { key: 'pecho', label: 'Pecho (cm)' },\r\n            { key: 'cadera', label: 'Cadera (cm)' },\r\n            { key: 'sobre_ombligo', label: 'Abd. Sobre Ombligo' },\r\n            { key: 'ombligo', label: 'Abd. Ombligo' },\r\n            { key: 'bajo_ombligo', label: 'Abd. Bajo Ombligo' },\r\n            { key: 'brazo_izq', label: 'Brazo Izq. (cm)' },\r\n            { key: 'brazo_der', label: 'Brazo Der. (cm)' },\r\n            { key: 'muslo_izq', label: 'Muslo Izq. (cm)' },\r\n            { key: 'muslo_der', label: 'Muslo Der. (cm)' },\r\n        ];\r\n\r\n        const summaryData = metricsConfig.map(metric => {\r\n            // Get all non-null values for this metric\r\n            const validMeasurements = sorted.filter(m =>\r\n                m[metric.key] !== null &&\r\n                m[metric.key] !== undefined &&\r\n                m[metric.key] !== '' &&\r\n                !isNaN(parseFloat(m[metric.key]))\r\n            );\r\n\r\n            if (validMeasurements.length < 2) return null; // Need at least 2 points for diff\r\n\r\n            const first = validMeasurements[0];\r\n            const last = validMeasurements[validMeasurements.length - 1];\r\n\r\n            const fv = parseFloat(first[metric.key]);\r\n            const lv = parseFloat(last[metric.key]);\r\n\r\n            const diff = lv - fv;\r\n            const diffStr = diff > 0 ? `+${diff.toFixed(1)}` : diff.toFixed(1);\r\n\r\n            return [\r\n                metric.label,\r\n                fv.toFixed(1),\r\n                lv.toFixed(1),\r\n                diffStr\r\n            ];\r\n        }).filter(row => row !== null);\r\n\r\n        if (summaryData.length > 0) {\r\n            autoTable(pdf, {\r\n                startY: yPosition,\r\n                head: [['Medida', 'Valor Inicial', 'Valor Actual', 'Diferencia']],\r\n                body: summaryData,\r\n                theme: 'striped',\r\n                headStyles: {\r\n                    fillColor: primaryColor,\r\n                    textColor: [255, 255, 255],\r\n                    fontSize: 9,\r\n                    fontStyle: 'bold',\r\n                    halign: 'center'\r\n                },\r\n                bodyStyles: {\r\n                    fontSize: 9,\r\n                    textColor: darkGray,\r\n                    halign: 'center'\r\n                },\r\n                columnStyles: {\r\n                    0: { halign: 'left', fontStyle: 'bold' },\r\n                    3: { fontStyle: 'bold' }\r\n                },\r\n                alternateRowStyles: {\r\n                    fillColor: [250, 250, 250]\r\n                },\r\n                margin: { left: 15, right: 15 },\r\n                didParseCell: (data) => {\r\n                    // Color-code the difference column\r\n                    if (data.column.index === 3 && data.section === 'body') {\r\n                        const val = parseFloat(data.cell.raw);\r\n                        if (!isNaN(val)) {\r\n                            if (val < 0) {\r\n                                data.cell.styles.textColor = [22, 163, 74]; // green for loss\r\n                            } else if (val > 0) {\r\n                                data.cell.styles.textColor = [220, 38, 38]; // red for gain\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n\r\n            yPosition = pdf.lastAutoTable.finalY + 10;\r\n        }\r\n    }\r\n\r\n    // === EVOLUTION CHARTS ===\r\n\r\n    // All available charts\r\n    const allCharts = [\r\n        { key: 'weight', title: 'Peso (kg)' },\r\n        { key: 'pecho', title: 'Pecho (cm)' },\r\n        { key: 'cadera', title: 'Cadera (cm)' },\r\n        { key: 'sobre_ombligo', title: 'Abd. Sobre Ombligo (cm)' },\r\n        { key: 'ombligo', title: 'Abd. Ombligo (cm)' },\r\n        { key: 'bajo_ombligo', title: 'Abd. Bajo Ombligo (cm)' },\r\n        { key: 'brazo_izq', title: 'Brazo Izquierdo (cm)' },\r\n        { key: 'brazo_der', title: 'Brazo Derecho (cm)' },\r\n        { key: 'muslo_izq', title: 'Muslo Izquierdo (cm)' },\r\n        { key: 'muslo_der', title: 'Muslo Derecho (cm)' }\r\n    ];\r\n\r\n    // Filter by selected charts\r\n    const chartsToInclude = selectedCharts\r\n        ? allCharts.filter(c => selectedCharts.includes(c.key))\r\n        : allCharts;\r\n\r\n    if (chartsToInclude.length > 0) {\r\n        // Check if we need a new page (if summary table took up space)\r\n        if (yPosition > pageHeight - 80) {\r\n            pdf.addPage();\r\n            yPosition = 20;\r\n        }\r\n\r\n        pdf.setFontSize(16);\r\n        pdf.setTextColor(...primaryColor);\r\n        pdf.setFont('helvetica', 'bold');\r\n        pdf.text('Evolución de Mediciones', 15, yPosition);\r\n\r\n        yPosition += 10;\r\n\r\n        // Chart configuration\r\n        const chartWidth = 85;\r\n        const chartHeight = 60;\r\n        const chartSpacing = 10;\r\n        const chartsPerRow = 2;\r\n\r\n        let chartIndex = 0;\r\n\r\n        for (const chartInfo of chartsToInclude) {\r\n            const chartRef = chartRefs[chartInfo.key];\r\n\r\n            if (!chartRef || !chartRef.current) {\r\n                console.warn(`Chart ref for ${chartInfo.key} not found`);\r\n                continue;\r\n            }\r\n\r\n            try {\r\n                const chartInstance = chartRef.current;\r\n                const canvas = chartInstance?.canvas;\r\n\r\n                if (!canvas) {\r\n                    console.warn(`Canvas for ${chartInfo.key} not found`);\r\n                    continue;\r\n                }\r\n\r\n                const col = chartIndex % chartsPerRow;\r\n                const row = Math.floor(chartIndex / chartsPerRow);\r\n\r\n                const xPos = 15 + col * (chartWidth + chartSpacing);\r\n                let chartYPos = yPosition + row * (chartHeight + chartSpacing + 5);\r\n\r\n                if (chartYPos + chartHeight > pageHeight - 20) {\r\n                    pdf.addPage();\r\n                    yPosition = 20;\r\n                    chartYPos = yPosition;\r\n                    chartIndex = 0;\r\n                }\r\n\r\n                // Create a temporary canvas to add white background\r\n                const tempCanvas = document.createElement('canvas');\r\n                tempCanvas.width = canvas.width;\r\n                tempCanvas.height = canvas.height;\r\n                const tempCtx = tempCanvas.getContext('2d');\r\n\r\n                // Fill with white background\r\n                tempCtx.fillStyle = '#ffffff';\r\n                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);\r\n\r\n                // Draw the original chart on top\r\n                tempCtx.drawImage(canvas, 0, 0);\r\n\r\n                // Get JPEG from temp canvas\r\n                const chartImgData = tempCanvas.toDataURL('image/jpeg', 0.8);\r\n\r\n                pdf.setFontSize(10);\r\n                pdf.setTextColor(...darkGray);\r\n                pdf.setFont('helvetica', 'bold');\r\n                pdf.text(chartInfo.title, xPos, chartYPos);\r\n\r\n                pdf.addImage(chartImgData, 'JPEG', xPos, chartYPos + 3, chartWidth, chartHeight);\r\n\r\n                chartIndex++;\r\n\r\n            } catch (error) {\r\n                console.error(`Error capturing chart ${chartInfo.key}:`, error);\r\n            }\r\n        }\r\n    }\r\n\r\n    // === MEASUREMENTS TABLE ===\r\n\r\n    // Add new page for table\r\n    pdf.addPage();\r\n    yPosition = 20;\r\n\r\n    pdf.setFontSize(16);\r\n    pdf.setTextColor(...primaryColor);\r\n    pdf.setFont('helvetica', 'bold');\r\n    pdf.text('Historial Completo de Mediciones', 15, yPosition);\r\n\r\n    yPosition += 10;\r\n\r\n    // Prepare table data\r\n    const tableData = [...patient.measurements]\r\n        .sort((a, b) => new Date(b.date) - new Date(a.date))\r\n        .map(m => [\r\n            new Date(m.date).toLocaleDateString('es-ES'),\r\n            m.weight ? `${m.weight} kg` : '-',\r\n            m.pecho || '-',\r\n            m.cadera || '-',\r\n            `${m.sobre_ombligo || '-'} | ${m.ombligo || '-'} | ${m.bajo_ombligo || '-'}`,\r\n            `${m.brazo_izq || '-'} | ${m.brazo_der || '-'}`,\r\n            `${m.muslo_izq || '-'} | ${m.muslo_der || '-'}`\r\n        ]);\r\n\r\n    autoTable(pdf, {\r\n        startY: yPosition,\r\n        head: [['Fecha', 'Peso', 'Pecho', 'Cadera', 'Abd (S|O|B)', 'Brazos (I|D)', 'Muslos (I|D)']],\r\n        body: tableData,\r\n        theme: 'striped',\r\n        headStyles: {\r\n            fillColor: primaryColor,\r\n            textColor: [255, 255, 255],\r\n            fontSize: 9,\r\n            fontStyle: 'bold',\r\n            halign: 'center'\r\n        },\r\n        bodyStyles: {\r\n            fontSize: 8,\r\n            textColor: darkGray,\r\n            halign: 'center'\r\n        },\r\n        alternateRowStyles: {\r\n            fillColor: [250, 250, 250]\r\n        },\r\n        margin: { left: 15, right: 15 },\r\n        columnStyles: {\r\n            0: { halign: 'left', fontStyle: 'bold' }\r\n        }\r\n    });\r\n\r\n    // Add page numbers\r\n    addPageNumber();\r\n\r\n    // Generate filename\r\n    const fileName = `Mediciones_${patient.first_name}_${patient.last_name}_${new Date().toISOString().split('T')[0]}.pdf`;\r\n\r\n    // Save PDF\r\n    pdf.save(fileName);\r\n};\r\n"},{"path":"src/utils/subscriptionUtils.js","content":"import { addDays, parseISO } from 'date-fns';\r\n\r\nexport const calculateSubscriptionTerms = (patient, payments = []) => {\r\n    try {\r\n        if (!patient || !patient.subscriptionHistory || !Array.isArray(patient.subscriptionHistory)) return [];\r\n\r\n        const terms = patient.subscriptionHistory.map(sub => {\r\n            // Safe parse\r\n            if (!sub || !sub.start_date) return null;\r\n            const start = parseISO(sub.start_date);\r\n            if (isNaN(start.getTime())) return null;\r\n\r\n            const end = sub.end_date ? parseISO(sub.end_date) : addDays(start, 30);\r\n            const validEnd = isNaN(end.getTime()) ? addDays(start, 30) : end;\r\n\r\n            // Find matching payment - only by explicit link (subscription_id)\r\n            const payment = payments.find(p => p.subscription_id === sub.id);\r\n\r\n            const today = new Date().toISOString().split('T')[0];\r\n            const isCurrentTime = sub.start_date <= today && sub.end_date >= today;\r\n            const isFuture = sub.start_date > today;\r\n\r\n            let derivedStatus = 'archived';\r\n            if (isFuture) derivedStatus = 'future';\r\n            else if (isCurrentTime) derivedStatus = 'active';\r\n            else derivedStatus = 'expired';\r\n\r\n            if (sub.status === 'cancelled') derivedStatus = 'cancelled';\r\n            if (sub.status === 'paused') derivedStatus = 'paused';\r\n\r\n            return {\r\n                id: sub.id,\r\n                type: isCurrentTime ? 'current' : 'history',\r\n                label: sub.plan_name || 'Suscripción',\r\n                start: start,\r\n                end: validEnd,\r\n                status: derivedStatus,\r\n                payment: payment, // Keep original payment object\r\n                isPaid: !!payment, // Keep original isPaid\r\n                originalData: sub, // Keep originalData\r\n                payment_rate_id: sub.payment_rate_id, // Keep original payment_rate_id\r\n                price: sub.price || sub.amount // Keep original price\r\n            };\r\n        }).filter(Boolean);\r\n\r\n        // Sort by start date descending\r\n        return terms.sort((a, b) => b.start - a.start);\r\n    } catch (e) {\r\n        console.error(\"Error calculating subscription terms:\", e);\r\n        return [];\r\n    }\r\n};\r\n"}]