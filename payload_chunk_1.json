[{"path":".env.local","content":"VITE_SUPABASE_URL=https://gnziiexbwafppyardsbm.supabase.co\nVITE_SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduemlpZXhid2FmcHB5YXJkc2JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzU3MzcsImV4cCI6MjA4NTcxMTczN30._OGW9i5TFngCEMT17RRrpHmTlDxA5j1DzF5ErIwAdYg\n"},{"path":"analyze_angel.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\n\r\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\r\n\r\n// Load env vars manually\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\nconst envConfig = fs.readFileSync(envPath, 'utf8');\r\nconst env = {};\r\nenvConfig.split('\\n').forEach(line => {\r\n    const [key, value] = line.split('=');\r\n    if (key && value) env[key.trim()] = value.trim();\r\n});\r\n\r\nconst supabaseUrl = env.VITE_SUPABASE_URL;\r\nconst supabaseKey = env.VITE_SUPABASE_KEY;\r\n\r\nif (!supabaseUrl || !supabaseKey) {\r\n    console.error('Missing Supabase URL or Key');\r\n    process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function analyzeAngel() {\r\n    console.log('Searching for Angel...');\r\n    const { data: patients, error } = await supabase\r\n        .from('patients')\r\n        .select('id, first_name, last_name, subscription_end')\r\n        .limit(10);\r\n\r\n    if (error) {\r\n        console.error('Error fetching patients:', error);\r\n        return;\r\n    }\r\n\r\n    if (!patients || patients.length === 0) {\r\n        console.log('No patients found.');\r\n        return;\r\n    }\r\n\r\n    console.log('Patients found:', JSON.stringify(patients, null, 2));\r\n\r\n    for (const p of patients) {\r\n        console.log(`\\n--- Patient: ${p.first_name} ${p.last_name} (ID: ${p.id}) ---`);\r\n        console.log('Current Subscription End:', p.subscription_end);\r\n\r\n        const { data: history, error: hError } = await supabase\r\n            .from('subscription_history')\r\n            .select('*')\r\n            .eq('patient_id', p.id)\r\n            .order('start_date', { ascending: false });\r\n\r\n        if (hError) console.error('History Error:', hError);\r\n        console.log('Subscription History:', JSON.stringify(history, null, 2));\r\n\r\n        const { data: extensions, error: eError } = await supabase\r\n            .from('subscription_extensions')\r\n            .select('*')\r\n            .eq('patient_id', p.id)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (eError) console.error('Extensions Error:', eError);\r\n        console.log('Extensions:', JSON.stringify(extensions, null, 2));\r\n    }\r\n}\r\n\r\nanalyzeAngel();\r\n"},{"path":"angel_details.json","content":"{\n  \"subscriptions\": [\n    {\n      \"id\": \"85aa1571-0529-40d8-b7e4-279918f375ce\",\n      \"start_date\": \"2025-12-14\",\n      \"end_date\": \"2026-01-28\"\n    },\n    {\n      \"id\": \"3af7e357-6791-44c1-8af8-9c3660a9a467\",\n      \"start_date\": \"2025-11-14\",\n      \"end_date\": \"2026-01-28\"\n    },\n    {\n      \"id\": \"8db304d6-f6d7-4ee8-971f-77611bf9fc73\",\n      \"start_date\": \"2025-10-14\",\n      \"end_date\": \"2026-01-28\"\n    },\n    {\n      \"id\": \"3bed3226-5de4-482e-897e-e1378a7bca46\",\n      \"start_date\": \"2025-09-14\",\n      \"end_date\": \"2026-01-28\"\n    },\n    {\n      \"id\": \"10103460-1e04-468c-b897-787b6d434ab5\",\n      \"start_date\": \"2025-08-14\",\n      \"end_date\": \"2026-01-28\"\n    },\n    {\n      \"id\": \"59fdc360-bf60-4a2a-b34d-4013bd32ddbd\",\n      \"start_date\": \"2025-07-14\",\n      \"end_date\": \"2026-01-28\"\n    }\n  ],\n  \"extensions\": [\n    {\n      \"id\": \"76f3ed3d-70e3-4682-b741-8d3c6ecb8d14\",\n      \"days\": 14,\n      \"prev\": \"2026-01-14\",\n      \"new\": \"2026-01-28\",\n      \"created\": \"2026-02-08T22:39:03.625061+00:00\"\n    }\n  ]\n}"},{"path":"apply_migration_temp.js","content":"import { createClient } from '@supabase/supabase-js';\r\nimport dotenv from 'dotenv';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\n\r\n// Load environment variables\r\ndotenv.config({ path: '.env.local' });\r\n\r\nconst supabaseUrl = process.env.VITE_SUPABASE_URL;\r\nconst supabaseKey = process.env.VITE_SUPABASE_ANON_KEY;\r\n\r\nif (!supabaseUrl || !supabaseKey) {\r\n    console.error('Missing Supabase URL or Key in .env.local');\r\n    process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nconst sql = `\r\n-- Create subscription_pauses table\r\nCREATE TABLE IF NOT EXISTS public.subscription_pauses (\r\n    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\r\n    patient_id UUID NOT NULL REFERENCES public.patients(id) ON DELETE CASCADE,\r\n    start_date DATE NOT NULL,\r\n    end_date DATE, -- NULL means currently paused\r\n    notes TEXT,\r\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL\r\n);\r\n\r\n-- Enable RLS (if not already enabled)\r\nALTER TABLE public.subscription_pauses ENABLE ROW LEVEL SECURITY;\r\n\r\n-- Create policies (safe idempotency)\r\nDO $$\r\nBEGIN\r\n    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'subscription_pauses' AND policyname = 'Enable read access for all users') THEN\r\n        CREATE POLICY \"Enable read access for all users\" ON public.subscription_pauses FOR SELECT USING (true);\r\n    END IF;\r\n    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'subscription_pauses' AND policyname = 'Enable insert access for all users') THEN\r\n        CREATE POLICY \"Enable insert access for all users\" ON public.subscription_pauses FOR INSERT WITH CHECK (true);\r\n    END IF;\r\n    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'subscription_pauses' AND policyname = 'Enable update access for all users') THEN\r\n        CREATE POLICY \"Enable update access for all users\" ON public.subscription_pauses FOR UPDATE USING (true);\r\n    END IF;\r\n    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'subscription_pauses' AND policyname = 'Enable delete access for all users') THEN\r\n        CREATE POLICY \"Enable delete access for all users\" ON public.subscription_pauses FOR DELETE USING (true);\r\n    END IF;\r\nEND\r\n$$;\r\n`;\r\n\r\nasync function runMigration() {\r\n    console.log('Running migration...');\r\n    // We can't execute raw SQL with supabase-js unless we have a specific function for it or use the REST API which doesn't support raw SQL directly usually for security.\r\n    // However, the previous conversations showed usage of .sql files.\r\n    // If we can't run raw SQL, we might need the user to do it.\r\n    // But wait, the previous logs showed successful SQL execution via MCP? No, it failed.\r\n    // Actually, I can try to use a Postgres client if I had the connection string, but I only have the URL/Anon key usually.\r\n    // Let's check .env.local for connection string.\r\n}\r\n\r\n// Check .env.local content first\r\nconsole.log('Checking .env.local...');\r\nconst envPath = path.resolve(process.cwd(), '.env.local');\r\nif (fs.existsSync(envPath)) {\r\n    console.log('.env.local found.');\r\n    const envConfig = dotenv.parse(fs.readFileSync(envPath));\r\n    console.log('Keys present:', Object.keys(envConfig));\r\n} else {\r\n    console.log('.env.local NOT found.');\r\n}\r\n"},{"path":"apply_notes_migration.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport fs from 'fs';\r\n\r\nconst supabaseUrl = 'https://gnziiexbwafppyardsbm.supabase.co';\r\nconst supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduemlpZXhid2FmcHB5YXJkc2JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzU3MzcsImV4cCI6MjA4NTcxMTczN30._OGW9i5TFngCEMT17RRrpHmTlDxA5j1DzF5ErIwAdYg';\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function applyMigration() {\r\n    console.log('Applying migration...');\r\n    const sql = fs.readFileSync('migration_add_notes.sql', 'utf8');\r\n\r\n    // We can't run raw SQL easily with js client on public schema usually, but let's try via rpc if exists or just standard query if permissions allow.\r\n    // Actually, we probably can't run DDL with anon key unless allowed. \r\n    // But since I've been doing it via tools, maybe I have a tool? \r\n    // Wait, I don't have a direct SQL tool. I have been using scripts.\r\n    // Let's try to run it via the `postgres` function if it exists, or just via a dummy query trick depending on setup.\r\n    // Ah, likely I can't run DDL.\r\n\r\n    // BUT the user asked me to link it to supabase.\r\n    // If I can't run DDL, I should ask the user to run it or use a dashboard.\r\n    // HOWEVER, previous logs showed \"apply_migration\" scripts. Let's see how they did it.\r\n    // They used `supabase.rpc('exec_sql', ...)` or similar?\r\n    // Let's check `apply_migration_temp.js` if it exists.\r\n\r\n    // As a fallback, I will assume I can't and notify user, OR I'll try to just use a text field if I can't verify schema.\r\n    // But I should try.\r\n\r\n    // Actually, looking at previous context, there is no `exec_sql` RPC mentioned.\r\n    // I will try to use the `mcp_supabase` tool if available? \r\n    // \"mcp_supabase-mcp-server_apply_migration\" IS available in my tools definition!\r\n    // I should use that instead of a script.\r\n\r\n    console.log(\"Migration script is just a placeholder, I will use the tool.\");\r\n}\r\n\r\napplyMigration();\r\n"},{"path":"check_angel_extensions.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\n\r\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\nconst envConfig = fs.readFileSync(envPath, 'utf8');\r\nconst env = {};\r\nenvConfig.split('\\n').forEach(line => {\r\n    const [key, value] = line.split('=');\r\n    if (key && value) env[key.trim()] = value.trim();\r\n});\r\n\r\nconst supabaseUrl = env.VITE_SUPABASE_URL;\r\nconst supabaseKey = env.VITE_SUPABASE_KEY;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nconst ANGEL_ID = \"ecdaeee4-4f23-479a-a9af-59346c40966e\";\r\n\r\nasync function checkAngelExtensions() {\r\n    console.log('Checking extensions for Angel...');\r\n\r\n    const { data: extensions, error } = await supabase\r\n        .from('subscription_extensions')\r\n        .select('*')\r\n        .eq('patient_id', ANGEL_ID);\r\n\r\n    if (error) {\r\n        console.error('Error:', error);\r\n        return;\r\n    }\r\n\r\n    console.log('Extensions found:', JSON.stringify(extensions, null, 2));\r\n\r\n    let totalDaysAdded = 0;\r\n    if (extensions) {\r\n        totalDaysAdded = extensions.reduce((acc, curr) => acc + (curr.days_added || 0), 0);\r\n    }\r\n    console.log('Total days added:', totalDaysAdded);\r\n}\r\n\r\ncheckAngelExtensions();\r\n"},{"path":"check_angel_history.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\n\r\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\nconst envConfig = fs.readFileSync(envPath, 'utf8');\r\nconst env = {};\r\nenvConfig.split('\\n').forEach(line => {\r\n    const [key, value] = line.split('=');\r\n    if (key && value) env[key.trim()] = value.trim();\r\n});\r\n\r\nconst supabaseUrl = env.VITE_SUPABASE_URL;\r\nconst supabaseKey = env.VITE_SUPABASE_KEY;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nconst ANGEL_ID = \"ecdaeee4-4f23-479a-a9af-59346c40966e\";\r\n\r\nasync function checkHistory() {\r\n    const { data: subs, error } = await supabase\r\n        .from('patient_subscriptions')\r\n        .select('*')\r\n        .eq('patient_id', ANGEL_ID)\r\n        .order('start_date', { ascending: false });\r\n\r\n    if (error) {\r\n        console.error('Error:', error);\r\n        return;\r\n    }\r\n\r\n    const simplifiedSubs = subs ? subs.map(s => ({\r\n        id: s.id,\r\n        start_date: s.start_date,\r\n        end_date: s.end_date\r\n    })) : [];\r\n\r\n    console.log('--- SUBSCRIPTIONS ---');\r\n    simplifiedSubs.forEach(s => console.log(JSON.stringify(s)));\r\n\r\n    const { data: extensions } = await supabase\r\n        .from('subscription_extensions')\r\n        .select('*')\r\n        .eq('patient_id', ANGEL_ID);\r\n\r\n    const simplifiedExtensions = extensions ? extensions.map(e => ({\r\n        id: e.id,\r\n        days: e.days_added,\r\n        prev: e.previous_end_date,\r\n        new: e.new_end_date,\r\n        created: e.created_at\r\n    })) : [];\r\n\r\n    console.log('--- EXTENSIONS ---');\r\n    simplifiedExtensions.forEach(e => console.log(JSON.stringify(e)));\r\n\r\n    const output = {\r\n        subscriptions: simplifiedSubs,\r\n        extensions: simplifiedExtensions\r\n    };\r\n\r\n    fs.writeFileSync('angel_details.json', JSON.stringify(output, null, 2));\r\n    console.log('Data written to angel_details.json');\r\n}\r\n\r\ncheckHistory();\r\n"},{"path":"check_categories.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = 'https://gnziiexbwafppyardsbm.supabase.co';\r\nconst supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduemlpZXhid2FmcHB5YXJkc2JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzU3MzcsImV4cCI6MjA4NTcxMTczN30._OGW9i5TFngCEMT17RRrpHmTlDxA5j1DzF5ErIwAdYg';\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function checkCategories() {\r\n    console.log('Checking payment_categories table...');\r\n    const { data, error } = await supabase.from('payment_categories').select('*');\r\n\r\n    if (error) {\r\n        console.error('Error fetching payment_categories:', error);\r\n    } else {\r\n        console.log('Success. Found', data.length, 'categories:');\r\n        console.log(data);\r\n    }\r\n\r\n    console.log('\\nChecking patients column...');\r\n    const { data: patients, error: pError } = await supabase.from('patients').select('payment_category_id').limit(1);\r\n\r\n    if (pError) {\r\n        console.error('Error checking patients column:', pError);\r\n    } else {\r\n        console.log('Success. patients table has payment_category_id column.');\r\n    }\r\n}\r\n\r\ncheckCategories();\r\n"},{"path":"check_categories_final.sql","content":"SELECT id, label, is_active FROM payment_categories;\r\n"},{"path":"check_clinical_config.sql","content":"SELECT * FROM clinical_categories;\r\n"},{"path":"check_constraints.sql","content":"SELECT column_name, is_nullable, data_type \r\nFROM information_schema.columns \r\nWHERE table_name = 'patients'\r\nORDER BY is_nullable ASC; -- Show NO (not null) first\r\n"},{"path":"check_data.sql","content":"-- Check columns in patients\r\nSELECT column_name, data_type \r\nFROM information_schema.columns \r\nWHERE table_name = 'patients' AND column_name = 'payment_category_id';\r\n\r\n-- Check content of payment_categories\r\nSELECT * FROM payment_categories;\r\n\r\n-- Check if any patient has a category assigned\r\nSELECT id, first_name, payment_category_id FROM patients WHERE payment_category_id IS NOT NULL LIMIT 5;\r\n"},{"path":"check_data_existence.sql","content":"-- Count how many patients have data in these \"unused\" columns\r\nSELECT \r\n    COUNT(CASE WHEN favorite_foods IS NOT NULL AND favorite_foods != '' THEN 1 END) as favorite_foods_count,\r\n    COUNT(CASE WHEN platos_que_no_pueden_faltar IS NOT NULL AND platos_que_no_pueden_faltar != '' THEN 1 END) as platos_count,\r\n    COUNT(CASE WHEN allergies IS NOT NULL AND allergies != '' THEN 1 END) as allergies_count -- Just for comparison\r\nFROM patients;\r\n\r\n-- Show sample data if exists\r\nSELECT id, first_name, favorite_foods, platos_que_no_pueden_faltar \r\nFROM patients \r\nWHERE \r\n    (favorite_foods IS NOT NULL AND favorite_foods != '') OR \r\n    (platos_que_no_pueden_faltar IS NOT NULL AND platos_que_no_pueden_faltar != '')\r\nLIMIT 5;\r\n"},{"path":"check_patients.sql","content":"-- Refresh schema cache again to be absolutely sure\r\nNOTIFY pgrst, 'reload config';\r\n\r\n-- Check if the column is populated for ANY patient\r\nSELECT id, first_name, payment_category_id FROM patients WHERE payment_category_id IS NOT NULL;\r\n\r\n-- Check structure again\r\nSELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'patients' AND column_name = 'payment_category_id';\r\n"},{"path":"check_referrals.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = 'https://gnziiexbwafppyardsbm.supabase.co';\r\nconst supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduemlpZXhid2FmcHB5YXJkc2JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzU3MzcsImV4cCI6MjA4NTcxMTczN30._OGW9i5TFngCEMT17RRrpHmTlDxA5j1DzF5ErIwAdYg';\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function checkReferrals() {\r\n    console.log('Fetching referral_sources...');\r\n    const { data: sources, error: sError } = await supabase.from('referral_sources').select('*');\r\n    if (sError) console.error(sError);\r\n    else console.log('Sources:', sources);\r\n\r\n    console.log('\\nFetching patients referral_source values...');\r\n    const { data: patients, error: pError } = await supabase.from('patients').select('id, first_name, referral_source');\r\n    if (pError) console.error(pError);\r\n    else {\r\n        patients.forEach(p => {\r\n            console.log(`Patient ${p.first_name}: referral_source = ${p.referral_source}`);\r\n        });\r\n    }\r\n}\r\n\r\ncheckReferrals();\r\n"},{"path":"check_rpc_function.js","content":"import { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = 'https://gnziiexbwafppyardsbm.supabase.co';\r\nconst supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduemlpZXhid2FmcHB5YXJkc2JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzU3MzcsImV4cCI6MjA4NTcxMTczN30._OGW9i5TFngCEMT17RRrpHmTlDxA5j1DzF5ErIwAdYg';\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function checkFunction() {\r\n    console.log('Checking function...');\r\n    const { data, error } = await supabase.rpc('register_payment_by_email', {\r\n        p_email: 'test@example.com',\r\n        p_amount: 10,\r\n        p_date: '2023-01-01'\r\n    });\r\n\r\n    if (error) {\r\n        console.error('Error:', error);\r\n    } else {\r\n        console.log('Success:', data);\r\n    }\r\n}\r\n\r\ncheckFunction();\r\n"},{"path":"check_schema.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = 'https://gnziiexbwafppyardsbm.supabase.co';\r\nconst supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduemlpZXhid2FmcHB5YXJkc2JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzU3MzcsImV4cCI6MjA4NTcxMTczN30._OGW9i5TFngCEMT17RRrpHmTlDxA5j1DzF5ErIwAdYg';\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseAnonKey);\r\n\r\nasync function checkSchema() {\r\n    console.log('Checking patients table schema...');\r\n    const { data, error } = await supabase.from('patients').select('*').limit(1);\r\n\r\n    if (error) {\r\n        console.error('Error fetching patients:', error);\r\n        return;\r\n    }\r\n\r\n    if (data && data.length > 0) {\r\n        console.log('Columns found in patients table:');\r\n        console.log(Object.keys(data[0]).join('\\n'));\r\n\r\n        // Check for clinical_data column specifically\r\n        if (Object.keys(data[0]).includes('clinical_data')) {\r\n            console.log('\\nSUCCESS: clinical_data column EXISTS.');\r\n        } else {\r\n            console.log('\\nWARNING: clinical_data column DOES NOT EXIST.');\r\n        }\r\n    } else {\r\n        console.log('No patients found to infer schema.');\r\n        // Try to insert a dummy to see error if columns missing? No, safer to just rely on this.\r\n        // Or ask for table info via rpc if available.\r\n    }\r\n}\r\n\r\ncheckSchema();\r\n"},{"path":"check_usage.sql","content":"-- Check clinical categories\r\nSELECT * FROM clinical_categories;\r\n\r\n-- Check if plan_id is being used in recent payments\r\nSELECT id, date, plan_id, payment_rate_id FROM payments ORDER BY date DESC LIMIT 10;\r\n"},{"path":"cleanup_categories.sql","content":"-- 1. DELETE duplicates / incorrect entries\r\nDELETE FROM payment_categories \r\nWHERE label NOT IN ('Online', 'Maroon Think', 'Hawk Training Center');\r\n\r\n-- 2. Ensure the correct 3 exist (with correct UUID-like IDs or whatever we settled on)\r\n-- We'll just select them to see what remains.\r\nSELECT * FROM payment_categories;\r\n"},{"path":"create_n8n_view.sql","content":"-- DROP view first to allow column structure changes\r\nDROP VIEW IF EXISTS patient_status_view;\r\n\r\n-- Create view to calculate days remaining AND include tariff info\r\n-- This view is intended for use with n8n or other automation tools\r\n\r\nCREATE OR REPLACE VIEW patient_status_view AS\r\nSELECT\r\n    p.id as patient_id,\r\n    p.first_name,\r\n    p.last_name,\r\n    p.email,\r\n    ps.id as subscription_id,\r\n    ps.plan_name,\r\n    ps.end_date as subscription_end_date,\r\n    (ps.end_date - CURRENT_DATE) as days_remaining,\r\n    ps.status as subscription_status,\r\n    -- Rate Info\r\n    pr.label as rate_label,\r\n    pr.amount as rate_amount,\r\n    pr.is_active as rate_is_active\r\nFROM\r\n    patients p\r\nJOIN\r\n    patient_subscriptions ps ON p.id = ps.patient_id\r\nLEFT JOIN\r\n    payment_rates pr ON ps.payment_rate_id = pr.id\r\nWHERE\r\n    ps.status = 'active';\r\n\r\n-- Grant access to the authenticated role (standard for Supabase)\r\nGRANT SELECT ON patient_status_view TO authenticated;\r\nGRANT SELECT ON patient_status_view TO service_role;\r\n"},{"path":"create_stripe_function.sql","content":"-- Create a function to register payments from Stripe via n8n\r\n-- This function finds the patient by email and inserts the payment\r\n\r\nCREATE OR REPLACE FUNCTION register_payment_by_email(\r\n    p_email TEXT,\r\n    p_amount NUMERIC,\r\n    p_date DATE,\r\n    p_concept TEXT DEFAULT 'Mensualidad Stripe'\r\n)\r\nRETURNS JSON\r\nLANGUAGE plpgsql\r\nSECURITY DEFINER\r\nAS $$\r\nDECLARE\r\n    v_patient_id UUID;\r\n    v_patient_name TEXT;\r\n    v_payment_id UUID;\r\nBEGIN\r\n    -- 1. Find Patient (Case Insensitive)\r\n    SELECT id, first_name || ' ' || last_name\r\n    INTO v_patient_id, v_patient_name\r\n    FROM patients\r\n    WHERE email ILIKE p_email\r\n    LIMIT 1;\r\n\r\n    -- 2. Handle Not Found\r\n    IF v_patient_id IS NULL THEN\r\n        RETURN json_build_object(\r\n            'success', false,\r\n            'message', 'No patient found with email: ' || p_email\r\n        );\r\n    END IF;\r\n\r\n    -- 3. Insert Payment\r\n    INSERT INTO payments (\r\n        patient_id,\r\n        date,\r\n        amount,\r\n        payment_method,\r\n        concept,\r\n        status,\r\n        created_at\r\n    ) VALUES (\r\n        v_patient_id,\r\n        p_date,\r\n        p_amount,\r\n        'Stripe',\r\n        p_concept,\r\n        'pagado',\r\n        NOW()\r\n    ) RETURNING id INTO v_payment_id;\r\n\r\n    -- 4. Return Success\r\n    RETURN json_build_object(\r\n        'success', true,\r\n        'message', 'Payment registered successfully',\r\n        'patient_name', v_patient_name,\r\n        'payment_id', v_payment_id\r\n    );\r\nEND;\r\n$$;\r\n\r\n-- Grant access\r\nGRANT EXECUTE ON FUNCTION register_payment_by_email TO authenticated;\r\nGRANT EXECUTE ON FUNCTION register_payment_by_email TO service_role;\r\n"},{"path":"drop_favorite_foods.sql","content":"-- Drop the unused column\r\nALTER TABLE patients DROP COLUMN favorite_foods;\r\n"},{"path":"eslint.config.js","content":"import js from '@eslint/js'\nimport globals from 'globals'\nimport reactHooks from 'eslint-plugin-react-hooks'\nimport reactRefresh from 'eslint-plugin-react-refresh'\nimport { defineConfig, globalIgnores } from 'eslint/config'\n\nexport default defineConfig([\n  globalIgnores(['dist']),\n  {\n    files: ['**/*.{js,jsx}'],\n    extends: [\n      js.configs.recommended,\n      reactHooks.configs.flat.recommended,\n      reactRefresh.configs.vite,\n    ],\n    languageOptions: {\n      ecmaVersion: 2020,\n      globals: globals.browser,\n      parserOptions: {\n        ecmaVersion: 'latest',\n        ecmaFeatures: { jsx: true },\n        sourceType: 'module',\n      },\n    },\n    rules: {\n      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],\n    },\n  },\n])\n"},{"path":"fix_active_no_history.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = 'https://gnziiexbwafppyardsbm.supabase.co';\r\nconst supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduemlpZXhid2FmcHB5YXJkc2JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzU3MzcsImV4cCI6MjA4NTcxMTczN30._OGW9i5TFngCEMT17RRrpHmTlDxA5j1DzF5ErIwAdYg';\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function fixPatients() {\r\n    console.log('Fetching patients...');\r\n    const { data: patients, error } = await supabase.from('patients').select('id, first_name, last_name, subscription_status');\r\n    const { data: history, error: historyError } = await supabase.from('patient_subscriptions').select('patient_id');\r\n\r\n    if (error || historyError) {\r\n        console.error('Error fetching data');\r\n        return;\r\n    }\r\n\r\n    for (const p of patients) {\r\n        const pHistory = history.filter(h => h.patient_id === p.id);\r\n        const name = `${p.first_name || ''} ${p.last_name || ''}`.trim();\r\n\r\n        if (p.subscription_status === 'active' && pHistory.length === 0) {\r\n            console.log(`Fixing patient ${name} (${p.id}): Active but no history. Setting to inactive.`);\r\n            const { error: updateError } = await supabase.from('patients').update({ subscription_status: 'inactive' }).eq('id', p.id);\r\n            if (updateError) console.error('Error updating:', updateError);\r\n            else console.log('Fixed.');\r\n        }\r\n    }\r\n    console.log('Done.');\r\n}\r\n\r\nfixPatients();\r\n"},{"path":"fix_angel.js","content":"\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\n\r\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\nconst envConfig = fs.readFileSync(envPath, 'utf8');\r\nconst env = {};\r\nenvConfig.split('\\n').forEach(line => {\r\n    const [key, value] = line.split('=');\r\n    if (key && value) env[key.trim()] = value.trim();\r\n});\r\n\r\nconst supabaseUrl = env.VITE_SUPABASE_URL;\r\nconst supabaseKey = env.VITE_SUPABASE_KEY;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nconst ANGEL_ID = \"ecdaeee4-4f23-479a-a9af-59346c40966e\";\r\nconst NEW_DATE = \"2026-01-28\";\r\n\r\nasync function fixAngel() {\r\n    console.log(`Updating Angel (${ANGEL_ID}) to ${NEW_DATE}...`);\r\n\r\n    // 1. Update patient record\r\n    const { data: patientData, error: patientError } = await supabase\r\n        .from('patients')\r\n        .update({ subscription_end: NEW_DATE })\r\n        .eq('id', ANGEL_ID)\r\n        .select();\r\n\r\n    if (patientError) {\r\n        console.error('Error updating patient:', patientError);\r\n    } else {\r\n        console.log('Patient updated:', JSON.stringify(patientData, null, 2));\r\n    }\r\n\r\n    // 2. Update active subscription history (blindly)\r\n    const { data: historyData, error: historyError } = await supabase\r\n        .from('patient_subscriptions')\r\n        .update({ end_date: NEW_DATE })\r\n        .eq('patient_id', ANGEL_ID)\r\n        .eq('status', 'active')\r\n        .select();\r\n\r\n    if (historyError) {\r\n        console.error('Error updating history:', historyError);\r\n    } else {\r\n        console.log('History updated:', JSON.stringify(historyData, null, 2));\r\n    }\r\n}\r\n\r\nfixAngel();\r\n"},{"path":"fix_permissions.sql","content":"-- Fix permissions for subscription_pauses\r\n\r\n-- Ensure RLS is enabled\r\nALTER TABLE public.subscription_pauses ENABLE ROW LEVEL SECURITY;\r\n\r\n-- Drop existing policies to avoid conflicts\r\nDROP POLICY IF EXISTS \"Enable read access for all users\" ON public.subscription_pauses;\r\nDROP POLICY IF EXISTS \"Enable insert access for all users\" ON public.subscription_pauses;\r\nDROP POLICY IF EXISTS \"Enable update access for all users\" ON public.subscription_pauses;\r\nDROP POLICY IF EXISTS \"Enable delete access for all users\" ON public.subscription_pauses;\r\nDROP POLICY IF EXISTS \"Enable all access for all users\" ON public.subscription_pauses;\r\n\r\n-- Create permissive policies (adjust if you have specific auth requirements)\r\nCREATE POLICY \"Enable read access for all users\" ON public.subscription_pauses FOR SELECT USING (true);\r\nCREATE POLICY \"Enable insert access for all users\" ON public.subscription_pauses FOR INSERT WITH CHECK (true);\r\nCREATE POLICY \"Enable update access for all users\" ON public.subscription_pauses FOR UPDATE USING (true);\r\nCREATE POLICY \"Enable delete access for all users\" ON public.subscription_pauses FOR DELETE USING (true);\r\n\r\n-- Notify schema reload\r\nNOTIFY pgrst, 'reload config';\r\n"},{"path":"force_add_column.sql","content":"-- Forcefully add the column. \r\n-- Even if it fails saying \"already exists\", that's fine, we just want to be SURE.\r\n\r\nALTER TABLE payments \r\nADD COLUMN IF NOT EXISTS payment_rate_id UUID REFERENCES payment_rates(id) ON DELETE SET NULL;\r\n\r\n-- Verify immediately\r\nSELECT column_name, data_type \r\nFROM information_schema.columns \r\nWHERE table_name = 'payments';\r\n"},{"path":"force_refresh.sql","content":"-- 1. Reload the schema cache for PostgREST (API)\r\nNOTIFY pgrst, 'reload config';\r\n\r\n-- 2. Explicitly grant permissions (just in case)\r\nGRANT ALL ON TABLE patients TO authenticated;\r\nGRANT ALL ON TABLE patients TO service_role;\r\n\r\n-- 3. Verify column is visible to the system\r\nSELECT column_name, data_type, is_updatable\r\nFROM information_schema.columns \r\nWHERE table_name = 'patients' AND column_name = 'payment_category_id';\r\n"},{"path":"get_schema.sql","content":"SELECT \r\n    table_name, \r\n    column_name, \r\n    data_type \r\nFROM \r\n    information_schema.columns \r\nWHERE \r\n    table_schema = 'public' \r\nORDER BY \r\n    table_name, column_name;\r\n"},{"path":"index.html","content":"<!doctype html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\" />\n    <link rel=\"icon\" type=\"image/svg+xml\" href=\"/vite.svg\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n    <title>nutri-crm</title>\n  </head>\n  <body>\n    <div id=\"root\"></div>\n    <script type=\"module\" src=\"/src/main.jsx\"></script>\n  </body>\n</html>\n"}]